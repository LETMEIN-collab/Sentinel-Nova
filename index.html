<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SENTINEL NOVA â€” Global Security Terminal</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#000;color:#d4d4d4;overflow-x:hidden;font-size:12px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#000}::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
:root{--bg0:#000;--bg1:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--bdr:#222;--bdrh:#333;--amber:#ff9500;--amberd:#b36800;--amberbg:rgba(255,149,0,0.08);--red:#ff3b30;--redbg:rgba(255,59,48,0.1);--grn:#30d158;--grnbg:rgba(48,209,88,0.08);--blu:#0a84ff;--cyan:#64d2ff;--pur:#bf5af2;--yel:#ffd60a;--t1:#e5e5e5;--t2:#999;--t3:#666;--mono:'JetBrains Mono',monospace}

/* TICKER */
.ticker{background:#050505;border-bottom:1px solid var(--bdr);height:24px;overflow:hidden;display:flex;align-items:center}
.tscroll{display:flex;animation:tsc 60s linear infinite;white-space:nowrap}.tscroll:hover{animation-play-state:paused}
@keyframes tsc{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.tk{display:inline-flex;align-items:center;gap:5px;margin-right:28px;font:500 11px var(--mono);letter-spacing:.3px}
.tk .s{color:var(--t2)}.tk .p{color:var(--t1)}.tk .up{color:var(--grn);font-size:10px}.tk .dn{color:var(--red);font-size:10px}
.tsep{color:var(--bdr);margin-right:28px}

/* HEADER */
.hdr{background:var(--bg1);border-bottom:1px solid var(--bdr);padding:8px 16px;display:flex;align-items:center;justify-content:space-between}
.hdr-l{display:flex;align-items:center;gap:12px}
.logo{font:700 14px var(--mono);color:var(--red);letter-spacing:2px}
.logo span{color:var(--t3);font-weight:400;font-size:10px;letter-spacing:1px;margin-left:8px}
.hdr-r{display:flex;align-items:center;gap:20px;font:400 11px var(--mono);color:var(--t3)}
.live{display:flex;align-items:center;gap:5px}
.ldot{width:6px;height:6px;background:var(--grn);border-radius:50%;animation:bl 2s infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.3}}
.threat{padding:3px 10px;border-radius:3px;font:600 10px var(--mono);letter-spacing:1px;text-transform:uppercase;background:var(--redbg);color:var(--red);border:1px solid rgba(255,59,48,.3)}

/* LAYOUT */
.shell{display:grid;grid-template-columns:240px 1fr 280px;height:calc(100vh - 79px);overflow:hidden}
.sidebar{background:var(--bg1);border-right:1px solid var(--bdr);overflow-y:auto}
.center{display:flex;flex-direction:column;overflow:hidden}
.rpanel{background:var(--bg1);border-left:1px solid var(--bdr);overflow-y:auto}

/* PANELS */
.ph{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg2);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:2}
.pt{font:600 10px var(--mono);text-transform:uppercase;letter-spacing:1.5px;color:var(--red);display:flex;align-items:center;gap:6px}
.pb{font:500 9px var(--mono);padding:1px 6px;border-radius:2px;letter-spacing:.5px}
.pbd{padding:10px 12px}

/* RISK GAUGES */
.rg{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--bdr)}.rg:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.rg-t{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px}
.rg-l{font:500 11px/1 'Inter',sans-serif;color:var(--t2)}
.rg-v{font:700 16px var(--mono)}
.rg-b{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;margin-bottom:3px}
.rg-f{height:100%;border-radius:2px;transition:width 1s ease}
.rg-m{font:400 9px var(--mono);color:var(--t3);display:flex;justify-content:space-between}

/* MAP */
.mwrap{position:relative;width:100%;height:100%;min-height:300px;background:var(--bg0)}
.mwrap svg{width:100%;height:100%}
#leaflet-map{width:100%;height:100%;background:#000;z-index:0}
.leaflet-container{background:#000!important}
.leaflet-control-zoom{border:1px solid var(--bdr)!important;border-radius:3px!important}
.leaflet-control-zoom a{background:var(--bg2)!important;color:var(--t2)!important;border-color:var(--bdr)!important;width:26px!important;height:26px!important;line-height:26px!important;font-size:13px!important}
.leaflet-control-zoom a:hover{background:var(--bg3)!important;color:var(--t1)!important}
.leaflet-control-attribution{display:none!important}
.pulse-marker{border-radius:50%;animation:pmark 2s infinite}
@keyframes pmark{0%{box-shadow:0 0 0 0 rgba(255,59,48,.5)}70%{box-shadow:0 0 0 12px rgba(255,59,48,0)}100%{box-shadow:0 0 0 0 rgba(255,59,48,0)}}
.leaflet-popup-content-wrapper{background:var(--bg2)!important;color:var(--t1)!important;border:1px solid var(--bdrh)!important;border-radius:6px!important;box-shadow:0 4px 20px rgba(0,0,0,.6)!important;font-family:'Inter',sans-serif!important;font-size:11px!important}
.leaflet-popup-tip{background:var(--bg2)!important;border:1px solid var(--bdrh)!important}
.leaflet-popup-close-button{color:var(--t3)!important;font-size:16px!important}
.leaflet-popup-close-button:hover{color:var(--t1)!important}
.conn-arc{stroke-dasharray:6,4;animation:arcflow 3s linear infinite}
@keyframes arcflow{0%{stroke-dashoffset:0}100%{stroke-dashoffset:-30}}
.mfilt{position:absolute;top:8px;left:8px;display:flex;gap:4px;flex-wrap:wrap}
.mfb{font:500 9px var(--mono);padding:3px 8px;border-radius:2px;border:1px solid var(--bdr);background:var(--bg2);color:var(--t3);cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.5px}
.mfb:hover{border-color:var(--bdrh);color:var(--t2)}.mfb.a{background:var(--redbg);border-color:rgba(255,59,48,.4);color:var(--red)}
.mstat{position:absolute;top:8px;right:8px;display:flex;gap:6px}
.ms{background:rgba(0,0,0,.8);border:1px solid var(--bdr);border-radius:3px;padding:4px 8px;text-align:center}
.msv{font:700 14px var(--mono);display:block}.msl{font:400 8px var(--mono);color:var(--t3);text-transform:uppercase;letter-spacing:.5px}
.mleg{position:absolute;bottom:8px;left:8px;display:flex;gap:10px;font:400 9px var(--mono);color:var(--t3)}
.ml{display:flex;align-items:center;gap:3px}.mld{width:6px;height:6px;border-radius:50%}
.mpulse{animation:mp 2s infinite}@keyframes mp{0%{r:5;opacity:.9}50%{r:14;opacity:0}100%{r:5;opacity:0}}

/* CONNECTION LINES */
.conn-line{stroke-dasharray:4,3;animation:dash 20s linear infinite}
@keyframes dash{0%{stroke-dashoffset:0}100%{stroke-dashoffset:-200}}

/* NEWS TICKER */
.newstick{background:#050505;border-top:1px solid var(--bdr);height:22px;overflow:hidden;display:flex;align-items:center}
.newstick .label{font:600 9px var(--mono);color:var(--red);padding:0 10px;text-transform:uppercase;letter-spacing:1px;white-space:nowrap;border-right:1px solid var(--bdr);flex-shrink:0}
.nscroll{display:flex;animation:nsc 90s linear infinite;white-space:nowrap}.nscroll:hover{animation-play-state:paused}
@keyframes nsc{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.nitem{display:inline-flex;align-items:center;gap:6px;margin-right:40px;font:400 10px 'Inter',sans-serif;color:var(--t2)}
.nitem .ndot{width:4px;height:4px;border-radius:50%;flex-shrink:0}
.nitem .nsrc{font:400 9px var(--mono);color:var(--t3);margin-left:4px}

/* HEADER SPARKLINE */
.hdr-spgi{display:flex;align-items:center;gap:8px;padding:2px 10px;background:var(--bg2);border:1px solid var(--bdr);border-radius:3px}

/* BREAKING NEWS BANNER */
.breaking-banner{background:linear-gradient(90deg,#1a0000,#330000,#1a0000);border-bottom:2px solid #ff3b30;padding:0;overflow:hidden;animation:bannerIn .4s ease-out}
@keyframes bannerIn{from{max-height:0;opacity:0}to{max-height:60px;opacity:1}}
.breaking-banner .bb-inner{display:flex;align-items:center;gap:10px;padding:6px 16px;min-height:36px}
.breaking-banner .bb-pulse{width:8px;height:8px;border-radius:50%;background:#ff3b30;animation:bbpulse 1.2s ease-in-out infinite;flex-shrink:0}
@keyframes bbpulse{0%,100%{box-shadow:0 0 4px #ff3b30}50%{box-shadow:0 0 16px #ff3b30,0 0 30px rgba(255,59,48,.4)}}
.breaking-banner .bb-tag{font:700 9px var(--mono);color:#ff3b30;letter-spacing:1.5px;text-transform:uppercase;flex-shrink:0;padding:2px 8px;border:1px solid rgba(255,59,48,.4);border-radius:2px;background:rgba(255,59,48,.12)}
.breaking-banner .bb-headline{font:600 11px/1.3 'Inter',sans-serif;color:#ff6b6b;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.breaking-banner .bb-headline a{color:#ff6b6b;text-decoration:none}
.breaking-banner .bb-headline a:hover{color:#ff9999;text-decoration:underline}
.breaking-banner .bb-sources{font:400 9px var(--mono);color:var(--t3);flex-shrink:0;white-space:nowrap}
.breaking-banner .bb-time{font:400 9px var(--mono);color:var(--t3);flex-shrink:0}
.breaking-banner .bb-dismiss{background:none;border:1px solid rgba(255,59,48,.3);color:var(--t3);font:400 10px var(--mono);cursor:pointer;padding:2px 6px;border-radius:2px;flex-shrink:0}
.breaking-banner .bb-dismiss:hover{color:var(--t1);border-color:var(--t3)}

/* INTEL SEARCH */
.isrch{display:flex;align-items:center;gap:6px;padding:4px 12px;background:var(--bg2);border-bottom:1px solid var(--bdr)}
.isrch input{flex:1;background:var(--card);border:1px solid var(--bdr);border-radius:3px;padding:4px 8px;font:400 10px var(--mono);color:var(--t1);outline:none}
.isrch input::placeholder{color:var(--t3)}
.isrch input:focus{border-color:var(--red)}
.isrch button{background:var(--red);color:#fff;border:none;border-radius:3px;padding:4px 10px;font:600 9px var(--mono);cursor:pointer;letter-spacing:.5px}
.isrch button:hover{opacity:.85}
.isrch .clear{background:transparent;color:var(--t3);border:1px solid var(--bdr);padding:4px 8px}

/* INTEL FEED */
.fi{padding:8px 0;border-bottom:1px solid var(--bdr)}.fi:last-child{border-bottom:none}
.fi:hover{background:var(--bg2);margin:0 -12px;padding:8px 12px}
.fit{display:flex;align-items:center;gap:6px;margin-bottom:3px}
.fis{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.fitg{font:500 8px var(--mono);padding:1px 5px;border-radius:2px;text-transform:uppercase;letter-spacing:.5px}
.fitm{font:400 9px var(--mono);color:var(--t3);margin-left:auto}
.fitt{font:500 11px/1.4 'Inter',sans-serif;color:var(--t1)}
.fisu{font:400 10px 'Inter',sans-serif;color:var(--t3);margin-top:2px}

/* MARKET */
.mr{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(34,34,34,.5);font:400 11px var(--mono)}
.mr:last-child{border-bottom:none}
.mrs{color:var(--t1);font-weight:500;width:65px}.mrp{color:var(--t1);width:65px;text-align:right}.mrc{width:60px;text-align:right;font-size:10px}
.msec{padding:6px 12px;font:600 9px var(--mono);color:var(--red);letter-spacing:1.5px;text-transform:uppercase;background:var(--bg2);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:1}

/* CHART TABS */
.ctabs{display:flex;gap:4px;margin-bottom:8px}
.ct{font:500 9px var(--mono);padding:3px 8px;border-radius:2px;border:1px solid var(--bdr);background:transparent;color:var(--t3);cursor:pointer;letter-spacing:.5px;transition:all .15s}
.ct.a{background:var(--redbg);border-color:rgba(255,59,48,.4);color:var(--red)}.ct:hover{border-color:var(--bdrh)}

/* TOOLTIP */
.tt{position:fixed;background:var(--bg2);border:1px solid var(--bdrh);border-radius:4px;padding:8px 12px;z-index:200;pointer-events:none;max-width:280px;box-shadow:0 4px 20px rgba(0,0,0,.6)}
.tt h5{font:600 11px 'Inter',sans-serif;margin-bottom:3px}.tt p{font:400 10px 'Inter',sans-serif;color:var(--t2);line-height:1.4}

/* REGIONAL */
.rr{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--bdr);font:400 10px var(--mono)}
.rr:last-child{border-bottom:none}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useMemo}=React;

/* â•â•â• MINI SVG CHART COMPONENTS â•â•â• */
const Sparkline=({data,dataKey,w=200,h=60,color='#30d158',fill=true,showAxis=false})=>{
  const vals=data.map(d=>d[dataKey]);
  const mn=Math.min(...vals),mx=Math.max(...vals);
  const range=mx-mn||1;
  const pad=4;
  const pts=vals.map((v,i)=>{
    const x=pad+(i/(vals.length-1))*(w-pad*2);
    const y=pad+((mx-v)/range)*(h-pad*2);
    return `${x},${y}`;
  });
  const line=pts.join(' ');
  const areaPath=`M${pts[0]} L${line.replace(/,/g,' ').split(' L').join(' L')} L${pad+(vals.length-1)/(vals.length-1)*(w-pad*2)},${h} L${pad},${h} Z`;
  const polyline=pts.join(' ');
  const gradId='g'+Math.random().toString(36).slice(2,8);
  return(
    <svg width="100%" height={h} viewBox={`0 0 ${w} ${h}`} preserveAspectRatio="none">
      {fill&&<defs><linearGradient id={gradId} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={color} stopOpacity=".25"/><stop offset="100%" stopColor={color} stopOpacity="0"/></linearGradient></defs>}
      {fill&&<polygon points={`${pts[0]} ${polyline} ${pad+(vals.length-1)/(vals.length-1)*(w-pad*2)},${h-pad} ${pad},${h-pad}`} fill={`url(#${gradId})`}/>}
      <polyline points={polyline} fill="none" stroke={color} strokeWidth="1.5" strokeLinejoin="round" strokeLinecap="round"/>
    </svg>
  );
};

const AreaChartSVG=({data,keys,colors,w=400,h=180,labels})=>{
  const allVals=keys.flatMap(k=>data.map(d=>d[k]));
  const mx=Math.max(...allVals),mn=0;
  const range=mx-mn||1;
  const pad={t:10,r:10,b:24,l:32};
  const cw=w-pad.l-pad.r,ch=h-pad.t-pad.b;
  const toX=i=>pad.l+(i/(data.length-1))*cw;
  const toY=v=>pad.t+((mx-v)/range)*ch;
  return(
    <svg width="100%" viewBox={`0 0 ${w} ${h}`} style={{display:'block'}}>
      {/* grid */}
      {[0,.25,.5,.75,1].map((f,i)=>{
        const y=pad.t+f*ch;
        const v=Math.round(mx-(f*range));
        return <g key={i}><line x1={pad.l} y1={y} x2={w-pad.r} y2={y} stroke="#1a1a1a" strokeWidth=".5"/><text x={pad.l-4} y={y+3} fill="#666" fontSize="8" fontFamily="JetBrains Mono" textAnchor="end">{v}</text></g>;
      })}
      {/* x labels */}
      {data.map((d,i)=><text key={i} x={toX(i)} y={h-4} fill="#666" fontSize="8" fontFamily="JetBrains Mono" textAnchor="middle">{d.d||d.month||''}</text>)}
      {/* areas + lines */}
      {keys.map((k,ki)=>{
        const pts=data.map((d,i)=>`${toX(i)},${toY(d[k])}`).join(' ');
        const gid='ac'+ki+Math.random().toString(36).slice(2,6);
        return <g key={k}>
          <defs><linearGradient id={gid} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={colors[ki]} stopOpacity=".15"/><stop offset="100%" stopColor={colors[ki]} stopOpacity="0"/></linearGradient></defs>
          <polygon points={`${toX(0)},${toY(0)} ${pts} ${toX(data.length-1)},${toY(0)}`} fill={`url(#${gid})`}/>
          <polyline points={pts} fill="none" stroke={colors[ki]} strokeWidth="1.5" strokeLinejoin="round"/>
        </g>;
      })}
    </svg>
  );
};

/* â•â•â• DATA â•â•â• */
const TICKERS=[
  {s:'SPGI',p:'404.78',c:'-3.04%',u:false},{s:'ES1',p:'5,954',c:'-0.07%',u:false},{s:'NQ1',p:'21,220',c:'-0.14%',u:false},
  {s:'DXY',p:'97.69',c:'-0.22%',u:false},{s:'GC1',p:'5,228',c:'+2.90%',u:true},{s:'CL1',p:'65.97',c:'-0.80%',u:false},
  {s:'US10Y',p:'4.010',c:'-6bp',u:false},{s:'VIX',p:'21.11',c:'+10.58%',u:true},{s:'BTC',p:'64,762',c:'-3.92%',u:false},
  {s:'EUR',p:'1.1820',c:'+0.31%',u:true},{s:'GBP',p:'1.3519',c:'+0.26%',u:true},{s:'JPY',p:'148.50',c:'-0.45%',u:false},
  {s:'NG1',p:'3.088',c:'-2.03%',u:false},{s:'HG1',p:'5.90',c:'-1.65%',u:false},{s:'W1',p:'572.00',c:'+2.27%',u:true},
];

/* Advisory level colors & labels */
const ADV_COLORS={4:'#ff3b30',3:'#ff9500',2:'#ffd60a',1:'#30d158'};
const ADV_LABELS={4:'DO NOT TRAVEL',3:'RECONSIDER TRAVEL',2:'EXERCISE INCREASED CAUTION',1:'EXERCISE NORMAL PRECAUTIONS'};
const ADV_SHORT={4:'L4 â€” DNT',3:'L3 â€” RECONSIDER',2:'L2 â€” CAUTION',1:'L1 â€” NORMAL'};

/* Country risk rating RSS */
const RATING_RSS_QUERIES=[
  'sovereign+credit+rating+downgrade+upgrade+Moody+Fitch+%22S%26P%22',
  'country+rating+outlook+negative+positive+watch+sovereign',
];

/* Current fallback â€” Level 4 Do Not Travel (as of Feb 2026, State Dept) */
const ADV_FALLBACK=[
  {country:'Afghanistan',level:4,title:'Afghanistan â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/afghanistan-travel-advisory.html',desc:'Terrorism, wrongful detention, kidnapping'},
  {country:'Ukraine',level:4,title:'Ukraine â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/ukraine-travel-advisory.html',desc:'Armed conflict with Russia, civil unrest'},
  {country:'Russia',level:4,title:'Russia â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/russia-travel-advisory.html',desc:'Wrongful detention, harassment of US citizens'},
  {country:'Syria',level:4,title:'Syria â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/syria-travel-advisory.html',desc:'Terrorism, civil unrest, kidnapping'},
  {country:'Iran',level:4,title:'Iran â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iran-travel-advisory.html',desc:'Wrongful detention, terrorism, kidnapping'},
  {country:'Iraq',level:4,title:'Iraq â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iraq-travel-advisory.html',desc:'Terrorism, kidnapping, armed conflict'},
  {country:'Yemen',level:4,title:'Yemen â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/yemen-travel-advisory.html',desc:'Civil unrest, terrorism, Houthi activity'},
  {country:'Somalia',level:4,title:'Somalia â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/somalia-travel-advisory.html',desc:'Terrorism, piracy, kidnapping'},
  {country:'Sudan',level:4,title:'Sudan â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/sudan-travel-advisory.html',desc:'Armed conflict, civil unrest, kidnapping'},
  {country:'South Sudan',level:4,title:'South Sudan â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/south-sudan-travel-advisory.html',desc:'Crime, kidnapping, armed conflict'},
  {country:'Libya',level:4,title:'Libya â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/libya-travel-advisory.html',desc:'Crime, terrorism, armed conflict'},
  {country:'Mali',level:4,title:'Mali â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mali-travel-advisory.html',desc:'Crime, terrorism, kidnapping'},
  {country:'Haiti',level:4,title:'Haiti â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/haiti-travel-advisory.html',desc:'Kidnapping, gang violence, civil unrest'},
  {country:'North Korea',level:4,title:'North Korea â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/north-korea-travel-advisory.html',desc:'Wrongful detention, nuclear/missile threat'},
  {country:'Venezuela',level:4,title:'Venezuela â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/venezuela-travel-advisory.html',desc:'Crime, civil unrest, wrongful detention'},
  {country:'Myanmar (Burma)',level:4,title:'Myanmar â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burma-travel-advisory.html',desc:'Civil unrest, armed conflict'},
  {country:'Burkina Faso',level:4,title:'Burkina Faso â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burkina-faso-travel-advisory.html',desc:'Terrorism, crime, kidnapping'},
  {country:'Niger',level:4,title:'Niger â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/niger-travel-advisory.html',desc:'Terrorism, kidnapping'},
  {country:'Central African Republic',level:4,title:'CAR â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/central-african-republic-travel-advisory.html',desc:'Crime, civil unrest, kidnapping'},
  {country:'Belarus',level:4,title:'Belarus â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/belarus-travel-advisory.html',desc:'Wrongful detention, Russia-Ukraine spillover'},
  {country:'Lebanon',level:4,title:'Lebanon â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/lebanon-travel-advisory.html',desc:'Crime, terrorism, Hezbollah activity'},
  {country:'Gaza Strip',level:4,title:'Gaza â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/israel-the-west-bank-and-gaza-travel-advisory.html',desc:'Armed conflict, terrorism'},
  // Level 3 â€” Reconsider Travel
  {country:'Pakistan',level:3,title:'Pakistan â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism, sectarian violence'},
  {country:'Nigeria',level:3,title:'Nigeria â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, kidnapping'},
  {country:'Honduras',level:3,title:'Honduras â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, kidnapping'},
  {country:'El Salvador',level:3,title:'El Salvador â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'Ethiopia',level:3,title:'Ethiopia â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Civil unrest, armed conflict'},
  {country:'Democratic Republic of the Congo',level:3,title:'DRC â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, armed conflict'},
  {country:'Cameroon',level:3,title:'Cameroon â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, kidnapping'},
  {country:'Chad',level:3,title:'Chad â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, minefields'},
  {country:'Mauritania',level:3,title:'Mauritania â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Guinea',level:3,title:'Guinea â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Civil unrest, crime'},
  {country:'Colombia',level:3,title:'Colombia â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, kidnapping'},
  {country:'Kenya',level:3,title:'Kenya â€” Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  // Level 2 â€” Exercise Increased Caution
  {country:'Mexico',level:2,title:'Mexico â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, kidnapping'},
  {country:'Brazil',level:2,title:'Brazil â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'Egypt',level:2,title:'Egypt â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism'},
  {country:'Turkey',level:2,title:'Turkey â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism, arbitrary detention'},
  {country:'India',level:2,title:'India â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Israel',level:2,title:'Israel â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism, civil unrest'},
  {country:'Philippines',level:2,title:'Philippines â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'South Africa',level:2,title:'South Africa â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'Jamaica',level:2,title:'Jamaica â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'China',level:2,title:'China â€” Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Wrongful detention, arbitrary enforcement'},
  {country:'Russia',level:4,title:'Russia â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Wrongful detention'},
];

/* Current fallback sovereign rating changes */
const RATING_FALLBACK=[
  {headline:'Fitch Warns Eastern Europe Faces Downgrades if Greenland Strife Cracks NATO',src:'Fitch Ratings',agency:'Fitch',direction:'watch',color:'#ffd60a',time:'Jan 2026',url:'https://www.insurancejournal.com/news/international/2026/01/16/854630.htm'},
  {headline:'Moody\'s Upgrades Israel Outlook to Stable from Negative â€” Ceasefire Effect',src:'Moody\'s',agency:'Moody\'s',direction:'upgrade',color:'#30d158',time:'Jan 2026',url:'https://ratings.moodys.com/ratings-news/429502'},
  {headline:'Scope Downgrades US to AA- from AA â€” Fiscal Deterioration & Governance',src:'Scope Ratings',agency:'Scope',direction:'downgrade',color:'#ff3b30',time:'Oct 2025',url:'https://scoperatings.com'},
  {headline:'S&P Downgrades France to A+ from AA- â€” Unscheduled Move on Budget Risk',src:'S&P Global',agency:'S&P',direction:'downgrade',color:'#ff3b30',time:'Oct 2025',url:'https://www.spglobal.com/ratings'},
  {headline:'Moody\'s France Outlook Cut to Negative â€” Political Fragmentation Risk',src:'Moody\'s',agency:'Moody\'s',direction:'downgrade',color:'#ff3b30',time:'Oct 2025',url:'https://ratings.moodys.com/ratings-news/453186'},
  {headline:'S&P Upgrades South Africa to BB â€” First Upgrade in Nearly Two Decades',src:'S&P Global',agency:'S&P',direction:'upgrade',color:'#30d158',time:'Nov 2025',url:'https://www.spglobal.com/ratings'},
  {headline:'Moody\'s Downgrades Botswana to Baa1 â€” Diamond Downturn & Rising Debt',src:'Moody\'s',agency:'Moody\'s',direction:'downgrade',color:'#ff3b30',time:'Oct 2025',url:'https://www.moodys.com'},
  {headline:'Moody\'s Downgrades US to Aa1 â€” Last AAA Rating Lost by Any Major Agency',src:'Moody\'s',agency:'Moody\'s',direction:'downgrade',color:'#ff3b30',time:'May 2025',url:'https://www.moodys.com/web/en/us/about-us/usrating.html'},
  {headline:'Fitch Downgrades China to A from A+ â€” Debt Trajectory & Tariff Impact',src:'Fitch Ratings',agency:'Fitch',direction:'downgrade',color:'#ff3b30',time:'Apr 2025',url:'https://www.fitchratings.com'},
  {headline:'Fitch 2026 Sovereign Outlook: Neutral â€” Fiscal Consolidation Will Be Painful',src:'Fitch Ratings',agency:'Fitch',direction:'watch',color:'#ffd60a',time:'Feb 2026',url:'https://www.investmentexecutive.com/uncategorized/sovereign-rating-outlook-neutral-for-2026-fitch/'},
  {headline:'Moody\'s 2026: Debt/GDP Ratios Remain High â€” Limited Room for Shocks',src:'Moody\'s',agency:'Moody\'s',direction:'watch',color:'#ffd60a',time:'Feb 2026',url:'https://www.moodys.com/web/en/us/insights/credit-risk/outlooks/global-sovereigns-2026.html'},
  {headline:'S&P 2026 Outlook: Geopolitical Risks Could Destabilize Credit Quality',src:'S&P Global',agency:'S&P',direction:'watch',color:'#ffd60a',time:'Feb 2026',url:'https://www.spglobal.com/ratings/en/regulatory/article/global-sovereign-rating-trends-2026-geopolitical-risks-could-destabilize-credit-quality-dynamics-s101667695'},
];

const INCIDENTS=[
  {id:19,t:'Mexico â€” "El Mencho" CJNG Leader Killed, Nationwide Cartel Violence Erupts',sv:'critical',cat:'CONFLICT',reg:'N. America',tm:'NOW',lat:20.3,lon:-103.3,imp:'25 National Guard killed, 250+ roadblocks, 20 states, tourists stranded, Puerto Vallarta airport shut',ty:'Cartel'},
  {id:1,t:'Russian Naval Buildup in Black Sea â€” NATO Alert Level Raised',sv:'critical',cat:'CONFLICT',reg:'E. Europe',tm:'12m',lat:44,lon:34,imp:'NATO Article 5 consultation triggered',ty:'Military'},
  {id:2,t:'Cat-5 Cyclone Bearing Down on Bay of Bengal â€” 2.4M at Risk',sv:'critical',cat:'CLIMATE',reg:'S. Asia',tm:'28m',lat:16,lon:87,imp:'$8.2B estimated damage',ty:'Weather'},
  {id:3,t:'Major Ransomware Attack on European Energy Grid Operator',sv:'critical',cat:'CYBER',reg:'W. Europe',tm:'1h',lat:50,lon:8,imp:'3 nations, grid at 60%',ty:'Cyber'},
  {id:4,t:'Taiwan Strait â€” PLA Air Incursions Reach 52 Sorties in 24h',sv:'critical',cat:'CONFLICT',reg:'E. Asia',tm:'2h',lat:24,lon:121,imp:'Semiconductor supply risk',ty:'Military'},
  {id:5,t:'Strait of Hormuz â€” Tanker Seized by IRGC Navy',sv:'critical',cat:'ENERGY',reg:'M. East',tm:'3h',lat:26.5,lon:56,imp:'Oil +4.2%, $2.1B/day trade risk',ty:'Maritime'},
  {id:6,t:'Sahel Region â€” Wagner Group Expands Into 3 New Countries',sv:'high',cat:'CONFLICT',reg:'W. Africa',tm:'4h',lat:14,lon:-2,imp:'Democratic transitions destabilized',ty:'Military'},
  {id:7,t:'Mediterranean Wildfire Season â€” 340K Ha Across 5 Nations',sv:'high',cat:'CLIMATE',reg:'S. Europe',tm:'5h',lat:38,lon:23,imp:'$3.1B economic impact',ty:'Wildfire'},
  {id:8,t:'North Korea ICBM Test â€” Trajectory Over Sea of Japan',sv:'critical',cat:'CONFLICT',reg:'E. Asia',tm:'6h',lat:39,lon:127,imp:'UN emergency session called',ty:'WMD'},
  {id:9,t:'Amazon Deforestation Surge â€” 40% Above 5-Year Average',sv:'high',cat:'CLIMATE',reg:'S. America',tm:'6h',lat:-5,lon:-60,imp:'Carbon sink -12%',ty:'Deforestation'},
  {id:10,t:'US-China Semiconductor Export Controls Expanded',sv:'high',cat:'ECONOMIC',reg:'Global',tm:'8h',lat:39,lon:-77,imp:'$45B bilateral trade affected',ty:'Trade'},
  {id:11,t:'Arctic Permafrost Methane Release Exceeds Models by 40%',sv:'high',cat:'CLIMATE',reg:'Arctic',tm:'10h',lat:72,lon:125,imp:'Tipping point risk elevated',ty:'Emissions'},
  {id:12,t:'Sudan Civil Conflict â€” 2M New Displacements',sv:'high',cat:'CONFLICT',reg:'E. Africa',tm:'12h',lat:15,lon:32,imp:'Humanitarian crisis, spillover',ty:'Civil War'},
  {id:13,t:'EU Carbon Border Tax Phase 2 â€” 8 Sectors Added',sv:'medium',cat:'REGULATORY',reg:'Europe',tm:'1d',lat:50,lon:4,imp:'â‚¬45B cross-border trade',ty:'Regulatory'},
  {id:14,t:'India-Pakistan Indus Treaty Renegotiation Stalls',sv:'high',cat:'CONFLICT',reg:'S. Asia',tm:'1d',lat:30,lon:72,imp:'300M affected, agriculture risk',ty:'Water'},
  {id:15,t:'Pacific Islands Climate Emergency â€” Sea Level +18cm',sv:'high',cat:'CLIMATE',reg:'Oceania',tm:'1d',lat:-8,lon:160,imp:'$420M relocation costs',ty:'Sea Level'},
  {id:16,t:'Venezuelan Migration Crisis â€” 800K Cross to Colombia',sv:'medium',cat:'SOCIAL',reg:'S. America',tm:'1d',lat:7,lon:-72,imp:'$1.2B aid needed',ty:'Migration'},
  {id:17,t:'Chinese Spy Balloon Incursions â€” 3 Nations Report',sv:'medium',cat:'INTEL',reg:'Global',tm:'2d',lat:45,lon:-100,imp:'Sovereignty concern',ty:'Espionage'},
  {id:18,t:'Gulf of Guinea Piracy â€” 12 Incidents in 30 Days',sv:'medium',cat:'MARITIME',reg:'W. Africa',tm:'2d',lat:4,lon:3,imp:'$800M insurance spike',ty:'Maritime'},
];

const CC={CONFLICT:'#ff3b30',CLIMATE:'#ff9500',CYBER:'#bf5af2',ECONOMIC:'#0a84ff',ENERGY:'#ffd60a',REGULATORY:'#64d2ff',SOCIAL:'#30d158',INTEL:'#ff375f',MARITIME:'#5ac8fa',HEALTH:'#30d158'};
const SC={critical:'#ff3b30',high:'#ff9500',medium:'#ffd60a',low:'#30d158'};

/* Connection lines between related incidents [fromId, toId, label, color] */
const CONNS=[
  [5,1,'Energy supply chain disruption','#ffd60a'],   // Hormuz â†’ Black Sea
  [4,8,'East Asia escalation corridor','#ff3b30'],     // Taiwan â†’ DPRK
  [1,3,'Hybrid warfare vector','#bf5af2'],             // Black Sea â†’ Cyber EU
  [10,4,'Trade decoupling','#0a84ff'],                 // US-China â†’ Taiwan
  [5,14,'Water-energy nexus','#64d2ff'],               // Hormuz â†’ Indus
  [6,12,'Sahel-Sudan conflict arc','#ff3b30'],         // Sahel â†’ Sudan
];

/* News headlines for live ticker */
const NEWS=[
  {t:'NATO deploys additional carrier group to Eastern Mediterranean amid rising tensions',s:'Reuters',c:'#ff3b30'},
  {t:'Global reinsurance rates surge 18% on back of record climate losses',s:'FT',c:'#ff9500'},
  {t:'CISA warns of critical infrastructure vulnerability in energy sector SCADA systems',s:'CyberScoop',c:'#bf5af2'},
  {t:'World Bank revises global GDP growth forecast down to 2.4% citing geopolitical risk',s:'Bloomberg',c:'#0a84ff'},
  {t:'China conducts live-fire naval exercises in South China Sea for third consecutive week',s:'SCMP',c:'#ff3b30'},
  {t:'European gas storage levels fall below 5-year average ahead of winter season',s:'Platts',c:'#ffd60a'},
  {t:'UN Security Council emergency session on Sahel security deterioration',s:'AP',c:'#ff3b30'},
  {t:'IMF warns sovereign debt risks compounding climate vulnerability in 40 nations',s:'FT',c:'#ff9500'},
  {t:'US Treasury sanctions 12 entities linked to ransomware-as-a-service operations',s:'WSJ',c:'#bf5af2'},
  {t:'Arctic shipping routes see 300% increase in commercial traffic year-over-year',s:'Reuters',c:'#64d2ff'},
  {t:'OPEC+ signals potential output cut extension as demand outlook weakens',s:'Bloomberg',c:'#ffd60a'},
  {t:'S&P Global upgrades defense sector outlook to positive on sustained spending growth',s:'S&P Global',c:'#30d158'},
];

const MKTS={
  'COMMODITIES':[{s:'GC1',n:'Gold',p:'5,228',c:'+2.90%',u:1},{s:'CL1',n:'WTI Crude',p:'65.97',c:'-0.80%',u:0},{s:'NG1',n:'Nat Gas',p:'3.088',c:'-2.03%',u:0},{s:'HG1',n:'Copper',p:'5.90',c:'-1.65%',u:0},{s:'W1',n:'Wheat',p:'572.00',c:'+2.27%',u:1}],
  'FX & RATES':[{s:'DXY',n:'Dollar Idx',p:'97.69',c:'-0.22%',u:0},{s:'EUR',n:'EUR/USD',p:'1.1820',c:'+0.31%',u:1},{s:'US10Y',n:'10Y Yield',p:'4.010%',c:'-6bp',u:0},{s:'US2Y',n:'2Y Yield',p:'3.570%',c:'-7bp',u:0}],
  'CRYPTO':[{s:'BTC',n:'Bitcoin',p:'64,762',c:'-3.92%',u:0},{s:'ETH',n:'Ethereum',p:'2,680',c:'-4.10%',u:0}],
  'DEFENSE & INTEL':[{s:'SPGI',n:'S&P Global',p:'404.78',c:'-3.04%',u:0},{s:'LMT',n:'Lockheed',p:'661.49',c:'+0.42%',u:1},{s:'RTX',n:'RTX Corp',p:'204.81',c:'+0.64%',u:1},{s:'NOC',n:'Northrop',p:'724.83',c:'+3.38%',u:1},{s:'PLTR',n:'Palantir',p:'135.38',c:'+1.77%',u:1}],
};

/* SPGI RSS feed queries */
const SPGI_RSS_QUERIES=[
  '%22S%26P+Global%22+SPGI+earnings+revenue',
  '%22S%26P+Global%22+ratings+credit+Platts',
];

/* Current SPGI news fallback (Feb 2026) */
const SPGI_NEWS_FALLBACK=[
  {t:'S&P Global Reports Q4 & Full-Year 2025 Results â€” Revenue Up 9% to $3.92B',src:'S&P Global IR',tm:'Feb 10',url:'https://investor.spglobal.com/news-releases/news-details/2026/SP-Global-Reports-Fourth-Quarter-and-Full-Year-2025-Results/default.aspx'},
  {t:'SPGI Stock Drops 17% Premarket After 2026 Guidance Disappoints Analysts',src:'Seeking Alpha',tm:'Feb 10',url:'https://seekingalpha.com/news/4549419-sp-global-stock-drops-after-q4-earnings-2026-guidance-disappoint'},
  {t:'SPGI Up 7.3% â€” Strong 2025 Results and New Climate-Risk Data Push',src:'Simply Wall St',tm:'Feb 14',url:'https://simplywall.st/stocks/us/diversified-financials/nyse-spgi/sp-global/news/why-sp-global-spgi-is-up-73-after-strong-2025-results-and-ne'},
  {t:'S&P Global Ratings Wins Ratings Provider of the Year â€” PE Wire Europe Awards',src:'PE Wire',tm:'Feb 12',url:'https://www.stocktitan.net/news/SPGI/s-p-global-ratings-wins-ratings-provider-of-the-year-at-private-g48vy8gp0m8s.html'},
  {t:'S&P Global to Present at Raymond James 47th Institutional Investors Conference',src:'Stock Titan',tm:'Feb 18',url:'https://www.stocktitan.net/news/SPGI/s-p-global-to-present-at-raymond-james-47th-annual-institutional-dsjn8x6nn5cs.html'},
  {t:'S&P Global Energy & Verisk Launch Climate-Risk Data Collaboration for Banks & Insurers',src:'S&P Global',tm:'Feb 2026',url:'https://press.spglobal.com'},
  {t:'Full-Year 2025: Revenue $15.3B (+8%), Adjusted EPS $17.83 (+14%), $12.85B Buyback Complete',src:'S&P Global IR',tm:'Feb 10',url:'https://press.spglobal.com/2026-02-10-S-P-Global-Reports-Fourth-Quarter-and-Full-Year-2025-Results'},
  {t:'2026 Guidance: Reported Revenue Growth 6.6%-8.6%, New CERAWeek Energy Conference Role',src:'S&P Global',tm:'Feb 10',url:'https://investor.spglobal.com'},
];

const TREND={
  '1M':[{d:'W1',geo:72,clim:65,cyb:61,con:74},{d:'W2',geo:74,clim:67,cyb:63,con:76},{d:'W3',geo:75,clim:69,cyb:62,con:79},{d:'W4',geo:78,clim:72,cyb:65,con:83}],
  '6M':[{d:'Sep',geo:68,clim:58,cyb:55,con:65},{d:'Oct',geo:70,clim:62,cyb:58,con:70},{d:'Nov',geo:72,clim:64,cyb:60,con:73},{d:'Dec',geo:74,clim:66,cyb:62,con:76},{d:'Jan',geo:76,clim:70,cyb:64,con:80},{d:'Feb',geo:78,clim:72,cyb:65,con:83}],
  '1Y':[{d:'Mar',geo:60,clim:48,cyb:50,con:55},{d:'May',geo:62,clim:52,cyb:52,con:58},{d:'Jul',geo:65,clim:55,cyb:54,con:62},{d:'Sep',geo:68,clim:58,cyb:55,con:65},{d:'Nov',geo:72,clim:64,cyb:60,con:73},{d:'Feb',geo:78,clim:72,cyb:65,con:83}],
};

const SPGI=[{t:'09:30',p:417.5},{t:'10:00',p:414.2},{t:'10:30',p:411.8},{t:'11:00',p:409.6},{t:'11:30',p:407.3},{t:'12:00',p:406.1},{t:'12:30',p:405.4},{t:'13:00',p:404.2},{t:'13:30',p:403.8},{t:'14:00',p:402.9},{t:'14:30',p:403.5},{t:'15:00',p:404.1},{t:'15:30',p:404.5},{t:'16:00',p:404.78}];

/* (Regional risk now computed from live advisories) */

/* â•â•â• RSS FEED CONFIG â•â•â• */
const RSS_FEEDS=[
  // Conflict & military
  {q:'Russia+Ukraine+war+military+frontline',cat:'CONFLICT'},
  {q:'Iran+US+tensions+military+strikes+nuclear',cat:'CONFLICT'},
  {q:'China+Taiwan+military+South+China+Sea',cat:'CONFLICT'},
  {q:'Israel+Gaza+Hamas+Hezbollah+Middle+East+war',cat:'CONFLICT'},
  {q:'NATO+military+defense+troops+deployment',cat:'CONFLICT'},
  {q:'North+Korea+missile+nuclear+ICBM',cat:'CONFLICT'},
  // Climate & disasters
  {q:'climate+disaster+extreme+weather+hurricane+wildfire',cat:'CLIMATE'},
  // Cyber
  {q:'cybersecurity+ransomware+hack+breach+critical+infrastructure',cat:'CYBER'},
  // Economic & sanctions
  {q:'global+economy+sanctions+trade+war+tariff+recession',cat:'ECONOMIC'},
  {q:'US+China+trade+decoupling+semiconductor+sanctions',cat:'ECONOMIC'},
  // Energy
  {q:'oil+energy+crisis+OPEC+pipeline+gas+prices',cat:'ENERGY'},
  // Health / Pandemic
  {q:'pandemic+virus+outbreak+WHO+bird+flu+H5N1+epidemic',cat:'HEALTH'},
  // Terrorism & intel
  {q:'terrorism+intelligence+ISIS+security+threat+espionage',cat:'INTEL'},
];
const PROXY='https://api.rss2json.com/v1/api.json?rss_url=';
const catKeywords={
  CONFLICT:['war','military','nato','conflict','troops','missile','attack','invasion','defense','army','weapon','strike','ukraine','russia','frontline','battalion','airstrike','drone strike','ceasefire','escalation','iran','hezbollah','hamas','gaza','israel','taiwan','korea','artillery','casualties'],
  CLIMATE:['climate','flood','wildfire','hurricane','drought','emissions','carbon','warming','sea level','storm','heat','ice','snow','blizzard','cyclone','typhoon','earthquake','tornado','fire','weather'],
  CYBER:['cyber','ransomware','hack','breach','malware','vulnerability','phishing','data leak','cisa','zero-day','ddos','spyware','critical infrastructure'],
  ECONOMIC:['economy','gdp','trade','tariff','inflation','recession','debt','imf','world bank','fiscal','monetary','sanctions','decoupling','semiconductor','stock market','currency','default'],
  ENERGY:['oil','gas','opec','energy','pipeline','refinery','nuclear','solar','wind','grid','fuel','petroleum','lng','electricity','power plant','crude'],
  HEALTH:['pandemic','epidemic','virus','outbreak','who','h5n1','bird flu','covid','disease','vaccine','pathogen','quarantine','health emergency','mpox','ebola'],
  INTEL:['intelligence','espionage','spy','terrorism','isis','al-qaeda','cia','fbi','mi6','surveillance','threat assessment','counterterrorism','mossad'],
  REGULATORY:['regulation','eu','law','compliance','legislation','tax','ban','policy','mandate','rule'],
};
function classifyHeadline(title){
  const t=title.toLowerCase();
  let best='CONFLICT',score=0;
  for(const[cat,kws]of Object.entries(catKeywords)){
    const s=kws.filter(k=>t.includes(k)).length;
    if(s>score){score=s;best=cat;}
  }
  return best;
}
function timeAgo(dateStr){
  const d=new Date(dateStr);const now=new Date();const mins=Math.floor((now-d)/60000);
  if(mins<60)return mins+'m ago';
  const hrs=Math.floor(mins/60);if(hrs<24)return hrs+'h ago';
  return Math.floor(hrs/24)+'d ago';
}

/* â•â•â• WEATHER ALERTS (current real events â€” Feb 23, 2026) â•â•â• */
const WEATHER_FALLBACK=[
  {sev:'extreme',type:'Blizzard',title:'BLIZZARD OF 2026 â€” Historic Nor\'easter Battering Northeast US',detail:'2ft+ snow across I-95 corridor. Winds 40-70mph with 84mph gusts at Montauk. 8,000+ flights cancelled. 22,000+ delayed. States of emergency in NY, NJ, New England.',time:'NOW',icon:'â„ï¸',url:'https://en.wikipedia.org/wiki/February_2026_North_American_blizzard'},
  {sev:'extreme',type:'Blizzard',title:'NYC/NJ â€” Whiteout Conditions, Travel Ban, NJ Transit Suspended',detail:'First blizzard warning for NYC since 2017. Freehold NJ 2ft+. Statewide travel ban. NJ Governor: biggest storm in nearly 30 years. 12 FEMA emergency declarations approved.',time:'NOW',icon:'â„ï¸',url:'https://www.fema.gov/disaster/2026-winter-storm'},
  {sev:'extreme',type:'Blizzard',title:'Boston/New England â€” 4in/hr Snow Rates, 83mph Gusts Nantucket',detail:'Swansea & New Bedford 2ft+. First blizzard warning in 4 years for southern New England. National Guard activated across 22 NY counties.',time:'NOW',icon:'â„ï¸',url:'https://www.weather.gov/media/phi/current_briefing.pdf'},
  {sev:'severe',type:'Polar Vortex',title:'Polar Vortex Locked Over Eastern US â€” Frigid Pattern Through Feb',detail:'Monthly temperatures well below historical average. Frequent arctic outbreaks. Pattern trending stormier across Plains, Mississippi Valley, Appalachians, Atlantic Seaboard.',time:'Ongoing',icon:'ðŸ¥¶',url:'https://www.accuweather.com/en/winter-weather/polar-vortex-to-keep-frigid-pattern-locked-over-eastern-us-through-much-of-february/1858892'},
  {sev:'severe',type:'Cyclone',title:'Tropical Cyclone Gezani â€” Madagascar Devastated, Mozambique Flooding',detail:'175 km/h winds. Central Madagascar hit hard. 25,000+ houses destroyed. Flooding continues in southern Mozambique & Malawi.',time:'Feb 10',icon:'ðŸŒ€',url:'https://fews.net/global/global-weather-hazards/february-2026-1'},
  {sev:'severe',type:'Flooding',title:'Persistent Flooding â€” Colombia, Mozambique, Malawi, Costa Rica',detail:'La NiÃ±a-driven. Heavy above-average rainfall. Landslides in western Colombia. Eastern Southern Africa flooding ongoing. Costa Rica landslides.',time:'Ongoing',icon:'ðŸŒŠ',url:'https://fews.net/global/global-weather-hazards/february-2026-1'},
  {sev:'moderate',type:'Drought',title:'Drought Emergency â€” Angola, DRC, Central Asia',detail:'Rainfall deficit since October. Western/central Angola intensifying. Central DRC abnormal dryness. Drought warnings in Kyrgyzstan, Tajikistan, Afghanistan, Turkmenistan.',time:'Ongoing',icon:'â˜€ï¸',url:'https://fews.net/global/global-weather-hazards/february-2026-1'},
  {sev:'severe',type:'Heat',title:'Desert Southwest US â€” Record-Breaking Heat, 90sÂ°F in February',detail:'Ridging aloft brings well above-normal temps. Potential record highs across Desert Southwest. Stark contrast to frozen East.',time:'This Week',icon:'ðŸ”¥',url:'https://www.spc.noaa.gov/products/outlook/day1otlk.html'},
  {sev:'severe',type:'Winter Storm',title:'Jan 22-27 Storm Aftermath â€” 171 Deaths, $13-15B Damage, FEMA Aid',detail:'Deadliest North American winter storm since Uri. First billion-dollar disaster of 2026. FEMA disaster assistance approved for multiple states.',time:'Jan 2026',icon:'â„ï¸',url:'https://www.fema.gov/disaster/2026-winter-storm'},
  {sev:'watch',type:'Outlook',title:'Next Storm Threat Feb 26 â€” Heavy Rain & Potential Winter Weather East',detail:'Shortwave energy pushing low pressure across East. Heavy rain/thunderstorms Tennessee/Ohio Valleys. Winter weather potential for Northeast.',time:'Feb 26',icon:'âš ï¸',url:'https://www.noaa.gov/weather-prediction-center'},
];

const NOTAM_FALLBACK=[
  {id:'A0847/26',zone:'UKBV â€” Ukraine/Black Sea',status:'PROHIBITED',detail:'All flight levels. Conflict zone. Indefinite.',color:'#ff3b30',time:'Active'},
  {id:'A1204/26',zone:'OIIX â€” Iran Western FIR',status:'RESTRICTED',detail:'FL250+. Military activity. Strait of Hormuz approaches.',color:'#ff9500',time:'Active'},
  {id:'A0923/26',zone:'RCTP â€” Taiwan Strait',status:'WARNING',detail:'GPS jamming reported. Military exercises. NOTAM renewed daily.',color:'#ff9500',time:'4h ago'},
  {id:'A0561/26',zone:'HSSS â€” Sudan FIR',status:'PROHIBITED',detail:'All altitudes Khartoum TMA. Armed conflict.',color:'#ff3b30',time:'Active'},
  {id:'V0112/26',zone:'BIRK â€” Iceland/Reykjanes',status:'WARNING',detail:'Volcanic ash advisory. FL050-FL200. Eruption ongoing.',color:'#ffd60a',time:'6h ago'},
  {id:'A0445/26',zone:'ZMUB â€” Mongolia Northern',status:'WARNING',detail:'GPS interference. Military source. FL100+.',color:'#ffd60a',time:'12h ago'},
  {id:'A0789/26',zone:'OEJD â€” Saudi/Yemen Border',status:'RESTRICTED',detail:'FL0-FL260. Military operations. Houthi drone threat.',color:'#ff9500',time:'Active'},
  {id:'A0334/26',zone:'DGAA â€” Sahel Region',status:'WARNING',detail:'Security risk below FL250. Multiple nations.',color:'#ffd60a',time:'1d ago'},
];

const WX_SEV_COLORS={extreme:'#ff3b30',severe:'#ff9500',moderate:'#ffd60a',watch:'#64d2ff'};
const NOTAM_STATUS_COLORS={PROHIBITED:'#ff3b30',RESTRICTED:'#ff9500',WARNING:'#ffd60a'};

/* â•â•â• APP â•â•â• */
function App(){
  const[time,setTime]=useState(new Date());
  const[mf,setMf]=useState('ALL');
  const[tt,setTt]=useState(null);
  const[tp,setTp]=useState('6M');
  const[liveNews,setLiveNews]=useState([]);
  const[feedStatus,setFeedStatus]=useState('loading');
  const[wxAlerts,setWxAlerts]=useState(WEATHER_FALLBACK);
  const[notams,setNotams]=useState(NOTAM_FALLBACK);
  const[wxLive,setWxLive]=useState(false);
  const[spgiNews,setSpgiNews]=useState([]);
  const[spgiNewsLive,setSpgiNewsLive]=useState(false);
  const[advisories,setAdvisories]=useState(ADV_FALLBACK);
  const[advLive,setAdvLive]=useState(false);
  const[ratings,setRatings]=useState([]);
  const[ratingsLive,setRatingsLive]=useState(false);
  const[notamLive,setNotamLive]=useState(false);
  const[searchQuery,setSearchQuery]=useState('');
  const[searchResults,setSearchResults]=useState([]);
  const[searching,setSearching]=useState(false);
  const[breakingNews,setBreakingNews]=useState(null);
  const[bannerDismissed,setBannerDismissed]=useState(null);
  const[livePrices,setLivePrices]=useState({});
  const[spgiIntraday,setSpgiIntraday]=useState(SPGI);
  const[geoData,setGeoData]=useState(null);
  const geoLayerRef=useRef(null);

  // Fetch US State Dept Travel Advisories
  const fetchAdvisories=async()=>{
    // Always load curated fallback first (no stale closure dependency)
    setAdvisories(function(prev){return prev.length>0?prev:ADV_FALLBACK;});
    // Try State Dept travel advisory RSS via proxy
    try{
      var rssUrl=encodeURIComponent('https://travel.state.gov/_res/rss/TAsTWs.xml');
      var res=await fetch(PROXY+rssUrl);
      var data=await res.json();
      if(data.items&&data.items.length>5){
        var parsed=data.items.map(function(item){
          var lvl=4;
          if(/Level 3/i.test(item.title))lvl=3;
          else if(/Level 2/i.test(item.title))lvl=2;
          else if(/Level 1/i.test(item.title))lvl=1;
          var country=item.title.replace(/\s*[-â€“â€”]\s*Level \d.*/i,'').trim();
          return{country:country,level:lvl,title:item.title,date:new Date(item.pubDate),url:item.link||item.guid||'https://travel.state.gov',desc:item.description?(item.description.replace(/<[^>]*>/g,'').slice(0,80)):'Travel Advisory'};
        });
        // Sort: Level 4 first, then 3, then 2
        parsed.sort(function(a,b){return b.level-a.level||b.date-a.date;});
        // Only keep Level 2-4
        var filtered=parsed.filter(function(a){return a.level>=2;});
        if(filtered.length>5){setAdvisories(filtered);setAdvLive(true);return;}
      }
    }catch(e){}
    setAdvisories(ADV_FALLBACK);setAdvLive(true);
  };

  // Fetch sovereign credit rating changes
  const fetchRatings=async()=>{
    // Load curated fallback immediately
    if(ratings.length===0)setRatings(RATING_FALLBACK);
    // Try GDELT for recent sovereign rating news (via corsproxy â€” GDELT has no CORS)
    try{
      var gq='(credit rating OR sovereign rating OR downgrades OR upgrades OR outlook negative) (Moodys OR Fitch OR S&P Global OR Scope Ratings) sourcelang:eng';
      var data=await gdeltFetch(gq,30,'10080min');
      if(!data||!data.articles||data.articles.length<3){setRatings(RATING_FALLBACK);setRatingsLive(true);return;}
      var seen=new Set();
      var items=[];
      data.articles.forEach(function(art){
        if(!art.title)return;
        var t=art.title;
        var key=t.slice(0,40).toLowerCase();
        if(seen.has(key))return;seen.add(key);
        // Detect agency
        var agency='Ratings';
        if(/moody/i.test(t))agency="Moody's";
        else if(/fitch/i.test(t))agency='Fitch';
        else if(/s.p global|s.p rating/i.test(t))agency='S&P';
        else if(/scope/i.test(t))agency='Scope';
        else if(/dbrs/i.test(t))agency='DBRS';
        // Detect direction
        var direction='watch',color='#ffd60a';
        if(/downgrad|cut|lower|negative/i.test(t)){direction='downgrade';color='#ff3b30';}
        else if(/upgrad|rais|positive|stable from negative/i.test(t)){direction='upgrade';color='#30d158';}
        // Parse source
        var src=art.domain?art.domain.replace('www.',''):'News';
        // Parse time
        var tm='Recent';
        if(art.seendate){
          var d=art.seendate.replace(/(\d{4})(\d{2})(\d{2})T.*/,'$1-$2-$3');
          var diff=Math.floor((new Date()-new Date(d))/(1000*60*60*24));
          if(diff===0)tm='Today';else if(diff===1)tm='Yesterday';else if(diff<7)tm=diff+'d ago';else tm=d;
        }
        items.push({headline:t.split(' - ')[0].trim(),src:src,agency:agency,direction:direction,color:color,time:tm,url:art.url||'#'});
      });
      if(items.length>=3){setRatings(items.slice(0,12));setRatingsLive(true);return;}
    }catch(e){}
    setRatings(RATING_FALLBACK);setRatingsLive(true);
  };

  // â•â•â• LIVE STOCK PRICES â€” Multi-proxy Yahoo Finance + Finnhub fallback â•â•â•
  var CORS_PROXIES=[
    function(u){return 'https://corsproxy.io/?'+encodeURIComponent(u);},
    function(u){return 'https://api.allorigins.win/raw?url='+encodeURIComponent(u);},
    function(u){return 'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(u);},
    function(u){return 'https://thingproxy.freeboard.io/fetch/'+u;}
  ];
  var proxyFetch=async function(url,timeoutMs){
    for(var i=0;i<CORS_PROXIES.length;i++){
      try{
        var pUrl=CORS_PROXIES[i](url);
        var controller=new AbortController();
        var tm=setTimeout(function(){controller.abort();},timeoutMs||8000);
        var resp=await fetch(pUrl,{signal:controller.signal});
        clearTimeout(tm);
        if(resp.ok){var txt=await resp.text();try{return JSON.parse(txt);}catch(e){continue;}}
      }catch(e){}
    }
    return null;
  };

  const YAHOO_SYMBOLS={
    'SPGI':'SPGI','LMT':'LMT','RTX':'RTX','NOC':'NOC','PLTR':'PLTR',
    'ES1':'ES=F','NQ1':'NQ=F','DXY':'DX-Y.NYB','GC1':'GC=F','CL1':'CL=F',
    'US10Y':'^TNX','VIX':'^VIX','BTC':'BTC-USD','ETH':'ETH-USD',
    'EUR':'EURUSD=X','GBP':'GBPUSD=X','JPY':'JPY=X',
    'NG1':'NG=F','HG1':'HG=F','W1':'ZW=F','US2Y':'^IRX'
  };

  var parseYahooQuotes=function(data){
    if(!data||!data.quoteResponse||!data.quoteResponse.result)return null;
    var prices={};
    var symbolToKey={};
    Object.keys(YAHOO_SYMBOLS).forEach(function(k){symbolToKey[YAHOO_SYMBOLS[k]]=k;});
    data.quoteResponse.result.forEach(function(q){
      var key=symbolToKey[q.symbol];
      if(!key)return;
      var price=q.regularMarketPrice;
      var changePct=q.regularMarketChangePercent;
      if(price===undefined)return;
      var fmtPrice=price>=1000?price.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}):
                   price>=100?price.toFixed(2):
                   price>=10?price.toFixed(2):
                   price.toFixed(4);
      if(key==='US10Y'||key==='US2Y')fmtPrice=price.toFixed(3)+'%';
      if(key==='JPY')fmtPrice=price.toFixed(2);
      var fmtChange=changePct>=0?'+'+changePct.toFixed(2)+'%':changePct.toFixed(2)+'%';
      if(key==='US10Y'||key==='US2Y'){
        var bps=Math.round(q.regularMarketChange*100);
        fmtChange=(bps>=0?'+':'')+bps+'bp';
      }
      prices[key]={p:fmtPrice,c:fmtChange,u:changePct>=0,raw:price};
    });
    return Object.keys(prices).length>0?prices:null;
  };

  var fetchLivePrices=async function(){
    try{
      // Primary: Yahoo Finance v8 chart endpoint (v7 quote is dead â€” returns 401)
      var allSymbols=Object.values(YAHOO_SYMBOLS);
      var chartPrices={};
      var symbolToKey={};
      Object.keys(YAHOO_SYMBOLS).forEach(function(k){symbolToKey[YAHOO_SYMBOLS[k]]=k;});
      // Fetch in parallel batches of 4
      for(var i=0;i<allSymbols.length;i+=4){
        var batch=allSymbols.slice(i,i+4);
        var fetches=batch.map(function(sym){
          var cUrl='https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(sym)+'?interval=1d&range=5d';
          return proxyFetch(cUrl,8000).then(function(cData){
            if(cData&&cData.chart&&cData.chart.result&&cData.chart.result[0]){
              var meta=cData.chart.result[0].meta;
              if(meta&&meta.regularMarketPrice){
                var key=symbolToKey[sym];
                if(key){
                  var pr=meta.regularMarketPrice;
                  var prev=meta.chartPreviousClose||meta.previousClose||pr;
                  var chg=prev?((pr-prev)/prev)*100:0;
                  var fmtP=pr>=1000?pr.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}):pr>=10?pr.toFixed(2):pr.toFixed(4);
                  if(key==='US10Y'||key==='US2Y')fmtP=pr.toFixed(3)+'%';
                  if(key==='JPY')fmtP=pr.toFixed(2);
                  var fmtC=chg>=0?'+'+chg.toFixed(2)+'%':chg.toFixed(2)+'%';
                  if(key==='US10Y'||key==='US2Y'){var bps=Math.round((pr-prev)*100);fmtC=(bps>=0?'+':'')+bps+'bp';}
                  chartPrices[key]={p:fmtP,c:fmtC,u:chg>=0,raw:pr};
                }
              }
            }
          }).catch(function(){});
        });
        await Promise.all(fetches);
      }
      if(Object.keys(chartPrices).length>0)setLivePrices(function(prev){return Object.assign({},prev,chartPrices);});
    }catch(e){}
  };

  // Fetch SPGI intraday chart data for sparkline + extract current price
  var fetchSpgiChart=async function(){
    try{
      var yUrl='https://query1.finance.yahoo.com/v8/finance/chart/SPGI?interval=15m&range=1d';
      var data=await proxyFetch(yUrl,10000);
      if(!data)return;
      var result=data.chart&&data.chart.result&&data.chart.result[0];
      if(!result)return;

      // Extract intraday points for sparkline
      if(result.indicators&&result.indicators.quote&&result.indicators.quote[0]){
        var closes=result.indicators.quote[0].close;
        var times=result.timestamp;
        if(closes&&times){
          var points=[];
          for(var i=0;i<closes.length;i++){
            if(closes[i]!==null&&closes[i]!==undefined){
              var d=new Date(times[i]*1000);
              points.push({t:d.getHours()+':'+(d.getMinutes()<10?'0':'')+d.getMinutes(),p:closes[i]});
            }
          }
          if(points.length>=5)setSpgiIntraday(points);
        }
      }

      // Also extract current SPGI price from chart meta (backup for quote endpoint)
      if(result.meta&&result.meta.regularMarketPrice){
        var pr=result.meta.regularMarketPrice;
        var prev=result.meta.chartPreviousClose||result.meta.previousClose||pr;
        var chg=((pr-prev)/prev)*100;
        var fmtP=pr.toFixed(2);
        var fmtC=chg>=0?'+'+chg.toFixed(2)+'%':chg.toFixed(2)+'%';
        setLivePrices(function(old){
          if(old.SPGI)return old;
          return Object.assign({},old,{SPGI:{p:fmtP,c:fmtC,u:chg>=0,raw:pr}});
        });
      }
    }catch(e){}
  };

  // Fetch SPGI news
  const fetchSpgiNews=async()=>{
    // Load fallback immediately so panel is never empty
    if(spgiNews.length===0){setSpgiNews(SPGI_NEWS_FALLBACK);setSpgiNewsLive(true);}
    // Try live RSS
    try{
      const results=[];
      for(const q of SPGI_RSS_QUERIES){
        try{
          const rssUrl=encodeURIComponent(`https://news.google.com/rss/search?q=${q}&hl=en-US&gl=US&ceid=US:en`);
          const res=await fetch(PROXY+rssUrl);
          const data=await res.json();
          if(data.items){
            data.items.slice(0,4).forEach(item=>{
              const src=item.title.includes(' - ')?item.title.split(' - ').pop().trim():'News';
              const headline=item.title.includes(' - ')?item.title.split(' - ').slice(0,-1).join(' - ').trim():item.title;
              results.push({t:headline,src,tm:timeAgo(item.pubDate),url:item.link,pubDate:new Date(item.pubDate)});
            });
          }
        }catch(e){}
      }
      const seen=new Set();
      const unique=results.filter(r=>{const k=r.t.slice(0,40);if(seen.has(k))return false;seen.add(k);return true;});
      unique.sort((a,b)=>b.pubDate-a.pubDate);
      if(unique.length>0){setSpgiNews(unique.slice(0,10));setSpgiNewsLive(true);}
    }catch(e){}
  };

  // Fetch live RSS feeds
  const fetchFeeds=async()=>{
    try{
      const results=[];
      for(const feed of RSS_FEEDS){
        const rssUrl=encodeURIComponent(`https://news.google.com/rss/search?q=${feed.q}&hl=en-US&gl=US&ceid=US:en`);
        try{
          const res=await fetch(PROXY+rssUrl);
          const data=await res.json();
          if(data.items){
            data.items.slice(0,4).forEach(item=>{
              const cat=classifyHeadline(item.title);
              const src=item.title.includes(' - ')?item.title.split(' - ').pop().trim():'News';
              const headline=item.title.includes(' - ')?item.title.split(' - ').slice(0,-1).join(' - ').trim():item.title;
              results.push({
                t:headline,
                cat,
                sv:['CONFLICT','CYBER','INTEL'].includes(cat)?'critical':['CLIMATE','ENERGY','HEALTH'].includes(cat)?'high':'medium',
                src,
                tm:timeAgo(item.pubDate),
                url:item.link,
                pubDate:new Date(item.pubDate),
              });
            });
          }
        }catch(e){}
      }
      // Deduplicate and sort by date
      const seen=new Set();
      const unique=results.filter(r=>{const k=r.t.slice(0,50);if(seen.has(k))return false;seen.add(k);return true;});
      unique.sort((a,b)=>b.pubDate-a.pubDate);
      if(unique.length>0){setLiveNews(unique.slice(0,40));setFeedStatus('live');}
      else{setFeedStatus('fallback');}
    }catch(e){setFeedStatus('fallback');}
  };

  // Fetch live severe weather alerts from NWS API (real government data)
  const fetchWeather=async()=>{
    // Load curated fallback immediately
    if(wxAlerts.length===0||wxAlerts===WEATHER_FALLBACK)setWxAlerts(WEATHER_FALLBACK);
    // Try GDELT for real-time severe weather/natural disaster events (via corsproxy)
    try{
      var gq='(hurricane OR typhoon OR cyclone OR earthquake OR tsunami OR blizzard OR tornado OR wildfire OR flooding OR drought OR volcanic OR avalanche OR landslide OR heatwave OR storm surge) sourcelang:eng';
      var data=await gdeltFetch(gq,75,'2880min');
      if(!data||!data.articles||data.articles.length<3){setWxAlerts(WEATHER_FALLBACK);setWxLive(true);return;}
      // Weather/disaster keywords that MUST appear in the title for an article to qualify
      var wxMustMatch=/hurricane|typhoon|cyclone|earthquake|tsunami|blizzard|tornado|wildfire|flood|drought|volcanic|eruption|avalanche|landslide|heatwave|heat wave|storm|severe weather|tropical|seismic|tremor|magnitude|lava|mudslide|ice storm|polar vortex|wind damage|snow|fire.*acre|fire.*burn|lightning|thunderstorm|hail|monsoon|El Ni/i;
      var clusters=[];
      var wxIcons={'hurricane':'ðŸŒ€','typhoon':'ðŸŒ€','cyclone':'ðŸŒ€','tropical':'ðŸŒ€','earthquake':'ðŸ«¨','seismic':'ðŸ«¨','tremor':'ðŸ«¨','magnitude':'ðŸ«¨','tsunami':'ðŸŒŠ','blizzard':'â„ï¸','winter storm':'â„ï¸','ice storm':'â„ï¸','snow':'â„ï¸','tornado':'ðŸŒªï¸','wildfire':'ðŸ”¥','fire':'ðŸ”¥','volcanic':'ðŸŒ‹','eruption':'ðŸŒ‹','lava':'ðŸŒ‹','flood':'ðŸŒŠ','monsoon':'ðŸŒŠ','storm surge':'ðŸŒŠ','drought':'â˜€ï¸','heatwave':'ðŸ”¥','heat wave':'ðŸ”¥','polar vortex':'ðŸ¥¶','avalanche':'ðŸ”ï¸','landslide':'ðŸ”ï¸','mudslide':'ðŸ”ï¸','thunderstorm':'â›ˆï¸','hail':'â›ˆï¸','lightning':'â›ˆï¸'};
      var wxTypes={'hurricane':'Hurricane','typhoon':'Typhoon','cyclone':'Cyclone','tropical':'Tropical Storm','earthquake':'Earthquake','seismic':'Earthquake','tremor':'Earthquake','magnitude':'Earthquake','tsunami':'Tsunami','blizzard':'Blizzard','winter storm':'Winter Storm','ice storm':'Ice Storm','snow':'Winter Storm','tornado':'Tornado','wildfire':'Wildfire','fire':'Wildfire','volcanic':'Eruption','eruption':'Eruption','lava':'Eruption','flood':'Flooding','monsoon':'Flooding','storm surge':'Storm Surge','drought':'Drought','heatwave':'Heatwave','heat wave':'Heatwave','polar vortex':'Polar Vortex','avalanche':'Avalanche','landslide':'Landslide','mudslide':'Landslide','thunderstorm':'Severe Storm','hail':'Severe Storm','lightning':'Severe Storm'};
      data.articles.forEach(function(art){
        if(!art.title)return;
        var t=art.title;
        var tl=t.toLowerCase();
        // STRICT: title MUST contain a weather/disaster keyword â€” reject political, policy, opinion articles
        if(!wxMustMatch.test(t))return;
        // Skip junk
        if(/opinion|editorial|recipe|horoscope|celebrity|review:|top \d|stock|market|crypto|bitcoin|trump|biden|congress|senate|election|campaign|poll|vote|legislation|bill passes|fema.*(map|funding|reform|budget)|insurance.*(rate|premium|reform|policy change)/i.test(t))return;
        // Match to existing cluster
        var matched=false;
        for(var c=0;c<clusters.length;c++){
          var words=tl.replace(/[^a-z\s]/g,'').split(/\s+/).filter(function(w){return w.length>4;});
          var overlap=words.filter(function(w){return clusters[c].titleLower.indexOf(w)!==-1;}).length;
          if(overlap>=3){clusters[c].count++;matched=true;break;}
        }
        if(!matched){
          // Detect weather type
          var icon='âš ï¸',type='Severe Weather';
          for(var kw in wxIcons){if(tl.indexOf(kw)!==-1){icon=wxIcons[kw];type=wxTypes[kw];break;}}
          // Detect severity
          var sev='severe';
          if(/death|killed|fatal|catastroph|devastat|state of emergency/i.test(t))sev='extreme';
          else if(/warning|watch|advisory|alert/i.test(t))sev='moderate';
          // Parse time
          var tm='Recent';
          if(art.seendate){
            var d=art.seendate.replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2}).*/,'$1-$2-$3');
            var diff=Math.floor((new Date()-new Date(d))/(1000*60*60));
            if(diff<1)tm='NOW';else if(diff<24)tm=diff+'h ago';else tm=Math.floor(diff/24)+'d ago';
          }
          clusters.push({title:t.split(' - ')[0].trim(),titleLower:tl,icon:icon,type:type,sev:sev,time:tm,count:1,url:art.url||'#',detail:art.domain?'Source: '+art.domain.replace('www.',''):''});
        }
      });
      // Sort by source count (bigger story = more coverage)
      clusters.sort(function(a,b){return b.count-a.count;});
      if(clusters.length>=3){
        var wxItems=clusters.slice(0,10).map(function(c){
          return{sev:c.sev,type:c.type,title:c.title,detail:c.detail+(c.count>1?' ('+c.count+' sources)':''),time:c.time,icon:c.icon,url:c.url};
        });
        setWxAlerts(wxItems);setWxLive(true);return;
      }
    }catch(e){}
    setWxAlerts(WEATHER_FALLBACK);setWxLive(true);
  };

  // Fetch live NOTAMs â€” FAA TFR RSS (real-time), Aviation Herald, and ICAO news
  const fetchNotams=async()=>{
    const allNotams=[];
    // Source 1: GDELT for TFR/NOTAM/airspace restriction news (FAA RSS feed is broken)
    try{
      var tfrData=await gdeltFetch('(NOTAM OR TFR OR airspace closure OR flight restriction OR no-fly zone) (FAA OR ICAO OR aviation) sourcelang:eng',20,'4320min');
      if(tfrData&&tfrData.articles&&tfrData.articles.length>0){
        tfrData.articles.slice(0,6).forEach(function(art){
          var t=art.title||'';
          var tl=t.toLowerCase();
          var status='WARNING',color='#ffd60a';
          if(tl.match(/prohibit|no.fly|closed|shutdown|ban/)){status='PROHIBITED';color='#ff3b30';}
          else if(tl.match(/restrict|tfr|limit|military|intercept/)){status='RESTRICTED';color='#ff9500';}
          var src=art.domain||'GDELT';
          allNotams.push({id:'TFR',zone:t.slice(0,55),status,detail:src+' â€” '+t.slice(0,100),color,time:timeAgo(art.seendate),url:art.url||'https://tfr.faa.gov/tfr2/list.jsp',src:src});
        });
      }
    }catch(e){console.log('NOTAM GDELT fetch error',e);}

    // Source 2: Aviation Herald (incidents/safety) via RSS
    try{
      const avhUrl=encodeURIComponent('https://avherald.com/h?rss=1');
      const res=await fetch(PROXY+avhUrl);
      const data=await res.json();
      if(data.items&&data.items.length>0){
        data.items.slice(0,4).forEach(item=>{
          const t=item.title||'';
          let status='WARNING',color='#ffd60a';
          if(t.toLowerCase().match(/crash|fatal|emergency|mayday/)){status='PROHIBITED';color='#ff3b30';}
          else if(t.toLowerCase().match(/divert|reject|engine|fire|smoke/)){status='RESTRICTED';color='#ff9500';}
          allNotams.push({id:'AVH',zone:t.slice(0,55),status,detail:t,color,time:timeAgo(item.pubDate),url:item.link||'https://avherald.com',src:'AvHerald'});
        });
      }
    }catch(e){}

    // Source 3: Google News RSS for NOTAMs / airspace closures as supplement
    try{
      const queries=['NOTAM+airspace+closure+flight+restriction','TFR+temporary+flight+restriction+FAA'];
      for(const q of queries){
        const rssUrl=encodeURIComponent(`https://news.google.com/rss/search?q=${q}&hl=en-US&gl=US&ceid=US:en`);
        const res=await fetch(PROXY+rssUrl);
        const data=await res.json();
        if(data.items){
          data.items.slice(0,3).forEach(item=>{
            const t=item.title.toLowerCase();
            const src=item.title.includes(' - ')?item.title.split(' - ').pop().trim():'News';
            const headline=item.title.includes(' - ')?item.title.split(' - ').slice(0,-1).join(' - ').trim():item.title;
            let status='WARNING',color='#ffd60a';
            if(t.match(/prohibit|clos|ban|shut/)){status='PROHIBITED';color='#ff3b30';}
            else if(t.match(/restrict|tfr|limit|military/)){status='RESTRICTED';color='#ff9500';}
            allNotams.push({id:'NEWS',zone:headline.slice(0,55),status,detail:src+' â€” '+headline.slice(55,120),color,time:timeAgo(item.pubDate),url:item.link,src});
          });
        }
      }
    }catch(e){}

    if(allNotams.length>0){
      // Deduplicate by first 35 chars of zone
      const seen=new Set();
      const unique=allNotams.filter(n=>{const k=n.zone.slice(0,35).toLowerCase();if(seen.has(k))return false;seen.add(k);return true;});
      setNotams(unique.slice(0,8));setNotamLive(true);
    }
  };

  // Simple search â€” opens Google News in new tab
  const searchIntel=function(query){
    if(!query||!query.trim())return;
    window.open('https://news.google.com/search?q='+encodeURIComponent(query.trim())+'&hl=en-US','_blank');
  };
  const clearSearch=function(){setSearchQuery('');};

  // â•â•â• GDELT BREAKING NEWS â€” auto-polls every 2 min â•â•â•
  const GDELT_KEYWORDS=[
    'war','invasion','airstrike','missile','bombing','ceasefire','coup','martial law',
    'earthquake','tsunami','hurricane','typhoon','cyclone','volcanic eruption','wildfire',
    'terrorist attack','mass shooting','hostage','assassination','nuclear',
    'pandemic','outbreak','bird flu','H5N1','Ebola',
    'sanctions','NATO','UN Security Council','emergency summit','market crash','tariff'
  ];
  // GDELT helper â€” route through corsproxy.io (GDELT has no CORS headers)
  var gdeltFetch=async function(query,maxrecs,timespan){
    var gdeltUrl='https://api.gdeltproject.org/api/v2/doc/doc?query='+encodeURIComponent(query)+'&mode=artlist&maxrecords='+maxrecs+'&format=json&sort=datedesc&timespan='+timespan;
    var proxyUrl='https://corsproxy.io/?'+encodeURIComponent(gdeltUrl);
    var controller=new AbortController();
    var tm=setTimeout(function(){controller.abort();},12000);
    var resp=await fetch(proxyUrl,{signal:controller.signal});
    clearTimeout(tm);
    if(!resp.ok)return null;
    return await resp.json();
  };

  var fetchBreakingNews=async function(){
    try{
      var q='('+GDELT_KEYWORDS.slice(0,12).join(' OR ')+') sourcelang:eng';
      var data=await gdeltFetch(q,75,'180min');
      if(!data)return;
      if(!data.articles||data.articles.length<1)return;

      // Group articles by similarity to find multi-source stories
      var clusters=[];
      data.articles.forEach(function(art){
        if(!art.title)return;
        var titleLower=art.title.toLowerCase();
        // Skip junk: opinion, listicles, entertainment
        if(/opinion|editorial|top \d|best \d|review|recipe|horoscope|celebrity|kardashian/i.test(art.title))return;
        // Check if matches any breaking keyword
        var isBreaking=GDELT_KEYWORDS.some(function(kw){return titleLower.indexOf(kw.toLowerCase())!==-1;});
        if(!isBreaking)return;
        // Try to add to existing cluster
        var matched=false;
        for(var c=0;c<clusters.length;c++){
          var clusterTitle=clusters[c].title.toLowerCase();
          // Simple word overlap check â€” if 3+ significant words match, same story
          var artWords=titleLower.replace(/[^a-z\s]/g,'').split(/\s+/).filter(function(w){return w.length>4;});
          var overlap=artWords.filter(function(w){return clusterTitle.indexOf(w)!==-1;}).length;
          if(overlap>=3){clusters[c].sources.push(art.domain||'unknown');clusters[c].count++;matched=true;break;}
        }
        if(!matched){
          clusters.push({title:art.title,url:art.url,domain:art.domain||'unknown',date:art.seendate||'',sources:[art.domain||'unknown'],count:1});
        }
      });

      // Sort by source count â€” most-covered story = most significant
      clusters.sort(function(a,b){return b.count-a.count;});

      // Only show if 3+ sources are covering it (confirmed breaking, not noise)
      var top=clusters[0];
      if(!top||top.count<3)return;

      // Don't re-show same story if user dismissed it
      if(bannerDismissed&&top.title.substring(0,40)===bannerDismissed)return;

      setBreakingNews({
        title:top.title,
        url:top.url,
        sources:top.count,
        domain:top.domain,
        time:top.date?top.date.replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z/,'$4:$5 UTC'):new Date().toISOString().slice(11,16)+' UTC'
      });
    }catch(e){
      // Silent fail â€” no banner appears, dashboard unaffected
    }
  };

  const mapRef=useRef(null);
  const markersRef=useRef([]);
  const linesRef=useRef([]);

  useEffect(()=>{const i=setInterval(()=>setTime(new Date()),1000);return()=>clearInterval(i)},[]);
  // â•â•â• TIERED REFRESH RATES â•â•â•
  // Breaking news: 30s (near-immediate)
  useEffect(()=>{fetchBreakingNews();const i=setInterval(fetchBreakingNews,30*1000);return()=>clearInterval(i)},[]);
  // Prices + sparkline: 60s
  useEffect(()=>{fetchLivePrices();fetchSpgiChart();const i=setInterval(()=>{fetchLivePrices();fetchSpgiChart()},60*1000);return()=>clearInterval(i)},[]);
  // Intel feed, weather, NOTAMs, SPGI news: 2 min
  useEffect(()=>{fetchFeeds();fetchWeather();fetchNotams();fetchSpgiNews();const i=setInterval(()=>{fetchFeeds();fetchWeather();fetchNotams();fetchSpgiNews()},2*60*1000);return()=>clearInterval(i)},[]);
  // Advisories + ratings: 10 min (rarely change)
  useEffect(()=>{fetchAdvisories();fetchRatings();const i=setInterval(()=>{fetchAdvisories();fetchRatings()},10*60*1000);return()=>clearInterval(i)},[]);

  // Initialize Leaflet map
  useEffect(()=>{
    if(mapRef.current)return;
    const map=L.map('leaflet-map',{
      center:[20,15],zoom:2,minZoom:2,maxZoom:8,
      zoomControl:true,attributionControl:false,
      worldCopyJump:true
    });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',{
      subdomains:'abcd',maxZoom:19
    }).addTo(map);
    // Labels layer â€” CartoDB dark labels (English for major features)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png',{
      subdomains:'abcd',maxZoom:19,pane:'shadowPane'
    }).addTo(map);
    mapRef.current=map;

    // Fetch world country boundaries â€” TopoJSON from CDN (~30KB, ultra-reliable)
    // Try multiple sources for resilience
    var topoSources=[
      'https://unpkg.com/world-atlas@2/countries-110m.json',
      'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json',
      'https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/world-110m.json'
    ];
    (function tryTopoFetch(idx){
      if(idx>=topoSources.length){console.error('All TopoJSON sources failed');return;}
      console.log('Trying TopoJSON source',idx+1+'/'+topoSources.length,':',topoSources[idx]);
      fetch(topoSources[idx])
        .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json();})
        .then(function(topo){
          // Convert TopoJSON to GeoJSON
          var objKey=topo.objects.countries?'countries':Object.keys(topo.objects)[0];
          var geo=topojson.feature(topo,topo.objects[objKey]);
          console.log('TopoJSON converted to GeoJSON:',geo.features.length,'countries, source:',topoSources[idx]);
          setGeoData(geo);
        })
        .catch(function(e){
          console.warn('TopoJSON source',idx+1,'failed:',e.message,', trying next...');
          tryTopoFetch(idx+1);
        });
    })(0);

    // Add connection lines
    CONNS.forEach(([fromId,toId,label,color])=>{
      const f=INCIDENTS.find(i=>i.id===fromId);const t=INCIDENTS.find(i=>i.id===toId);
      if(!f||!t)return;
      const line=L.polyline([[f.lat,f.lon],[t.lat,t.lon]],{
        color,weight:1.5,opacity:0.35,dashArray:'6,4',className:'conn-arc'
      }).addTo(map);
      linesRef.current.push(line);
    });
  },[]);

  // Update markers when filter changes
  useEffect(()=>{
    if(!mapRef.current)return;
    const map=mapRef.current;
    // Clear old markers
    markersRef.current.forEach(m=>map.removeLayer(m));
    markersRef.current=[];
    // Add filtered markers
    const filtered=mf==='ALL'?INCIDENTS:INCIDENTS.filter(i=>i.cat===mf);
    filtered.forEach(inc=>{
      const col=SC[inc.sv];
      const size=inc.sv==='critical'?10:8;
      const pulseClass=inc.sv==='critical'?'pulse-marker':'';
      const icon=L.divIcon({
        className:'',
        html:`<div style="width:${size}px;height:${size}px;background:${col};border-radius:50%;border:2px solid rgba(0,0,0,0.6);box-shadow:0 0 ${inc.sv==='critical'?'12':'6'}px ${col}80;cursor:pointer" class="${pulseClass}"></div>`,
        iconSize:[size,size],iconAnchor:[size/2,size/2]
      });
      const marker=L.marker([inc.lat,inc.lon],{icon}).addTo(map);
      const popup=`<div style="font-family:Inter,sans-serif">
        <div style="font:600 10px 'JetBrains Mono';color:${col};text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${inc.cat} â€” ${inc.sv.toUpperCase()}</div>
        <div style="font:500 12px/1.4 Inter;color:#e5e5e5;margin-bottom:4px">${inc.t}</div>
        <div style="font:400 10px 'JetBrains Mono';color:#999">${inc.reg} Â· ${inc.tm} ago</div>
        <div style="font:500 10px 'JetBrains Mono';color:#999;margin-top:4px">${inc.imp}</div>
      </div>`;
      marker.bindPopup(popup,{maxWidth:280,closeButton:true});
      marker.on('mouseover',function(){this.openPopup()});
      markersRef.current.push(marker);
    });
  },[mf]);

  // â•â•â• ADVISORY COUNTRY SHADING â€” color-code map by State Dept levels â•â•â•
  // Supports both ISO numeric (world-atlas TopoJSON) and ISO alpha-3 (GeoJSON) IDs
  var ADV_NUMERIC={
    '004':4,'804':4,'643':4,'760':4,'364':4,'368':4,'887':4,'706':4,'729':4,
    '728':4,'434':4,'466':4,'332':4,'408':4,'862':4,'104':4,'854':4,'562':4,
    '140':4,'112':4,'422':4,'275':4,
    '586':3,'566':3,'340':3,'222':3,'231':3,'180':3,'120':3,'148':3,'478':3,
    '324':3,'170':3,'404':3,
    '484':2,'076':2,'818':2,'792':2,'356':2,'376':2,'608':2,'710':2,'388':2,'156':2
  };
  var ADV_ALPHA3={
    'AFG':4,'UKR':4,'RUS':4,'SYR':4,'IRN':4,'IRQ':4,'YEM':4,'SOM':4,'SDN':4,
    'SSD':4,'LBY':4,'MLI':4,'HTI':4,'PRK':4,'VEN':4,'MMR':4,'BFA':4,'NER':4,
    'CAF':4,'BLR':4,'LBN':4,'PSE':4,
    'PAK':3,'NGA':3,'HND':3,'SLV':3,'ETH':3,'COD':3,'CMR':3,'TCD':3,'MRT':3,
    'GIN':3,'COL':3,'KEN':3,
    'MEX':2,'BRA':2,'EGY':2,'TUR':2,'IND':2,'ISR':2,'PHL':2,'ZAF':2,'JAM':2,'CHN':2
  };
  // Country names for popups: numeric ID -> display name
  var ID_NAMES={
    '004':'Afghanistan','804':'Ukraine','643':'Russia','760':'Syria','364':'Iran','368':'Iraq',
    '887':'Yemen','706':'Somalia','729':'Sudan','728':'South Sudan','434':'Libya','466':'Mali',
    '332':'Haiti','408':'North Korea','862':'Venezuela','104':'Myanmar','854':'Burkina Faso',
    '562':'Niger','140':'Central African Republic','112':'Belarus','422':'Lebanon','275':'Palestine',
    '586':'Pakistan','566':'Nigeria','340':'Honduras','222':'El Salvador','231':'Ethiopia',
    '180':'DR Congo','120':'Cameroon','148':'Chad','478':'Mauritania','324':'Guinea',
    '170':'Colombia','404':'Kenya','484':'Mexico','076':'Brazil','818':'Egypt','792':'Turkey',
    '356':'India','376':'Israel','608':'Philippines','710':'South Africa','388':'Jamaica','156':'China',
    'AFG':'Afghanistan','UKR':'Ukraine','RUS':'Russia','SYR':'Syria','IRN':'Iran','IRQ':'Iraq',
    'YEM':'Yemen','SOM':'Somalia','SDN':'Sudan','SSD':'South Sudan','LBY':'Libya','MLI':'Mali',
    'HTI':'Haiti','PRK':'North Korea','VEN':'Venezuela','MMR':'Myanmar','BFA':'Burkina Faso',
    'NER':'Niger','CAF':'Central African Republic','BLR':'Belarus','LBN':'Lebanon','PSE':'Palestine',
    'PAK':'Pakistan','NGA':'Nigeria','HND':'Honduras','SLV':'El Salvador','ETH':'Ethiopia',
    'COD':'DR Congo','CMR':'Cameroon','TCD':'Chad','MRT':'Mauritania','GIN':'Guinea',
    'COL':'Colombia','KEN':'Kenya','MEX':'Mexico','BRA':'Brazil','EGY':'Egypt','TUR':'Turkey',
    'IND':'India','ISR':'Israel','PHL':'Philippines','ZAF':'South Africa','JAM':'Jamaica','CHN':'China'
  };
  var getAdvLevel=function(featureId){
    var id=String(featureId||'');
    return ADV_NUMERIC[id]||ADV_ALPHA3[id]||0;
  };
  useEffect(()=>{
    if(!mapRef.current||!geoData||advisories.length===0){console.log('Advisory shading skipped â€” map:',!!mapRef.current,'geo:',!!geoData,'adv:',advisories.length);return;}
    console.log('Advisory shading: painting onto',geoData.features?geoData.features.length:0,'countries');
    var map=mapRef.current;
    if(geoLayerRef.current){map.removeLayer(geoLayerRef.current);}
    var matchCount=0;
    var advColors={4:'rgba(255,59,48,0.45)',3:'rgba(255,149,0,0.35)',2:'rgba(255,214,10,0.2)'};
    var advBorders={4:'rgba(255,59,48,0.8)',3:'rgba(255,149,0,0.6)',2:'rgba(255,214,10,0.35)'};
    var layer=L.geoJSON(geoData,{
      style:function(feature){
        var lvl=getAdvLevel(feature.id);
        if(lvl>=2){
          matchCount++;
          return{fillColor:advColors[lvl],fillOpacity:1,weight:1,color:advBorders[lvl],opacity:0.8};
        }
        return{fillColor:'transparent',fillOpacity:0,weight:0.3,color:'rgba(255,255,255,0.05)',opacity:0.5};
      },
      onEachFeature:function(feature,layer){
        var lvl=getAdvLevel(feature.id);
        if(lvl>=2){
          var dispName=ID_NAMES[String(feature.id)]||feature.properties.name||String(feature.id);
          var lvlLabel={4:'DO NOT TRAVEL',3:'RECONSIDER TRAVEL',2:'EXERCISE INCREASED CAUTION'};
          var lvlColor={4:'#ff3b30',3:'#ff9500',2:'#ffd60a'};
          layer.bindPopup('<div style="font-family:Inter,sans-serif"><div style="font:700 10px JetBrains Mono;color:'+lvlColor[lvl]+';letter-spacing:1px;margin-bottom:4px">LEVEL '+lvl+' â€” '+lvlLabel[lvl]+'</div><div style="font:600 12px Inter;color:#e5e5e5;margin-bottom:4px">'+dispName+'</div></div>',{maxWidth:260});
        }
      }
    });
    layer.addTo(map);
    layer.bringToBack();
    geoLayerRef.current=layer;
    console.log('Advisory shading complete:',matchCount,'countries colored');
  },[geoData,advisories]);

  const fi=mf==='ALL'?INCIDENTS:INCIDENTS.filter(i=>i.cat===mf);

  // Use live news for feed + wire, fallback to static
  const feedItems=liveNews.length>0?liveNews:INCIDENTS;
  const wireItems=liveNews.length>0?liveNews:NEWS;

  // Compute advisory summary stats
  const advStats=useMemo(()=>{
    const l4=advisories.filter(a=>a.level===4).length;
    const l3=advisories.filter(a=>a.level===3).length;
    const l2=advisories.filter(a=>a.level===2).length;
    return{l4,l3,l2,total:advisories.length};
  },[advisories]);

  return(
    <div>
      {/* Ticker */}
      <div className="ticker"><div className="tscroll">
        {[...TICKERS,...TICKERS].map((t,i)=>{var lp=livePrices[t.s];var price=lp?lp.p:t.p;var change=lp?lp.c:t.c;var up=lp?lp.u:t.u;return <React.Fragment key={i}>
          <span className="tk"><span className="s">{t.s}</span><span className="p">{price}</span><span className={up?'up':'dn'}>{change}</span></span>
          {i%5===4&&<span className="tsep">â”‚</span>}
        </React.Fragment>})}
      </div></div>

      {/* Breaking News Banner â€” GDELT powered */}
      {breakingNews&&<div className="breaking-banner">
        <div className="bb-inner">
          <div className="bb-pulse"/>
          <span className="bb-tag">BREAKING</span>
          <span className="bb-headline"><a href={breakingNews.url} target="_blank" rel="noopener noreferrer">{breakingNews.title}</a></span>
          <span className="bb-sources">{breakingNews.sources} sources</span>
          <span className="bb-time">{breakingNews.time}</span>
          <button className="bb-dismiss" onClick={function(){setBannerDismissed(breakingNews.title.substring(0,40));setBreakingNews(null);}}>âœ•</button>
        </div>
      </div>}

      {/* Header */}
      <div className="hdr">
        <div className="hdr-l"><div className="logo">SENTINEL NOVA<span>GLOBAL SECURITY TERMINAL</span></div><span style={{font:'600 8px var(--mono)',color:'#30d158',padding:'2px 8px',borderRadius:2,border:'1px solid rgba(48,209,88,.4)',background:'rgba(48,209,88,.1)',letterSpacing:'1.5px',marginLeft:12}}>GSSC-READY</span></div>
        <div className="hdr-r">
          <div className="hdr-spgi">
            <span style={{font:'600 10px var(--mono)',color:'var(--t2)'}}>SPGI</span>
            <span style={{font:'700 11px var(--mono)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{livePrices.SPGI?livePrices.SPGI.p:'512.38'}</span>
            <svg width="48" height="16" viewBox="0 0 48 16"><polyline points={spgiIntraday.map((d,i)=>{const x=i/(spgiIntraday.length-1)*48;const mn=Math.min(...spgiIntraday.map(s=>s.p));const mx=Math.max(...spgiIntraday.map(s=>s.p));const range=mx-mn||1;return `${x},${2+((mx-d.p)/range)*12}`}).join(' ')} fill="none" stroke={livePrices.SPGI?(livePrices.SPGI.u?'#30d158':'#ff3b30'):'#30d158'} strokeWidth="1.2"/></svg>
            <span style={{font:'500 9px var(--mono)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{livePrices.SPGI?livePrices.SPGI.c:'+1.24%'}</span>
          </div>
          <span className="threat">âš  {advStats.l4>0?'L4 ADVISORIES: '+advStats.l4:'THREAT LEVEL: ELEVATED'}</span>
          <span className="live"><span className="ldot"></span>LIVE</span>
          <span>{time.toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})}</span>
          <span style={{color:'var(--t3)'}}>UTC {time.toISOString().slice(11,19)}</span>
        </div>
      </div>

      <div className="shell">
        {/* LEFT SIDEBAR */}
        <div className="sidebar">
          {/* TRAVEL ADVISORIES */}
          <div className="ph"><div className="pt">â—† US Travel Advisories</div><span className="pb" style={{background:advLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:advLive?'var(--grn)':'var(--t3)'}}>{advLive?'â— STATE DEPT LIVE':'LOADING'}</span></div>
          {/* Summary bar */}
          {advLive&&<div style={{display:'flex',gap:0,borderBottom:'1px solid var(--bdr)'}}>
            <div style={{flex:1,padding:'6px 8px',textAlign:'center',background:'rgba(255,59,48,0.08)',borderRight:'1px solid var(--bdr)'}}>
              <div style={{font:'700 16px var(--mono)',color:'#ff3b30'}}>{advStats.l4}</div>
              <div style={{font:'500 7px var(--mono)',color:'var(--t3)',letterSpacing:'.5px'}}>L4 â€” DNT</div>
            </div>
            <div style={{flex:1,padding:'6px 8px',textAlign:'center',background:'rgba(255,149,0,0.06)',borderRight:'1px solid var(--bdr)'}}>
              <div style={{font:'700 16px var(--mono)',color:'#ff9500'}}>{advStats.l3}</div>
              <div style={{font:'500 7px var(--mono)',color:'var(--t3)',letterSpacing:'.5px'}}>L3 â€” RECON</div>
            </div>
            <div style={{flex:1,padding:'6px 8px',textAlign:'center',background:'rgba(255,214,10,0.05)'}}>
              <div style={{font:'700 16px var(--mono)',color:'#ffd60a'}}>{advStats.l2}</div>
              <div style={{font:'500 7px var(--mono)',color:'var(--t3)',letterSpacing:'.5px'}}>L2 â€” CAUT</div>
            </div>
          </div>}
          <div className="pbd" style={{padding:'6px 12px'}}>
            {advisories.length>0?advisories.map((adv,i)=>{
              const inner=<div key={i} style={{padding:'5px 0',borderBottom:i<advisories.length-1?'1px solid var(--bdr)':'none'}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:2}}>
                  <span style={{font:'600 8px var(--mono)',color:ADV_COLORS[adv.level],padding:'1px 5px',borderRadius:2,background:ADV_COLORS[adv.level]+'18',border:'1px solid '+ADV_COLORS[adv.level]+'35',letterSpacing:'.5px'}}>{ADV_SHORT[adv.level]||'L'+adv.level}</span>
                  <span style={{font:'400 8px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{adv.date?timeAgo(adv.date.toISOString()):''}</span>
                </div>
                <div style={{font:'500 10px/1.3 Inter,sans-serif',color:'var(--t1)',cursor:adv.url?'pointer':'default'}}>{adv.country}{adv.url&&<span style={{color:'var(--t3)',fontSize:9,marginLeft:4}}>â†—</span>}</div>
                {adv.desc&&<div style={{font:'400 9px Inter,sans-serif',color:'var(--t3)',marginTop:1}}>{adv.desc.slice(0,80)}</div>}
              </div>;
              return adv.url?<a key={i} href={adv.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
            }):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading advisories...</div>}
          </div>

          {/* SOVEREIGN RISK RATINGS */}
          <div className="ph"><div className="pt">â—† Sovereign Risk Ratings</div><span className="pb" style={{background:ratingsLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:ratingsLive?'var(--grn)':'var(--t3)'}}>{ratingsLive?'â— LIVE':'LOADING'}</span></div>
          <div className="pbd" style={{padding:'6px 12px'}}>
            {ratings.length>0?ratings.map((r,i)=>{
              const inner=<div key={i} style={{padding:'5px 0',borderBottom:i<ratings.length-1?'1px solid var(--bdr)':'none'}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:2}}>
                  <span style={{font:'600 8px var(--mono)',color:r.color,padding:'1px 5px',borderRadius:2,background:r.color+'18',border:'1px solid '+r.color+'35',letterSpacing:'.5px',textTransform:'uppercase'}}>{r.direction}</span>
                  {r.agency&&<span style={{font:'500 8px var(--mono)',color:'var(--t2)'}}>{r.agency}</span>}
                  <span style={{font:'400 8px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{r.time}</span>
                </div>
                <div style={{font:'500 10px/1.3 Inter,sans-serif',color:'var(--t1)',cursor:r.url?'pointer':'default'}}>{r.headline.slice(0,65)}{r.headline.length>65?'...':''}{r.url&&<span style={{color:'var(--t3)',fontSize:9,marginLeft:4}}>â†—</span>}</div>
                <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:1}}>{r.src}</div>
              </div>;
              return r.url?<a key={i} href={r.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
            }):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading ratings...</div>}
          </div>
        </div>

        {/* CENTER */}
        <div className="center">
          {/* MAP */}
          <div style={{flex:'1 1 55%',minHeight:0,borderBottom:'1px solid var(--bdr)'}}>
            <div className="mwrap">
              <div id="leaflet-map"></div>
              <div className="mfilt" style={{zIndex:1000}}>
                {['ALL','CONFLICT','CLIMATE','CYBER','ENERGY','ECONOMIC'].map(f=>(
                  <button key={f} className={`mfb ${mf===f?'a':''}`} onClick={()=>setMf(f)}>{f}</button>
                ))}
              </div>
              <div className="mstat" style={{zIndex:1000}}>
                <div className="ms"><span className="msv" style={{color:'var(--red)'}}>{INCIDENTS.filter(i=>i.sv==='critical').length}</span><span className="msl">Critical</span></div>
                <div className="ms"><span className="msv" style={{color:'var(--amber)'}}>{INCIDENTS.filter(i=>i.sv==='high').length}</span><span className="msl">High</span></div>
                <div className="ms"><span className="msv" style={{color:'var(--t1)'}}>{INCIDENTS.length}</span><span className="msl">Total</span></div>
              </div>
              <div className="mleg" style={{zIndex:1000}}>
                {Object.entries(CC).slice(0,6).map(([k,v])=><span key={k} className="ml"><span className="mld" style={{background:v}}></span>{k}</span>)}
              </div>
            </div>
          </div>

          {/* BOTTOM: Intel + Trends */}
          <div style={{flex:'1 1 45%',display:'grid',gridTemplateColumns:'1fr 1fr',overflow:'hidden'}}>
            {/* Intel Feed â€” live or fallback */}
            <div style={{overflow:'auto',borderRight:'1px solid var(--bdr)',display:'flex',flexDirection:'column'}}>
              <div className="ph">
                <div className="pt">â—† Intelligence Feed</div>
                <span className="pb" style={{background:feedStatus==='live'?'var(--grnbg)':'var(--redbg)',color:feedStatus==='live'?'var(--grn)':'var(--red)'}}>
                  {feedStatus==='live'?'â— LIVE RSS':feedStatus==='loading'?'LOADING...':feedItems.length+' ACTIVE'}
                </span>
              </div>
              <div className="isrch">
                <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>ðŸ”</span>
                <input
                  type="text"
                  placeholder="Search intel â€” e.g. Mexico cartel, Iran nuclear, bird flu..."
                  value={searchQuery}
                  onChange={e=>setSearchQuery(e.target.value)}
                  onKeyDown={e=>{if(e.key==='Enter')searchIntel(searchQuery);}}
                />
                <button onClick={()=>searchIntel(searchQuery)}>{searching?'SEARCHING...':'SEARCH'}</button>
                {searchResults.length>0&&<button className="clear" onClick={clearSearch}>âœ• CLEAR</button>}
              </div>
              <div className="pbd" style={{flex:1,overflow:'auto'}}>
                {feedStatus==='live'?
                  liveNews.map(function(item,idx){
                    return <a key={idx} href={item.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                    <div className="fi">
                      <div className="fit">
                        <div className="fis" style={{background:SC[item.sv]}}/>
                        <span className="fitg" style={{background:(CC[item.cat]||'#999')+'20',color:CC[item.cat]||'#999',border:'1px solid '+(CC[item.cat]||'#999')+'40'}}>{item.cat}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.src}</span>
                        <span className="fitm">{item.tm}</span>
                      </div>
                      <div className="fitt" style={{cursor:'pointer'}}>{item.t} <span style={{color:'var(--t3)',fontSize:9}}>â†—</span></div>
                    </div></a>;
                  })
                :
                  INCIDENTS.map(function(inc){
                    var q=encodeURIComponent(inc.t.split('â€”')[0].trim());
                    var url='https://news.google.com/search?q='+q;
                    return <a key={inc.id} href={url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                    <div className="fi">
                      <div className="fit">
                        <div className="fis" style={{background:SC[inc.sv]}}/>
                        <span className="fitg" style={{background:CC[inc.cat]+'20',color:CC[inc.cat],border:'1px solid '+CC[inc.cat]+'40'}}>{inc.cat}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{inc.reg}</span>
                        <span className="fitm">{inc.tm}</span>
                      </div>
                      <div className="fitt" style={{cursor:'pointer'}}>{inc.t} <span style={{color:'var(--t3)',fontSize:9}}>â†—</span></div>
                      <div className="fisu">{inc.imp}</div>
                    </div></a>;
                  })
                }
              </div>
            </div>

            {/* Weather + NOTAMs Split Panel */}
            <div style={{overflow:'hidden',display:'flex',flexDirection:'column'}}>
              {/* SEVERE WEATHER */}
              <div style={{flex:'1 1 50%',overflow:'auto',borderBottom:'1px solid var(--bdr)'}}>
                <div className="ph">
                  <div className="pt">â—† Severe Weather</div>
                  <span className="pb" style={{background:'var(--redbg)',color:'var(--red)'}}>{wxAlerts.filter(w=>w.sev==='extreme').length} EXTREME</span>
                </div>
                <div className="pbd" style={{padding:'6px 12px'}}>
                  {wxAlerts.map((wx,i)=>{
                    const inner=<div key={i} style={{padding:'6px 0',borderBottom:i<wxAlerts.length-1?'1px solid var(--bdr)':'none'}}>
                      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                        <span style={{fontSize:12}}>{wx.icon}</span>
                        <span style={{font:'600 9px var(--mono)',color:WX_SEV_COLORS[wx.sev],textTransform:'uppercase',letterSpacing:'.5px',padding:'1px 5px',borderRadius:2,background:WX_SEV_COLORS[wx.sev]+'18',border:'1px solid '+WX_SEV_COLORS[wx.sev]+'35'}}>{wx.sev}</span>
                        <span style={{font:'500 9px var(--mono)',color:'var(--t3)'}}>{wx.type}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{wx.time}</span>
                      </div>
                      <div style={{font:'500 11px/1.3 Inter,sans-serif',color:'var(--t1)'}}>{wx.title}</div>
                      <div style={{font:'400 10px Inter,sans-serif',color:'var(--t3)',marginTop:2}}>{wx.detail}</div>
                    </div>;
                    return wx.url?<a key={i} href={wx.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
                  })}
                </div>
              </div>

              {/* NOTAMs */}
              <div style={{flex:'1 1 50%',overflow:'auto'}}>
                <div className="ph">
                  <div className="pt">â—† Active NOTAMs</div>
                  <span className="pb" style={{background:notamLive?'var(--grnbg)':'var(--redbg)',color:notamLive?'var(--grn)':'var(--red)'}}>{notamLive?'â— LIVE':notams.filter(n=>n.status==='PROHIBITED').length+' PROHIBITED'}</span>
                </div>
                <div className="pbd" style={{padding:'6px 12px'}}>
                  {notams.map((n,i)=>{
                    const inner=<div key={i} style={{padding:'6px 0',borderBottom:i<notams.length-1?'1px solid var(--bdr)':'none'}}>
                      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                        <span style={{font:'600 9px var(--mono)',color:'var(--t2)'}}>{n.id}</span>
                        <span style={{font:'600 8px var(--mono)',color:NOTAM_STATUS_COLORS[n.status]||n.color,textTransform:'uppercase',letterSpacing:'.5px',padding:'1px 5px',borderRadius:2,background:(NOTAM_STATUS_COLORS[n.status]||n.color)+'18',border:'1px solid '+(NOTAM_STATUS_COLORS[n.status]||n.color)+'35'}}>{n.status}</span>
                        {n.src&&<span style={{font:'400 8px var(--mono)',color:'var(--t3)',padding:'1px 4px',border:'1px solid var(--bdr)',borderRadius:2}}>{n.src}</span>}
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{n.time}</span>
                      </div>
                      <div style={{font:'500 10px/1.3 var(--mono)',color:'var(--t1)',cursor:n.url?'pointer':'default'}}>{n.zone}{n.url&&<span style={{color:'var(--t3)',fontSize:9,marginLeft:4}}>â†—</span>}</div>
                      <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:2}}>{n.detail}</div>
                    </div>;
                    return n.url?<a key={i} href={n.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* RIGHT PANEL */}
        <div className="rpanel">
          {/* SPGI */}
          <div className="ph"><div className="pt">â—† SPGI â€” S&P Global</div><span className="pb" style={{background:livePrices.SPGI?(livePrices.SPGI.u?'var(--grnbg)':'var(--redbg)'):'var(--grnbg)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{livePrices.SPGI?livePrices.SPGI.c:'+1.24%'}</span></div>
          <div className="pbd">
            <div style={{display:'flex',alignItems:'baseline',gap:8}}>
              <span style={{font:'700 22px var(--mono)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{'$'+(livePrices.SPGI?livePrices.SPGI.p:'512.38')}</span>
              <span style={{font:'500 11px var(--mono)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{livePrices.SPGI?livePrices.SPGI.c:'+$6.28'}</span>
            </div>
            <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:2}}>NYSE Â· {livePrices.SPGI?'â— LIVE':'Intraday'} Â· Updated {time.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false})}</div>
            <div style={{marginTop:8}}><Sparkline data={spgiIntraday} dataKey="p" w={260} h={55} color={livePrices.SPGI?(livePrices.SPGI.u?'#30d158':'#ff3b30'):'#30d158'}/></div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginTop:8,font:'400 9px var(--mono)'}}>
              <div><span style={{color:'var(--t3)'}}>Open</span><br/><span style={{color:'var(--t1)'}}>{spgiIntraday.length>0?spgiIntraday[0].p.toFixed(2):'508.20'}</span></div>
              <div><span style={{color:'var(--t3)'}}>High</span><br/><span style={{color:'var(--t1)'}}>{Math.max(...spgiIntraday.map(function(d){return d.p})).toFixed(2)}</span></div>
              <div><span style={{color:'var(--t3)'}}>Low</span><br/><span style={{color:'var(--t1)'}}>{Math.min(...spgiIntraday.map(function(d){return d.p})).toFixed(2)}</span></div>
              <div><span style={{color:'var(--t3)'}}>Mkt Cap</span><br/><span style={{color:'var(--t1)'}}>{livePrices.SPGI?'$'+(livePrices.SPGI.raw*314.8/1e9).toFixed(1)+'B':'$161.2B'}</span></div>
              <div><span style={{color:'var(--t3)'}}>Prev</span><br/><span style={{color:'var(--t1)'}}>{spgiIntraday.length>0?spgiIntraday[0].p.toFixed(2):'508.20'}</span></div>
              <div><span style={{color:'var(--t3)'}}>Points</span><br/><span style={{color:'var(--t1)'}}>{spgiIntraday.length} pts</span></div>
            </div>
          </div>

          {/* SPGI News */}
          <div className="ph"><div className="pt">â—† SPGI News & Updates</div><span className="pb" style={{background:spgiNewsLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:spgiNewsLive?'var(--grn)':'var(--t3)'}}>{spgiNewsLive?'â— LIVE':'LOADING'}</span></div>
          <div className="pbd" style={{padding:'6px 12px'}}>
            {spgiNews.length>0?spgiNews.map((item,i)=>(
              <a key={i} href={item.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                <div style={{padding:'5px 0',borderBottom:i<spgiNews.length-1?'1px solid var(--bdr)':'none'}}>
                  <div style={{font:'500 10px/1.4 Inter,sans-serif',color:'var(--t1)',cursor:'pointer'}}>{item.t} <span style={{color:'var(--t3)',fontSize:9}}>â†—</span></div>
                  <div style={{display:'flex',justifyContent:'space-between',marginTop:2}}>
                    <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.src}</span>
                    <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.tm}</span>
                  </div>
                </div>
              </a>
            )):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading SPGI news...</div>}
          </div>

          {/* France 24 Live Stream */}
          <div className="ph" style={{marginTop:8}}><div className="pt">â—† France 24 Live</div><span className="pb" style={{background:'var(--redbg)',color:'var(--red)'}}>â— LIVE 24/7</span></div>
          <div style={{padding:'0 12px 12px',background:'var(--card)',borderRadius:'0 0 6px 6px'}}>
            <iframe
              src="https://embed.france24.com/en/live"
              style={{width:'100%',height:180,border:'1px solid var(--bdr)',borderRadius:4,marginTop:6}}
              allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
              allowFullScreen
              title="France 24 English Live"
            ></iframe>
            <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:4,textAlign:'center'}}>France 24 English Â· 24/7 International News Â· Independent & Impartial</div>
          </div>
        </div>
      </div>

      {/* News Ticker â€” live or fallback */}
      <div className="newstick">
        <span className="label">â—† WIRE</span>
        <div className="nscroll">
          {liveNews.length>0?
            [...liveNews,...liveNews].map((n,i)=><span key={i} className="nitem">
              <span className="ndot" style={{background:CC[n.cat]||'#999'}}></span>
              {n.t}
              <span className="nsrc">{n.src}</span>
            </span>)
          :
            [...NEWS,...NEWS].map((n,i)=><span key={i} className="nitem">
              <span className="ndot" style={{background:n.c}}></span>
              {n.t}
              <span className="nsrc">{n.s}</span>
            </span>)
          }
        </div>
      </div>

      {/* Tooltip */}
      {tt&&<div className="tt" style={{left:tt.x,top:tt.y}}>
        <h5 style={{color:SC[tt.i.sv]}}>{tt.i.cat} â€” {tt.i.sv.toUpperCase()}</h5>
        <p style={{color:'var(--t1)',fontWeight:500}}>{tt.i.t}</p>
        <p style={{marginTop:3}}>{tt.i.reg} Â· {tt.i.tm} ago</p>
        <p style={{marginTop:2,color:'var(--t2)'}}>{tt.i.imp}</p>
      </div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
