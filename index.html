<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>SENTINEL NOVA — Global Security Terminal</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#000;color:#d4d4d4;overflow-x:hidden;font-size:12px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#000}::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
:root{--bg0:#000;--bg1:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--bdr:#222;--bdrh:#333;--amber:#ff9500;--amberd:#b36800;--amberbg:rgba(255,149,0,0.08);--red:#ff3b30;--redbg:rgba(255,59,48,0.1);--grn:#30d158;--grnbg:rgba(48,209,88,0.08);--blu:#0a84ff;--cyan:#64d2ff;--pur:#bf5af2;--yel:#ffd60a;--t1:#e5e5e5;--t2:#999;--t3:#666;--mono:'JetBrains Mono',monospace}

/* TICKER */
.ticker{background:#050505;border-bottom:1px solid var(--bdr);height:24px;overflow:hidden;display:flex;align-items:center}
.tscroll{display:flex;animation:tsc 30s linear infinite;white-space:nowrap}.tscroll:hover{animation-play-state:paused}
@keyframes tsc{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.tk{display:inline-flex;align-items:center;gap:5px;margin-right:28px;font:500 11px var(--mono);letter-spacing:.3px}
.tk .s{color:var(--t2)}.tk .p{color:var(--t1)}.tk .up{color:var(--grn);font-size:10px}.tk .dn{color:var(--red);font-size:10px}
.tsep{color:var(--bdr);margin-right:28px}

/* HEADER */
.hdr{background:var(--bg1);border-bottom:1px solid var(--bdr);padding:8px 16px;display:flex;align-items:center;justify-content:space-between;min-height:40px;overflow:hidden}
.hdr-l{display:flex;align-items:center;gap:10px;flex-shrink:0}
.logo{font:700 13px var(--mono);color:var(--red);letter-spacing:2px;white-space:nowrap}
.logo span{color:var(--t3);font-weight:400;font-size:9px;letter-spacing:1px;margin-left:6px}
.hdr-r{display:flex;align-items:center;gap:10px;font:400 10px var(--mono);color:var(--t3);flex-shrink:1;min-width:0;overflow:hidden}
.live{display:flex;align-items:center;gap:5px}
.ldot{width:6px;height:6px;background:var(--grn);border-radius:50%;animation:bl 2s infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.3}}
.threat{padding:3px 8px;border-radius:3px;font:600 9px var(--mono);letter-spacing:.5px;text-transform:uppercase;background:var(--redbg);color:var(--red);border:1px solid rgba(255,59,48,.3);white-space:nowrap;flex-shrink:0}

/* LAYOUT */
.shell{display:grid;grid-template-columns:260px 1fr 280px;height:calc(100vh - 101px);overflow:hidden}
.sidebar{background:var(--bg1);border-right:1px solid var(--bdr);overflow-y:auto}
.center{display:flex;flex-direction:column;overflow:hidden}
.rpanel{background:var(--bg1);border-left:1px solid var(--bdr);overflow-y:auto}

/* PANELS */
.ph{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--bg2);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:2;gap:6px;min-height:28px;overflow:hidden}
.pt{font:600 9px var(--mono);text-transform:uppercase;letter-spacing:1px;color:var(--red);display:flex;align-items:center;gap:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
.pb{font:500 8px var(--mono);padding:1px 5px;border-radius:2px;letter-spacing:.5px;white-space:nowrap;flex-shrink:0}
.pbd{padding:10px 12px}

/* RISK GAUGES */
.rg{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--bdr)}.rg:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.rg-t{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px}
.rg-l{font:500 11px/1 'Inter',sans-serif;color:var(--t2)}
.rg-v{font:700 16px var(--mono)}
.rg-b{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;margin-bottom:3px}
.rg-f{height:100%;border-radius:2px;transition:width 1s ease}
.rg-m{font:400 9px var(--mono);color:var(--t3);display:flex;justify-content:space-between}

/* MAP */
.mwrap{position:relative;width:100%;height:100%;min-height:300px;background:var(--bg0)}
.mwrap svg{width:100%;height:100%}
#leaflet-map{width:100%;height:100%;background:#000;z-index:0}
.leaflet-container{background:#000!important}
.leaflet-control-zoom{border:1px solid var(--bdr)!important;border-radius:3px!important}
.leaflet-control-zoom a{background:var(--bg2)!important;color:var(--t2)!important;border-color:var(--bdr)!important;width:26px!important;height:26px!important;line-height:26px!important;font-size:13px!important}
.leaflet-control-zoom a:hover{background:var(--bg3)!important;color:var(--t1)!important}
.leaflet-control-attribution{display:none!important}
.pulse-marker{border-radius:50%;animation:pmark 2s infinite}
@keyframes pmark{0%{box-shadow:0 0 0 0 rgba(255,59,48,.5)}70%{box-shadow:0 0 0 12px rgba(255,59,48,0)}100%{box-shadow:0 0 0 0 rgba(255,59,48,0)}}
.leaflet-popup-content-wrapper{background:var(--bg2)!important;color:var(--t1)!important;border:1px solid var(--bdrh)!important;border-radius:6px!important;box-shadow:0 4px 20px rgba(0,0,0,.6)!important;font-family:'Inter',sans-serif!important;font-size:11px!important}
.leaflet-popup-tip{background:var(--bg2)!important;border:1px solid var(--bdrh)!important}
.leaflet-popup-close-button{color:var(--t3)!important;font-size:16px!important}
.leaflet-popup-close-button:hover{color:var(--t1)!important}
.conn-arc{stroke-dasharray:6,4;animation:arcflow 3s linear infinite}
@keyframes arcflow{0%{stroke-dashoffset:0}100%{stroke-dashoffset:-30}}
.mfilt{position:absolute;top:8px;left:8px;display:flex;gap:4px;flex-wrap:wrap;z-index:1000}
.mfb{font:500 9px var(--mono);padding:3px 8px;border-radius:2px;border:1px solid var(--bdr);background:var(--bg2);color:var(--t3);cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.5px}
.mfb:hover{border-color:var(--bdrh);color:var(--t2)}.mfb.a{background:var(--redbg);border-color:rgba(255,59,48,.4);color:var(--red)}
.mstat{position:absolute;top:8px;right:8px;display:flex;gap:6px}
.ms{background:rgba(0,0,0,.8);border:1px solid var(--bdr);border-radius:3px;padding:4px 8px;text-align:center}
.msv{font:700 14px var(--mono);display:block}.msl{font:400 8px var(--mono);color:var(--t3);text-transform:uppercase;letter-spacing:.5px}
.map-search{position:absolute;top:8px;right:8px;z-index:10000;display:flex;align-items:center;gap:4px;pointer-events:auto}
.map-search input{background:rgba(0,0,0,0.8);border:1px solid rgba(255,255,255,0.25);color:var(--t1);font:400 10px var(--mono);padding:6px 12px;border-radius:4px;width:180px;outline:none;backdrop-filter:blur(10px);pointer-events:auto}
.map-search input::placeholder{color:var(--t3)}
.map-search input:focus{border-color:rgba(10,132,255,0.6);box-shadow:0 0 8px rgba(10,132,255,0.3);background:rgba(0,0,0,0.9)}
.mleg{position:absolute;bottom:8px;left:8px;display:flex;gap:8px;font:400 8px var(--mono);color:var(--t3);flex-wrap:wrap;max-width:60%}
.ml{display:flex;align-items:center;gap:3px;white-space:nowrap}.mld{width:6px;height:6px;border-radius:50%}
.mpulse{animation:mp 2s infinite}@keyframes mp{0%{r:5;opacity:.9}50%{r:14;opacity:0}100%{r:5;opacity:0}}

/* CONNECTION LINES */
.conn-line{stroke-dasharray:4,3;animation:dash 20s linear infinite}
@keyframes dash{0%{stroke-dashoffset:0}100%{stroke-dashoffset:-200}}

/* NEWS TICKER */
.newstick{background:#050505;border-top:1px solid var(--bdr);height:22px;overflow:hidden;display:flex;align-items:center}
.newstick .label{font:600 9px var(--mono);color:var(--red);padding:0 10px;text-transform:uppercase;letter-spacing:1px;white-space:nowrap;border-right:1px solid var(--bdr);flex-shrink:0}
.nscroll{display:flex;animation:nsc 200s linear infinite;white-space:nowrap}.nscroll:hover{animation-play-state:paused}
.nitem a{color:inherit;text-decoration:none}.nitem a:hover{text-decoration:underline;color:var(--t1)}
@keyframes nsc{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.nitem{display:inline-flex;align-items:center;gap:6px;margin-right:40px;font:400 10px 'Inter',sans-serif;color:var(--t2)}
.nitem .ndot{width:4px;height:4px;border-radius:50%;flex-shrink:0}
.nitem .nsrc{font:400 9px var(--mono);color:var(--t3);margin-left:4px}

/* HEADER SPARKLINE */
.hdr-spgi{display:flex;align-items:center;gap:6px;padding:2px 8px;background:var(--bg2);border:1px solid var(--bdr);border-radius:3px;flex-shrink:0;white-space:nowrap}

/* BREAKING NEWS BANNER */
.breaking-banner{background:linear-gradient(90deg,#1a0000,#330000,#1a0000);border-bottom:2px solid #ff3b30;padding:0;overflow:hidden;animation:bannerIn .4s ease-out}
@keyframes bannerIn{from{max-height:0;opacity:0}to{max-height:60px;opacity:1}}
.breaking-banner .bb-inner{display:flex;align-items:center;gap:8px;padding:6px 12px;min-height:36px;overflow:hidden}
.breaking-banner .bb-pulse{width:8px;height:8px;border-radius:50%;background:#ff3b30;animation:bbpulse 1.2s ease-in-out infinite;flex-shrink:0}
@keyframes bbpulse{0%,100%{box-shadow:0 0 4px #ff3b30}50%{box-shadow:0 0 16px #ff3b30,0 0 30px rgba(255,59,48,.4)}}
.breaking-banner .bb-tag{font:700 9px var(--mono);color:#ff3b30;letter-spacing:1.5px;text-transform:uppercase;flex-shrink:0;padding:2px 8px;border:1px solid rgba(255,59,48,.4);border-radius:2px;background:rgba(255,59,48,.12)}
.breaking-banner .bb-headline{font:600 11px/1.3 'Inter',sans-serif;color:#ff6b6b;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.breaking-banner .bb-headline a{color:#ff6b6b;text-decoration:none}
.breaking-banner .bb-headline a:hover{color:#ff9999;text-decoration:underline}
.breaking-banner .bb-sources{font:400 9px var(--mono);color:var(--t3);flex-shrink:0;white-space:nowrap}
.breaking-banner .bb-time{font:400 9px var(--mono);color:var(--t3);flex-shrink:0}
.breaking-banner .bb-dismiss{background:none;border:1px solid rgba(255,59,48,.3);color:var(--t3);font:400 10px var(--mono);cursor:pointer;padding:2px 6px;border-radius:2px;flex-shrink:0}
.breaking-banner .bb-dismiss:hover{color:var(--t1);border-color:var(--t3)}

/* INTEL SEARCH */
.isrch{display:flex;align-items:center;gap:6px;padding:4px 12px;background:var(--bg2);border-bottom:1px solid var(--bdr)}
.isrch input{flex:1;background:var(--card);border:1px solid var(--bdr);border-radius:3px;padding:4px 8px;font:400 10px var(--mono);color:var(--t1);outline:none}
.isrch input::placeholder{color:var(--t3)}
.isrch input:focus{border-color:var(--red)}
.isrch button{background:var(--red);color:#fff;border:none;border-radius:3px;padding:4px 10px;font:600 9px var(--mono);cursor:pointer;letter-spacing:.5px}
.isrch button:hover{opacity:.85}
.isrch .clear{background:transparent;color:var(--t3);border:1px solid var(--bdr);padding:4px 8px}

/* INTEL FEED */
.fi{padding:8px 0;border-bottom:1px solid var(--bdr)}.fi:last-child{border-bottom:none}
.fi:hover{background:var(--bg2);margin:0 -12px;padding:8px 12px}
.fit{display:flex;align-items:center;gap:5px;margin-bottom:3px;overflow:hidden}
.fis{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.fitg{font:500 8px var(--mono);padding:1px 5px;border-radius:2px;text-transform:uppercase;letter-spacing:.5px;flex-shrink:0;white-space:nowrap}
.fitm{font:400 9px var(--mono);color:var(--t3);margin-left:auto;flex-shrink:0;white-space:nowrap}
.fitt{font:500 11px/1.4 'Inter',sans-serif;color:var(--t1);overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.fisu{font:400 10px 'Inter',sans-serif;color:var(--t3);margin-top:2px}

/* MARKET */
.mr{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(34,34,34,.5);font:400 11px var(--mono)}
.mr:last-child{border-bottom:none}
.mrs{color:var(--t1);font-weight:500;width:65px}.mrp{color:var(--t1);width:65px;text-align:right}.mrc{width:60px;text-align:right;font-size:10px}
.msec{padding:6px 12px;font:600 9px var(--mono);color:var(--red);letter-spacing:1.5px;text-transform:uppercase;background:var(--bg2);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:1}

/* CHART TABS */
.ctabs{display:flex;gap:4px;margin-bottom:8px}
.ct{font:500 9px var(--mono);padding:3px 8px;border-radius:2px;border:1px solid var(--bdr);background:transparent;color:var(--t3);cursor:pointer;letter-spacing:.5px;transition:all .15s}
.ct.a{background:var(--redbg);border-color:rgba(255,59,48,.4);color:var(--red)}.ct:hover{border-color:var(--bdrh)}

/* TOOLTIP */
.tt{position:fixed;background:var(--bg2);border:1px solid var(--bdrh);border-radius:4px;padding:8px 12px;z-index:200;pointer-events:none;max-width:280px;box-shadow:0 4px 20px rgba(0,0,0,.6)}
.tt h5{font:600 11px 'Inter',sans-serif;margin-bottom:3px}.tt p{font:400 10px 'Inter',sans-serif;color:var(--t2);line-height:1.4}

/* REGIONAL */
.rr{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--bdr);font:400 10px var(--mono)}
.rr:last-child{border-bottom:none}

/* ALERT FLASH */
.alert-flash{position:fixed;top:55px;left:0;right:0;background:var(--bg2);border-bottom:3px solid;padding:10px 16px;z-index:150;animation:alertSlide .3s ease-out;font:500 11px Inter,sans-serif;color:var(--t1);box-shadow:0 2px 10px rgba(0,0,0,.4)}
.alert-flash.alert-red{border-bottom-color:#ff3b30;background:rgba(255,59,48,0.08)}
.alert-flash.alert-orange{border-bottom-color:#ff9500;background:rgba(255,149,0,0.08)}
.alert-flash.alert-yellow{border-bottom-color:#ffd60a;background:rgba(255,214,10,0.08)}
@keyframes alertSlide{from{transform:translateY(-100%);opacity:0}to{transform:translateY(0);opacity:1}}

/* COUNTRY BRIEF PANEL */
.country-brief{position:fixed;right:12px;top:80px;width:340px;max-height:calc(100vh - 100px);background:var(--bg2);border:1px solid var(--bdr);border-radius:6px;box-shadow:0 8px 32px rgba(0,0,0,.6);overflow-y:auto;z-index:140;animation:briefSlide .3s ease-out;font-family:Inter,sans-serif}
@keyframes briefSlide{from{transform:translateX(360px);opacity:0}to{transform:translateX(0);opacity:1}}
.country-brief-header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--bdr);gap:8px}
.country-brief-title{font:700 13px var(--mono);color:var(--t1)}
.country-brief-level{font:700 10px var(--mono);padding:2px 6px;border-radius:2px;text-transform:uppercase;letter-spacing:.5px}
.country-brief-close{background:none;border:none;color:var(--t3);cursor:pointer;font:700 16px var(--mono);padding:0}
.country-brief-close:hover{color:var(--t1)}
.country-brief-content{padding:12px}
.cb-section{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--bdr)}
.cb-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.cb-section-title{font:600 10px var(--mono);color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.cb-item{font:400 9px Inter,sans-serif;color:var(--t2);line-height:1.5;margin-bottom:4px}
.cb-item:last-child{margin-bottom:0}
.cb-desc{font:400 10px Inter,sans-serif;color:var(--t1);line-height:1.4}

/* THEME TOGGLE */
.theme-toggle{background:transparent;border:1px solid var(--bdr);color:var(--t2);padding:3px 8px;border-radius:3px;cursor:pointer;font:500 11px var(--mono);transition:all .2s;margin-left:8px}
.theme-toggle:hover{border-color:var(--bdrh);color:var(--t1)}
.adv-tog{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;user-select:none;border-radius:2px;flex-direction:column;position:relative}
.adv-tog:hover{filter:brightness(1.3)}
.adv-tog.off{opacity:0.25;filter:grayscale(1)}
.adv-tog::after{content:'';position:absolute;bottom:0;left:20%;right:20%;height:2px;border-radius:1px;transition:all .2s}
.adv-tog.on::after{background:currentColor;opacity:0.6}
.adv-tog.off::after{background:var(--t3);opacity:0.15}
.adv-tooltip{background:rgba(0,0,0,0.9)!important;color:#fff!important;border:1px solid rgba(255,255,255,0.2)!important;border-radius:3px!important;font:500 10px 'JetBrains Mono',monospace!important;padding:6px 10px!important;box-shadow:0 2px 8px rgba(0,0,0,0.4)!important;pointer-events:auto!important;max-width:260px!important}
.adv-tooltip::before{border-top-color:rgba(0,0,0,0.9)!important}
.adv-tooltip a{pointer-events:auto!important;display:inline-block;margin-top:2px}
.marker-cluster{background:rgba(0,0,0,0.5)!important;border:2px solid rgba(255,255,255,0.3)!important}
.marker-cluster div{background:rgba(0,0,0,0.7)!important;color:#fff!important;font:600 11px var(--mono)!important}
.marker-cluster-small{background:rgba(255,149,0,0.3)!important;border-color:rgba(255,149,0,0.5)!important}
.marker-cluster-small div{background:rgba(255,149,0,0.6)!important}
.marker-cluster-medium{background:rgba(255,59,48,0.3)!important;border-color:rgba(255,59,48,0.5)!important}
.marker-cluster-medium div{background:rgba(255,59,48,0.6)!important}
.marker-cluster-large{background:rgba(255,59,48,0.4)!important;border-color:rgba(255,59,48,0.7)!important}
.marker-cluster-large div{background:rgba(255,59,48,0.8)!important}
.brief-btn{background:rgba(10,132,255,.12);border:1px solid rgba(10,132,255,.4);color:#0a84ff;padding:3px 8px;border-radius:3px;cursor:pointer;font:600 9px var(--mono);letter-spacing:.5px;transition:all .2s;white-space:nowrap;flex-shrink:0}
.brief-btn:hover{background:rgba(10,132,255,.25);color:#4da6ff}
.brief-btn:disabled{opacity:.5;cursor:wait}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useMemo}=React;

/* ═══ MINI SVG CHART COMPONENTS ═══ */
const Sparkline=({data,dataKey,w=200,h=60,color='#30d158',fill=true,showAxis=false})=>{
  const vals=data.map(d=>d[dataKey]);
  const mn=Math.min(...vals),mx=Math.max(...vals);
  const range=mx-mn||1;
  const pad=4;
  const pts=vals.map((v,i)=>{
    const x=pad+(i/(vals.length-1))*(w-pad*2);
    const y=pad+((mx-v)/range)*(h-pad*2);
    return `${x},${y}`;
  });
  const line=pts.join(' ');
  const areaPath=`M${pts[0]} L${line.replace(/,/g,' ').split(' L').join(' L')} L${pad+(vals.length-1)/(vals.length-1)*(w-pad*2)},${h} L${pad},${h} Z`;
  const polyline=pts.join(' ');
  const gradId='g'+Math.random().toString(36).slice(2,8);
  return(
    <svg width="100%" height={h} viewBox={`0 0 ${w} ${h}`} preserveAspectRatio="none">
      {fill&&<defs><linearGradient id={gradId} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={color} stopOpacity=".25"/><stop offset="100%" stopColor={color} stopOpacity="0"/></linearGradient></defs>}
      {fill&&<polygon points={`${pts[0]} ${polyline} ${pad+(vals.length-1)/(vals.length-1)*(w-pad*2)},${h-pad} ${pad},${h-pad}`} fill={`url(#${gradId})`}/>}
      <polyline points={polyline} fill="none" stroke={color} strokeWidth="1.5" strokeLinejoin="round" strokeLinecap="round"/>
    </svg>
  );
};

const AreaChartSVG=({data,keys,colors,w=400,h=180,labels})=>{
  const allVals=keys.flatMap(k=>data.map(d=>d[k]));
  const mx=Math.max(...allVals),mn=0;
  const range=mx-mn||1;
  const pad={t:10,r:10,b:24,l:32};
  const cw=w-pad.l-pad.r,ch=h-pad.t-pad.b;
  const toX=i=>pad.l+(i/(data.length-1))*cw;
  const toY=v=>pad.t+((mx-v)/range)*ch;
  return(
    <svg width="100%" viewBox={`0 0 ${w} ${h}`} style={{display:'block'}}>
      {/* grid */}
      {[0,.25,.5,.75,1].map((f,i)=>{
        const y=pad.t+f*ch;
        const v=Math.round(mx-(f*range));
        return <g key={i}><line x1={pad.l} y1={y} x2={w-pad.r} y2={y} stroke="#1a1a1a" strokeWidth=".5"/><text x={pad.l-4} y={y+3} fill="#666" fontSize="8" fontFamily="JetBrains Mono" textAnchor="end">{v}</text></g>;
      })}
      {/* x labels */}
      {data.map((d,i)=><text key={i} x={toX(i)} y={h-4} fill="#666" fontSize="8" fontFamily="JetBrains Mono" textAnchor="middle">{d.d||d.month||''}</text>)}
      {/* areas + lines */}
      {keys.map((k,ki)=>{
        const pts=data.map((d,i)=>`${toX(i)},${toY(d[k])}`).join(' ');
        const gid='ac'+ki+Math.random().toString(36).slice(2,6);
        return <g key={k}>
          <defs><linearGradient id={gid} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={colors[ki]} stopOpacity=".15"/><stop offset="100%" stopColor={colors[ki]} stopOpacity="0"/></linearGradient></defs>
          <polygon points={`${toX(0)},${toY(0)} ${pts} ${toX(data.length-1)},${toY(0)}`} fill={`url(#${gid})`}/>
          <polyline points={pts} fill="none" stroke={colors[ki]} strokeWidth="1.5" strokeLinejoin="round"/>
        </g>;
      })}
    </svg>
  );
};

/* ═══ DATA ═══ */
const TICKERS=[
  {s:'SPGI',p:'404.78',c:'-3.04%',u:false},{s:'ES1',p:'5,954',c:'-0.07%',u:false},{s:'NQ1',p:'21,220',c:'-0.14%',u:false},
  {s:'DXY',p:'97.69',c:'-0.22%',u:false},{s:'GC1',p:'5,228',c:'+2.90%',u:true},{s:'CL1',p:'65.97',c:'-0.80%',u:false},
  {s:'US10Y',p:'4.010',c:'-6bp',u:false},{s:'VIX',p:'21.11',c:'+10.58%',u:true},{s:'BTC',p:'64,762',c:'-3.92%',u:false},
  {s:'EUR',p:'1.1820',c:'+0.31%',u:true},{s:'GBP',p:'1.3519',c:'+0.26%',u:true},{s:'JPY',p:'148.50',c:'-0.45%',u:false},
  {s:'NG1',p:'3.088',c:'-2.03%',u:false},{s:'HG1',p:'5.90',c:'-1.65%',u:false},{s:'W1',p:'572.00',c:'+2.27%',u:true},
];

/* Advisory level colors & labels */
const ADV_COLORS={4:'#ff3b30',3:'#ff9500',2:'#ffd60a',1:'#30d158'};
const ADV_LABELS={4:'DO NOT TRAVEL',3:'RECONSIDER TRAVEL',2:'EXERCISE INCREASED CAUTION',1:'EXERCISE NORMAL PRECAUTIONS'};
const ADV_SHORT={4:'L4 — DNT',3:'L3 — RECONSIDER',2:'L2 — CAUTION',1:'L1 — NORMAL'};

/* Country risk rating RSS */
const RATING_RSS_QUERIES=[
  'sovereign+credit+rating+downgrade+upgrade+Moody+Fitch+%22S%26P%22',
  'country+rating+outlook+negative+positive+watch+sovereign',
];

/* Current fallback — Level 4 Do Not Travel (as of Feb 2026, State Dept) */
const ADV_FALLBACK=[
  {country:'Afghanistan',level:4,title:'Afghanistan — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/afghanistan-travel-advisory.html',desc:'Terrorism, wrongful detention, kidnapping'},
  {country:'Ukraine',level:4,title:'Ukraine — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/ukraine-travel-advisory.html',desc:'Armed conflict with Russia, civil unrest'},
  {country:'Russia',level:4,title:'Russia — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/russia-travel-advisory.html',desc:'Wrongful detention, harassment of US citizens'},
  {country:'Syria',level:4,title:'Syria — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/syria-travel-advisory.html',desc:'Terrorism, civil unrest, kidnapping'},
  {country:'Iran',level:4,title:'Iran — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iran-travel-advisory.html',desc:'Wrongful detention, terrorism, kidnapping'},
  {country:'Iraq',level:4,title:'Iraq — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iraq-travel-advisory.html',desc:'Terrorism, kidnapping, armed conflict'},
  {country:'Yemen',level:4,title:'Yemen — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/yemen-travel-advisory.html',desc:'Civil unrest, terrorism, Houthi activity'},
  {country:'Somalia',level:4,title:'Somalia — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/somalia-travel-advisory.html',desc:'Terrorism, piracy, kidnapping'},
  {country:'Sudan',level:4,title:'Sudan — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/sudan-travel-advisory.html',desc:'Armed conflict, civil unrest, kidnapping'},
  {country:'South Sudan',level:4,title:'South Sudan — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/south-sudan-travel-advisory.html',desc:'Crime, kidnapping, armed conflict'},
  {country:'Libya',level:4,title:'Libya — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/libya-travel-advisory.html',desc:'Crime, terrorism, armed conflict'},
  {country:'Mali',level:4,title:'Mali — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mali-travel-advisory.html',desc:'Crime, terrorism, kidnapping'},
  {country:'Haiti',level:4,title:'Haiti — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/haiti-travel-advisory.html',desc:'Kidnapping, gang violence, civil unrest'},
  {country:'North Korea',level:4,title:'North Korea — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/north-korea-travel-advisory.html',desc:'Wrongful detention, nuclear/missile threat'},
  {country:'Venezuela',level:4,title:'Venezuela — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/venezuela-travel-advisory.html',desc:'Crime, civil unrest, wrongful detention'},
  {country:'Myanmar (Burma)',level:4,title:'Myanmar — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burma-travel-advisory.html',desc:'Civil unrest, armed conflict'},
  {country:'Burkina Faso',level:4,title:'Burkina Faso — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burkina-faso-travel-advisory.html',desc:'Terrorism, crime, kidnapping'},
  {country:'Niger',level:4,title:'Niger — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/niger-travel-advisory.html',desc:'Terrorism, kidnapping'},
  {country:'Central African Republic',level:4,title:'CAR — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/central-african-republic-travel-advisory.html',desc:'Crime, civil unrest, kidnapping'},
  {country:'Belarus',level:4,title:'Belarus — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/belarus-travel-advisory.html',desc:'Wrongful detention, Russia-Ukraine spillover'},
  {country:'Lebanon',level:4,title:'Lebanon — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/lebanon-travel-advisory.html',desc:'Crime, terrorism, Hezbollah activity'},
  {country:'Gaza Strip',level:4,title:'Gaza — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/israel-the-west-bank-and-gaza-travel-advisory.html',desc:'Armed conflict, terrorism'},
  // Level 3 — Reconsider Travel
  {country:'Pakistan',level:3,title:'Pakistan — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism, sectarian violence'},
  {country:'Nigeria',level:3,title:'Nigeria — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, kidnapping'},
  {country:'Honduras',level:3,title:'Honduras — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, kidnapping'},
  {country:'Ethiopia',level:3,title:'Ethiopia — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Civil unrest, armed conflict'},
  {country:'Democratic Republic of the Congo',level:3,title:'DRC — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, armed conflict'},
  {country:'Cameroon',level:3,title:'Cameroon — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, kidnapping'},
  {country:'Chad',level:3,title:'Chad — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, minefields'},
  {country:'Mauritania',level:3,title:'Mauritania — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Guinea-Bissau',level:3,title:'Guinea-Bissau — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, civil unrest'},
  {country:'Bangladesh',level:3,title:'Bangladesh — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, civil unrest'},
  {country:'Guatemala',level:3,title:'Guatemala — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, violence'},
  {country:'Uganda',level:3,title:'Uganda — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Nicaragua',level:3,title:'Nicaragua — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Arbitrary detention, limited healthcare'},
  {country:'Colombia',level:3,title:'Colombia — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, kidnapping'},
  {country:'Israel',level:3,title:'Israel — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/israel-the-west-bank-and-gaza-travel-advisory.html',desc:'Terrorism, civil unrest, armed conflict'},
  // Level 2 — Exercise Increased Caution
  {country:'Kenya',level:2,title:'Kenya — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Mexico',level:2,title:'Mexico — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, kidnapping'},
  {country:'Brazil',level:2,title:'Brazil — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'Egypt',level:2,title:'Egypt — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism'},
  {country:'Turkey',level:2,title:'Turkey — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism, arbitrary detention'},
  {country:'India',level:2,title:'India — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Philippines',level:2,title:'Philippines — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'South Africa',level:2,title:'South Africa — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'Jamaica',level:2,title:'Jamaica — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'China',level:2,title:'China — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Wrongful detention, arbitrary enforcement'},
  {country:'Guinea',level:2,title:'Guinea — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Civil unrest, crime'},
];

/* Polymarket geopolitical search terms — used to find relevant markets */
const POLY_GEO_TERMS=['war','conflict','military','nuclear','invasion','ceasefire','nato','sanctions','coup','assassination','missile','iran','russia','ukraine','china','taiwan','korea','middle east','terrorism','troops','election','president','prime minister','parliament','tariff','embargo','drone','strike','border','refugee','diplomat','treaty','security','geopolit','protest','uprising','regime','dictator','authoritarian','democrat','republic','congress','senate','legislation','indictment','impeach','arrest','detain','hostage','kidnap','cartel','insurgent','rebel','separatist','annexation','occupation','airstrike','casualt','deploy','weapon','cyber','hack','breach','espionage','intelligence','surveillance','climate','hurricane','earthquake','tsunami','pandemic','outbreak','famine'];
const POLY_EXCLUDE=/\b(nba|nfl|mlb|nhl|nascar|ufc|mma|boxing|soccer|football match|premier league|la liga|bundesliga|serie a|ligue 1|champions league|world cup|super bowl|march madness|wimbledon|us open tennis|f1 grand prix|oscar|grammy|emmy|tony award|golden globe|billboard|box office|fashion|vogue|met gala|kardashian|celebrity|influencer|tiktok|youtube|twitch|spotify|netflix|hulu|disney\+|bachelor|bachelorette|love island|survivor|big brother|american idol|crypto price|bitcoin price|bitcoin etf|ethereum price|solana price|memecoin|dogecoin|shiba|pepe coin|nft|defi|airdrop|token launch|ipo price|stock price|earnings beat|revenue target|will .+ win the|who will win|mvp|rookie|playoff|championship|draft pick|transfer fee|album|song|movie|tv show|release date|game of the year|console|playstation|xbox|nintendo|streamer|podcast|book sales|bestseller|real estate|home price|mortgage rate|weather forecast|temperature|rain|snow)\b/i;
const POLY_EXCLUDE_CATS=/^(sports|entertainment|pop culture|music|gaming|crypto|business|science|technology)$/i;
/* Fallback markets if API is unavailable */
const POLY_FALLBACK=[
  {question:'Russia-Ukraine ceasefire in 2026?',yes:0.18,volume:'$12.4M',slug:'russia-ukraine-ceasefire-2026',category:'Geopolitics'},
  {question:'US-Iran military conflict in 2026?',yes:0.14,volume:'$8.2M',slug:'us-iran-military-conflict-2026',category:'Geopolitics'},
  {question:'China military action against Taiwan by 2027?',yes:0.06,volume:'$15.1M',slug:'china-taiwan-military-2027',category:'Geopolitics'},
  {question:'North Korea nuclear test in 2026?',yes:0.22,volume:'$3.8M',slug:'north-korea-nuclear-test-2026',category:'Geopolitics'},
  {question:'NATO Article 5 invoked by 2027?',yes:0.04,volume:'$5.6M',slug:'nato-article-5-2027',category:'Geopolitics'},
  {question:'Israel-Hezbollah ceasefire holds through 2026?',yes:0.42,volume:'$6.9M',slug:'israel-hezbollah-ceasefire-2026',category:'Geopolitics'},
  {question:'New US sanctions on China in 2026?',yes:0.71,volume:'$4.3M',slug:'us-china-sanctions-2026',category:'Geopolitics'},
  {question:'Venezuela military intervention by 2027?',yes:0.05,volume:'$2.1M',slug:'venezuela-intervention-2027',category:'Geopolitics'},
];

const INCIDENTS=[
  {id:19,t:'Mexico — "El Mencho" CJNG Leader Killed, Nationwide Cartel Violence Erupts',sv:'critical',cat:'CONFLICT',reg:'N. America',tm:'NOW',lat:20.3,lon:-103.3,imp:'25 National Guard killed, 250+ roadblocks, 20 states, tourists stranded, Puerto Vallarta airport shut',ty:'Cartel'},
  {id:1,t:'Russian Naval Buildup in Black Sea — NATO Alert Level Raised',sv:'critical',cat:'CONFLICT',reg:'E. Europe',tm:'12m',lat:44,lon:34,imp:'NATO Article 5 consultation triggered',ty:'Military'},
  {id:2,t:'Cat-5 Cyclone Bearing Down on Bay of Bengal — 2.4M at Risk',sv:'critical',cat:'CLIMATE',reg:'S. Asia',tm:'28m',lat:16,lon:87,imp:'$8.2B estimated damage',ty:'Weather'},
  {id:3,t:'Major Ransomware Attack on European Energy Grid Operator',sv:'critical',cat:'CYBER',reg:'W. Europe',tm:'1h',lat:50,lon:8,imp:'3 nations, grid at 60%',ty:'Cyber'},
  {id:4,t:'Taiwan Strait — PLA Air Incursions Reach 52 Sorties in 24h',sv:'critical',cat:'CONFLICT',reg:'E. Asia',tm:'2h',lat:24,lon:121,imp:'Semiconductor supply risk',ty:'Military'},
  {id:5,t:'Strait of Hormuz — Tanker Seized by IRGC Navy',sv:'critical',cat:'ENERGY',reg:'M. East',tm:'3h',lat:26.5,lon:56,imp:'Oil +4.2%, $2.1B/day trade risk',ty:'Maritime'},
  {id:6,t:'Sahel Region — Wagner Group Expands Into 3 New Countries',sv:'high',cat:'CONFLICT',reg:'W. Africa',tm:'4h',lat:14,lon:-2,imp:'Democratic transitions destabilized',ty:'Military'},
  {id:7,t:'Mediterranean Wildfire Season — 340K Ha Across 5 Nations',sv:'high',cat:'CLIMATE',reg:'S. Europe',tm:'5h',lat:38,lon:23,imp:'$3.1B economic impact',ty:'Wildfire'},
  {id:8,t:'North Korea ICBM Test — Trajectory Over Sea of Japan',sv:'critical',cat:'CONFLICT',reg:'E. Asia',tm:'6h',lat:39,lon:127,imp:'UN emergency session called',ty:'WMD'},
  {id:9,t:'Amazon Deforestation Surge — 40% Above 5-Year Average',sv:'high',cat:'CLIMATE',reg:'S. America',tm:'6h',lat:-5,lon:-60,imp:'Carbon sink -12%',ty:'Deforestation'},
  {id:10,t:'US-China Semiconductor Export Controls Expanded',sv:'high',cat:'ECONOMIC',reg:'Global',tm:'8h',lat:39,lon:-77,imp:'$45B bilateral trade affected',ty:'Trade'},
  {id:11,t:'Arctic Permafrost Methane Release Exceeds Models by 40%',sv:'high',cat:'CLIMATE',reg:'Arctic',tm:'10h',lat:72,lon:125,imp:'Tipping point risk elevated',ty:'Emissions'},
  {id:12,t:'Sudan Civil Conflict — 2M New Displacements',sv:'high',cat:'CONFLICT',reg:'E. Africa',tm:'12h',lat:15,lon:32,imp:'Humanitarian crisis, spillover',ty:'Civil War'},
  {id:13,t:'EU Carbon Border Tax Phase 2 — 8 Sectors Added',sv:'medium',cat:'REGULATORY',reg:'Europe',tm:'1d',lat:50,lon:4,imp:'€45B cross-border trade',ty:'Regulatory'},
  {id:14,t:'India-Pakistan Indus Treaty Renegotiation Stalls',sv:'high',cat:'CONFLICT',reg:'S. Asia',tm:'1d',lat:30,lon:72,imp:'300M affected, agriculture risk',ty:'Water'},
  {id:15,t:'Pacific Islands Climate Emergency — Sea Level +18cm',sv:'high',cat:'CLIMATE',reg:'Oceania',tm:'1d',lat:-8,lon:160,imp:'$420M relocation costs',ty:'Sea Level'},
  {id:16,t:'Venezuelan Migration Crisis — 800K Cross to Colombia',sv:'medium',cat:'SOCIAL',reg:'S. America',tm:'1d',lat:7,lon:-72,imp:'$1.2B aid needed',ty:'Migration'},
  {id:17,t:'Chinese Spy Balloon Incursions — 3 Nations Report',sv:'medium',cat:'INTEL',reg:'Global',tm:'2d',lat:45,lon:-100,imp:'Sovereignty concern',ty:'Espionage'},
  {id:18,t:'Gulf of Guinea Piracy — 12 Incidents in 30 Days',sv:'medium',cat:'MARITIME',reg:'W. Africa',tm:'2d',lat:4,lon:3,imp:'$800M insurance spike',ty:'Maritime'},
];

const CC={CONFLICT:'#ff3b30',CLIMATE:'#ff9500',CYBER:'#bf5af2',ECONOMIC:'#0a84ff',ENERGY:'#ffd60a',REGULATORY:'#64d2ff',SOCIAL:'#30d158',INTEL:'#ff375f',MARITIME:'#5ac8fa',HEALTH:'#30d158'};
const SC={critical:'#ff3b30',high:'#ff9500',medium:'#ffd60a',low:'#30d158'};

/* Connection lines between related incidents [fromId, toId, label, color] */
const CONNS=[
  [5,1,'Energy supply chain disruption','#ffd60a'],   // Hormuz → Black Sea
  [4,8,'East Asia escalation corridor','#ff3b30'],     // Taiwan → DPRK
  [1,3,'Hybrid warfare vector','#bf5af2'],             // Black Sea → Cyber EU
  [10,4,'Trade decoupling','#0a84ff'],                 // US-China → Taiwan
  [5,14,'Water-energy nexus','#64d2ff'],               // Hormuz → Indus
  [6,12,'Sahel-Sudan conflict arc','#ff3b30'],         // Sahel → Sudan
];

/* News headlines for live ticker */
const NEWS=[
  {t:'NATO deploys additional carrier group to Eastern Mediterranean amid rising tensions',s:'Reuters',c:'#ff3b30'},
  {t:'Global reinsurance rates surge 18% on back of record climate losses',s:'FT',c:'#ff9500'},
  {t:'CISA warns of critical infrastructure vulnerability in energy sector SCADA systems',s:'CyberScoop',c:'#bf5af2'},
  {t:'World Bank revises global GDP growth forecast down to 2.4% citing geopolitical risk',s:'Bloomberg',c:'#0a84ff'},
  {t:'China conducts live-fire naval exercises in South China Sea for third consecutive week',s:'SCMP',c:'#ff3b30'},
  {t:'European gas storage levels fall below 5-year average ahead of winter season',s:'Platts',c:'#ffd60a'},
  {t:'UN Security Council emergency session on Sahel security deterioration',s:'AP',c:'#ff3b30'},
  {t:'IMF warns sovereign debt risks compounding climate vulnerability in 40 nations',s:'FT',c:'#ff9500'},
  {t:'US Treasury sanctions 12 entities linked to ransomware-as-a-service operations',s:'WSJ',c:'#bf5af2'},
  {t:'Arctic shipping routes see 300% increase in commercial traffic year-over-year',s:'Reuters',c:'#64d2ff'},
  {t:'OPEC+ signals potential output cut extension as demand outlook weakens',s:'Bloomberg',c:'#ffd60a'},
  {t:'S&P Global upgrades defense sector outlook to positive on sustained spending growth',s:'S&P Global',c:'#30d158'},
];

const MKTS={
  'COMMODITIES':[{s:'GC1',n:'Gold',p:'5,228',c:'+2.90%',u:1},{s:'CL1',n:'WTI Crude',p:'65.97',c:'-0.80%',u:0},{s:'NG1',n:'Nat Gas',p:'3.088',c:'-2.03%',u:0},{s:'HG1',n:'Copper',p:'5.90',c:'-1.65%',u:0},{s:'W1',n:'Wheat',p:'572.00',c:'+2.27%',u:1}],
  'FX & RATES':[{s:'DXY',n:'Dollar Idx',p:'97.69',c:'-0.22%',u:0},{s:'EUR',n:'EUR/USD',p:'1.1820',c:'+0.31%',u:1},{s:'US10Y',n:'10Y Yield',p:'4.010%',c:'-6bp',u:0},{s:'US2Y',n:'2Y Yield',p:'3.570%',c:'-7bp',u:0}],
  'CRYPTO':[{s:'BTC',n:'Bitcoin',p:'64,762',c:'-3.92%',u:0},{s:'ETH',n:'Ethereum',p:'2,680',c:'-4.10%',u:0}],
  'DEFENSE & INTEL':[{s:'SPGI',n:'S&P Global',p:'404.78',c:'-3.04%',u:0},{s:'LMT',n:'Lockheed',p:'661.49',c:'+0.42%',u:1},{s:'RTX',n:'RTX Corp',p:'204.81',c:'+0.64%',u:1},{s:'NOC',n:'Northrop',p:'724.83',c:'+3.38%',u:1},{s:'PLTR',n:'Palantir',p:'135.38',c:'+1.77%',u:1}],
};

/* SPGI RSS feed queries */
const SPGI_RSS_QUERIES=[
  '%22S%26P+Global%22+SPGI+earnings+revenue',
  '%22S%26P+Global%22+ratings+credit+Platts',
];

/* Current SPGI news fallback (Feb 2026) */
const SPGI_NEWS_FALLBACK=[
  {t:'S&P Global Reports Q4 & Full-Year 2025 Results — Revenue Up 9% to $3.92B',src:'S&P Global IR',tm:'Feb 10',url:'https://investor.spglobal.com/news-releases/news-details/2026/SP-Global-Reports-Fourth-Quarter-and-Full-Year-2025-Results/default.aspx'},
  {t:'SPGI Stock Drops 17% Premarket After 2026 Guidance Disappoints Analysts',src:'Seeking Alpha',tm:'Feb 10',url:'https://seekingalpha.com/news/4549419-sp-global-stock-drops-after-q4-earnings-2026-guidance-disappoint'},
  {t:'SPGI Up 7.3% — Strong 2025 Results and New Climate-Risk Data Push',src:'Simply Wall St',tm:'Feb 14',url:'https://simplywall.st/stocks/us/diversified-financials/nyse-spgi/sp-global/news/why-sp-global-spgi-is-up-73-after-strong-2025-results-and-ne'},
  {t:'S&P Global Ratings Wins Ratings Provider of the Year — PE Wire Europe Awards',src:'PE Wire',tm:'Feb 12',url:'https://www.stocktitan.net/news/SPGI/s-p-global-ratings-wins-ratings-provider-of-the-year-at-private-g48vy8gp0m8s.html'},
  {t:'S&P Global to Present at Raymond James 47th Institutional Investors Conference',src:'Stock Titan',tm:'Feb 18',url:'https://www.stocktitan.net/news/SPGI/s-p-global-to-present-at-raymond-james-47th-annual-institutional-dsjn8x6nn5cs.html'},
  {t:'S&P Global Energy & Verisk Launch Climate-Risk Data Collaboration for Banks & Insurers',src:'S&P Global',tm:'Feb 2026',url:'https://press.spglobal.com'},
  {t:'Full-Year 2025: Revenue $15.3B (+8%), Adjusted EPS $17.83 (+14%), $12.85B Buyback Complete',src:'S&P Global IR',tm:'Feb 10',url:'https://press.spglobal.com/2026-02-10-S-P-Global-Reports-Fourth-Quarter-and-Full-Year-2025-Results'},
  {t:'2026 Guidance: Reported Revenue Growth 6.6%-8.6%, New CERAWeek Energy Conference Role',src:'S&P Global',tm:'Feb 10',url:'https://investor.spglobal.com'},
];

const TREND={
  '1M':[{d:'W1',geo:72,clim:65,cyb:61,con:74},{d:'W2',geo:74,clim:67,cyb:63,con:76},{d:'W3',geo:75,clim:69,cyb:62,con:79},{d:'W4',geo:78,clim:72,cyb:65,con:83}],
  '6M':[{d:'Sep',geo:68,clim:58,cyb:55,con:65},{d:'Oct',geo:70,clim:62,cyb:58,con:70},{d:'Nov',geo:72,clim:64,cyb:60,con:73},{d:'Dec',geo:74,clim:66,cyb:62,con:76},{d:'Jan',geo:76,clim:70,cyb:64,con:80},{d:'Feb',geo:78,clim:72,cyb:65,con:83}],
  '1Y':[{d:'Mar',geo:60,clim:48,cyb:50,con:55},{d:'May',geo:62,clim:52,cyb:52,con:58},{d:'Jul',geo:65,clim:55,cyb:54,con:62},{d:'Sep',geo:68,clim:58,cyb:55,con:65},{d:'Nov',geo:72,clim:64,cyb:60,con:73},{d:'Feb',geo:78,clim:72,cyb:65,con:83}],
};

const SPGI=[{t:'09:30',p:417.5},{t:'10:00',p:414.2},{t:'10:30',p:411.8},{t:'11:00',p:409.6},{t:'11:30',p:407.3},{t:'12:00',p:406.1},{t:'12:30',p:405.4},{t:'13:00',p:404.2},{t:'13:30',p:403.8},{t:'14:00',p:402.9},{t:'14:30',p:403.5},{t:'15:00',p:404.1},{t:'15:30',p:404.5},{t:'16:00',p:404.78}];

/* (Regional risk now computed from live advisories) */

/* ═══ RSS FEED CONFIG ═══ */
const RSS_FEEDS=[
  // Conflict & military
  {q:'Russia+Ukraine+war+military+frontline',cat:'CONFLICT'},
  {q:'Iran+US+tensions+military+strikes+nuclear',cat:'CONFLICT'},
  {q:'China+Taiwan+military+South+China+Sea',cat:'CONFLICT'},
  {q:'Israel+Gaza+Hamas+Hezbollah+Middle+East+war',cat:'CONFLICT'},
  {q:'NATO+military+defense+troops+deployment',cat:'CONFLICT'},
  {q:'North+Korea+missile+nuclear+ICBM',cat:'CONFLICT'},
  // Climate & disasters
  {q:'climate+disaster+extreme+weather+hurricane+wildfire',cat:'CLIMATE'},
  // Cyber
  {q:'cybersecurity+ransomware+hack+breach+critical+infrastructure',cat:'CYBER'},
  // Economic & sanctions
  {q:'global+economy+sanctions+trade+war+tariff+recession',cat:'ECONOMIC'},
  {q:'US+China+trade+decoupling+semiconductor+sanctions',cat:'ECONOMIC'},
  // Energy
  {q:'oil+energy+crisis+OPEC+pipeline+gas+prices',cat:'ENERGY'},
  // Health / Pandemic
  {q:'pandemic+virus+outbreak+WHO+bird+flu+H5N1+epidemic',cat:'HEALTH'},
  // Terrorism & intel
  {q:'terrorism+intelligence+ISIS+security+threat+espionage',cat:'INTEL'},
];
const PROXY='https://api.rss2json.com/v1/api.json?rss_url=';
// Multi-proxy RSS fetch — tries rss2json first, then allorigins+DOMParser fallback
async function rssFetch(feedUrl){
  // Method 1: rss2json (returns JSON directly)
  try{
    var res=await fetch(PROXY+encodeURIComponent(feedUrl),{signal:AbortSignal.timeout(8000)});
    if(res.ok){var data=await res.json();if(data.items&&data.items.length>0)return data;}
  }catch(e){}
  // Method 2: allorigins raw XML → parse with DOMParser
  try{
    var res2=await fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(feedUrl),{signal:AbortSignal.timeout(8000)});
    if(res2.ok){
      var xml=await res2.text();
      var doc=new DOMParser().parseFromString(xml,'text/xml');
      var entries=doc.querySelectorAll('item, entry');
      if(entries.length>0){
        var items=[];
        entries.forEach(function(el){
          var title=el.querySelector('title')?el.querySelector('title').textContent:'';
          var link=el.querySelector('link')?el.querySelector('link').textContent||el.querySelector('link').getAttribute('href'):'';
          var pubDate=el.querySelector('pubDate, published, updated')?el.querySelector('pubDate, published, updated').textContent:'';
          var desc=el.querySelector('description, summary, content')?el.querySelector('description, summary, content').textContent:'';
          items.push({title:title,link:link,pubDate:pubDate,description:desc,guid:link});
        });
        return{items:items};
      }
    }
  }catch(e){}
  // Method 3: corsproxy.org raw XML
  try{
    var res3=await fetch('https://corsproxy.org/?'+encodeURIComponent(feedUrl),{signal:AbortSignal.timeout(8000)});
    if(res3.ok){
      var xml3=await res3.text();
      var doc3=new DOMParser().parseFromString(xml3,'text/xml');
      var entries3=doc3.querySelectorAll('item, entry');
      if(entries3.length>0){
        var items3=[];
        entries3.forEach(function(el){
          var title=el.querySelector('title')?el.querySelector('title').textContent:'';
          var link=el.querySelector('link')?el.querySelector('link').textContent||el.querySelector('link').getAttribute('href'):'';
          var pubDate=el.querySelector('pubDate, published, updated')?el.querySelector('pubDate, published, updated').textContent:'';
          var desc=el.querySelector('description, summary, content')?el.querySelector('description, summary, content').textContent:'';
          items3.push({title:title,link:link,pubDate:pubDate,description:desc,guid:link});
        });
        return{items:items3};
      }
    }
  }catch(e){}
  return{items:[]};
}
const catKeywords={
  CONFLICT:['war','military','nato','conflict','troops','missile','attack','invasion','defense','army','weapon','strike','ukraine','russia','frontline','battalion','airstrike','drone strike','ceasefire','escalation','iran','hezbollah','hamas','gaza','israel','taiwan','korea','artillery','casualties'],
  CLIMATE:['climate','flood','wildfire','hurricane','drought','emissions','carbon','warming','sea level','storm','heat','ice','snow','blizzard','cyclone','typhoon','earthquake','tornado','fire','weather'],
  CYBER:['cyber','ransomware','hack','breach','malware','vulnerability','phishing','data leak','cisa','zero-day','ddos','spyware','critical infrastructure'],
  ECONOMIC:['economy','gdp','trade','tariff','inflation','recession','debt','imf','world bank','fiscal','monetary','sanctions','decoupling','semiconductor','stock market','currency','default'],
  ENERGY:['oil','gas','opec','energy','pipeline','refinery','nuclear','solar','wind','grid','fuel','petroleum','lng','electricity','power plant','crude'],
  HEALTH:['pandemic','epidemic','virus','outbreak','who','h5n1','bird flu','covid','disease','vaccine','pathogen','quarantine','health emergency','mpox','ebola'],
  INTEL:['intelligence','espionage','spy','terrorism','isis','al-qaeda','cia','fbi','mi6','surveillance','threat assessment','counterterrorism','mossad'],
  REGULATORY:['regulation','eu','law','compliance','legislation','tax','ban','policy','mandate','rule'],
};
function classifyHeadline(title){
  const t=title.toLowerCase();
  let best='CONFLICT',score=0;
  for(const[cat,kws]of Object.entries(catKeywords)){
    const s=kws.filter(k=>t.includes(k)).length;
    if(s>score){score=s;best=cat;}
  }
  return best;
}
// Decode HTML entities from RSS/API responses (e.g. &amp; → &, &#39; → ')
function decEnt(s){
  if(!s||typeof s!=='string')return s||'';
  return s.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#x27;/g,"'").replace(/&apos;/g,"'").replace(/&#(\d+);/g,function(_,n){return String.fromCharCode(n);});
}
function timeAgo(dateStr){
  if(!dateStr)return 'Active';
  // Handle various date formats: ISO, FAA (MM/DD/YYYY HH:MM), epoch ms, YYYYMMDDHHMMSS
  var d;
  if(typeof dateStr==='number')d=new Date(dateStr);
  else if(/^\d{12,14}$/.test(dateStr))d=new Date(dateStr.slice(0,4)+'-'+dateStr.slice(4,6)+'-'+dateStr.slice(6,8)+'T'+dateStr.slice(8,10)+':'+dateStr.slice(10,12)+':00Z');
  else if(/^\d{4}\/\d{2}\/\d{2}/.test(dateStr))d=new Date(dateStr.replace(/\//g,'-'));
  else d=new Date(dateStr);
  if(!d||isNaN(d.getTime()))return 'Active';
  var now=new Date();var mins=Math.floor((now-d)/60000);
  if(mins<0)return 'Just now';
  if(mins<60)return mins+'m ago';
  var hrs=Math.floor(mins/60);if(hrs<24)return hrs+'h ago';
  return Math.floor(hrs/24)+'d ago';
}
// Humanize raw NOTAM ICAO text into readable English
function humanizeNotam(raw){
  if(!raw||raw.length<5)return raw||'';
  var t=raw;
  // Common ICAO abbreviations → plain English
  t=t.replace(/\bCLSD\b/gi,'CLOSED');t=t.replace(/\bDUE TO\b/gi,'due to');
  t=t.replace(/\bOPS\b/gi,'operations');t=t.replace(/\bMIL\b/gi,'military');
  t=t.replace(/\bACFT\b/gi,'aircraft');t=t.replace(/\bFLT\b/gi,'flight');
  t=t.replace(/\bRWY\b/gi,'Runway');t=t.replace(/\bTWY\b/gi,'Taxiway');
  t=t.replace(/\bSFC\b/gi,'surface');t=t.replace(/\bUNL\b/gi,'unlimited');
  t=t.replace(/\bABV\b/gi,'above');t=t.replace(/\bBLW\b/gi,'below');
  t=t.replace(/\bEFF\b/gi,'effective');t=t.replace(/\bTIL\b/gi,'until');
  t=t.replace(/\bUFN\b/gi,'further notice');t=t.replace(/\bPJE\b/gi,'parachute jumping');
  t=t.replace(/\bNAV\b/gi,'navigation');t=t.replace(/\bSVCE?\b/gi,'service');
  t=t.replace(/\bUNSVCBL\b/gi,'unserviceable');t=t.replace(/\bINOP\b/gi,'inoperative');
  t=t.replace(/\bU\/S\b/gi,'unserviceable');t=t.replace(/\bAP\b/gi,'airport');
  t=t.replace(/\bAD\b/gi,'aerodrome');t=t.replace(/\bFIR\b/gi,'Flight Information Region');
  t=t.replace(/\bUIR\b/gi,'Upper Information Region');
  t=t.replace(/\bTFR\b/gi,'Temporary Flight Restriction');
  t=t.replace(/\bGNSS\b/gi,'GPS/GNSS');t=t.replace(/\bIAMG\b/gi,'Iranian-aligned militia');
  t=t.replace(/\bUAS\b/gi,'drone');t=t.replace(/\bRPAS\b/gi,'drone');
  t=t.replace(/\bSEC\b/gi,'security');t=t.replace(/\bHAZ\b/gi,'hazard');
  t=t.replace(/\bWIP\b/gi,'work in progress');t=t.replace(/\bCTN\b/gi,'caution');
  t=t.replace(/\bEMERG\b/gi,'emergency');t=t.replace(/\bPROHIB\b/gi,'prohibited');
  t=t.replace(/\bFL(\d+)/g,function(_,n){return n+'00ft (~'+Math.round(n*100*0.3048/1000)+'km alt)';});
  // Clean up excessive whitespace/newlines
  t=t.replace(/\s+/g,' ').trim();
  // Sentence case — first letter upper, rest preserved
  if(t.length>0)t=t.charAt(0).toUpperCase()+t.slice(1);
  return t;
}

/* ═══ WEATHER ALERTS (current real events — Feb 23, 2026) ═══ */
const WEATHER_FALLBACK=[
  {sev:'extreme',type:'Flooding',title:'Indonesia — Severe Flooding Across Bali & Java',detail:'Heavy monsoon rainfall triggers flash floods and landslides. Thousands displaced across Bali, East Java. Infrastructure damage, road closures, evacuations underway.',time:'Recent',icon:'🌊',url:'https://reliefweb.int/country/idn'},
  {sev:'extreme',type:'Blizzard',title:'Northeast US — Historic Blizzard, States of Emergency Declared',detail:'2ft+ snow across I-95 corridor. 8,000+ flights cancelled. Travel bans in NY, NJ, New England. National Guard activated.',time:'Feb 2026',icon:'❄️',url:'https://www.weather.gov'},
  {sev:'severe',type:'Cyclone',title:'Tropical Cyclone Gezani — Madagascar, Mozambique Devastated',detail:'175 km/h winds. 25,000+ houses destroyed in Madagascar. Severe flooding across southern Mozambique and Malawi.',time:'Feb 2026',icon:'🌀',url:'https://reliefweb.int/country/mdg'},
  {sev:'severe',type:'Flooding',title:'Colombia & Central America — Persistent Landslides, Flooding',detail:'La Niña-driven heavy rainfall. Landslides in western Colombia. Costa Rica mudslides. Thousands evacuated across region.',time:'Ongoing',icon:'🌊',url:'https://reliefweb.int/country/col'},
  {sev:'severe',type:'Earthquake',title:'Turkey/Syria Border Region — Seismic Activity Continues',detail:'Ongoing aftershock sequences. Elevated seismic risk across Hatay, Kahramanmaras provinces. USGS monitoring.',time:'Ongoing',icon:'🫨',url:'https://earthquake.usgs.gov'},
  {sev:'moderate',type:'Drought',title:'East Africa — Severe Drought, Food Insecurity Escalating',detail:'Horn of Africa drought worsening. Ethiopia, Kenya, Somalia affected. Crop failure and water shortages. UN humanitarian response ongoing.',time:'Ongoing',icon:'☀️',url:'https://fews.net/east-africa'},
  {sev:'moderate',type:'Drought',title:'Central Asia — Drought Emergency, Water Shortages',detail:'Rainfall deficit since October. Kyrgyzstan, Tajikistan, Afghanistan, Turkmenistan facing severe water stress. Agricultural impact.',time:'Ongoing',icon:'☀️',url:'https://fews.net/central-asia'},
  {sev:'severe',type:'Wildfire',title:'Australia — Bushfire Season Intensifying Across Eastern States',detail:'Extreme fire danger ratings in NSW and Queensland. Multiple uncontrolled fires. Evacuations in rural communities.',time:'Recent',icon:'🔥',url:'https://www.rfs.nsw.gov.au/fire-information/fires-near-me'},
  {sev:'severe',type:'Typhoon',title:'Western Pacific — Enhanced Typhoon Activity Forecast',detail:'Warm sea surface temperatures driving above-average cyclone formation. Philippines, Japan, Taiwan on alert.',time:'Outlook',icon:'🌀',url:'https://www.metoc.navy.mil/jtwc/jtwc.html'},
  {sev:'watch',type:'Outlook',title:'Southern Hemisphere Cyclone Season — Active Through April',detail:'Multiple tropical systems expected across Indian Ocean, Coral Sea. Australia, Fiji, Madagascar at elevated risk.',time:'Outlook',icon:'⚠️',url:'https://www.metoc.navy.mil/jtwc/jtwc.html'},
];

const NOTAM_FALLBACK=[
  {id:'A0095/25',zone:'Ukraine — All Airspace',status:'PROHIBITED',detail:'Complete airspace closure, all altitudes. Armed conflict since Feb 2022. No civilian flights permitted.',color:'#ff3b30',time:'Active'},
  {id:'A0131/26',zone:'Iraq — Baghdad Region',status:'RESTRICTED',detail:'Flights below 32,000ft prohibited. Militia drone and missile threat. GPS spoofing reported. US and EU restrictions active.',color:'#ff9500',time:'Active'},
  {id:'A0561/26',zone:'Sudan — Khartoum Region',status:'PROHIBITED',detail:'All altitudes closed. Khartoum airport destroyed. Armed conflict. No air traffic control available.',color:'#ff3b30',time:'Active'},
  {id:'SFAR117',zone:'Iran — Tehran Region',status:'PROHIBITED',detail:'All US civil flights prohibited (FAA SFAR 117). European safety warning active. Full airspace ban.',color:'#ff3b30',time:'Active'},
  {id:'A0001/21',zone:'Pakistan — Islamabad/Lahore',status:'WARNING',detail:'Heightened security alert. Islamabad mosque attack Feb 6. Pakistan airstrikes into Afghanistan Feb 22.',color:'#ff9500',time:'2d ago'},
  {id:'W0120/21',zone:'Saudi Arabia — Yemen Border',status:'RESTRICTED',detail:'Active military operations. Houthi drone and missile threat. Asir, Jizan, Najran provinces affected.',color:'#ff9500',time:'Active'},
  {id:'FZNA/25',zone:'DR Congo — Eastern/Goma',status:'RESTRICTED',detail:'200-mile eastern border restriction. Goma airport closed. Anti-aircraft weapon risk from armed groups.',color:'#ff9500',time:'Active'},
  {id:'A0334/26',zone:'Sahel Region — West Africa',status:'WARNING',detail:'High-altitude flights only (above 32,000ft). Military shoot-down threat. Wagner Group air defense active.',color:'#ffd60a',time:'Active'},
  {id:'KICZ/26',zone:'Eastern Pacific Ocean',status:'WARNING',detail:'FAA advisory: GPS interference and military activity. Active Jan 16 through Mar 17, 2026.',color:'#ffd60a',time:'Active'},
];

const WX_SEV_COLORS={extreme:'#ff3b30',severe:'#ff9500',moderate:'#ffd60a',watch:'#64d2ff'};
const NOTAM_STATUS_COLORS={PROHIBITED:'#ff3b30',RESTRICTED:'#ff9500',WARNING:'#ffd60a'};

/* ═══ APP ═══ */
function App(){
  const[time,setTime]=useState(new Date());
  const[mf,setMf]=useState('ALL');
  const[tt,setTt]=useState(null);
  const[tp,setTp]=useState('6M');
  const[liveNews,setLiveNews]=useState([]);
  const[feedStatus,setFeedStatus]=useState('loading');
  const[wxAlerts,setWxAlerts]=useState(WEATHER_FALLBACK);
  const[notams,setNotams]=useState(NOTAM_FALLBACK);
  const[wxLive,setWxLive]=useState(false);
  const[spgiNews,setSpgiNews]=useState([]);
  const[spgiNewsLive,setSpgiNewsLive]=useState(false);
  const[advisories,setAdvisories]=useState(ADV_FALLBACK);
  const[advLive,setAdvLive]=useState(false);
  const[polyMarkets,setPolyMarkets]=useState([]);
  const[polyLive,setPolyLive]=useState(false);
  const[notamLive,setNotamLive]=useState(false);
  const[searchQuery,setSearchQuery]=useState('');
  const[searchResults,setSearchResults]=useState([]);
  const[searching,setSearching]=useState(false);
  const[breakingNews,setBreakingNews]=useState(null);
  const[bannerDismissed,setBannerDismissed]=useState(null);
  const[livePrices,setLivePrices]=useState({});
  const[spgiIntraday,setSpgiIntraday]=useState(SPGI);
  const[geoData,setGeoData]=useState(null);
  const[countryBrief,setCountryBrief]=useState(null);
  const[alertQueue,setAlertQueue]=useState([]);
  const[darkMode,setDarkMode]=useState(true);
  const[advFilter,setAdvFilter]=useState(new Set([3,4]));
  const geoLayerRef=useRef(null);
  const advMarkersRef=useRef([]);

  // Fetch US State Dept Travel Advisories
  const fetchAdvisories=async()=>{
    // Always load curated fallback first (no stale closure dependency)
    setAdvisories(function(prev){return prev.length>0?prev:ADV_FALLBACK;});
    // Try State Dept travel advisory RSS via proxy
    try{
      var data=await rssFetch('https://travel.state.gov/_res/rss/TAsTWs.xml');
      if(data.items&&data.items.length>5){
        var parsed=data.items.map(function(item){
          var _tit=decEnt(item.title||'');
          var lvl=4;
          if(/Level 3/i.test(_tit))lvl=3;
          else if(/Level 2/i.test(_tit))lvl=2;
          else if(/Level 1/i.test(_tit))lvl=1;
          var country=_tit.replace(/\s*[-–—]\s*Level \d.*/i,'').trim();
          return{country:country,level:lvl,title:_tit,date:new Date(item.pubDate),url:item.link||item.guid||'https://travel.state.gov',desc:item.description?decEnt(item.description.replace(/<[^>]*>/g,'').slice(0,80)):'Travel Advisory'};
        });
        // Sort: Level 4 first, then 3, then 2
        parsed.sort(function(a,b){return b.level-a.level||b.date-a.date;});
        // Only keep Level 2-4
        var filtered=parsed.filter(function(a){return a.level>=2;});
        if(filtered.length>5){setAdvisories(filtered);setAdvLive(true);return;}
      }
    }catch(e){}
    setAdvisories(ADV_FALLBACK);setAdvLive(true);
  };

  // Fetch sovereign credit rating changes
  // Fetch Polymarket geopolitical prediction markets
  const fetchPolymarkets=async()=>{
    if(polyMarkets.length===0)setPolyMarkets(POLY_FALLBACK);
    try{
      // Gamma API — public, no auth needed. Try direct first (has CORS), then proxy.
      // Use /events endpoint — event slugs work in polymarket.com/event/{slug} URLs
      var baseUrl='https://gamma-api.polymarket.com/events?active=true&closed=false&limit=80&order=volume&ascending=false';
      var resp=null;
      try{
        var controller=new AbortController();
        var tm=setTimeout(function(){controller.abort();},8000);
        resp=await fetch(baseUrl,{signal:controller.signal});
        clearTimeout(tm);
        if(!resp.ok)resp=null;
      }catch(e){resp=null;}
      if(!resp){
        try{
          var proxyUrl='https://corsproxy.io/?'+encodeURIComponent(baseUrl);
          var controller2=new AbortController();
          var tm2=setTimeout(function(){controller2.abort();},8000);
          resp=await fetch(proxyUrl,{signal:controller2.signal});
          clearTimeout(tm2);
          if(!resp.ok)resp=null;
        }catch(e){resp=null;}
      }
      if(!resp){setPolyMarkets(POLY_FALLBACK);setPolyLive(true);return;}
      var allEvents=await resp.json();
      if(!Array.isArray(allEvents)||allEvents.length===0){setPolyMarkets(POLY_FALLBACK);setPolyLive(true);return;}
      // Filter for geopolitical/security/politics events
      var geoEvents=allEvents.filter(function(ev){
        var title=(ev.title||ev.question||'');
        var desc=(ev.description||'');
        var cat=(ev.category||'').trim();
        var q=title+' '+desc;
        if(POLY_EXCLUDE_CATS.test(cat))return false;
        if(POLY_EXCLUDE.test(q))return false;
        var ql=q.toLowerCase()+' '+cat.toLowerCase();
        if(POLY_GEO_TERMS.some(function(term){return ql.indexOf(term)!==-1;}))return true;
        var catl=cat.toLowerCase();
        if(catl==='politics'||catl==='world'||catl==='geopolitics'||catl==='climate')return true;
        return false;
      });
      // Parse events — extract top market from each event for the probability
      var items=geoEvents.slice(0,12).map(function(ev){
        var markets=ev.markets||[];
        var topMarket=markets[0]||{};
        var prices=[];
        try{prices=JSON.parse(topMarket.outcomePrices||'[]');}catch(e){}
        var yesPrice=prices[0]?parseFloat(prices[0]):0;
        var vol=parseFloat(ev.volume||topMarket.volume||0);
        var volStr=vol>=1000000?'$'+(vol/1000000).toFixed(1)+'M':vol>=1000?'$'+(vol/1000).toFixed(0)+'K':'$'+vol.toFixed(0);
        return{
          question:(ev.title||topMarket.question||'').slice(0,80),
          yes:yesPrice,
          volume:volStr,
          slug:ev.slug||'',
          category:ev.category||'Geopolitics',
          endDate:ev.endDate||topMarket.endDate||''
        };
      });
      items.sort(function(a,b){
        var aV=parseFloat(a.volume.replace(/[$MK,]/g,''))||0;
        var bV=parseFloat(b.volume.replace(/[$MK,]/g,''))||0;
        if(a.volume.includes('M'))aV*=1000;
        if(b.volume.includes('M'))bV*=1000;
        return bV-aV;
      });
      if(items.length>=2){setPolyMarkets(items);setPolyLive(true);return;}
    }catch(e){}
    setPolyMarkets(POLY_FALLBACK);setPolyLive(true);
  };

  // ═══ LIVE STOCK PRICES — Multi-proxy Yahoo Finance + Finnhub fallback ═══
  var CORS_PROXIES=[
    function(u){return 'https://corsproxy.io/?'+encodeURIComponent(u);},
    function(u){return 'https://api.allorigins.win/raw?url='+encodeURIComponent(u);},
    function(u){return 'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(u);},
    function(u){return 'https://thingproxy.freeboard.io/fetch/'+u;}
  ];
  var proxyFetch=async function(url,timeoutMs){
    for(var i=0;i<CORS_PROXIES.length;i++){
      try{
        var pUrl=CORS_PROXIES[i](url);
        var controller=new AbortController();
        var tm=setTimeout(function(){controller.abort();},timeoutMs||8000);
        var resp=await fetch(pUrl,{signal:controller.signal});
        clearTimeout(tm);
        if(resp.ok){var txt=await resp.text();try{return JSON.parse(txt);}catch(e){continue;}}
      }catch(e){}
    }
    return null;
  };

  const YAHOO_SYMBOLS={
    'SPGI':'SPGI','LMT':'LMT','RTX':'RTX','NOC':'NOC','PLTR':'PLTR',
    'ES1':'ES=F','NQ1':'NQ=F','DXY':'DX-Y.NYB','GC1':'GC=F','CL1':'CL=F',
    'US10Y':'^TNX','VIX':'^VIX','BTC':'BTC-USD','ETH':'ETH-USD',
    'EUR':'EURUSD=X','GBP':'GBPUSD=X','JPY':'JPY=X',
    'NG1':'NG=F','HG1':'HG=F','W1':'ZW=F','US2Y':'^IRX'
  };

  var parseYahooQuotes=function(data){
    if(!data||!data.quoteResponse||!data.quoteResponse.result)return null;
    var prices={};
    var symbolToKey={};
    Object.keys(YAHOO_SYMBOLS).forEach(function(k){symbolToKey[YAHOO_SYMBOLS[k]]=k;});
    data.quoteResponse.result.forEach(function(q){
      var key=symbolToKey[q.symbol];
      if(!key)return;
      var price=q.regularMarketPrice;
      var changePct=q.regularMarketChangePercent;
      if(price===undefined)return;
      var fmtPrice=price>=1000?price.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}):
                   price>=100?price.toFixed(2):
                   price>=10?price.toFixed(2):
                   price.toFixed(4);
      if(key==='US10Y'||key==='US2Y')fmtPrice=price.toFixed(3)+'%';
      if(key==='JPY')fmtPrice=price.toFixed(2);
      var fmtChange=changePct>=0?'+'+changePct.toFixed(2)+'%':changePct.toFixed(2)+'%';
      if(key==='US10Y'||key==='US2Y'){
        var bps=Math.round(q.regularMarketChange*100);
        fmtChange=(bps>=0?'+':'')+bps+'bp';
      }
      prices[key]={p:fmtPrice,c:fmtChange,u:changePct>=0,raw:price};
    });
    return Object.keys(prices).length>0?prices:null;
  };

  var fetchLivePrices=async function(){
    try{
      // Primary: Yahoo Finance v8 chart endpoint (v7 quote is dead — returns 401)
      var allSymbols=Object.values(YAHOO_SYMBOLS);
      var chartPrices={};
      var symbolToKey={};
      Object.keys(YAHOO_SYMBOLS).forEach(function(k){symbolToKey[YAHOO_SYMBOLS[k]]=k;});
      var cacheBust='&_t='+Date.now();
      // Fetch in parallel batches of 4
      for(var i=0;i<allSymbols.length;i+=4){
        var batch=allSymbols.slice(i,i+4);
        var fetches=batch.map(function(sym){
          var cUrl='https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(sym)+'?interval=1d&range=5d'+cacheBust;
          return proxyFetch(cUrl,8000).then(function(cData){
            if(cData&&cData.chart&&cData.chart.result&&cData.chart.result[0]){
              var meta=cData.chart.result[0].meta;
              if(meta&&meta.regularMarketPrice){
                var key=symbolToKey[sym];
                if(key){
                  var pr=meta.regularMarketPrice;
                  var prev=meta.chartPreviousClose||meta.previousClose||pr;
                  var chg=prev?((pr-prev)/prev)*100:0;
                  var fmtP=pr>=1000?pr.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}):pr>=10?pr.toFixed(2):pr.toFixed(4);
                  if(key==='US10Y'||key==='US2Y')fmtP=pr.toFixed(3)+'%';
                  if(key==='JPY')fmtP=pr.toFixed(2);
                  var fmtC=chg>=0?'+'+chg.toFixed(2)+'%':chg.toFixed(2)+'%';
                  if(key==='US10Y'||key==='US2Y'){var bps=Math.round((pr-prev)*100);fmtC=(bps>=0?'+':'')+bps+'bp';}
                  chartPrices[key]={p:fmtP,c:fmtC,u:chg>=0,raw:pr};
                }
              }
            }
          }).catch(function(){});
        });
        await Promise.all(fetches);
      }
      if(Object.keys(chartPrices).length>0){
        setLivePrices(function(prev){
          // Only update symbols that actually returned data — don't wipe out existing live prices for symbols that failed this cycle
          var merged=Object.assign({},prev);
          Object.keys(chartPrices).forEach(function(k){merged[k]=chartPrices[k];});
          return merged;
        });
      }
    }catch(e){}
  };

  // Fetch SPGI intraday chart data for sparkline + extract current price
  var fetchSpgiChart=async function(){
    try{
      var yUrl='https://query1.finance.yahoo.com/v8/finance/chart/SPGI?interval=15m&range=1d&_t='+Date.now();
      var data=await proxyFetch(yUrl,10000);
      if(!data)return;
      var result=data.chart&&data.chart.result&&data.chart.result[0];
      if(!result)return;

      // Extract intraday points for sparkline
      if(result.indicators&&result.indicators.quote&&result.indicators.quote[0]){
        var closes=result.indicators.quote[0].close;
        var times=result.timestamp;
        if(closes&&times){
          var points=[];
          for(var i=0;i<closes.length;i++){
            if(closes[i]!==null&&closes[i]!==undefined){
              var d=new Date(times[i]*1000);
              points.push({t:d.getHours()+':'+(d.getMinutes()<10?'0':'')+d.getMinutes(),p:closes[i]});
            }
          }
          if(points.length>=5)setSpgiIntraday(points);
        }
      }

      // Also extract current SPGI price from chart meta (backup for quote endpoint)
      if(result.meta&&result.meta.regularMarketPrice){
        var pr=result.meta.regularMarketPrice;
        var prev=result.meta.chartPreviousClose||result.meta.previousClose||pr;
        var chg=((pr-prev)/prev)*100;
        var fmtP=pr.toFixed(2);
        var fmtC=chg>=0?'+'+chg.toFixed(2)+'%':chg.toFixed(2)+'%';
        setLivePrices(function(old){
          if(old.SPGI)return old;
          return Object.assign({},old,{SPGI:{p:fmtP,c:fmtC,u:chg>=0,raw:pr}});
        });
      }
    }catch(e){}
  };

  // Fetch SPGI news
  const fetchSpgiNews=async()=>{
    // Load fallback immediately so panel is never empty
    if(spgiNews.length===0){setSpgiNews(SPGI_NEWS_FALLBACK);setSpgiNewsLive(true);}
    // Try live RSS
    try{
      const results=[];
      for(const q of SPGI_RSS_QUERIES){
        try{
          const data=await rssFetch(`https://news.google.com/rss/search?q=${q}&hl=en-US&gl=US&ceid=US:en`);
          if(data.items){
            data.items.slice(0,4).forEach(item=>{
              var _t=decEnt(item.title||'');
              const src=_t.includes(' - ')?_t.split(' - ').pop().trim():'News';
              const headline=_t.includes(' - ')?_t.split(' - ').slice(0,-1).join(' - ').trim():_t;
              results.push({t:headline,src,tm:timeAgo(item.pubDate),url:item.link,pubDate:new Date(item.pubDate)});
            });
          }
        }catch(e){}
      }
      const seen=new Set();
      const unique=results.filter(r=>{const k=r.t.slice(0,40);if(seen.has(k))return false;seen.add(k);return true;});
      unique.sort((a,b)=>b.pubDate-a.pubDate);
      if(unique.length>0){setSpgiNews(unique.slice(0,10));setSpgiNewsLive(true);}
    }catch(e){}
  };

  // Fetch live RSS feeds
  const fetchFeeds=async()=>{
    try{
      const results=[];
      for(const feed of RSS_FEEDS){
        try{
          const data=await rssFetch(`https://news.google.com/rss/search?q=${feed.q}&hl=en-US&gl=US&ceid=US:en`);
          if(data.items){
            data.items.slice(0,4).forEach(item=>{
              var _ti=decEnt(item.title||'');
              const cat=classifyHeadline(_ti);
              const src=_ti.includes(' - ')?_ti.split(' - ').pop().trim():'News';
              const headline=_ti.includes(' - ')?_ti.split(' - ').slice(0,-1).join(' - ').trim():_ti;
              results.push({
                t:headline,
                cat,
                sv:['CONFLICT','CYBER','INTEL'].includes(cat)?'critical':['CLIMATE','ENERGY','HEALTH'].includes(cat)?'high':'medium',
                src,
                tm:timeAgo(item.pubDate),
                url:item.link,
                pubDate:new Date(item.pubDate),
              });
            });
          }
        }catch(e){}
      }
      // Deduplicate and sort by date
      const seen=new Set();
      const unique=results.filter(r=>{const k=r.t.slice(0,50);if(seen.has(k))return false;seen.add(k);return true;});
      unique.sort((a,b)=>b.pubDate-a.pubDate);
      if(unique.length>0){setLiveNews(unique.slice(0,40));setFeedStatus('live');}
      else{setFeedStatus('fallback');}
    }catch(e){setFeedStatus('fallback');}
  };

  // Fetch GLOBAL weather/disaster alerts — multi-source, multi-region
  var wxMustMatch=/hurricane|typhoon|cyclone|earthquake|tsunami|blizzard|tornado|wildfire|flood|drought|volcanic|eruption|avalanche|landslide|heatwave|heat wave|storm|severe weather|tropical|seismic|tremor|magnitude|lava|mudslide|ice storm|polar vortex|wind damage|snow|fire.*acre|fire.*burn|lightning|thunderstorm|hail|monsoon|El Ni|rainfall|deluge|inundation|bushfire|sandstorm|dust storm|cold wave|freezing|famine|displacement|humanitarian|disaster|evacuati/i;
  var wxIcons={'hurricane':'🌀','typhoon':'🌀','cyclone':'🌀','tropical':'🌀','earthquake':'🫨','seismic':'🫨','tremor':'🫨','magnitude':'🫨','tsunami':'🌊','blizzard':'❄️','winter storm':'❄️','ice storm':'❄️','snow':'❄️','tornado':'🌪️','wildfire':'🔥','bushfire':'🔥','fire':'🔥','volcanic':'🌋','eruption':'🌋','lava':'🌋','flood':'🌊','monsoon':'🌊','rainfall':'🌊','deluge':'🌊','inundation':'🌊','storm surge':'🌊','drought':'☀️','famine':'☀️','heatwave':'🔥','heat wave':'🔥','polar vortex':'🥶','cold wave':'🥶','freezing':'🥶','avalanche':'🏔️','landslide':'🏔️','mudslide':'🏔️','thunderstorm':'⛈️','hail':'⛈️','lightning':'⛈️','sandstorm':'🌫️','dust storm':'🌫️','disaster':'⚠️','humanitarian':'⚠️','evacuati':'⚠️'};
  var wxTypes={'hurricane':'Hurricane','typhoon':'Typhoon','cyclone':'Cyclone','tropical':'Tropical Storm','earthquake':'Earthquake','seismic':'Earthquake','tremor':'Earthquake','magnitude':'Earthquake','tsunami':'Tsunami','blizzard':'Blizzard','winter storm':'Winter Storm','ice storm':'Ice Storm','snow':'Winter Storm','tornado':'Tornado','wildfire':'Wildfire','bushfire':'Bushfire','fire':'Wildfire','volcanic':'Eruption','eruption':'Eruption','lava':'Eruption','flood':'Flooding','monsoon':'Monsoon Flooding','rainfall':'Heavy Rainfall','deluge':'Flooding','inundation':'Flooding','storm surge':'Storm Surge','drought':'Drought','famine':'Drought/Famine','heatwave':'Heatwave','heat wave':'Heatwave','polar vortex':'Polar Vortex','cold wave':'Cold Wave','freezing':'Cold Wave','avalanche':'Avalanche','landslide':'Landslide','mudslide':'Landslide','thunderstorm':'Severe Storm','hail':'Severe Storm','lightning':'Severe Storm','sandstorm':'Sandstorm','dust storm':'Dust Storm','disaster':'Natural Disaster','humanitarian':'Humanitarian Crisis','evacuati':'Evacuation'};

  const fetchWeather=async()=>{
    if(wxAlerts.length===0||wxAlerts===WEATHER_FALLBACK)setWxAlerts(WEATHER_FALLBACK);
    var allArticles=[];
    // Source 1: GDELT — broad global disaster query (no sourcelang filter for global reach)
    var gdeltQueries=[
      '(flood OR flooding OR rainfall OR deluge OR inundation OR monsoon OR landslide OR mudslide) disaster',
      '(earthquake OR tsunami OR seismic OR volcanic OR eruption) disaster',
      '(hurricane OR typhoon OR cyclone OR tropical storm OR tornado OR blizzard OR wildfire OR bushfire OR drought OR heatwave OR famine)',
      '(disaster OR evacuation OR humanitarian crisis) (flood OR storm OR earthquake OR fire OR drought)'
    ];
    for(var qi=0;qi<gdeltQueries.length;qi++){
      try{
        var data=await gdeltFetch(gdeltQueries[qi],40,'4320min');
        if(data&&data.articles)allArticles=allArticles.concat(data.articles);
      }catch(e){}
    }
    // Source 2: Global disaster RSS feeds (ReliefWeb, GDACS, Google News global)
    var wxRssFeeds=[
      'https://reliefweb.int/updates/rss.xml',
      'https://news.google.com/rss/search?q=flooding+OR+earthquake+OR+cyclone+OR+typhoon+OR+wildfire+OR+drought+disaster&hl=en&gl=US&ceid=US:en',
      'https://news.google.com/rss/search?q=flood+OR+landslide+OR+monsoon+Asia+OR+Africa+OR+Pacific&hl=en&gl=US&ceid=US:en'
    ];
    for(var ri=0;ri<wxRssFeeds.length;ri++){
      try{
        var rssData=await rssFetch(wxRssFeeds[ri]);
        if(rssData&&rssData.items){
          rssData.items.slice(0,12).forEach(function(item){
            allArticles.push({title:item.title||'',url:item.link||'#',domain:item.link?item.link.split('/')[2]:'',seendate:item.pubDate||''});
          });
        }
      }catch(e){}
    }
    // Cluster and deduplicate
    if(allArticles.length<3){setWxAlerts(WEATHER_FALLBACK);setWxLive(true);return;}
    var clusters=[];
    allArticles.forEach(function(art){
      if(!art.title)return;
      var t=decEnt(art.title);
      var tl=t.toLowerCase();
      if(!wxMustMatch.test(t))return;
      if(/opinion|editorial|recipe|horoscope|celebrity|review:|top \d|stock|market|crypto|bitcoin|trump|biden|congress|senate|election|campaign|poll|vote|legislation|bill passes|insurance.*(rate|premium|reform)/i.test(t))return;
      var matched=false;
      for(var c=0;c<clusters.length;c++){
        var words=tl.replace(/[^a-z\s]/g,'').split(/\s+/).filter(function(w){return w.length>4;});
        var overlap=words.filter(function(w){return clusters[c].titleLower.indexOf(w)!==-1;}).length;
        if(overlap>=3){clusters[c].count++;matched=true;break;}
      }
      if(!matched){
        var icon='⚠️',type='Severe Weather';
        for(var kw in wxIcons){if(tl.indexOf(kw)!==-1){icon=wxIcons[kw];type=wxTypes[kw];break;}}
        var sev='severe';
        if(/death|killed|fatal|catastroph|devastat|state of emergency|emergency declar/i.test(t))sev='extreme';
        else if(/warning|watch|advisory|alert|outlook/i.test(t))sev='moderate';
        var tm='Recent';
        if(art.seendate){
          try{
            var d=typeof art.seendate==='string'&&/^\d{12,14}/.test(art.seendate)?art.seendate.replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2}).*/,'$1-$2-$3'):art.seendate;
            var diff=Math.floor((new Date()-new Date(d))/(1000*60*60));
            if(diff<0)tm='Just now';else if(diff<1)tm='NOW';else if(diff<24)tm=diff+'h ago';else tm=Math.floor(diff/24)+'d ago';
          }catch(e){}
        }
        clusters.push({title:t.split(' - ')[0].trim(),titleLower:tl,icon:icon,type:type,sev:sev,time:tm,count:1,url:art.url||'#',detail:art.domain?'Source: '+art.domain.replace('www.',''):''});
      }
    });
    clusters.sort(function(a,b){return b.count-a.count;});
    if(clusters.length>=2){
      var wxItems=clusters.slice(0,12).map(function(c){
        return{sev:c.sev,type:c.type,title:c.title,detail:c.detail+(c.count>1?' ('+c.count+' sources)':''),time:c.time,icon:c.icon,url:c.url};
      });
      setWxAlerts(wxItems);setWxLive(true);return;
    }
    setWxAlerts(WEATHER_FALLBACK);setWxLive(true);
  };

  // ═══ NOTAM FETCH — FAA direct API (primary) + news supplements ═══
  // ICAO code → readable location name
  var ICAO_NAMES={ORBB:'Baghdad FIR, Iraq',ORBI:'Baghdad Intl, Iraq',UKBV:'Kyiv FIR, Ukraine',UKBB:'Boryspil, Ukraine',
    HSSS:'Khartoum FIR, Sudan',HSSK:'Khartoum, Sudan',OIIX:'Tehran FIR, Iran',OIIE:'Tehran Imam Khomeini, Iran',
    OPKR:'Karachi FIR, Pakistan',OPLR:'Lahore FIR, Pakistan',FZZA:'Kinshasa FIR, DRC',FZNA:'Goma, DRC',
    OEJD:'Jeddah FIR, Saudi Arabia',KZDC:'Washington DC ARTCC',LTBB:'Istanbul FIR, Turkey',
    VHHH:'Hong Kong Intl',RCTP:'Taipei Taoyuan',EGLL:'London Heathrow',LFPG:'Paris CDG'};
  var NOTAM_LOCATIONS='ORBB,UKBV,HSSS,OIIX,OPKR,FZZA,OEJD,KZDC,ORBI,UKBB,HSSK,OIIE,FZNA,LTBB,VHHH,RCTP,EGLL,LFPG';
  const fetchNotams=async()=>{
    const allNotams=[];
    // Source 1 (PRIMARY): FAA NOTAM Search API — real NOTAM data
    try{
      var faaUrl='https://notams.aim.faa.gov/notamSearch/search';
      var body='searchType=0&designatorsForLocation='+NOTAM_LOCATIONS;
      var proxies=['https://corsproxy.io/?','https://api.allorigins.win/raw?url=','https://corsproxy.org/?'];
      var resp=null;
      for(var pi=0;pi<proxies.length;pi++){
        try{
          var pUrl=proxies[pi]+encodeURIComponent(faaUrl);
          var controller=new AbortController();
          var tmr=setTimeout(function(){controller.abort();},10000);
          resp=await fetch(pUrl,{
            method:'POST',signal:controller.signal,
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body:body
          });
          clearTimeout(tmr);
          if(resp.ok)break;
          resp=null;
        }catch(pe){resp=null;}
      }
      if(resp&&resp.ok){
        var faaData=await resp.json();
        var items=faaData.notamList||faaData.endpointResponse||faaData;
        if(Array.isArray(items)){
          items.forEach(function(n){
            var msg=(n.icaoMessage||n.traditionalMessage||n.text||'');
            var loc=n.facilityDesignator||n.icaoLocation||'';
            var id=n.notamNumber||n.id||'FAA';
            var msgUp=msg.toUpperCase();
            // Filter: only significant NOTAMs
            var isSig=msgUp.match(/CLSD|CLOSED|PROHIBIT|RESTRICT|TFR|NO.FLY|HAZARD|MILITARY|ARMED CONFLICT|LASER|UAS|DRONE|GPS|GNSS|JAMM|SPOOF|MISSILE|VOLCANIC|ASH|NUCLEAR|SECURITY/);
            if(!isSig)return;
            var status='WARNING',color='#ffd60a';
            if(msgUp.match(/CLSD|CLOSED|PROHIBIT|NO.FLY/)){status='PROHIBITED';color='#ff3b30';}
            else if(msgUp.match(/RESTRICT|TFR|MILITARY|ARMED|MISSILE|HAZARD|SECURITY/)){status='RESTRICTED';color='#ff9500';}
            // Readable location name
            var locName=ICAO_NAMES[loc]||(loc+' region');
            // Humanize the raw NOTAM text
            var readable=humanizeNotam(msg);
            var zone=locName;
            var detail=readable.slice(0,140);
            var t='Active';
            if(n.issueDate)t=timeAgo(n.issueDate);
            else if(n.startDate)t=timeAgo(n.startDate);
            allNotams.push({id:id,zone:zone.slice(0,60),status:status,detail:detail,color:color,time:t,src:'FAA'});
          });
          if(allNotams.length>0)console.log('SENTINEL: FAA NOTAM API returned '+allNotams.length+' significant NOTAMs');
        }
      }
    }catch(e){console.log('FAA NOTAM API error (falling back to news)',e);}

    // Source 2: GDELT news for TFR/airspace restriction articles (supplements FAA data)
    try{
      var tfrData=await gdeltFetch('(NOTAM OR TFR OR "airspace closure" OR "flight restriction" OR "no-fly zone" OR "airspace closed" OR "flight ban" OR FIR) (FAA OR ICAO OR EASA OR aviation OR airspace) sourcelang:eng',25,'4320min');
      if(tfrData&&tfrData.articles&&tfrData.articles.length>0){
        tfrData.articles.slice(0,6).forEach(function(art){
          var t=decEnt(art.title||'');
          var tl=t.toLowerCase();
          var status='WARNING',color='#ffd60a';
          if(tl.match(/prohibit|no.fly|closed|shutdown|ban/)){status='PROHIBITED';color='#ff3b30';}
          else if(tl.match(/restrict|tfr|limit|military|intercept/)){status='RESTRICTED';color='#ff9500';}
          var src=art.domain||'GDELT';
          allNotams.push({id:'TFR',zone:t.slice(0,55),status,detail:src+' — '+t.slice(0,100),color,time:timeAgo(art.seendate),src:src});
        });
      }
    }catch(e){}

    // Source 3: Aviation Herald (incidents/safety) via RSS
    try{
      const data=await rssFetch('https://avherald.com/h?rss=1');
      if(data.items&&data.items.length>0){
        data.items.slice(0,4).forEach(item=>{
          const t=decEnt(item.title||'');
          let status='WARNING',color='#ffd60a';
          if(t.toLowerCase().match(/crash|fatal|emergency|mayday/)){status='PROHIBITED';color='#ff3b30';}
          else if(t.toLowerCase().match(/divert|reject|engine|fire|smoke/)){status='RESTRICTED';color='#ff9500';}
          allNotams.push({id:'AVH',zone:t.slice(0,55),status,detail:t,color,time:timeAgo(item.pubDate),src:'AvHerald'});
        });
      }
    }catch(e){}

    // Source 4: Google News RSS for NOTAMs / airspace closures
    try{
      const queries=['NOTAM+airspace+closure+flight+restriction','TFR+temporary+flight+restriction+FAA'];
      for(const q of queries){
        const data=await rssFetch('https://news.google.com/rss/search?q='+q+'&hl=en-US&gl=US&ceid=US:en');
        if(data.items){
          data.items.slice(0,3).forEach(item=>{
            var _ti=decEnt(item.title||'');
            const t=_ti.toLowerCase();
            const src=_ti.includes(' - ')?_ti.split(' - ').pop().trim():'News';
            const headline=_ti.includes(' - ')?_ti.split(' - ').slice(0,-1).join(' - ').trim():_ti;
            let status='WARNING',color='#ffd60a';
            if(t.match(/prohibit|clos|ban|shut/)){status='PROHIBITED';color='#ff3b30';}
            else if(t.match(/restrict|tfr|limit|military/)){status='RESTRICTED';color='#ff9500';}
            allNotams.push({id:'NEWS',zone:headline.slice(0,55),status,detail:src+' — '+headline.slice(55,120),color,time:timeAgo(item.pubDate),src:src});
          });
        }
      }
    }catch(e){}

    if(allNotams.length>0){
      // Deduplicate by first 35 chars of zone
      const seen=new Set();
      const unique=allNotams.filter(n=>{const k=n.zone.slice(0,35).toLowerCase();if(seen.has(k))return false;seen.add(k);return true;});
      // Merge: live results first, then fill with fallback entries not already covered
      const liveZones=new Set(unique.map(n=>n.zone.slice(0,25).toLowerCase()));
      const fallbackFill=NOTAM_FALLBACK.filter(fb=>!liveZones.has(fb.zone.slice(0,25).toLowerCase()));
      const merged=[...unique,...fallbackFill].slice(0,14);
      setNotams(merged);setNotamLive(true);
    }else{
      // All sources failed — use curated fallback
      setNotams(NOTAM_FALLBACK);setNotamLive(true);
      console.log('SENTINEL: All NOTAM sources failed, using verified fallback');
    }
  };

  // Simple search — opens Google News in new tab
  const searchIntel=function(query){
    if(!query||!query.trim())return;
    window.open('https://news.google.com/search?q='+encodeURIComponent(query.trim())+'&hl=en-US','_blank');
  };
  const clearSearch=function(){setSearchQuery('');};

  // ═══ GDELT BREAKING NEWS — auto-polls every 2 min ═══
  const GDELT_KEYWORDS=[
    'war','invasion','airstrike','missile','bombing','ceasefire','coup','martial law',
    'earthquake','tsunami','hurricane','typhoon','cyclone','volcanic eruption','wildfire',
    'terrorist attack','mass shooting','hostage','assassination','nuclear',
    'pandemic','outbreak','bird flu','H5N1','Ebola',
    'sanctions','NATO','UN Security Council','emergency summit','market crash','tariff'
  ];
  // GDELT helper — multi-proxy fallback (GDELT has no CORS headers)
  var gdeltProxies=[
    function(u){return 'https://corsproxy.io/?'+encodeURIComponent(u);},
    function(u){return 'https://api.allorigins.win/raw?url='+encodeURIComponent(u);},
    function(u){return 'https://corsproxy.org/?'+encodeURIComponent(u);}
  ];
  var gdeltFetch=async function(query,maxrecs,timespan){
    var gdeltUrl='https://api.gdeltproject.org/api/v2/doc/doc?query='+encodeURIComponent(query)+'&mode=artlist&maxrecords='+maxrecs+'&format=json&sort=datedesc&timespan='+timespan;
    for(var pi=0;pi<gdeltProxies.length;pi++){
      try{
        var proxyUrl=gdeltProxies[pi](gdeltUrl);
        var controller=new AbortController();
        var tm=setTimeout(function(){controller.abort();},10000);
        var resp=await fetch(proxyUrl,{signal:controller.signal});
        clearTimeout(tm);
        if(resp.ok){var data=await resp.json();if(data&&(data.articles||Array.isArray(data)))return data;}
      }catch(e){continue;}
    }
    return null;
  };

  // ── TIER 1: Direct RSS scan of major outlets for stories they tag as "breaking" ──
  var BREAKING_RSS=[
    {url:'https://feeds.bbci.co.uk/news/world/rss.xml',name:'BBC'},
    {url:'http://rss.cnn.com/rss/edition_world.rss',name:'CNN'},
    {url:'https://www.aljazeera.com/xml/rss/all.xml',name:'Al Jazeera'},
    {url:'https://feeds.reuters.com/reuters/topNews',name:'Reuters'},
    {url:'https://rss.nytimes.com/services/xml/rss/nyt/World.xml',name:'NY Times'},
  ];
  var breakingPattern=/breaking|just in|developing|flash|urgent/i;
  var securityBreaking=/kill|dead|shot|attack|bomb|strike|shoot|war|coup|quake|tsunami|hurricane|crash|hostage|kidnap|missile|nuclear|terror|explo|casualt|evacuat|siege|fire|collaps|shoot|armed|troops|invasion/i;

  var fetchBreakingRSS=async function(){
    try{
      var candidates=[];
      var rssPromises=BREAKING_RSS.map(function(feed){
        return rssFetch(feed.url).then(function(data){
          if(!data.items)return;
          // Check items published in the last 60 minutes
          var cutoff=Date.now()-60*60*1000;
          data.items.slice(0,10).forEach(function(item){
            var pubTime=new Date(item.pubDate).getTime();
            if(pubTime<cutoff)return;
            var title=decEnt(item.title||'');
            // Promote if outlet tags it as breaking OR headline matches urgent security terms
            var isTaggedBreaking=breakingPattern.test(title)||breakingPattern.test(item.description||'')||((item.categories||[]).join(' ').toLowerCase().indexOf('breaking')!==-1);
            var isUrgentSecurity=securityBreaking.test(title);
            if(isTaggedBreaking||isUrgentSecurity){
              candidates.push({title:title.replace(/^(BREAKING|JUST IN|DEVELOPING)[:\s\-]*/i,'').trim(),url:item.link,source:feed.name,time:new Date(item.pubDate).toISOString().slice(11,16)+' UTC',priority:isTaggedBreaking?2:1,pubTime:pubTime});
            }
          });
        }).catch(function(){});
      });
      await Promise.all(rssPromises);
      if(candidates.length===0)return false;
      // Sort: tagged breaking first, then by recency
      candidates.sort(function(a,b){return b.priority-a.priority||b.pubTime-a.pubTime;});
      var top=candidates[0];
      if(bannerDismissed&&top.title.substring(0,40)===bannerDismissed)return false;
      setBreakingNews({title:top.title,url:top.url,sources:candidates.length,domain:top.source,time:top.time});
      return true;
    }catch(e){return false;}
  };

  // ── TIER 2: GDELT cluster-based breaking detection (fallback) ──
  var fetchBreakingNews=async function(){
    try{
      // Tier 1: Check major outlet RSS feeds first — fastest path to real breaking news
      var rssHit=await fetchBreakingRSS();
      if(rssHit)return; // RSS found a breaking story, no need for GDELT

      // Tier 2: GDELT multi-source clustering
      var q='('+GDELT_KEYWORDS.slice(0,12).join(' OR ')+') sourcelang:eng';
      var data=await gdeltFetch(q,75,'180min');
      if(!data)return;
      if(!data.articles||data.articles.length<1)return;

      var clusters=[];
      data.articles.forEach(function(art){
        if(!art.title)return;
        art.title=decEnt(art.title);
        var titleLower=art.title.toLowerCase();
        if(/opinion|editorial|top \d|best \d|review|recipe|horoscope|celebrity|kardashian/i.test(art.title))return;
        var isBreaking=GDELT_KEYWORDS.some(function(kw){return titleLower.indexOf(kw.toLowerCase())!==-1;});
        if(!isBreaking)return;
        var matched=false;
        for(var c=0;c<clusters.length;c++){
          var clusterTitle=clusters[c].title.toLowerCase();
          var artWords=titleLower.replace(/[^a-z\s]/g,'').split(/\s+/).filter(function(w){return w.length>4;});
          var overlap=artWords.filter(function(w){return clusterTitle.indexOf(w)!==-1;}).length;
          if(overlap>=3){clusters[c].sources.push(art.domain||'unknown');clusters[c].count++;matched=true;break;}
        }
        if(!matched){
          clusters.push({title:art.title,url:art.url,domain:art.domain||'unknown',date:art.seendate||'',sources:[art.domain||'unknown'],count:1});
        }
      });

      clusters.sort(function(a,b){return b.count-a.count;});
      var top=clusters[0];
      if(!top||top.count<3)return;
      if(bannerDismissed&&top.title.substring(0,40)===bannerDismissed)return;

      setBreakingNews({
        title:top.title,
        url:top.url,
        sources:top.count,
        domain:top.domain,
        time:top.date?top.date.replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z/,'$4:$5 UTC'):new Date().toISOString().slice(11,16)+' UTC'
      });
    }catch(e){
      // Silent fail — no banner appears, dashboard unaffected
    }
  };

  const mapRef=useRef(null);
  const markersRef=useRef([]);
  const linesRef=useRef([]);
  const alertAudioRef=useRef(null);

  const triggerAlert=function(type,message){
    const newAlert={id:Date.now(),type,message};
    setAlertQueue(prev=>[...prev,newAlert]);
    // Play beep
    try{
      const ctx=new(window.AudioContext||window.webkitAudioContext)();
      const osc=ctx.createOscillator();
      const gain=ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value=440;
      gain.gain.setValueAtTime(0.15,ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.2);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime+0.2);
    }catch(e){}
    // Auto-remove after 5 seconds
    setTimeout(function(){setAlertQueue(prev=>prev.filter(a=>a.id!==newAlert.id));},5000);
  };

  useEffect(()=>{const i=setInterval(()=>setTime(new Date()),1000);return()=>clearInterval(i)},[]);

  // Theme toggle effect
  useEffect(()=>{
    const root=document.documentElement;
    if(darkMode){
      root.style.setProperty('--bg0','#000');
      root.style.setProperty('--bg1','#0a0a0a');
      root.style.setProperty('--bg2','#111');
      root.style.setProperty('--bg3','#1a1a1a');
      root.style.setProperty('--bdr','#222');
      root.style.setProperty('--bdrh','#333');
      root.style.setProperty('--t1','#e5e5e5');
      root.style.setProperty('--t2','#999');
      root.style.setProperty('--t3','#666');
      document.body.style.background='#000';
      document.body.style.color='#d4d4d4';
    }else{
      root.style.setProperty('--bg0','#fff');
      root.style.setProperty('--bg1','#f5f5f5');
      root.style.setProperty('--bg2','#eee');
      root.style.setProperty('--bg3','#e0e0e0');
      root.style.setProperty('--bdr','#ddd');
      root.style.setProperty('--bdrh','#ccc');
      root.style.setProperty('--t1','#1a1a1a');
      root.style.setProperty('--t2','#555');
      root.style.setProperty('--t3','#888');
      document.body.style.background='#fff';
      document.body.style.color='#1a1a1a';
    }
  },[darkMode]);

  // ═══ TIERED REFRESH RATES ═══
  // Breaking news: 30s (near-immediate)
  useEffect(()=>{fetchBreakingNews();const i=setInterval(fetchBreakingNews,30*1000);return()=>clearInterval(i)},[]);
  // Prices + sparkline: 60s
  useEffect(()=>{fetchLivePrices();fetchSpgiChart();const i=setInterval(()=>{fetchLivePrices();fetchSpgiChart()},60*1000);return()=>clearInterval(i)},[]);
  // Intel feed, weather, NOTAMs, SPGI news: 2 min
  useEffect(()=>{fetchFeeds();fetchWeather();fetchNotams();fetchSpgiNews();const i=setInterval(()=>{fetchFeeds();fetchWeather();fetchNotams();fetchSpgiNews()},2*60*1000);return()=>clearInterval(i)},[]);
  // Advisories + ratings: 10 min (rarely change)
  useEffect(()=>{fetchAdvisories();fetchPolymarkets();const i=setInterval(()=>{fetchAdvisories();fetchPolymarkets()},10*60*1000);return()=>clearInterval(i)},[]);

  // Advisory data (component-level so JSX + map useEffect can both access)
  var ADV_COUNTRIES={
    'Afghanistan':4,'Ukraine':4,'Russia':4,'Syria':4,'Iran':4,'Iraq':4,
    'Yemen':4,'Somalia':4,'Sudan':4,'South Sudan':4,'Libya':4,'Mali':4,
    'Haiti':4,'North Korea':4,'Venezuela':4,'Myanmar':4,'Burkina Faso':4,
    'Niger':4,'Central African Republic':4,'Belarus':4,'Lebanon':4,
    'Pakistan':3,'Nigeria':3,'Honduras':3,'Israel':3,'Ethiopia':3,
    'Democratic Republic of the Congo':3,'Chad':3,'Mauritania':3,
    'Colombia':3,'Bangladesh':3,'Guatemala':3,'Uganda':3,
    'Guinea-Bissau':3,'Cameroon':3,'Nicaragua':3,'Kenya':3,
    'Mexico':2,'Brazil':2,'Egypt':2,'Turkey':2,'India':2,
    'Guinea':2,'Philippines':2,'South Africa':2,'Jamaica':2,'China':2
  };
  var ADV_ALIASES={
    'Burma':'Myanmar','Republic of the Congo':'DR Congo',
    'Dem. Rep. Congo':'Democratic Republic of the Congo',
    'Congo':'Democratic Republic of the Congo',
    'Korea, Dem. Rep.':'North Korea','Korea':'North Korea',
    'Korea, Rep.':'South Korea',
    'Lao PDR':'Laos','Syrian Arab Republic':'Syria',
    'Iran (Islamic Republic of)':'Iran','Iran, Islamic Rep.':'Iran',
    'Côte d\'Ivoire':'Ivory Coast','Cote d\'Ivoire':'Ivory Coast',
    'Russian Federation':'Russia',
    'Venezuela (Bolivarian Republic of)':'Venezuela',
    'Republic of Guinea':'Guinea',
    'Palestine':'Gaza','West Bank and Gaza':'Gaza',
    'Türkiye':'Turkey','Turkiye':'Turkey'
  };
  function getAdvLevel(name){
    if(ADV_COUNTRIES[name])return ADV_COUNTRIES[name];
    var alias=ADV_ALIASES[name];
    if(alias&&ADV_COUNTRIES[alias])return ADV_COUNTRIES[alias];
    var ks=Object.keys(ADV_COUNTRIES);
    for(var k=0;k<ks.length;k++){
      if(name.indexOf(ks[k])!==-1||ks[k].indexOf(name)!==-1)return ADV_COUNTRIES[ks[k]];
    }
    return 0;
  }
  // State Dept travel advisory URLs (component-level so JSX can access)
  var ADV_URLS={
    'Afghanistan':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/afghanistan-travel-advisory.html',
    'Ukraine':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/ukraine-travel-advisory.html',
    'Russia':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/russia-travel-advisory.html',
    'Syria':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/syria-travel-advisory.html',
    'Iran':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iran-travel-advisory.html',
    'Iraq':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iraq-travel-advisory.html',
    'Yemen':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/yemen-travel-advisory.html',
    'Somalia':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/somalia-travel-advisory.html',
    'Sudan':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/sudan-travel-advisory.html',
    'South Sudan':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/south-sudan-travel-advisory.html',
    'Libya':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/libya-travel-advisory.html',
    'Mali':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mali-travel-advisory.html',
    'Haiti':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/haiti-travel-advisory.html',
    'North Korea':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/north-korea-travel-advisory.html',
    'Venezuela':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/venezuela-travel-advisory.html',
    'Myanmar':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burma-travel-advisory.html',
    'Burkina Faso':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burkina-faso-travel-advisory.html',
    'Niger':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/niger-travel-advisory.html',
    'Central African Republic':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/central-african-republic-travel-advisory.html',
    'Belarus':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/belarus-travel-advisory.html',
    'Lebanon':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/lebanon-travel-advisory.html',
    'Pakistan':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/pakistan-travel-advisory.html',
    'Nigeria':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/nigeria-travel-advisory.html',
    'Honduras':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/honduras-travel-advisory.html',
    'Israel':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/israel-the-west-bank-and-gaza-travel-advisory.html',
    'Ethiopia':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/ethiopia-travel-advisory.html',
    'Democratic Republic of the Congo':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/democratic-republic-of-the-congo-travel-advisory.html',
    'Chad':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/chad-travel-advisory.html',
    'Mauritania':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mauritania-travel-advisory.html',
    'Colombia':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/colombia-travel-advisory.html',
    'Bangladesh':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/bangladesh-travel-advisory.html',
    'Guatemala':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/guatemala-travel-advisory.html',
    'Uganda':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/uganda-travel-advisory.html',
    'Guinea-Bissau':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/guinea-bissau-travel-advisory.html',
    'Cameroon':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/cameroon-travel-advisory.html',
    'Nicaragua':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/nicaragua-travel-advisory.html',
    'Kenya':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/kenya-travel-advisory.html',
    'Mexico':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mexico-travel-advisory.html',
    'Brazil':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/brazil-travel-advisory.html',
    'Egypt':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/egypt-travel-advisory.html',
    'Turkey':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/turkey-travel-advisory.html',
    'India':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/india-travel-advisory.html',
    'Guinea':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/guinea-travel-advisory.html',
    'Philippines':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/philippines-travel-advisory.html',
    'South Africa':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/south-africa-travel-advisory.html',
    'Jamaica':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jamaica-travel-advisory.html',
    'China':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/china-travel-advisory.html'
  };
  function getAdvUrl(name){
    if(ADV_URLS[name])return ADV_URLS[name];
    var alias=ADV_ALIASES[name];
    if(alias&&ADV_URLS[alias])return ADV_URLS[alias];
    var keys=Object.keys(ADV_URLS);
    for(var k=0;k<keys.length;k++){
      if(name.indexOf(keys[k])!==-1||keys[k].indexOf(name)!==-1)return ADV_URLS[keys[k]];
    }
    return 'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories.html/';
  }

  // Initialize Leaflet map
  useEffect(()=>{
    if(mapRef.current)return;
    const map=L.map('leaflet-map',{
      center:[20,15],zoom:2,minZoom:2,maxZoom:8,
      zoomControl:false,attributionControl:false,
      worldCopyJump:true
    });
    const tileUrl=darkMode?'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png':'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';
    const labelUrl=darkMode?'https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png':'https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png';
    L.tileLayer(tileUrl,{
      subdomains:'abcd',maxZoom:19
    }).addTo(map);
    // Labels layer — CartoDB labels (English for major features)
    L.tileLayer(labelUrl,{
      subdomains:'abcd',maxZoom:19,pane:'shadowPane'
    }).addTo(map);
    L.control.zoom({position:'bottomright'}).addTo(map);
    mapRef.current=map;

    // ═══ ADVISORY SHADING — GeoJSON country fill ═══
    var advFillColors={4:'rgba(255,59,48,0.35)',3:'rgba(255,149,0,0.25)',2:'rgba(255,214,10,0.18)'};
    var advStrokeColors={4:'rgba(255,59,48,0.6)',3:'rgba(255,149,0,0.5)',2:'rgba(255,214,10,0.4)'};
    var lvlLabels={4:'LEVEL 4 — DO NOT TRAVEL',3:'LEVEL 3 — RECONSIDER TRAVEL',2:'LEVEL 2 — EXERCISE INCREASED CAUTION'};

    // Fetch GeoJSON and render
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
      .then(function(r){return r.json();})
      .then(function(geo){
        var layer=L.geoJSON(geo,{
          style:function(feature){
            var name=feature.properties.name||'';
            var lv=getAdvLevel(name);
            if(lv>0){
              return{fillColor:advFillColors[lv],fillOpacity:1,color:advStrokeColors[lv],weight:1.5,opacity:1};
            }
            return{fillColor:'transparent',fillOpacity:0,color:'transparent',weight:0,opacity:0};
          },
          onEachFeature:function(feature,layer){
            var name=feature.properties.name||'';
            var lv=getAdvLevel(name);
            if(lv>0){
              var url=getAdvUrl(name);
              layer.bindTooltip('<div style="pointer-events:auto;cursor:default">'+name+' — '+lvlLabels[lv]+'<br><a href="'+url+'" target="_blank" rel="noopener" style="color:#0a84ff;font-size:9px;pointer-events:auto;cursor:pointer">View State Dept Advisory ↗</a></div>',{sticky:false,className:'adv-tooltip',interactive:true,direction:'top',offset:L.point(0,-10)});
              layer.on('click',function(){
                var bounds=layer.getBounds();
                var center=bounds.getCenter();
                setCountryBrief({name:name,level:lv,lat:center.lat,lon:center.lng});
              });
              layer.on('mouseover',function(){
                layer.setStyle({fillOpacity:1,weight:2.5});
              });
              layer.on('mouseout',function(){
                layer.setStyle({fillOpacity:1,weight:1.5});
              });
            }
          },
          filter:function(feature){
            // Only render countries that have an advisory level
            var name=feature.properties.name||'';
            return getAdvLevel(name)>0;
          }
        }).addTo(map);
        geoLayerRef.current=layer;
        console.log('SENTINEL NOVA: GeoJSON advisory shading loaded');
      })
      .catch(function(err){console.error('GeoJSON load error:',err);});

    // Add connection lines
    CONNS.forEach(([fromId,toId,label,color])=>{
      const f=INCIDENTS.find(i=>i.id===fromId);const t=INCIDENTS.find(i=>i.id===toId);
      if(!f||!t)return;
      const line=L.polyline([[f.lat,f.lon],[t.lat,t.lon]],{
        color,weight:1.5,opacity:0.35,dashArray:'6,4',className:'conn-arc'
      }).addTo(map);
      linesRef.current.push(line);
    });
  },[]);

  // Update advisory GeoJSON shading when filter changes
  useEffect(()=>{
    if(!geoLayerRef.current)return;
    var fillColors={4:'rgba(255,59,48,0.35)',3:'rgba(255,149,0,0.25)',2:'rgba(255,214,10,0.18)'};
    var strokeColors={4:'rgba(255,59,48,0.6)',3:'rgba(255,149,0,0.5)',2:'rgba(255,214,10,0.4)'};
    geoLayerRef.current.eachLayer(function(layer){
      var name=(layer.feature&&layer.feature.properties&&layer.feature.properties.name)||'';
      var lv=getAdvLevel(name);
      if(lv>0){
        if(advFilter.has(lv)){
          layer.setStyle({fillColor:fillColors[lv],fillOpacity:1,color:strokeColors[lv],weight:1.5,opacity:1});
        }else{
          layer.setStyle({fillColor:'transparent',fillOpacity:0,color:'transparent',weight:0,opacity:0});
        }
      }
    });
  },[advFilter]);

  // Update markers when filter changes — use MarkerClusterGroup if available, else plain markers
  useEffect(()=>{
    if(!mapRef.current)return;
    const map=mapRef.current;
    // Remove old markers/cluster group
    markersRef.current.forEach(m=>map.removeLayer(m));
    markersRef.current=[];
    const filtered=mf==='ALL'?INCIDENTS:INCIDENTS.filter(i=>i.cat===mf);
    var useCluster=typeof L.markerClusterGroup==='function';
    var group=useCluster?L.markerClusterGroup({
      maxClusterRadius:40,
      spiderfyOnMaxZoom:true,
      showCoverageOnHover:false,
      zoomToBoundsOnClick:true,
      iconCreateFunction:function(cluster){
        var count=cluster.getChildCount();
        var sz=count<5?'small':count<15?'medium':'large';
        return L.divIcon({html:'<div><span>'+count+'</span></div>',className:'marker-cluster marker-cluster-'+sz,iconSize:L.point(36,36)});
      }
    }):null;
    filtered.forEach(inc=>{
      const col=SC[inc.sv];
      const size=inc.sv==='critical'?10:8;
      const pulseClass=inc.sv==='critical'?'pulse-marker':'';
      const icon=L.divIcon({
        className:'',
        html:`<div style="width:${size}px;height:${size}px;background:${col};border-radius:50%;border:2px solid rgba(0,0,0,0.6);box-shadow:0 0 ${inc.sv==='critical'?'12':'6'}px ${col}80;cursor:pointer" class="${pulseClass}"></div>`,
        iconSize:[size,size],iconAnchor:[size/2,size/2]
      });
      const marker=L.marker([inc.lat,inc.lon],{icon});
      const popup=`<div style="font-family:Inter,sans-serif">
        <div style="font:600 10px 'JetBrains Mono';color:${col};text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${inc.cat} — ${inc.sv.toUpperCase()}</div>
        <div style="font:500 12px/1.4 Inter;color:#e5e5e5;margin-bottom:4px">${inc.t}</div>
        <div style="font:400 10px 'JetBrains Mono';color:#999">${inc.reg} · ${inc.tm} ago</div>
        <div style="font:500 10px 'JetBrains Mono';color:#999;margin-top:4px">${inc.imp}</div>
      </div>`;
      marker.bindPopup(popup,{maxWidth:280,closeButton:true});
      marker.on('mouseover',function(){this.openPopup()});
      if(group){group.addLayer(marker);}else{marker.addTo(map);markersRef.current.push(marker);}
    });
    if(group){map.addLayer(group);markersRef.current=[group];}
  },[mf]);

  // Advisory shading is now painted directly via L.circle in map init (zero external deps)

  const fi=mf==='ALL'?INCIDENTS:INCIDENTS.filter(i=>i.cat===mf);

  // Use live news for feed + wire, fallback to static
  const feedItems=liveNews.length>0?liveNews:INCIDENTS;
  const wireItems=liveNews.length>0?liveNews:NEWS;

  // Compute advisory summary stats
  const advStats=useMemo(()=>{
    const l4=advisories.filter(a=>a.level===4).length;
    const l3=advisories.filter(a=>a.level===3).length;
    const l2=advisories.filter(a=>a.level===2).length;
    return{l4,l3,l2,total:advisories.length};
  },[advisories]);

  // ═══ GENERATE BRIEF — one-page top 10 global security developments (web-sourced) ═══
  const generateBrief=async function(){
    var D=window.docx;if(!D){alert('Document library not loaded. Please refresh.');return;}
    var now=new Date();
    var dateStr=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    var timeStr=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false})+' UTC';
    // Tightly scoped queries — each requires TWO security-relevant terms to co-occur
    var queries=[
      {q:'(airstrike OR missile OR shelling OR "armed conflict" OR "military offensive") (killed OR casualties OR "civilian" OR troops OR strike) sourcelang:eng',tag:'ARMED CONFLICT'},
      {q:'("terrorist attack" OR "suicide bomb" OR "car bomb" OR "IED" OR "mass shooting" OR "extremist") (killed OR injured OR claimed OR plot) sourcelang:eng',tag:'TERRORISM'},
      {q:'(kidnapping OR hostage OR abduction OR "ransom") (gang OR cartel OR militia OR "armed group" OR pirates) sourcelang:eng',tag:'KIDNAP & RANSOM'},
      {q:'(earthquake OR tsunami OR hurricane OR typhoon OR "volcanic eruption" OR cyclone) (deaths OR evacuated OR destroyed OR emergency OR casualties) sourcelang:eng',tag:'NATURAL DISASTER'},
      {q:'(ransomware OR cyberattack OR "data breach") (government OR hospital OR infrastructure OR pipeline OR bank) sourcelang:eng',tag:'CYBER THREAT'},
      {q:'(detained OR arrested OR "political prisoner" OR "wrongful detention") (journalist OR opposition OR diplomat OR activist OR dissident) sourcelang:eng',tag:'DETENTION / ARREST'},
      {q:'(deepfake OR "AI-generated" OR disinformation) (election OR government OR military OR "influence operation") sourcelang:eng',tag:'SYNTHETIC MEDIA'},
      {q:'(cartel OR assassination OR "drug war" OR "gang violence" OR "organized crime") (Mexico OR Colombia OR Ecuador OR Brazil OR Honduras) sourcelang:eng',tag:'ORGANIZED CRIME'},
      {q:'(coup OR "regime change" OR "martial law" OR "state of emergency" OR uprising OR revolution) (military OR government OR parliament OR protest) sourcelang:eng',tag:'POLITICAL INSTABILITY'},
      {q:'("nuclear" OR "ballistic missile" OR "weapons test" OR "chemical attack") (North Korea OR Iran OR Russia OR threat OR launch) sourcelang:eng',tag:'WMD / PROLIFERATION'},
    ];
    // Relevance keywords — headlines must contain at least one to pass the quality filter
    var securityTerms=/kill|dead|attack|bomb|shoot|strike|seize|arrest|detain|hostage|kidnap|ransom|breach|hack|quake|tsunami|hurricane|typhoon|cyclone|erupt|flood|wildfire|coup|martial|uprising|missile|nuclear|weapon|terror|explo|casualt|evacuat|cartel|traffick|assassin|deepfake|disinfo|sanction|militia|drone|shell|siege|riot|clash|protest.*violen/i;
    // Fetch top stories across all categories via GDELT
    var allDevs=[];
    var fetchPromises=queries.map(function(cat){
      return gdeltFetch(cat.q,6,'1440min').then(function(data){
        if(data&&data.articles){
          data.articles.forEach(function(art){
            var title=decEnt(art.title||'');
            // Strip source suffix (e.g. " - Reuters")
            if(title.indexOf(' - ')>25)title=title.substring(0,title.lastIndexOf(' - '));
            // Quality gate: must match security-relevant terms
            if(!securityTerms.test(title))return;
            var src=art.domain||'';
            var key=title.slice(0,35).toLowerCase().replace(/[^a-z0-9]/g,'');
            allDevs.push({headline:title.slice(0,120),tag:cat.tag,source:src,time:timeAgo(art.seendate),key:key,seendate:art.seendate||'',sources:art.socialimage?2:1});
          });
        }
      }).catch(function(){});
    });
    await Promise.all(fetchPromises);
    // Deduplicate by fuzzy key
    var seen=new Set();
    var unique=allDevs.filter(function(d){if(seen.has(d.key))return false;seen.add(d.key);return true;});
    // Sort by recency
    unique.sort(function(a,b){return(b.seendate||'').localeCompare(a.seendate||'');});
    var top10=unique.slice(0,10);
    // Fallback to dashboard data if GDELT underperformed
    if(top10.length<5){
      var news=liveNews.length>0?liveNews:INCIDENTS;
      news.slice(0,10-top10.length).forEach(function(n){
        top10.push({headline:decEnt(n.t||n.title||'').slice(0,120),tag:(n.cat||'SECURITY').toUpperCase(),source:decEnt(n.src||n.reg||''),time:n.tm||''});
      });
    }
    // Analytical language — varies by category, uses probabilistic phrasing
    var catAnalysis={
      'ARMED CONFLICT':['Assessed as a probable escalation','Likely to exacerbate regional instability','Indicates sustained hostilities with potential for further escalation'],
      'TERRORISM':['Assessed with moderate-to-high confidence as a deliberate attack','Likely intended to destabilize security conditions','Suggests a persistent and elevated threat environment'],
      'KIDNAP & RANSOM':['Indicates a probable increase in targeted abduction activity','Assessed as consistent with known patterns of opportunistic kidnapping','Likely linked to organized criminal or militia activity'],
      'NATURAL DISASTER':['Assessed as a significant humanitarian and logistical disruption','Likely to strain emergency response capacity','Indicates elevated physical risk to affected populations'],
      'CYBER THREAT':['Assessed as a probable targeted intrusion or exploitation','Likely to have operational impact on affected systems','Indicates a credible threat to critical infrastructure or data integrity'],
      'DETENTION / ARREST':['Assessed as a probable politically motivated action','Likely to draw international scrutiny and diplomatic response','Indicates deteriorating conditions for civil liberties'],
      'SYNTHETIC MEDIA':['Assessed with low-to-moderate confidence as a coordinated influence effort','May represent an emerging information threat vector','Warrants monitoring for amplification and downstream effects'],
      'ORGANIZED CRIME':['Assessed as consistent with cartel or transnational criminal activity','Likely reflects ongoing territorial or operational disputes','Indicates a persistent threat to local governance and public safety'],
      'POLITICAL INSTABILITY':['Assessed as a probable inflection point for governance continuity','Likely to trigger cascading political and security effects','Indicates elevated risk of civil unrest or authoritarian consolidation'],
      'WMD / PROLIFERATION':['Assessed with high confidence as a strategic provocation','Likely intended to signal deterrence capability or coercive intent','Indicates a material threat to regional or global security architecture'],
    };
    // Build document — sizes in HALF-POINTS, spacing in twips, line in 240ths (240=single,360=1.5x,480=double)
    var children=[];
    children.push(new D.Paragraph({spacing:{after:60},children:[
      new D.TextRun({text:'SENTINEL NOVA  ',font:'Arial',size:36,bold:true,color:'cc0000'}),
      new D.TextRun({text:'Global Security Brief',font:'Arial',size:24,color:'555555'}),
    ]}));
    children.push(new D.Paragraph({spacing:{after:200},border:{bottom:{style:D.BorderStyle.SINGLE,size:3,color:'cc0000',space:6}},children:[
      new D.TextRun({text:'Top 10 Developments  |  Past 24 Hours  |  '+dateStr+'  |  '+timeStr,font:'Arial',size:17,color:'999999'}),
    ]}));
    top10.forEach(function(d,idx){
      var phrases=catAnalysis[d.tag]||['Assessed as a notable security development','Likely to warrant continued monitoring','Indicates an evolving risk environment'];
      var phrase=phrases[idx%phrases.length];
      children.push(new D.Paragraph({spacing:{before:idx===0?40:400,after:40,line:360},children:[
        new D.TextRun({text:String(idx+1)+'.  ',font:'Arial',size:20,bold:true,color:'cc0000'}),
        new D.TextRun({text:d.headline,font:'Arial',size:19,bold:true,color:'1a1a1a'}),
      ]}));
      children.push(new D.Paragraph({spacing:{after:20,line:360},indent:{left:380},children:[
        new D.TextRun({text:d.tag,font:'Arial',size:15,bold:true,color:'0055aa'}),
        new D.TextRun({text:'  \u2014  '+phrase+'.',font:'Arial',size:16,color:'555555',italics:true}),
        new D.TextRun({text:'  ('+d.source+(d.time?', '+d.time:'')+')',font:'Arial',size:14,color:'AAAAAA'}),
      ]}));
    });
    children.push(new D.Paragraph({spacing:{before:300,line:360},border:{top:{style:D.BorderStyle.SINGLE,size:1,color:'DDDDDD',space:6}},children:[
      new D.TextRun({text:'OSINT assessment compiled from open-source feeds. Probabilistic language reflects assessed confidence based on source reliability and multi-source corroboration. All items require independent human verification prior to operational use. Classification: UNCLASSIFIED / FOUO.',font:'Arial',size:15,color:'BBBBBB',italics:true}),
    ]}));
    var doc=new D.Document({
      styles:{default:{document:{run:{font:'Arial',size:20}}}},
      sections:[{
        properties:{page:{size:{width:12240,height:15840},margin:{top:1080,right:1200,bottom:900,left:1200}}},
        footers:{default:new D.Footer({children:[
          new D.Paragraph({alignment:D.AlignmentType.CENTER,children:[
            new D.TextRun({text:'Powered by SENTINEL NOVA \u2014 Human Verified',font:'Arial',size:12,color:'BBBBBB',italics:true}),
          ]})
        ]})},
        children:children
      }]
    });
    var blob=await D.Packer.toBlob(doc);
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url;
    a.download='SENTINEL_NOVA_Brief_'+now.toISOString().slice(0,10)+'.docx';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  return(
    <div>
      {/* Ticker */}
      <div className="ticker"><div className="tscroll">
        {[...TICKERS,...TICKERS].map((t,i)=>{var lp=livePrices[t.s];var price=lp?lp.p:t.p;var change=lp?lp.c:t.c;var up=lp?lp.u:t.u;return <React.Fragment key={i}>
          <span className="tk"><span className="s">{t.s}</span><span className="p">{price}</span><span className={up?'up':'dn'}>{change}</span></span>
          {i%5===4&&<span className="tsep">│</span>}
        </React.Fragment>})}
      </div></div>

      {/* Breaking News Banner — GDELT powered */}
      {breakingNews&&<div className="breaking-banner">
        <div className="bb-inner">
          <div className="bb-pulse"/>
          <span className="bb-tag">BREAKING</span>
          <span className="bb-headline"><a href={breakingNews.url} target="_blank" rel="noopener noreferrer">{breakingNews.title}</a></span>
          <span className="bb-sources">{breakingNews.sources} sources</span>
          <span className="bb-time">{breakingNews.time}</span>
          <button className="bb-dismiss" onClick={function(){setBannerDismissed(breakingNews.title.substring(0,40));setBreakingNews(null);}}>✕</button>
        </div>
      </div>}

      {/* Alert Queue */}
      {alertQueue.map(alert=>{
        let color='alert-red';
        if(alert.type==='orange')color='alert-orange';
        else if(alert.type==='yellow')color='alert-yellow';
        return <div key={alert.id} className={'alert-flash '+color}>{alert.message}</div>;
      })}

      {/* Header */}
      <div className="hdr">
        <div className="hdr-l"><div className="logo">SENTINEL NOVA<span>GLOBAL SECURITY TERMINAL</span></div><span style={{font:'600 8px var(--mono)',color:'#30d158',padding:'2px 8px',borderRadius:2,border:'1px solid rgba(48,209,88,.4)',background:'rgba(48,209,88,.1)',letterSpacing:'1.5px',marginLeft:12}}>v2.1</span></div>
        <div className="hdr-r">
          <div className="hdr-spgi">
            <span style={{font:'600 10px var(--mono)',color:'var(--t2)'}}>SPGI</span>
            <span style={{font:'700 11px var(--mono)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{livePrices.SPGI?livePrices.SPGI.p:'435.58'}</span>
            <svg width="48" height="16" viewBox="0 0 48 16"><polyline points={spgiIntraday.map((d,i)=>{const x=i/(spgiIntraday.length-1)*48;const mn=Math.min(...spgiIntraday.map(s=>s.p));const mx=Math.max(...spgiIntraday.map(s=>s.p));const range=mx-mn||1;return `${x},${2+((mx-d.p)/range)*12}`}).join(' ')} fill="none" stroke={livePrices.SPGI?(livePrices.SPGI.u?'#30d158':'#ff3b30'):'#30d158'} strokeWidth="1.2"/></svg>
            <span style={{font:'500 9px var(--mono)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{livePrices.SPGI?livePrices.SPGI.c:'+1.24%'}</span>
          </div>
          <span className="threat">⚠ {advStats.l4>0?'L4 ADVISORIES: '+advStats.l4:'THREAT LEVEL: ELEVATED'}</span>
          <span className="live" style={{flexShrink:0}}><span className="ldot"></span>LIVE</span>
          <span style={{whiteSpace:'nowrap',flexShrink:0,fontSize:10}}>{time.toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})}</span>
          <span style={{color:'var(--t3)',whiteSpace:'nowrap',flexShrink:0,fontSize:10}}>UTC {time.toISOString().slice(11,19)}</span>
          <button className="brief-btn" onClick={generateBrief} title="Download intelligence brief as .docx">BRIEF</button>
          <button className="theme-toggle" onClick={function(){setDarkMode(!darkMode);}} title={darkMode?'Light Mode':'Dark Mode'}>{darkMode?'☀':'☾'}</button>
        </div>
      </div>

      <div className="shell">
        {/* LEFT SIDEBAR */}
        <div className="sidebar">
          {/* TRAVEL ADVISORIES */}
          <div className="ph"><div className="pt">◆ Travel Advisories</div><span className="pb" style={{background:advLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:advLive?'var(--grn)':'var(--t3)'}}>{advLive?'● LIVE':'LOADING'}</span></div>
          {/* Summary bar */}
          {advLive&&<div style={{display:'flex',gap:0,borderBottom:'1px solid var(--bdr)'}}>
            {[[4,'#ff3b30','rgba(255,59,48,0.08)','L4',advStats.l4],[3,'#ff9500','rgba(255,149,0,0.06)','L3',advStats.l3],[2,'#ffd60a','rgba(255,214,10,0.05)','L2',advStats.l2]].map(function(item,idx){
              var lv=item[0],col=item[1],bg=item[2],label=item[3],count=item[4];
              var active=advFilter.has(lv);
              return <div key={lv} className={'adv-tog'+(active?' on':' off')} onClick={function(){setAdvFilter(function(prev){var next=new Set(prev);if(next.has(lv))next.delete(lv);else next.add(lv);return next;});}} style={{flex:1,padding:'8px 8px 10px',textAlign:'center',background:active?bg:'transparent',borderRight:idx<2?'1px solid var(--bdr)':'none',cursor:'pointer',color:col}}>
                <div style={{font:'700 18px var(--mono)',color:active?col:'var(--t3)'}}>{count}</div>
                <div style={{font:'600 7px var(--mono)',color:active?col:'var(--t3)',letterSpacing:'.5px',opacity:active?0.8:0.4}}>{label}</div>
                <div style={{font:'500 6px var(--mono)',color:active?col:'var(--t3)',marginTop:2,opacity:0.5}}>{active?'ON':'OFF'}</div>
              </div>;
            })}
          </div>}
          <div className="pbd" style={{padding:'6px 12px'}}>
            {advisories.length>0?advisories.filter(adv=>advFilter.has(adv.level)).map((adv,i)=>{
              const inner=<div key={i} style={{padding:'5px 0',borderBottom:i<advisories.length-1?'1px solid var(--bdr)':'none',overflow:'hidden'}}>
                <div style={{display:'flex',alignItems:'center',gap:5,marginBottom:2,overflow:'hidden'}}>
                  <span style={{font:'600 7px var(--mono)',color:ADV_COLORS[adv.level],padding:'1px 4px',borderRadius:2,background:ADV_COLORS[adv.level]+'18',border:'1px solid '+ADV_COLORS[adv.level]+'35',letterSpacing:'.5px',flexShrink:0,whiteSpace:'nowrap'}}>{ADV_SHORT[adv.level]||'L'+adv.level}</span>
                  <span style={{font:'400 8px var(--mono)',color:'var(--t3)',marginLeft:'auto',flexShrink:0}}>{adv.date?adv.date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):''}</span>
                </div>
                <div style={{font:'500 10px/1.3 Inter,sans-serif',color:'var(--t1)',cursor:adv.url?'pointer':'default'}}>{adv.country}{adv.url&&<span style={{color:'var(--t3)',fontSize:9,marginLeft:4}}>↗</span>}</div>
                {adv.desc&&<div style={{font:'400 9px/1.3 Inter,sans-serif',color:'var(--t3)',marginTop:1}}>{adv.desc.slice(0,70)}</div>}
              </div>;
              return adv.url?<a key={i} href={adv.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
            }):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading advisories...</div>}
          </div>

          {/* POLYMARKET — GEOPOLITICAL RISK */}
          <div className="ph"><div className="pt">◆ Polymarket Geopolitical Risk</div><span className="pb" style={{background:polyLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:polyLive?'var(--grn)':'var(--t3)'}}>{polyLive?'● LIVE':'LOADING'}</span></div>
          <div className="pbd" style={{padding:'6px 12px'}}>
            {polyMarkets.length>0?polyMarkets.map((m,i)=>{
              var pct=Math.round(m.yes*100);
              var barColor=pct>=60?'#ff3b30':pct>=35?'#ff9500':'#30d158';
              var inner=<div key={i} style={{padding:'6px 0',borderBottom:i<polyMarkets.length-1?'1px solid var(--bdr)':'none'}}>
                <div style={{font:'500 10px/1.3 Inter,sans-serif',color:'var(--t1)',marginBottom:4}}>{m.question}</div>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <div style={{flex:1,height:6,background:'var(--bg0)',borderRadius:3,overflow:'hidden'}}>
                    <div style={{width:pct+'%',height:'100%',background:barColor,borderRadius:3,transition:'width 1s ease'}}></div>
                  </div>
                  <span style={{font:'700 11px var(--mono)',color:barColor,minWidth:36,textAlign:'right'}}>{pct}%</span>
                  <span style={{font:'400 8px var(--mono)',color:'var(--t3)',minWidth:44,textAlign:'right'}}>{m.volume}</span>
                </div>
              </div>;
              var pmUrl='https://polymarket.com/search?query='+encodeURIComponent(m.question);
              return <a key={i} href={pmUrl} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>;
            }):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading markets...</div>}
          </div>
        </div>

        {/* CENTER */}
        <div className="center">
          {/* MAP */}
          <div style={{flex:'1 1 55%',minHeight:0,borderBottom:'1px solid var(--bdr)'}}>
            <div className="mwrap">
              <div id="leaflet-map"></div>
              <div className="mfilt" style={{zIndex:1000}}>
                {['ALL','CONFLICT','CLIMATE','CYBER','ENERGY','ECONOMIC'].map(f=>(
                  <button key={f} className={`mfb ${mf===f?'a':''}`} onClick={()=>setMf(f)}>{f}</button>
                ))}
              </div>
              <div className="map-search">
                <input type="text" placeholder="Search country..." onKeyDown={function(e){
                  if(e.key==='Enter'){
                    var query=e.target.value.trim().toLowerCase();
                    if(!query)return;
                    // Search in GeoJSON layer
                    var found=false;
                    if(geoLayerRef.current){
                      geoLayerRef.current.eachLayer(function(layer){
                        if(found)return;
                        var name=(layer.feature&&layer.feature.properties&&layer.feature.properties.name)||'';
                        if(name.toLowerCase().indexOf(query)!==-1){
                          found=true;
                          var bounds=layer.getBounds();
                          mapRef.current.flyToBounds(bounds,{padding:[50,50],duration:1.2});
                          var lv=getAdvLevel(name);
                          var center=bounds.getCenter();
                          setCountryBrief({name:name,level:lv,lat:center.lat,lon:center.lng});
                        }
                      });
                    }
                    // If not found in advisory countries, try geocoding via Nominatim
                    if(!found&&mapRef.current){
                      fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(e.target.value.trim())+'&limit=1')
                        .then(function(r){return r.json();})
                        .then(function(data){
                          if(data&&data[0]){
                            var lat=parseFloat(data[0].lat);
                            var lon=parseFloat(data[0].lon);
                            mapRef.current.flyTo([lat,lon],5,{duration:1.2});
                            setCountryBrief({name:data[0].display_name.split(',')[0],level:0,lat:lat,lon:lon});
                          }
                        }).catch(function(){});
                    }
                    e.target.value='';
                  }
                }}/>
              </div>
              <div className="mleg" style={{zIndex:1000}}>
                {Object.entries(CC).slice(0,6).map(([k,v])=><span key={k} className="ml"><span className="mld" style={{background:v}}></span>{k}</span>)}
              </div>
            </div>
          </div>

          {/* BOTTOM: Intel + Trends */}
          <div style={{flex:'1 1 45%',display:'grid',gridTemplateColumns:'1fr 1fr',overflow:'hidden'}}>
            {/* Intel Feed — live or fallback */}
            <div style={{overflow:'auto',borderRight:'1px solid var(--bdr)',display:'flex',flexDirection:'column'}}>
              <div className="ph">
                <div className="pt">◆ Intelligence Feed</div>
                <span className="pb" style={{background:feedStatus==='live'?'var(--grnbg)':'var(--redbg)',color:feedStatus==='live'?'var(--grn)':'var(--red)'}}>
                  {feedStatus==='live'?'● LIVE RSS':feedStatus==='loading'?'LOADING...':feedItems.length+' ACTIVE'}
                </span>
              </div>
              <div className="isrch">
                <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>🔍</span>
                <input
                  type="text"
                  placeholder="Search intel — e.g. Mexico cartel, Iran nuclear, bird flu..."
                  value={searchQuery}
                  onChange={e=>setSearchQuery(e.target.value)}
                  onKeyDown={e=>{if(e.key==='Enter')searchIntel(searchQuery);}}
                />
                <button onClick={()=>searchIntel(searchQuery)}>{searching?'SEARCHING...':'SEARCH'}</button>
                {searchResults.length>0&&<button className="clear" onClick={clearSearch}>✕ CLEAR</button>}
              </div>
              <div className="pbd" style={{flex:1,overflow:'auto'}}>
                {feedStatus==='live'?
                  liveNews.map(function(item,idx){
                    return <a key={idx} href={item.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                    <div className="fi">
                      <div className="fit">
                        <div className="fis" style={{background:SC[item.sv]}}/>
                        <span className="fitg" style={{background:(CC[item.cat]||'#999')+'20',color:CC[item.cat]||'#999',border:'1px solid '+(CC[item.cat]||'#999')+'40'}}>{item.cat}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.src}</span>
                        <span className="fitm">{item.tm}</span>
                      </div>
                      <div className="fitt" style={{cursor:'pointer'}}>{item.t} <span style={{color:'var(--t3)',fontSize:9}}>↗</span></div>
                    </div></a>;
                  })
                :
                  INCIDENTS.map(function(inc){
                    var q=encodeURIComponent(inc.t.split('—')[0].trim());
                    var url='https://news.google.com/search?q='+q;
                    return <a key={inc.id} href={url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                    <div className="fi">
                      <div className="fit">
                        <div className="fis" style={{background:SC[inc.sv]}}/>
                        <span className="fitg" style={{background:CC[inc.cat]+'20',color:CC[inc.cat],border:'1px solid '+CC[inc.cat]+'40'}}>{inc.cat}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{inc.reg}</span>
                        <span className="fitm">{inc.tm}</span>
                      </div>
                      <div className="fitt" style={{cursor:'pointer'}}>{inc.t} <span style={{color:'var(--t3)',fontSize:9}}>↗</span></div>
                      <div className="fisu">{inc.imp}</div>
                    </div></a>;
                  })
                }
              </div>
            </div>

            {/* Weather + NOTAMs Split Panel */}
            <div style={{overflow:'hidden',display:'flex',flexDirection:'column'}}>
              {/* SEVERE WEATHER */}
              <div style={{flex:'1 1 50%',overflow:'auto',borderBottom:'1px solid var(--bdr)'}}>
                <div className="ph">
                  <div className="pt">◆ Severe Weather</div>
                  <span className="pb" style={{background:'var(--redbg)',color:'var(--red)'}}>{wxAlerts.filter(w=>w.sev==='extreme').length} EXTREME</span>
                </div>
                <div className="pbd" style={{padding:'6px 12px'}}>
                  {wxAlerts.map((wx,i)=>{
                    const inner=<div key={i} style={{padding:'6px 0',borderBottom:i<wxAlerts.length-1?'1px solid var(--bdr)':'none'}}>
                      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                        <span style={{fontSize:12}}>{wx.icon}</span>
                        <span style={{font:'600 9px var(--mono)',color:WX_SEV_COLORS[wx.sev],textTransform:'uppercase',letterSpacing:'.5px',padding:'1px 5px',borderRadius:2,background:WX_SEV_COLORS[wx.sev]+'18',border:'1px solid '+WX_SEV_COLORS[wx.sev]+'35'}}>{wx.sev}</span>
                        <span style={{font:'500 9px var(--mono)',color:'var(--t3)'}}>{wx.type}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{wx.time}</span>
                      </div>
                      <div style={{font:'500 11px/1.3 Inter,sans-serif',color:'var(--t1)'}}>{wx.title}</div>
                      <div style={{font:'400 10px Inter,sans-serif',color:'var(--t3)',marginTop:2}}>{wx.detail}</div>
                    </div>;
                    return wx.url?<a key={i} href={wx.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
                  })}
                </div>
              </div>

              {/* NOTAMs */}
              <div style={{flex:'1 1 50%',overflow:'auto'}}>
                <div className="ph">
                  <div className="pt">◆ Active NOTAMs</div>
                  <span className="pb" style={{background:notamLive?'var(--grnbg)':'var(--redbg)',color:notamLive?'var(--grn)':'var(--red)'}}>{notamLive?'● LIVE':notams.filter(n=>n.status==='PROHIBITED').length+' PROHIBITED'}</span>
                </div>
                <div className="pbd" style={{padding:'6px 12px'}}>
                  {notams.map((n,i)=>{
                    const inner=<div key={i} style={{padding:'6px 0',borderBottom:i<notams.length-1?'1px solid var(--bdr)':'none'}}>
                      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                        <span style={{font:'600 9px var(--mono)',color:'var(--t2)'}}>{n.id}</span>
                        <span style={{font:'600 8px var(--mono)',color:NOTAM_STATUS_COLORS[n.status]||n.color,textTransform:'uppercase',letterSpacing:'.5px',padding:'1px 5px',borderRadius:2,background:(NOTAM_STATUS_COLORS[n.status]||n.color)+'18',border:'1px solid '+(NOTAM_STATUS_COLORS[n.status]||n.color)+'35'}}>{n.status}</span>
                        {n.src&&<span style={{font:'400 8px var(--mono)',color:'var(--t3)',padding:'1px 4px',border:'1px solid var(--bdr)',borderRadius:2}}>{n.src}</span>}
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{n.time}</span>
                      </div>
                      <div style={{font:'500 10px/1.3 var(--mono)',color:'var(--t1)',cursor:n.url?'pointer':'default'}}>{n.zone}{n.url&&<span style={{color:'var(--t3)',fontSize:9,marginLeft:4}}>↗</span>}</div>
                      <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:2}}>{n.detail}</div>
                    </div>;
                    return n.url?<a key={i} href={n.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* RIGHT PANEL */}
        <div className="rpanel">
          {/* SPGI */}
          <div className="ph"><div className="pt">◆ SPGI — S&P Global</div><span className="pb" style={{background:livePrices.SPGI?(livePrices.SPGI.u?'var(--grnbg)':'var(--redbg)'):'var(--grnbg)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{livePrices.SPGI?livePrices.SPGI.c:'+1.24%'}</span></div>
          <div className="pbd">
            <div style={{display:'flex',alignItems:'baseline',gap:8}}>
              <span style={{font:'700 22px var(--mono)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{'$'+(livePrices.SPGI?livePrices.SPGI.p:'435.58')}</span>
              <span style={{font:'500 11px var(--mono)',color:livePrices.SPGI?(livePrices.SPGI.u?'var(--grn)':'var(--red)'):'var(--grn)'}}>{livePrices.SPGI?livePrices.SPGI.c:'+$6.28'}</span>
            </div>
            <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:2}}>NYSE · {livePrices.SPGI?'● LIVE':'Intraday'} · Updated {time.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false})}</div>
            <div style={{marginTop:8}}><Sparkline data={spgiIntraday} dataKey="p" w={260} h={55} color={livePrices.SPGI?(livePrices.SPGI.u?'#30d158':'#ff3b30'):'#30d158'}/></div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginTop:8,font:'400 9px var(--mono)'}}>
              <div><span style={{color:'var(--t3)'}}>Open</span><br/><span style={{color:'var(--t1)'}}>{spgiIntraday.length>0?spgiIntraday[0].p.toFixed(2):'508.20'}</span></div>
              <div><span style={{color:'var(--t3)'}}>High</span><br/><span style={{color:'var(--t1)'}}>{Math.max(...spgiIntraday.map(function(d){return d.p})).toFixed(2)}</span></div>
              <div><span style={{color:'var(--t3)'}}>Low</span><br/><span style={{color:'var(--t1)'}}>{Math.min(...spgiIntraday.map(function(d){return d.p})).toFixed(2)}</span></div>
              <div><span style={{color:'var(--t3)'}}>Mkt Cap</span><br/><span style={{color:'var(--t1)'}}>{livePrices.SPGI?'$'+(livePrices.SPGI.raw*314.8/1e9).toFixed(1)+'B':'$161.2B'}</span></div>
              <div><span style={{color:'var(--t3)'}}>Prev</span><br/><span style={{color:'var(--t1)'}}>{spgiIntraday.length>0?spgiIntraday[0].p.toFixed(2):'508.20'}</span></div>
              <div><span style={{color:'var(--t3)'}}>Points</span><br/><span style={{color:'var(--t1)'}}>{spgiIntraday.length} pts</span></div>
            </div>
          </div>

          {/* SPGI News */}
          <div className="ph"><div className="pt">◆ SPGI News & Updates</div><span className="pb" style={{background:spgiNewsLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:spgiNewsLive?'var(--grn)':'var(--t3)'}}>{spgiNewsLive?'● LIVE':'LOADING'}</span></div>
          <div className="pbd" style={{padding:'6px 12px'}}>
            {spgiNews.length>0?spgiNews.map((item,i)=>(
              <a key={i} href={item.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                <div style={{padding:'5px 0',borderBottom:i<spgiNews.length-1?'1px solid var(--bdr)':'none'}}>
                  <div style={{font:'500 10px/1.4 Inter,sans-serif',color:'var(--t1)',cursor:'pointer'}}>{item.t} <span style={{color:'var(--t3)',fontSize:9}}>↗</span></div>
                  <div style={{display:'flex',justifyContent:'space-between',marginTop:2}}>
                    <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.src}</span>
                    <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.tm}</span>
                  </div>
                </div>
              </a>
            )):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading SPGI news...</div>}
          </div>

          {/* France 24 Live Stream */}
          <div className="ph" style={{marginTop:8}}><div className="pt">◆ France 24 Live</div><span className="pb" style={{background:'var(--redbg)',color:'var(--red)'}}>● LIVE 24/7</span></div>
          <div style={{padding:'0 12px 12px',background:'var(--card)',borderRadius:'0 0 6px 6px'}}>
            <iframe
              src="https://embed.france24.com/en/live"
              style={{width:'100%',height:180,border:'1px solid var(--bdr)',borderRadius:4,marginTop:6}}
              allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
              allowFullScreen
              title="France 24 English Live"
            ></iframe>
            <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:4,textAlign:'center'}}>France 24 English · 24/7 International News · Independent & Impartial</div>
          </div>
        </div>
      </div>

      {/* News Ticker — live or fallback */}
      <div className="newstick">
        <span className="label">◆ WIRE</span>
        <div className="nscroll">
          {liveNews.length>0?
            [...liveNews,...liveNews].map((n,i)=><span key={i} className="nitem">
              <span className="ndot" style={{background:CC[n.cat]||'#999'}}></span>
              {n.url?<a href={n.url} target="_blank" rel="noopener noreferrer">{n.t}</a>:n.t}
              <span className="nsrc">{n.src}</span>
            </span>)
          :
            [...NEWS,...NEWS].map((n,i)=><span key={i} className="nitem">
              <span className="ndot" style={{background:n.c}}></span>
              {n.t}
              <span className="nsrc">{n.s}</span>
            </span>)
          }
        </div>
      </div>

      {/* Tooltip */}
      {tt&&<div className="tt" style={{left:tt.x,top:tt.y}}>
        <h5 style={{color:SC[tt.i.sv]}}>{tt.i.cat} — {tt.i.sv.toUpperCase()}</h5>
        <p style={{color:'var(--t1)',fontWeight:500}}>{tt.i.t}</p>
        <p style={{marginTop:3}}>{tt.i.reg} · {tt.i.tm} ago</p>
        <p style={{marginTop:2,color:'var(--t2)'}}>{tt.i.imp}</p>
      </div>}

      {/* Country Brief Panel */}
      {countryBrief&&<div className="country-brief">
        <div className="country-brief-header">
          <div style={{display:'flex',alignItems:'center',gap:8,flex:1}}>
            <span className="country-brief-title">{countryBrief.name}</span>
            <span className="country-brief-level" style={{background:ADV_COLORS[countryBrief.level]+'18',border:'1px solid '+ADV_COLORS[countryBrief.level]+'35',color:ADV_COLORS[countryBrief.level]}}>L{countryBrief.level}</span>
          </div>
          <button className="country-brief-close" onClick={function(){setCountryBrief(null);}}>✕</button>
        </div>
        <div className="country-brief-content">
          {/* Advisory Description */}
          <div className="cb-section">
            <div className="cb-section-title">Travel Advisory</div>
            <div className="cb-desc">{ADV_LABELS[countryBrief.level]}</div>
            {advisories.find(a=>a.country===countryBrief.name)?.desc&&<div className="cb-item" style={{marginTop:6}}>{advisories.find(a=>a.country===countryBrief.name).desc}</div>}
            {countryBrief.level>0&&<a href={getAdvUrl(countryBrief.name)} target="_blank" rel="noopener" style={{display:'inline-block',marginTop:8,font:'500 9px var(--mono)',color:'#0a84ff',textDecoration:'none',padding:'3px 8px',border:'1px solid rgba(10,132,255,0.3)',borderRadius:3,background:'rgba(10,132,255,0.08)',letterSpacing:'.3px'}}>View State Dept Advisory ↗</a>}
          </div>

          {/* Matching NOTAMs */}
          {notams.filter(n=>n.zone.toLowerCase().includes(countryBrief.name.toLowerCase())).length>0&&<div className="cb-section">
            <div className="cb-section-title">NOTAMs</div>
            {notams.filter(n=>n.zone.toLowerCase().includes(countryBrief.name.toLowerCase())).slice(0,3).map((n,i)=><div key={i} className="cb-item"><strong>{n.status}</strong>: {n.zone} — {n.detail.slice(0,50)}</div>)}
          </div>}

          {/* Matching Headlines */}
          {(liveNews.length>0?liveNews:NEWS).filter(n=>(n.t||n.title||'').toLowerCase().includes(countryBrief.name.toLowerCase())||(n.reg||'').toLowerCase().includes(countryBrief.name.toLowerCase())).length>0&&<div className="cb-section">
            <div className="cb-section-title">Headlines</div>
            {(liveNews.length>0?liveNews:NEWS).filter(n=>(n.t||n.title||'').toLowerCase().includes(countryBrief.name.toLowerCase())||(n.reg||'').toLowerCase().includes(countryBrief.name.toLowerCase())).slice(0,3).map((n,i)=><div key={i} className="cb-item">{n.t||n.title}</div>)}
          </div>}

          {/* Matching Prediction Markets */}
          {polyMarkets.filter(m=>m.question.toLowerCase().includes(countryBrief.name.toLowerCase())).length>0&&<div className="cb-section">
            <div className="cb-section-title">Prediction Markets</div>
            {polyMarkets.filter(m=>m.question.toLowerCase().includes(countryBrief.name.toLowerCase())).slice(0,2).map((m,i)=><div key={i} className="cb-item"><span style={{color:Math.round(m.yes*100)>=50?'#ff3b30':'#30d158',fontWeight:700}}>{Math.round(m.yes*100)}%</span> — {m.question.slice(0,55)}</div>)}
          </div>}
        </div>
      </div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
