<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>SENTINEL NOVA — Global Security Terminal</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#000;color:#d4d4d4;overflow-x:hidden;font-size:12px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#000}::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
:root{--bg0:#000;--bg1:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--bdr:#222;--bdrh:#333;--amber:#ff9500;--amberd:#b36800;--amberbg:rgba(255,149,0,0.08);--red:#ff3b30;--redbg:rgba(255,59,48,0.1);--grn:#30d158;--grnbg:rgba(48,209,88,0.08);--blu:#0a84ff;--cyan:#64d2ff;--pur:#bf5af2;--yel:#ffd60a;--t1:#e5e5e5;--t2:#999;--t3:#666;--mono:'JetBrains Mono',monospace}

/* TICKER */
.ticker{background:#050505;border-bottom:1px solid var(--bdr);height:24px;overflow:hidden;display:flex;align-items:center}
.tscroll{display:flex;animation:tsc 30s linear infinite;white-space:nowrap}.tscroll:hover{animation-play-state:paused}
@keyframes tsc{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.tk{display:inline-flex;align-items:center;gap:5px;margin-right:28px;font:500 11px var(--mono);letter-spacing:.3px}
.tk .s{color:var(--t2)}.tk .p{color:var(--t1)}.tk .up{color:var(--grn);font-size:10px}.tk .dn{color:var(--red);font-size:10px}
.tsep{color:var(--bdr);margin-right:28px}

/* HEADER */
.hdr{background:var(--bg1);border-bottom:1px solid var(--bdr);padding:8px 16px;display:flex;align-items:center;justify-content:space-between;min-height:40px;overflow:hidden}
.hdr-l{display:flex;align-items:center;gap:10px;flex-shrink:0}
.logo{font:700 13px var(--mono);color:var(--red);letter-spacing:2px;white-space:nowrap}
.logo span{color:var(--t3);font-weight:400;font-size:9px;letter-spacing:1px;margin-left:6px}
.hdr-r{display:flex;align-items:center;gap:10px;font:400 10px var(--mono);color:var(--t3);flex-shrink:1;min-width:0;overflow:hidden}
.live{display:flex;align-items:center;gap:5px}
.ldot{width:6px;height:6px;background:var(--grn);border-radius:50%;animation:bl 2s infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.3}}
.threat{padding:3px 8px;border-radius:3px;font:600 9px var(--mono);letter-spacing:.5px;text-transform:uppercase;background:var(--redbg);color:var(--red);border:1px solid rgba(255,59,48,.3);white-space:nowrap;flex-shrink:0}

/* LAYOUT */
.shell{display:grid;grid-template-columns:260px 1fr 280px;height:calc(100vh - 101px);overflow:hidden}
.sidebar{background:var(--bg1);border-right:1px solid var(--bdr);overflow-y:auto}
.center{display:flex;flex-direction:column;overflow:hidden}
.rpanel{background:var(--bg1);border-left:1px solid var(--bdr);overflow-y:auto}

/* PANELS */
.ph{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--bg2);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:2;gap:6px;min-height:28px;overflow:hidden}
.pt{font:600 9px var(--mono);text-transform:uppercase;letter-spacing:1px;color:var(--red);display:flex;align-items:center;gap:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
.pb{font:500 8px var(--mono);padding:1px 5px;border-radius:2px;letter-spacing:.5px;white-space:nowrap;flex-shrink:0}
.pbd{padding:10px 12px}

/* RISK GAUGES */
.rg{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--bdr)}.rg:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.rg-t{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px}
.rg-l{font:500 11px/1 'Inter',sans-serif;color:var(--t2)}
.rg-v{font:700 16px var(--mono)}
.rg-b{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;margin-bottom:3px}
.rg-f{height:100%;border-radius:2px;transition:width 1s ease}
.rg-m{font:400 9px var(--mono);color:var(--t3);display:flex;justify-content:space-between}

/* MAP */
.mwrap{position:relative;width:100%;height:100%;min-height:300px;background:var(--bg0)}
.mwrap svg{width:100%;height:100%}
#leaflet-map{width:100%;height:100%;background:#000;z-index:0}
.leaflet-container{background:#000!important}
.leaflet-control-zoom{border:1px solid var(--bdr)!important;border-radius:3px!important}
.leaflet-control-zoom a{background:var(--bg2)!important;color:var(--t2)!important;border-color:var(--bdr)!important;width:26px!important;height:26px!important;line-height:26px!important;font-size:13px!important}
.leaflet-control-zoom a:hover{background:var(--bg3)!important;color:var(--t1)!important}
.leaflet-control-attribution{display:none!important}
.pulse-marker{border-radius:50%;animation:pmark 2s infinite}
@keyframes pmark{0%{box-shadow:0 0 0 0 rgba(255,59,48,.5)}70%{box-shadow:0 0 0 12px rgba(255,59,48,0)}100%{box-shadow:0 0 0 0 rgba(255,59,48,0)}}
.leaflet-popup-content-wrapper{background:var(--bg2)!important;color:var(--t1)!important;border:1px solid var(--bdrh)!important;border-radius:6px!important;box-shadow:0 4px 20px rgba(0,0,0,.6)!important;font-family:'Inter',sans-serif!important;font-size:11px!important}
.leaflet-popup-tip{background:var(--bg2)!important;border:1px solid var(--bdrh)!important}
.leaflet-popup-close-button{color:var(--t3)!important;font-size:16px!important}
.leaflet-popup-close-button:hover{color:var(--t1)!important}
.conn-arc{stroke-dasharray:6,4;animation:arcflow 3s linear infinite}
@keyframes arcflow{0%{stroke-dashoffset:0}100%{stroke-dashoffset:-30}}
.mfilt{position:absolute;top:8px;left:8px;display:flex;gap:4px;flex-wrap:wrap;z-index:1000}
.mfb{font:500 9px var(--mono);padding:3px 8px;border-radius:2px;border:1px solid var(--bdr);background:var(--bg2);color:var(--t3);cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.5px}
.mfb:hover{border-color:var(--bdrh);color:var(--t2)}.mfb.a{background:var(--redbg);border-color:rgba(255,59,48,.4);color:var(--red)}
.mstat{position:absolute;top:8px;right:8px;display:flex;gap:6px}
.ms{background:rgba(0,0,0,.8);border:1px solid var(--bdr);border-radius:3px;padding:4px 8px;text-align:center}
.msv{font:700 14px var(--mono);display:block}.msl{font:400 8px var(--mono);color:var(--t3);text-transform:uppercase;letter-spacing:.5px}
.map-search{position:absolute;top:8px;right:8px;z-index:10000;display:flex;align-items:center;gap:4px;pointer-events:auto}
.map-search input{background:rgba(0,0,0,0.8);border:1px solid rgba(255,255,255,0.25);color:var(--t1);font:400 10px var(--mono);padding:6px 12px;border-radius:4px;width:180px;outline:none;backdrop-filter:blur(10px);pointer-events:auto}
.map-search input::placeholder{color:var(--t3)}
.map-search input:focus{border-color:rgba(10,132,255,0.6);box-shadow:0 0 8px rgba(10,132,255,0.3);background:rgba(0,0,0,0.9)}
.mleg{position:absolute;bottom:8px;left:8px;display:flex;gap:8px;font:400 8px var(--mono);color:var(--t3);flex-wrap:wrap;max-width:60%}
.ml{display:flex;align-items:center;gap:3px;white-space:nowrap}.mld{width:6px;height:6px;border-radius:50%}
.mpulse{animation:mp 2s infinite}@keyframes mp{0%{r:5;opacity:.9}50%{r:14;opacity:0}100%{r:5;opacity:0}}

/* CONNECTION LINES */
.conn-line{stroke-dasharray:4,3;animation:dash 20s linear infinite}
@keyframes dash{0%{stroke-dashoffset:0}100%{stroke-dashoffset:-200}}

/* NEWS TICKER */
.newstick{background:#050505;border-top:1px solid var(--bdr);height:22px;overflow:hidden;display:flex;align-items:center}
.newstick .label{font:600 9px var(--mono);color:var(--red);padding:0 10px;text-transform:uppercase;letter-spacing:1px;white-space:nowrap;border-right:1px solid var(--bdr);flex-shrink:0}
.nscroll{display:flex;animation:nsc 200s linear infinite;white-space:nowrap}.nscroll:hover{animation-play-state:paused}
.nitem a{color:inherit;text-decoration:none}.nitem a:hover{text-decoration:underline;color:var(--t1)}
@keyframes nsc{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.nitem{display:inline-flex;align-items:center;gap:6px;margin-right:40px;font:400 10px 'Inter',sans-serif;color:var(--t2)}
.nitem .ndot{width:4px;height:4px;border-radius:50%;flex-shrink:0}
.nitem .nsrc{font:400 9px var(--mono);color:var(--t3);margin-left:4px}

/* HEADER SPARKLINE */
.hdr-spgi{display:flex;align-items:center;gap:6px;padding:2px 8px;background:var(--bg2);border:1px solid var(--bdr);border-radius:3px;flex-shrink:0;white-space:nowrap}

/* BREAKING NEWS BANNER */
.breaking-banner{background:linear-gradient(90deg,#1a0000,#330000,#1a0000);border-bottom:2px solid #ff3b30;padding:0;overflow:hidden;animation:bannerIn .4s ease-out}
@keyframes bannerIn{from{max-height:0;opacity:0}to{max-height:60px;opacity:1}}
.breaking-banner .bb-inner{display:flex;align-items:center;gap:8px;padding:6px 12px;min-height:36px;overflow:hidden}
.breaking-banner .bb-pulse{width:8px;height:8px;border-radius:50%;background:#ff3b30;animation:bbpulse 1.2s ease-in-out infinite;flex-shrink:0}
@keyframes bbpulse{0%,100%{box-shadow:0 0 4px #ff3b30}50%{box-shadow:0 0 16px #ff3b30,0 0 30px rgba(255,59,48,.4)}}
.breaking-banner .bb-tag{font:700 9px var(--mono);color:#ff3b30;letter-spacing:1.5px;text-transform:uppercase;flex-shrink:0;padding:2px 8px;border:1px solid rgba(255,59,48,.4);border-radius:2px;background:rgba(255,59,48,.12)}
.breaking-banner .bb-headline{font:600 11px/1.3 'Inter',sans-serif;color:#ff6b6b;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.breaking-banner .bb-headline a{color:#ff6b6b;text-decoration:none}
.breaking-banner .bb-headline a:hover{color:#ff9999;text-decoration:underline}
.breaking-banner .bb-sources{font:400 9px var(--mono);color:var(--t3);flex-shrink:0;white-space:nowrap}
.breaking-banner .bb-time{font:400 9px var(--mono);color:var(--t3);flex-shrink:0}
.breaking-banner .bb-dismiss{background:none;border:1px solid rgba(255,59,48,.3);color:var(--t3);font:400 10px var(--mono);cursor:pointer;padding:2px 6px;border-radius:2px;flex-shrink:0}
.breaking-banner .bb-dismiss:hover{color:var(--t1);border-color:var(--t3)}

/* INTEL SEARCH */
.isrch{display:flex;align-items:center;gap:6px;padding:4px 12px;background:var(--bg2);border-bottom:1px solid var(--bdr)}
.isrch input{flex:1;background:var(--card);border:1px solid var(--bdr);border-radius:3px;padding:4px 8px;font:400 10px var(--mono);color:var(--t1);outline:none}
.isrch input::placeholder{color:var(--t3)}
.isrch input:focus{border-color:var(--red)}
.isrch button{background:var(--red);color:#fff;border:none;border-radius:3px;padding:4px 10px;font:600 9px var(--mono);cursor:pointer;letter-spacing:.5px}
.isrch button:hover{opacity:.85}
.isrch .clear{background:transparent;color:var(--t3);border:1px solid var(--bdr);padding:4px 8px}

/* INTEL FEED */
.fi{padding:8px 0;border-bottom:1px solid var(--bdr)}.fi:last-child{border-bottom:none}
.fi:hover{background:var(--bg2);margin:0 -12px;padding:8px 12px}
.fit{display:flex;align-items:center;gap:5px;margin-bottom:3px;overflow:hidden}
.fis{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.fitg{font:500 8px var(--mono);padding:1px 5px;border-radius:2px;text-transform:uppercase;letter-spacing:.5px;flex-shrink:0;white-space:nowrap}
.fitm{font:400 9px var(--mono);color:var(--t3);margin-left:auto;flex-shrink:0;white-space:nowrap}
.fitt{font:500 11px/1.4 'Inter',sans-serif;color:var(--t1);overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.fisu{font:400 10px 'Inter',sans-serif;color:var(--t3);margin-top:2px}

/* MARKET */
.mr{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(34,34,34,.5);font:400 11px var(--mono)}
.mr:last-child{border-bottom:none}
.mrs{color:var(--t1);font-weight:500;width:65px}.mrp{color:var(--t1);width:65px;text-align:right}.mrc{width:60px;text-align:right;font-size:10px}
.msec{padding:6px 12px;font:600 9px var(--mono);color:var(--red);letter-spacing:1.5px;text-transform:uppercase;background:var(--bg2);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:1}

/* CHART TABS */
.ctabs{display:flex;gap:4px;margin-bottom:8px}
.ct{font:500 9px var(--mono);padding:3px 8px;border-radius:2px;border:1px solid var(--bdr);background:transparent;color:var(--t3);cursor:pointer;letter-spacing:.5px;transition:all .15s}
.ct.a{background:var(--redbg);border-color:rgba(255,59,48,.4);color:var(--red)}.ct:hover{border-color:var(--bdrh)}

/* TOOLTIP */
.tt{position:fixed;background:var(--bg2);border:1px solid var(--bdrh);border-radius:4px;padding:8px 12px;z-index:200;pointer-events:none;max-width:280px;box-shadow:0 4px 20px rgba(0,0,0,.6)}
.tt h5{font:600 11px 'Inter',sans-serif;margin-bottom:3px}.tt p{font:400 10px 'Inter',sans-serif;color:var(--t2);line-height:1.4}

/* REGIONAL */
.rr{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--bdr);font:400 10px var(--mono)}
.rr:last-child{border-bottom:none}

/* ALERT FLASH */
.alert-flash{position:fixed;top:55px;left:0;right:0;background:var(--bg2);border-bottom:3px solid;padding:10px 16px;z-index:150;animation:alertSlide .3s ease-out;font:500 11px Inter,sans-serif;color:var(--t1);box-shadow:0 2px 10px rgba(0,0,0,.4)}
.alert-flash.alert-red{border-bottom-color:#ff3b30;background:rgba(255,59,48,0.08)}
.alert-flash.alert-orange{border-bottom-color:#ff9500;background:rgba(255,149,0,0.08)}
.alert-flash.alert-yellow{border-bottom-color:#ffd60a;background:rgba(255,214,10,0.08)}
@keyframes alertSlide{from{transform:translateY(-100%);opacity:0}to{transform:translateY(0);opacity:1}}

/* COUNTRY BRIEF PANEL */
.country-brief{position:fixed;right:12px;top:80px;width:340px;max-height:calc(100vh - 100px);background:var(--bg2);border:1px solid var(--bdr);border-radius:6px;box-shadow:0 8px 32px rgba(0,0,0,.6);overflow-y:auto;z-index:140;animation:briefSlide .3s ease-out;font-family:Inter,sans-serif}
@keyframes briefSlide{from{transform:translateX(360px);opacity:0}to{transform:translateX(0);opacity:1}}
.country-brief-header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--bdr);gap:8px}
.country-brief-title{font:700 13px var(--mono);color:var(--t1)}
.country-brief-level{font:700 10px var(--mono);padding:2px 6px;border-radius:2px;text-transform:uppercase;letter-spacing:.5px}
.country-brief-close{background:none;border:none;color:var(--t3);cursor:pointer;font:700 16px var(--mono);padding:0}
.country-brief-close:hover{color:var(--t1)}
.country-brief-content{padding:12px}
.cb-section{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--bdr)}
.cb-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.cb-section-title{font:600 10px var(--mono);color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.cb-item{font:400 9px Inter,sans-serif;color:var(--t2);line-height:1.5;margin-bottom:4px}
.cb-item:last-child{margin-bottom:0}
.cb-desc{font:400 10px Inter,sans-serif;color:var(--t1);line-height:1.4}

/* THEME TOGGLE */
.theme-toggle{background:transparent;border:1px solid var(--bdr);color:var(--t2);padding:3px 8px;border-radius:3px;cursor:pointer;font:500 11px var(--mono);transition:all .2s;margin-left:8px}
.theme-toggle:hover{border-color:var(--bdrh);color:var(--t1)}
.adv-tog{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;user-select:none;border-radius:2px;flex-direction:column;position:relative}
.adv-tog:hover{filter:brightness(1.3)}
.adv-tog.off{opacity:0.25;filter:grayscale(1)}
.adv-tog::after{content:'';position:absolute;bottom:0;left:20%;right:20%;height:2px;border-radius:1px;transition:all .2s}
.adv-tog.on::after{background:currentColor;opacity:0.6}
.adv-tog.off::after{background:var(--t3);opacity:0.15}
.adv-tooltip{background:rgba(0,0,0,0.9)!important;color:#fff!important;border:1px solid rgba(255,255,255,0.2)!important;border-radius:3px!important;font:500 10px 'JetBrains Mono',monospace!important;padding:6px 10px!important;box-shadow:0 2px 8px rgba(0,0,0,0.4)!important;pointer-events:auto!important;max-width:260px!important}
.adv-tooltip::before{border-top-color:rgba(0,0,0,0.9)!important}
.adv-tooltip a{pointer-events:auto!important;display:inline-block;margin-top:2px}
.marker-cluster{background:rgba(0,0,0,0.5)!important;border:2px solid rgba(255,255,255,0.3)!important}
.marker-cluster div{background:rgba(0,0,0,0.7)!important;color:#fff!important;font:600 11px var(--mono)!important}
.marker-cluster-small{background:rgba(255,149,0,0.3)!important;border-color:rgba(255,149,0,0.5)!important}
.marker-cluster-small div{background:rgba(255,149,0,0.6)!important}
.marker-cluster-medium{background:rgba(255,59,48,0.3)!important;border-color:rgba(255,59,48,0.5)!important}
.marker-cluster-medium div{background:rgba(255,59,48,0.6)!important}
.marker-cluster-large{background:rgba(255,59,48,0.4)!important;border-color:rgba(255,59,48,0.7)!important}
.marker-cluster-large div{background:rgba(255,59,48,0.8)!important}
.brief-btn{background:rgba(10,132,255,.12);border:1px solid rgba(10,132,255,.4);color:#0a84ff;padding:3px 8px;border-radius:3px;cursor:pointer;font:600 9px var(--mono);letter-spacing:.5px;transition:all .2s;white-space:nowrap;flex-shrink:0}
.brief-btn:hover{background:rgba(10,132,255,.25);color:#4da6ff}
.brief-btn:disabled{opacity:.5;cursor:wait}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useMemo}=React;

/* ═══ MINI SVG CHART COMPONENTS ═══ */
const Sparkline=({data,dataKey,w=200,h=60,color='#30d158',fill=true,showAxis=false})=>{
  const vals=data.map(d=>d[dataKey]);
  const mn=Math.min(...vals),mx=Math.max(...vals);
  const range=mx-mn||1;
  const pad=4;
  const pts=vals.map((v,i)=>{
    const x=pad+(i/(vals.length-1))*(w-pad*2);
    const y=pad+((mx-v)/range)*(h-pad*2);
    return `${x},${y}`;
  });
  const line=pts.join(' ');
  const areaPath=`M${pts[0]} L${line.replace(/,/g,' ').split(' L').join(' L')} L${pad+(vals.length-1)/(vals.length-1)*(w-pad*2)},${h} L${pad},${h} Z`;
  const polyline=pts.join(' ');
  const gradId='g'+Math.random().toString(36).slice(2,8);
  return(
    <svg width="100%" height={h} viewBox={`0 0 ${w} ${h}`} preserveAspectRatio="none">
      {fill&&<defs><linearGradient id={gradId} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={color} stopOpacity=".25"/><stop offset="100%" stopColor={color} stopOpacity="0"/></linearGradient></defs>}
      {fill&&<polygon points={`${pts[0]} ${polyline} ${pad+(vals.length-1)/(vals.length-1)*(w-pad*2)},${h-pad} ${pad},${h-pad}`} fill={`url(#${gradId})`}/>}
      <polyline points={polyline} fill="none" stroke={color} strokeWidth="1.5" strokeLinejoin="round" strokeLinecap="round"/>
    </svg>
  );
};

const AreaChartSVG=({data,keys,colors,w=400,h=180,labels})=>{
  const allVals=keys.flatMap(k=>data.map(d=>d[k]));
  const mx=Math.max(...allVals),mn=0;
  const range=mx-mn||1;
  const pad={t:10,r:10,b:24,l:32};
  const cw=w-pad.l-pad.r,ch=h-pad.t-pad.b;
  const toX=i=>pad.l+(i/(data.length-1))*cw;
  const toY=v=>pad.t+((mx-v)/range)*ch;
  return(
    <svg width="100%" viewBox={`0 0 ${w} ${h}`} style={{display:'block'}}>
      {/* grid */}
      {[0,.25,.5,.75,1].map((f,i)=>{
        const y=pad.t+f*ch;
        const v=Math.round(mx-(f*range));
        return <g key={i}><line x1={pad.l} y1={y} x2={w-pad.r} y2={y} stroke="#1a1a1a" strokeWidth=".5"/><text x={pad.l-4} y={y+3} fill="#666" fontSize="8" fontFamily="JetBrains Mono" textAnchor="end">{v}</text></g>;
      })}
      {/* x labels */}
      {data.map((d,i)=><text key={i} x={toX(i)} y={h-4} fill="#666" fontSize="8" fontFamily="JetBrains Mono" textAnchor="middle">{d.d||d.month||''}</text>)}
      {/* areas + lines */}
      {keys.map((k,ki)=>{
        const pts=data.map((d,i)=>`${toX(i)},${toY(d[k])}`).join(' ');
        const gid='ac'+ki+Math.random().toString(36).slice(2,6);
        return <g key={k}>
          <defs><linearGradient id={gid} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={colors[ki]} stopOpacity=".15"/><stop offset="100%" stopColor={colors[ki]} stopOpacity="0"/></linearGradient></defs>
          <polygon points={`${toX(0)},${toY(0)} ${pts} ${toX(data.length-1)},${toY(0)}`} fill={`url(#${gid})`}/>
          <polyline points={pts} fill="none" stroke={colors[ki]} strokeWidth="1.5" strokeLinejoin="round"/>
        </g>;
      })}
    </svg>
  );
};

/* ═══ DATA ═══ */
const TICKERS=[
  {s:'ES1',p:'5,954',c:'-0.07%',u:false},{s:'NQ1',p:'21,220',c:'-0.14%',u:false},{s:'GD',p:'289.15',c:'+0.88%',u:true},
  {s:'DXY',p:'97.69',c:'-0.22%',u:false},{s:'GC1',p:'5,228',c:'+2.90%',u:true},{s:'CL1',p:'65.97',c:'-0.80%',u:false},
  {s:'US10Y',p:'4.010',c:'-6bp',u:false},{s:'VIX',p:'21.11',c:'+10.58%',u:true},{s:'BTC',p:'64,762',c:'-3.92%',u:false},
  {s:'EUR',p:'1.1820',c:'+0.31%',u:true},{s:'GBP',p:'1.3519',c:'+0.26%',u:true},{s:'JPY',p:'148.50',c:'-0.45%',u:false},
  {s:'NG1',p:'3.088',c:'-2.03%',u:false},{s:'HG1',p:'5.90',c:'-1.65%',u:false},{s:'W1',p:'572.00',c:'+2.27%',u:true},
];

/* Advisory level colors & labels */
const ADV_COLORS={4:'#ff3b30',3:'#ff9500',2:'#ffd60a',1:'#30d158'};
const ADV_LABELS={4:'DO NOT TRAVEL',3:'RECONSIDER TRAVEL',2:'EXERCISE INCREASED CAUTION',1:'EXERCISE NORMAL PRECAUTIONS'};
const ADV_SHORT={4:'L4 — DNT',3:'L3 — RECONSIDER',2:'L2 — CAUTION',1:'L1 — NORMAL'};

/* Country risk rating RSS */
const RATING_RSS_QUERIES=[
  'sovereign+credit+rating+downgrade+upgrade+Moody+Fitch+%22S%26P%22',
  'country+rating+outlook+negative+positive+watch+sovereign',
];

/* Current fallback — Level 4 Do Not Travel (as of Feb 2026, State Dept) */
const ADV_FALLBACK=[
  {country:'Afghanistan',level:4,title:'Afghanistan — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/afghanistan-travel-advisory.html',desc:'Terrorism, wrongful detention, kidnapping'},
  {country:'Ukraine',level:4,title:'Ukraine — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/ukraine-travel-advisory.html',desc:'Armed conflict with Russia, civil unrest'},
  {country:'Russia',level:4,title:'Russia — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/russia-travel-advisory.html',desc:'Wrongful detention, harassment of US citizens'},
  {country:'Syria',level:4,title:'Syria — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/syria-travel-advisory.html',desc:'Terrorism, civil unrest, kidnapping'},
  {country:'Iran',level:4,title:'Iran — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iran-travel-advisory.html',desc:'Wrongful detention, terrorism, kidnapping'},
  {country:'Iraq',level:4,title:'Iraq — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iraq-travel-advisory.html',desc:'Terrorism, kidnapping, armed conflict'},
  {country:'Yemen',level:4,title:'Yemen — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/yemen-travel-advisory.html',desc:'Civil unrest, terrorism, Houthi activity'},
  {country:'Somalia',level:4,title:'Somalia — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/somalia-travel-advisory.html',desc:'Terrorism, piracy, kidnapping'},
  {country:'Sudan',level:4,title:'Sudan — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/sudan-travel-advisory.html',desc:'Armed conflict, civil unrest, kidnapping'},
  {country:'South Sudan',level:4,title:'South Sudan — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/south-sudan-travel-advisory.html',desc:'Crime, kidnapping, armed conflict'},
  {country:'Libya',level:4,title:'Libya — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/libya-travel-advisory.html',desc:'Crime, terrorism, armed conflict'},
  {country:'Mali',level:4,title:'Mali — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mali-travel-advisory.html',desc:'Crime, terrorism, kidnapping'},
  {country:'Haiti',level:4,title:'Haiti — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/haiti-travel-advisory.html',desc:'Kidnapping, gang violence, civil unrest'},
  {country:'North Korea',level:4,title:'North Korea — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/north-korea-travel-advisory.html',desc:'Wrongful detention, nuclear/missile threat'},
  {country:'Venezuela',level:4,title:'Venezuela — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/venezuela-travel-advisory.html',desc:'Crime, civil unrest, wrongful detention'},
  {country:'Myanmar (Burma)',level:4,title:'Myanmar — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burma-travel-advisory.html',desc:'Civil unrest, armed conflict'},
  {country:'Burkina Faso',level:4,title:'Burkina Faso — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burkina-faso-travel-advisory.html',desc:'Terrorism, crime, kidnapping'},
  {country:'Niger',level:4,title:'Niger — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/niger-travel-advisory.html',desc:'Terrorism, kidnapping'},
  {country:'Central African Republic',level:4,title:'CAR — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/central-african-republic-travel-advisory.html',desc:'Crime, civil unrest, kidnapping'},
  {country:'Belarus',level:4,title:'Belarus — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/belarus-travel-advisory.html',desc:'Wrongful detention, Russia-Ukraine spillover'},
  {country:'Lebanon',level:4,title:'Lebanon — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/lebanon-travel-advisory.html',desc:'Crime, terrorism, Hezbollah activity'},
  {country:'Gaza Strip',level:4,title:'Gaza — Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/israel-the-west-bank-and-gaza-travel-advisory.html',desc:'Armed conflict, terrorism'},
  // Level 3 — Reconsider Travel
  {country:'Pakistan',level:3,title:'Pakistan — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism, sectarian violence'},
  {country:'Nigeria',level:3,title:'Nigeria — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, kidnapping'},
  {country:'Honduras',level:3,title:'Honduras — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, kidnapping'},
  {country:'Ethiopia',level:3,title:'Ethiopia — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Civil unrest, armed conflict'},
  {country:'Democratic Republic of the Congo',level:3,title:'DRC — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, armed conflict'},
  {country:'Cameroon',level:3,title:'Cameroon — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, kidnapping'},
  {country:'Chad',level:3,title:'Chad — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, minefields'},
  {country:'Mauritania',level:3,title:'Mauritania — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Guinea-Bissau',level:3,title:'Guinea-Bissau — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, civil unrest'},
  {country:'Bangladesh',level:3,title:'Bangladesh — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, civil unrest'},
  {country:'Guatemala',level:3,title:'Guatemala — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, violence'},
  {country:'Uganda',level:3,title:'Uganda — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Nicaragua',level:3,title:'Nicaragua — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Arbitrary detention, limited healthcare'},
  {country:'Colombia',level:3,title:'Colombia — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism, kidnapping'},
  {country:'Israel',level:3,title:'Israel — Level 3: Reconsider Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/israel-the-west-bank-and-gaza-travel-advisory.html',desc:'Terrorism, civil unrest, armed conflict'},
  // Level 2 — Exercise Increased Caution
  {country:'Kenya',level:2,title:'Kenya — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Mexico',level:2,title:'Mexico — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, kidnapping'},
  {country:'Brazil',level:2,title:'Brazil — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'Egypt',level:2,title:'Egypt — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism'},
  {country:'Turkey',level:2,title:'Turkey — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Terrorism, arbitrary detention'},
  {country:'India',level:2,title:'India — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'Philippines',level:2,title:'Philippines — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime, terrorism'},
  {country:'South Africa',level:2,title:'South Africa — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'Jamaica',level:2,title:'Jamaica — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Crime'},
  {country:'China',level:2,title:'China — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Wrongful detention, arbitrary enforcement'},
  {country:'Guinea',level:2,title:'Guinea — Level 2: Exercise Increased Caution',date:new Date('2026-01-09'),url:'https://travel.state.gov',desc:'Civil unrest, crime'},
];

/* Polymarket geopolitical search terms — used to find relevant markets */
const POLY_GEO_TERMS=['war','conflict','military','nuclear','invasion','ceasefire','nato','sanctions','coup','assassination','missile','iran','russia','ukraine','china','taiwan','korea','middle east','terrorism','troops','election','president','prime minister','parliament','tariff','embargo','drone','strike','border','refugee','diplomat','treaty','security','geopolit','protest','uprising','regime','dictator','authoritarian','democrat','republic','congress','senate','legislation','indictment','impeach','arrest','detain','hostage','kidnap','cartel','insurgent','rebel','separatist','annexation','occupation','airstrike','casualt','deploy','weapon','cyber','hack','breach','espionage','intelligence','surveillance','climate','hurricane','earthquake','tsunami','pandemic','outbreak','famine'];
const POLY_EXCLUDE=/\b(nba|nfl|mlb|nhl|nascar|ufc|mma|boxing|soccer|football match|premier league|la liga|bundesliga|serie a|ligue 1|champions league|world cup|super bowl|march madness|wimbledon|us open tennis|f1 grand prix|oscar|grammy|emmy|tony award|golden globe|billboard|box office|fashion|vogue|met gala|kardashian|celebrity|influencer|tiktok|youtube|twitch|spotify|netflix|hulu|disney\+|bachelor|bachelorette|love island|survivor|big brother|american idol|crypto price|bitcoin price|bitcoin etf|ethereum price|solana price|memecoin|dogecoin|shiba|pepe coin|nft|defi|airdrop|token launch|ipo price|stock price|earnings beat|revenue target|will .+ win the|who will win|mvp|rookie|playoff|championship|draft pick|transfer fee|album|song|movie|tv show|release date|game of the year|console|playstation|xbox|nintendo|streamer|podcast|book sales|bestseller|real estate|home price|mortgage rate|weather forecast|temperature|rain|snow)\b/i;
const POLY_EXCLUDE_CATS=/^(sports|entertainment|pop culture|music|gaming|crypto|business|science|technology)$/i;
/* Fallback markets if API is unavailable */
const POLY_FALLBACK=[
  {question:'Russia-Ukraine ceasefire in 2026?',yes:0.18,volume:'$12.4M',slug:'russia-ukraine-ceasefire-2026',category:'Geopolitics'},
  {question:'US-Iran military conflict in 2026?',yes:0.14,volume:'$8.2M',slug:'us-iran-military-conflict-2026',category:'Geopolitics'},
  {question:'China military action against Taiwan by 2027?',yes:0.06,volume:'$15.1M',slug:'china-taiwan-military-2027',category:'Geopolitics'},
  {question:'North Korea nuclear test in 2026?',yes:0.22,volume:'$3.8M',slug:'north-korea-nuclear-test-2026',category:'Geopolitics'},
  {question:'NATO Article 5 invoked by 2027?',yes:0.04,volume:'$5.6M',slug:'nato-article-5-2027',category:'Geopolitics'},
  {question:'Israel-Hezbollah ceasefire holds through 2026?',yes:0.42,volume:'$6.9M',slug:'israel-hezbollah-ceasefire-2026',category:'Geopolitics'},
  {question:'New US sanctions on China in 2026?',yes:0.71,volume:'$4.3M',slug:'us-china-sanctions-2026',category:'Geopolitics'},
  {question:'Venezuela military intervention by 2027?',yes:0.05,volume:'$2.1M',slug:'venezuela-intervention-2027',category:'Geopolitics'},
];

const INCIDENTS=[
  {id:19,t:'Mexico — "El Mencho" CJNG Leader Killed, Nationwide Cartel Violence Erupts',sv:'critical',cat:'CONFLICT',reg:'N. America',tm:'NOW',lat:20.3,lon:-103.3,imp:'25 National Guard killed, 250+ roadblocks, 20 states, tourists stranded, Puerto Vallarta airport shut',ty:'Cartel'},
  {id:1,t:'Russian Naval Buildup in Black Sea — NATO Alert Level Raised',sv:'critical',cat:'CONFLICT',reg:'E. Europe',tm:'12m',lat:44,lon:34,imp:'NATO Article 5 consultation triggered',ty:'Military'},
  {id:2,t:'Cat-5 Cyclone Bearing Down on Bay of Bengal — 2.4M at Risk',sv:'critical',cat:'CLIMATE',reg:'S. Asia',tm:'28m',lat:16,lon:87,imp:'$8.2B estimated damage',ty:'Weather'},
  {id:3,t:'Major Ransomware Attack on European Energy Grid Operator',sv:'critical',cat:'CYBER',reg:'W. Europe',tm:'1h',lat:50,lon:8,imp:'3 nations, grid at 60%',ty:'Cyber'},
  {id:4,t:'Taiwan Strait — PLA Air Incursions Reach 52 Sorties in 24h',sv:'critical',cat:'CONFLICT',reg:'E. Asia',tm:'2h',lat:24,lon:121,imp:'Semiconductor supply risk',ty:'Military'},
  {id:5,t:'Strait of Hormuz — Tanker Seized by IRGC Navy',sv:'critical',cat:'ENERGY',reg:'M. East',tm:'3h',lat:26.5,lon:56,imp:'Oil +4.2%, $2.1B/day trade risk',ty:'Maritime'},
  {id:6,t:'Sahel Region — Wagner Group Expands Into 3 New Countries',sv:'high',cat:'CONFLICT',reg:'W. Africa',tm:'4h',lat:14,lon:-2,imp:'Democratic transitions destabilized',ty:'Military'},
  {id:7,t:'Mediterranean Wildfire Season — 340K Ha Across 5 Nations',sv:'high',cat:'CLIMATE',reg:'S. Europe',tm:'5h',lat:38,lon:23,imp:'$3.1B economic impact',ty:'Wildfire'},
  {id:8,t:'North Korea ICBM Test — Trajectory Over Sea of Japan',sv:'critical',cat:'CONFLICT',reg:'E. Asia',tm:'6h',lat:39,lon:127,imp:'UN emergency session called',ty:'WMD'},
  {id:9,t:'Amazon Deforestation Surge — 40% Above 5-Year Average',sv:'high',cat:'CLIMATE',reg:'S. America',tm:'6h',lat:-5,lon:-60,imp:'Carbon sink -12%',ty:'Deforestation'},
  {id:10,t:'US-China Semiconductor Export Controls Expanded',sv:'high',cat:'ECONOMIC',reg:'Global',tm:'8h',lat:39,lon:-77,imp:'$45B bilateral trade affected',ty:'Trade'},
  {id:11,t:'Arctic Permafrost Methane Release Exceeds Models by 40%',sv:'high',cat:'CLIMATE',reg:'Arctic',tm:'10h',lat:72,lon:125,imp:'Tipping point risk elevated',ty:'Emissions'},
  {id:12,t:'Sudan Civil Conflict — 2M New Displacements',sv:'high',cat:'CONFLICT',reg:'E. Africa',tm:'12h',lat:15,lon:32,imp:'Humanitarian crisis, spillover',ty:'Civil War'},
  {id:13,t:'EU Carbon Border Tax Phase 2 — 8 Sectors Added',sv:'medium',cat:'REGULATORY',reg:'Europe',tm:'1d',lat:50,lon:4,imp:'€45B cross-border trade',ty:'Regulatory'},
  {id:14,t:'India-Pakistan Indus Treaty Renegotiation Stalls',sv:'high',cat:'CONFLICT',reg:'S. Asia',tm:'1d',lat:30,lon:72,imp:'300M affected, agriculture risk',ty:'Water'},
  {id:15,t:'Pacific Islands Climate Emergency — Sea Level +18cm',sv:'high',cat:'CLIMATE',reg:'Oceania',tm:'1d',lat:-8,lon:160,imp:'$420M relocation costs',ty:'Sea Level'},
  {id:16,t:'Venezuelan Migration Crisis — 800K Cross to Colombia',sv:'medium',cat:'SOCIAL',reg:'S. America',tm:'1d',lat:7,lon:-72,imp:'$1.2B aid needed',ty:'Migration'},
  {id:17,t:'Chinese Spy Balloon Incursions — 3 Nations Report',sv:'medium',cat:'INTEL',reg:'Global',tm:'2d',lat:45,lon:-100,imp:'Sovereignty concern',ty:'Espionage'},
  {id:18,t:'Gulf of Guinea Piracy — 12 Incidents in 30 Days',sv:'medium',cat:'MARITIME',reg:'W. Africa',tm:'2d',lat:4,lon:3,imp:'$800M insurance spike',ty:'Maritime'},
];

const CC={CONFLICT:'#ff3b30',CLIMATE:'#ff9500',CYBER:'#bf5af2',ECONOMIC:'#0a84ff',ENERGY:'#ffd60a',REGULATORY:'#64d2ff',SOCIAL:'#30d158',INTEL:'#ff375f',MARITIME:'#5ac8fa',HEALTH:'#30d158'};
const SC={critical:'#ff3b30',high:'#ff9500',medium:'#ffd60a',low:'#30d158'};

/* Connection lines between related incidents [fromId, toId, label, color] */
const CONNS=[
  [5,1,'Energy supply chain disruption','#ffd60a'],   // Hormuz → Black Sea
  [4,8,'East Asia escalation corridor','#ff3b30'],     // Taiwan → DPRK
  [1,3,'Hybrid warfare vector','#bf5af2'],             // Black Sea → Cyber EU
  [10,4,'Trade decoupling','#0a84ff'],                 // US-China → Taiwan
  [5,14,'Water-energy nexus','#64d2ff'],               // Hormuz → Indus
  [6,12,'Sahel-Sudan conflict arc','#ff3b30'],         // Sahel → Sudan
];

/* News headlines for live ticker */
const NEWS=[
  {t:'NATO deploys additional carrier group to Eastern Mediterranean amid rising tensions',s:'Reuters',c:'#ff3b30'},
  {t:'Global reinsurance rates surge 18% on back of record climate losses',s:'FT',c:'#ff9500'},
  {t:'CISA warns of critical infrastructure vulnerability in energy sector SCADA systems',s:'CyberScoop',c:'#bf5af2'},
  {t:'World Bank revises global GDP growth forecast down to 2.4% citing geopolitical risk',s:'Bloomberg',c:'#0a84ff'},
  {t:'China conducts live-fire naval exercises in South China Sea for third consecutive week',s:'SCMP',c:'#ff3b30'},
  {t:'European gas storage levels fall below 5-year average ahead of winter season',s:'Platts',c:'#ffd60a'},
  {t:'UN Security Council emergency session on Sahel security deterioration',s:'AP',c:'#ff3b30'},
  {t:'IMF warns sovereign debt risks compounding climate vulnerability in 40 nations',s:'FT',c:'#ff9500'},
  {t:'US Treasury sanctions 12 entities linked to ransomware-as-a-service operations',s:'WSJ',c:'#bf5af2'},
  {t:'Arctic shipping routes see 300% increase in commercial traffic year-over-year',s:'Reuters',c:'#64d2ff'},
  {t:'OPEC+ signals potential output cut extension as demand outlook weakens',s:'Bloomberg',c:'#ffd60a'},
  {t:'IRGC deploys fast-attack craft near Strait of Hormuz — U.S. Fifth Fleet responds',s:'CENTCOM',c:'#ff3b30'},
];

const MKTS={
  'COMMODITIES':[{s:'GC1',n:'Gold',p:'5,228',c:'+2.90%',u:1},{s:'CL1',n:'WTI Crude',p:'65.97',c:'-0.80%',u:0},{s:'NG1',n:'Nat Gas',p:'3.088',c:'-2.03%',u:0},{s:'HG1',n:'Copper',p:'5.90',c:'-1.65%',u:0},{s:'W1',n:'Wheat',p:'572.00',c:'+2.27%',u:1}],
  'FX & RATES':[{s:'DXY',n:'Dollar Idx',p:'97.69',c:'-0.22%',u:0},{s:'EUR',n:'EUR/USD',p:'1.1820',c:'+0.31%',u:1},{s:'US10Y',n:'10Y Yield',p:'4.010%',c:'-6bp',u:0},{s:'US2Y',n:'2Y Yield',p:'3.570%',c:'-7bp',u:0}],
  'CRYPTO':[{s:'BTC',n:'Bitcoin',p:'64,762',c:'-3.92%',u:0},{s:'ETH',n:'Ethereum',p:'2,680',c:'-4.10%',u:0}],
  'DEFENSE & INTEL':[{s:'LMT',n:'Lockheed',p:'661.49',c:'+0.42%',u:1},{s:'RTX',n:'RTX Corp',p:'204.81',c:'+0.64%',u:1},{s:'NOC',n:'Northrop',p:'724.83',c:'+3.38%',u:1},{s:'GD',n:'Gen Dynamics',p:'289.15',c:'+0.88%',u:1},{s:'PLTR',n:'Palantir',p:'135.38',c:'+1.77%',u:1}],
};

/* MENA conflict RSS queries */
const MENA_RSS_QUERIES=[
  'Iran+Israel+military+strike+attack+MENA',
  'Houthi+Red+Sea+Hezbollah+Gaza+war+ceasefire',
];

/* MENA conflict wire fallback (Feb 2026) */
const MENA_WIRE_FALLBACK=[
  {t:'IRGC Navy conducts live-fire exercises near Strait of Hormuz — U.S. Fifth Fleet on alert',src:'CENTCOM',tm:'Active',dom:'MILITARY'},
  {t:'Iran enrichment at 60% threshold — IAEA inspectors report centrifuge cascade expansion at Fordow',src:'IAEA',tm:'Ongoing',dom:'NUCLEAR'},
  {t:'Houthi forces launch anti-ship ballistic missile at commercial vessel in Red Sea',src:'UKMTO',tm:'Recent',dom:'PROXY'},
  {t:'Hezbollah stockpile assessment — estimated 130,000+ rockets and precision-guided munitions',src:'IDF Intel',tm:'Standing',dom:'PROXY'},
  {t:'U.S. deploys additional carrier strike group to Eastern Mediterranean amid tensions',src:'DoD',tm:'Recent',dom:'MILITARY'},
  {t:'Iran-backed militia conducts drone attack on Al-Asad Airbase, Iraq',src:'CENTCOM',tm:'Recent',dom:'PROXY'},
  {t:'JCPOA revival talks stall — Tehran demands sanctions relief before nuclear compliance',src:'State Dept',tm:'Ongoing',dom:'DIPLOMACY'},
  {t:'Brent crude rises on Strait of Hormuz closure fears — conflict premium widens',src:'Reuters',tm:'Active',dom:'ENERGY'},
];

const TREND={
  '1M':[{d:'W1',geo:72,clim:65,cyb:61,con:74},{d:'W2',geo:74,clim:67,cyb:63,con:76},{d:'W3',geo:75,clim:69,cyb:62,con:79},{d:'W4',geo:78,clim:72,cyb:65,con:83}],
  '6M':[{d:'Sep',geo:68,clim:58,cyb:55,con:65},{d:'Oct',geo:70,clim:62,cyb:58,con:70},{d:'Nov',geo:72,clim:64,cyb:60,con:73},{d:'Dec',geo:74,clim:66,cyb:62,con:76},{d:'Jan',geo:76,clim:70,cyb:64,con:80},{d:'Feb',geo:78,clim:72,cyb:65,con:83}],
  '1Y':[{d:'Mar',geo:60,clim:48,cyb:50,con:55},{d:'May',geo:62,clim:52,cyb:52,con:58},{d:'Jul',geo:65,clim:55,cyb:54,con:62},{d:'Sep',geo:68,clim:58,cyb:55,con:65},{d:'Nov',geo:72,clim:64,cyb:60,con:73},{d:'Feb',geo:78,clim:72,cyb:65,con:83}],
};

/* (Regional risk now computed from Iran tracker data) */

/* (Regional risk now computed from live advisories) */

/* ═══ RSS FEED CONFIG ═══ */
const RSS_FEEDS=[
  // Conflict & military
  {q:'Russia+Ukraine+war+military+frontline',cat:'CONFLICT'},
  {q:'Iran+US+tensions+military+strikes+nuclear',cat:'CONFLICT'},
  {q:'China+Taiwan+military+South+China+Sea',cat:'CONFLICT'},
  {q:'Israel+Gaza+Hamas+Hezbollah+Middle+East+war',cat:'CONFLICT'},
  {q:'NATO+military+defense+troops+deployment',cat:'CONFLICT'},
  {q:'North+Korea+missile+nuclear+ICBM',cat:'CONFLICT'},
  // Climate & disasters
  {q:'climate+disaster+extreme+weather+hurricane+wildfire',cat:'CLIMATE'},
  // Cyber
  {q:'cybersecurity+ransomware+hack+breach+critical+infrastructure',cat:'CYBER'},
  // Economic & sanctions
  {q:'global+economy+sanctions+trade+war+tariff+recession',cat:'ECONOMIC'},
  {q:'US+China+trade+decoupling+semiconductor+sanctions',cat:'ECONOMIC'},
  // Energy
  {q:'oil+energy+crisis+OPEC+pipeline+gas+prices',cat:'ENERGY'},
  // Health / Pandemic
  {q:'pandemic+virus+outbreak+WHO+bird+flu+H5N1+epidemic',cat:'HEALTH'},
  // Terrorism & intel
  {q:'terrorism+intelligence+ISIS+security+threat+espionage',cat:'INTEL'},
];
const PROXY='https://api.rss2json.com/v1/api.json?rss_url=';
// Multi-proxy RSS fetch — tries rss2json first, then allorigins+DOMParser fallback
async function rssFetch(feedUrl){
  // Method 1: rss2json (returns JSON directly)
  try{
    var res=await fetch(PROXY+encodeURIComponent(feedUrl),{signal:AbortSignal.timeout(8000)});
    if(res.ok){var data=await res.json();if(data.items&&data.items.length>0)return data;}
  }catch(e){}
  // Method 2: allorigins raw XML → parse with DOMParser
  try{
    var res2=await fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(feedUrl),{signal:AbortSignal.timeout(8000)});
    if(res2.ok){
      var xml=await res2.text();
      var doc=new DOMParser().parseFromString(xml,'text/xml');
      var entries=doc.querySelectorAll('item, entry');
      if(entries.length>0){
        var items=[];
        entries.forEach(function(el){
          var title=el.querySelector('title')?el.querySelector('title').textContent:'';
          var link=el.querySelector('link')?el.querySelector('link').textContent||el.querySelector('link').getAttribute('href'):'';
          var pubDate=el.querySelector('pubDate, published, updated')?el.querySelector('pubDate, published, updated').textContent:'';
          var desc=el.querySelector('description, summary, content')?el.querySelector('description, summary, content').textContent:'';
          items.push({title:title,link:link,pubDate:pubDate,description:desc,guid:link});
        });
        return{items:items};
      }
    }
  }catch(e){}
  // Method 3: corsproxy.org raw XML
  try{
    var res3=await fetch('https://corsproxy.org/?'+encodeURIComponent(feedUrl),{signal:AbortSignal.timeout(8000)});
    if(res3.ok){
      var xml3=await res3.text();
      var doc3=new DOMParser().parseFromString(xml3,'text/xml');
      var entries3=doc3.querySelectorAll('item, entry');
      if(entries3.length>0){
        var items3=[];
        entries3.forEach(function(el){
          var title=el.querySelector('title')?el.querySelector('title').textContent:'';
          var link=el.querySelector('link')?el.querySelector('link').textContent||el.querySelector('link').getAttribute('href'):'';
          var pubDate=el.querySelector('pubDate, published, updated')?el.querySelector('pubDate, published, updated').textContent:'';
          var desc=el.querySelector('description, summary, content')?el.querySelector('description, summary, content').textContent:'';
          items3.push({title:title,link:link,pubDate:pubDate,description:desc,guid:link});
        });
        return{items:items3};
      }
    }
  }catch(e){}
  return{items:[]};
}
const catKeywords={
  CONFLICT:['war','military','nato','conflict','troops','missile','attack','invasion','defense','army','weapon','strike','ukraine','russia','frontline','battalion','airstrike','drone strike','ceasefire','escalation','iran','hezbollah','hamas','gaza','israel','taiwan','korea','artillery','casualties'],
  CLIMATE:['climate','flood','wildfire','hurricane','drought','emissions','carbon','warming','sea level','storm','heat','ice','snow','blizzard','cyclone','typhoon','earthquake','tornado','fire','weather'],
  CYBER:['cyber','ransomware','hack','breach','malware','vulnerability','phishing','data leak','cisa','zero-day','ddos','spyware','critical infrastructure'],
  ECONOMIC:['economy','gdp','trade','tariff','inflation','recession','debt','imf','world bank','fiscal','monetary','sanctions','decoupling','semiconductor','stock market','currency','default'],
  ENERGY:['oil','gas','opec','energy','pipeline','refinery','nuclear','solar','wind','grid','fuel','petroleum','lng','electricity','power plant','crude'],
  HEALTH:['pandemic','epidemic','virus','outbreak','who','h5n1','bird flu','covid','disease','vaccine','pathogen','quarantine','health emergency','mpox','ebola'],
  INTEL:['intelligence','espionage','spy','terrorism','isis','al-qaeda','cia','fbi','mi6','surveillance','threat assessment','counterterrorism','mossad'],
  REGULATORY:['regulation','eu','law','compliance','legislation','tax','ban','policy','mandate','rule'],
};
function classifyHeadline(title){
  const t=title.toLowerCase();
  let best='CONFLICT',score=0;
  for(const[cat,kws]of Object.entries(catKeywords)){
    const s=kws.filter(k=>t.includes(k)).length;
    if(s>score){score=s;best=cat;}
  }
  return best;
}
// Decode HTML entities from RSS/API responses (e.g. &amp; → &, &#39; → ')
function decEnt(s){
  if(!s||typeof s!=='string')return s||'';
  return s.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#x27;/g,"'").replace(/&apos;/g,"'").replace(/&#(\d+);/g,function(_,n){return String.fromCharCode(n);});
}
function timeAgo(dateStr){
  if(!dateStr)return 'Active';
  // Handle various date formats: ISO, FAA (MM/DD/YYYY HH:MM), epoch ms, YYYYMMDDHHMMSS
  var d;
  if(typeof dateStr==='number')d=new Date(dateStr);
  else if(/^\d{12,14}$/.test(dateStr))d=new Date(dateStr.slice(0,4)+'-'+dateStr.slice(4,6)+'-'+dateStr.slice(6,8)+'T'+dateStr.slice(8,10)+':'+dateStr.slice(10,12)+':00Z');
  else if(/^\d{4}\/\d{2}\/\d{2}/.test(dateStr))d=new Date(dateStr.replace(/\//g,'-'));
  else d=new Date(dateStr);
  if(!d||isNaN(d.getTime()))return 'Active';
  var now=new Date();var mins=Math.floor((now-d)/60000);
  if(mins<0)return 'Just now';
  if(mins<60)return mins+'m ago';
  var hrs=Math.floor(mins/60);if(hrs<24)return hrs+'h ago';
  return Math.floor(hrs/24)+'d ago';
}
/* ═══ IRAN-U.S. WAR TRACKER — MENA Escalation Monitor ═══ */
const IRAN_TRACKER_FALLBACK=[
  {sev:'critical',domain:'MILITARY',title:'IRGC Conducts Large-Scale Naval Exercises in Strait of Hormuz',detail:'Islamic Revolutionary Guard Corps deploying fast-attack craft, anti-ship missiles, and naval mines in exercises simulating closure of the Strait. U.S. Fifth Fleet on heightened alert. 21% of global oil transits this chokepoint.',time:'Active',icon:'\u{1F6A2}'},
  {sev:'critical',domain:'NUCLEAR',title:'Iran Enriching Uranium to 60% — Near Weapons-Grade Threshold',detail:'IAEA confirms stockpile of 60%-enriched uranium now exceeds 120 kg. Breakout time estimated at under two weeks. Diplomatic window narrowing rapidly. P5+1 talks stalled since 2023.',time:'Ongoing',icon:'\u2622\uFE0F'},
  {sev:'high',domain:'PROXY',title:'Houthi Anti-Ship Missile Strikes Continue in Red Sea',detail:'Ansar Allah forces launched multiple ballistic and cruise missiles at commercial vessels in the Bab el-Mandeb strait. U.S. and UK conducted retaliatory strikes on Houthi missile sites in Yemen. Shipping rerouting around Cape of Good Hope.',time:'Active',icon:'\u{1F3AF}'},
  {sev:'high',domain:'PROXY',title:'Hezbollah-Israel Border Tensions Remain Elevated',detail:'Daily exchange of fire along the Blue Line. Hezbollah rocket and drone attacks on northern Israel. IDF conducting airstrikes in southern Lebanon. Risk of wider escalation assessed as moderate-to-high.',time:'Active',icon:'\u{1F4A5}'},
  {sev:'high',domain:'MILITARY',title:'U.S. Carrier Strike Group Repositioned to Eastern Mediterranean',detail:'USS Eisenhower CSG redeployed from Central Command AOR. Additional F-35 squadrons forward-deployed to Al Udeid and Al Dhafra. Force posture consistent with contingency planning for Iran scenarios.',time:'Recent',icon:'\u2693'},
  {sev:'high',domain:'CYBER',title:'Iranian APT Groups Targeting U.S. Critical Infrastructure',detail:'CISA advisory: APT42 (Charming Kitten) and MuddyWater conducting espionage campaigns against U.S. energy, defense, and financial sectors. Destructive wiper malware variants detected in staging environments.',time:'Active',icon:'\u{1F4BB}'},
  {sev:'moderate',domain:'DIPLOMACY',title:'JCPOA Revival Talks — No Progress, Channels Narrowing',detail:'Back-channel diplomatic efforts through Oman yielding limited results. EU coordinator reporting impasse on sanctions relief sequencing. U.S. secondary sanctions on Iranian oil exports tightened. China and India continue importing Iranian crude via shadow fleet.',time:'Stalled',icon:'\u{1F91D}'},
  {sev:'moderate',domain:'SANCTIONS',title:'U.S. Treasury Designates Additional IRGC-Linked Entities',detail:'New OFAC sanctions targeting IRGC-Quds Force financial networks, petrochemical exports, and drone component suppliers. Asset freezes on 14 individuals and 8 entities across UAE, Turkey, and China.',time:'Recent',icon:'\u{1F4B0}'},
  {sev:'moderate',domain:'PROXY',title:'Iran-Backed Militias Strike U.S. Forces in Iraq and Syria',detail:'Islamic Resistance in Iraq launched drone and rocket attacks on Al-Asad and Al-Tanf bases. No U.S. casualties reported. Pentagon confirms proportional retaliatory strikes on militia weapons depots.',time:'Ongoing',icon:'\u{1F680}'},
  {sev:'high',domain:'INTEL',title:'Mossad-IRGC Shadow War Intensifies Across Region',detail:'Reported assassination of senior IRGC officer in Damascus. Iranian-linked plots disrupted in Europe. Cyber operations targeting Iranian nuclear facilities. Covert conflict escalation pattern accelerating.',time:'Active',icon:'\u{1F575}\uFE0F'},
  {sev:'moderate',domain:'ENERGY',title:'Oil Markets Pricing in Iran Conflict Premium',detail:'Brent crude trading above $85/bbl with $8-12 risk premium attributed to Strait of Hormuz closure scenarios. Lloyd\'s of London raising war-risk insurance premiums for Persian Gulf shipping. Energy analysts modeling $120-150/bbl spike in full blockade scenario.',time:'Active',icon:'\u{1F6E2}\uFE0F'},
  {sev:'critical',domain:'WMD',title:'Iran Ballistic Missile Arsenal — Growing Range and Precision',detail:'Shahab-3, Emad, and Khorramshahr missiles capable of striking Israel and U.S. bases in the Gulf. Solid-fuel Kheibar Shekan reduces launch preparation time. Estimated 3,000+ missile inventory. No effective arms control framework in place.',time:'Standing',icon:'\u{1F3AF}'},
];
const IRAN_SEV_COLORS={critical:'#ff3b30',high:'#ff9500',moderate:'#ffd60a',low:'#64d2ff'};
const IRAN_DOMAIN_COLORS={MILITARY:'#ff3b30',NUCLEAR:'#ff3b30',PROXY:'#ff9500',CYBER:'#bf5af2',DIPLOMACY:'#30d158',SANCTIONS:'#ffd60a',INTEL:'#ff6482',ENERGY:'#ff9f0a',WMD:'#ff3b30'};

/* ═══ APP ═══ */
function App(){
  const[time,setTime]=useState(new Date());
  const[mf,setMf]=useState('ALL');
  const[tt,setTt]=useState(null);
  const[tp,setTp]=useState('6M');
  const[liveNews,setLiveNews]=useState([]);
  const[feedStatus,setFeedStatus]=useState('loading');
  const[iranEvents,setIranEvents]=useState(IRAN_TRACKER_FALLBACK);
  const[iranMilitary,setIranMilitary]=useState([]);
  const[iranLive,setIranLive]=useState(false);
  const[menaWire,setMenaWire]=useState([]);
  const[menaWireLive,setMenaWireLive]=useState(false);
  const[advisories,setAdvisories]=useState(ADV_FALLBACK);
  const[advLive,setAdvLive]=useState(false);
  const[polyMarkets,setPolyMarkets]=useState([]);
  const[polyLive,setPolyLive]=useState(false);
  const[iranMilLive,setIranMilLive]=useState(false);
  const[searchQuery,setSearchQuery]=useState('');
  const[searchResults,setSearchResults]=useState([]);
  const[searching,setSearching]=useState(false);
  const[breakingNews,setBreakingNews]=useState(null);
  const[bannerDismissed,setBannerDismissed]=useState(null);
  const[livePrices,setLivePrices]=useState({});
  const[menaEscHistory,setMenaEscHistory]=useState([]);
  const[geoData,setGeoData]=useState(null);
  const[countryBrief,setCountryBrief]=useState(null);
  const[alertQueue,setAlertQueue]=useState([]);
  const[darkMode,setDarkMode]=useState(true);
  const[advFilter,setAdvFilter]=useState(new Set([3,4]));
  const geoLayerRef=useRef(null);
  const advMarkersRef=useRef([]);

  // Fetch US State Dept Travel Advisories
  const fetchAdvisories=async()=>{
    // Always load curated fallback first (no stale closure dependency)
    setAdvisories(function(prev){return prev.length>0?prev:ADV_FALLBACK;});
    // Try State Dept travel advisory RSS via proxy
    try{
      var data=await rssFetch('https://travel.state.gov/_res/rss/TAsTWs.xml');
      if(data.items&&data.items.length>5){
        var parsed=data.items.map(function(item){
          var _tit=decEnt(item.title||'');
          var lvl=4;
          if(/Level 3/i.test(_tit))lvl=3;
          else if(/Level 2/i.test(_tit))lvl=2;
          else if(/Level 1/i.test(_tit))lvl=1;
          var country=_tit.replace(/\s*[-–—]\s*Level \d.*/i,'').trim();
          return{country:country,level:lvl,title:_tit,date:new Date(item.pubDate),url:item.link||item.guid||'https://travel.state.gov',desc:item.description?decEnt(item.description.replace(/<[^>]*>/g,'').slice(0,80)):'Travel Advisory'};
        });
        // Sort: Level 4 first, then 3, then 2
        parsed.sort(function(a,b){return b.level-a.level||b.date-a.date;});
        // Only keep Level 2-4
        var filtered=parsed.filter(function(a){return a.level>=2;});
        if(filtered.length>5){setAdvisories(filtered);setAdvLive(true);return;}
      }
    }catch(e){}
    setAdvisories(ADV_FALLBACK);setAdvLive(true);
  };

  // Fetch sovereign credit rating changes
  // Fetch Polymarket geopolitical prediction markets
  const fetchPolymarkets=async()=>{
    if(polyMarkets.length===0)setPolyMarkets(POLY_FALLBACK);
    try{
      // Gamma API — public, no auth needed. Try direct first (has CORS), then proxy.
      // Use /events endpoint — event slugs work in polymarket.com/event/{slug} URLs
      var baseUrl='https://gamma-api.polymarket.com/events?active=true&closed=false&limit=80&order=volume&ascending=false';
      var resp=null;
      try{
        var controller=new AbortController();
        var tm=setTimeout(function(){controller.abort();},8000);
        resp=await fetch(baseUrl,{signal:controller.signal});
        clearTimeout(tm);
        if(!resp.ok)resp=null;
      }catch(e){resp=null;}
      if(!resp){
        try{
          var proxyUrl='https://corsproxy.io/?'+encodeURIComponent(baseUrl);
          var controller2=new AbortController();
          var tm2=setTimeout(function(){controller2.abort();},8000);
          resp=await fetch(proxyUrl,{signal:controller2.signal});
          clearTimeout(tm2);
          if(!resp.ok)resp=null;
        }catch(e){resp=null;}
      }
      if(!resp){setPolyMarkets(POLY_FALLBACK);setPolyLive(true);return;}
      var allEvents=await resp.json();
      if(!Array.isArray(allEvents)||allEvents.length===0){setPolyMarkets(POLY_FALLBACK);setPolyLive(true);return;}
      // Filter for geopolitical/security/politics events
      var geoEvents=allEvents.filter(function(ev){
        var title=(ev.title||ev.question||'');
        var desc=(ev.description||'');
        var cat=(ev.category||'').trim();
        var q=title+' '+desc;
        if(POLY_EXCLUDE_CATS.test(cat))return false;
        if(POLY_EXCLUDE.test(q))return false;
        var ql=q.toLowerCase()+' '+cat.toLowerCase();
        if(POLY_GEO_TERMS.some(function(term){return ql.indexOf(term)!==-1;}))return true;
        var catl=cat.toLowerCase();
        if(catl==='politics'||catl==='world'||catl==='geopolitics'||catl==='climate')return true;
        return false;
      });
      // Parse events — extract top market from each event for the probability
      var items=geoEvents.slice(0,12).map(function(ev){
        var markets=ev.markets||[];
        var topMarket=markets[0]||{};
        var prices=[];
        try{prices=JSON.parse(topMarket.outcomePrices||'[]');}catch(e){}
        var yesPrice=prices[0]?parseFloat(prices[0]):0;
        var vol=parseFloat(ev.volume||topMarket.volume||0);
        var volStr=vol>=1000000?'$'+(vol/1000000).toFixed(1)+'M':vol>=1000?'$'+(vol/1000).toFixed(0)+'K':'$'+vol.toFixed(0);
        return{
          question:(ev.title||topMarket.question||'').slice(0,80),
          yes:yesPrice,
          volume:volStr,
          slug:ev.slug||'',
          category:ev.category||'Geopolitics',
          endDate:ev.endDate||topMarket.endDate||''
        };
      });
      items.sort(function(a,b){
        var aV=parseFloat(a.volume.replace(/[$MK,]/g,''))||0;
        var bV=parseFloat(b.volume.replace(/[$MK,]/g,''))||0;
        if(a.volume.includes('M'))aV*=1000;
        if(b.volume.includes('M'))bV*=1000;
        return bV-aV;
      });
      if(items.length>=2){setPolyMarkets(items);setPolyLive(true);return;}
    }catch(e){}
    setPolyMarkets(POLY_FALLBACK);setPolyLive(true);
  };

  // ═══ LIVE STOCK PRICES — Multi-proxy Yahoo Finance + Finnhub fallback ═══
  var CORS_PROXIES=[
    function(u){return 'https://corsproxy.io/?'+encodeURIComponent(u);},
    function(u){return 'https://api.allorigins.win/raw?url='+encodeURIComponent(u);},
    function(u){return 'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(u);},
    function(u){return 'https://thingproxy.freeboard.io/fetch/'+u;}
  ];
  var proxyFetch=async function(url,timeoutMs){
    for(var i=0;i<CORS_PROXIES.length;i++){
      try{
        var pUrl=CORS_PROXIES[i](url);
        var controller=new AbortController();
        var tm=setTimeout(function(){controller.abort();},timeoutMs||8000);
        var resp=await fetch(pUrl,{signal:controller.signal});
        clearTimeout(tm);
        if(resp.ok){var txt=await resp.text();try{return JSON.parse(txt);}catch(e){continue;}}
      }catch(e){}
    }
    return null;
  };

  const YAHOO_SYMBOLS={
    'LMT':'LMT','RTX':'RTX','NOC':'NOC','GD':'GD','PLTR':'PLTR',
    'ES1':'ES=F','NQ1':'NQ=F','DXY':'DX-Y.NYB','GC1':'GC=F','CL1':'CL=F',
    'US10Y':'^TNX','VIX':'^VIX','BTC':'BTC-USD','ETH':'ETH-USD',
    'EUR':'EURUSD=X','GBP':'GBPUSD=X','JPY':'JPY=X',
    'NG1':'NG=F','HG1':'HG=F','W1':'ZW=F','US2Y':'^IRX'
  };

  var parseYahooQuotes=function(data){
    if(!data||!data.quoteResponse||!data.quoteResponse.result)return null;
    var prices={};
    var symbolToKey={};
    Object.keys(YAHOO_SYMBOLS).forEach(function(k){symbolToKey[YAHOO_SYMBOLS[k]]=k;});
    data.quoteResponse.result.forEach(function(q){
      var key=symbolToKey[q.symbol];
      if(!key)return;
      var price=q.regularMarketPrice;
      var changePct=q.regularMarketChangePercent;
      if(price===undefined)return;
      var fmtPrice=price>=1000?price.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}):
                   price>=100?price.toFixed(2):
                   price>=10?price.toFixed(2):
                   price.toFixed(4);
      if(key==='US10Y'||key==='US2Y')fmtPrice=price.toFixed(3)+'%';
      if(key==='JPY')fmtPrice=price.toFixed(2);
      var fmtChange=changePct>=0?'+'+changePct.toFixed(2)+'%':changePct.toFixed(2)+'%';
      if(key==='US10Y'||key==='US2Y'){
        var bps=Math.round(q.regularMarketChange*100);
        fmtChange=(bps>=0?'+':'')+bps+'bp';
      }
      prices[key]={p:fmtPrice,c:fmtChange,u:changePct>=0,raw:price};
    });
    return Object.keys(prices).length>0?prices:null;
  };

  var fetchLivePrices=async function(){
    try{
      // Primary: Yahoo Finance v8 chart endpoint (v7 quote is dead — returns 401)
      var allSymbols=Object.values(YAHOO_SYMBOLS);
      var chartPrices={};
      var symbolToKey={};
      Object.keys(YAHOO_SYMBOLS).forEach(function(k){symbolToKey[YAHOO_SYMBOLS[k]]=k;});
      var cacheBust='&_t='+Date.now();
      // Fetch in parallel batches of 4
      for(var i=0;i<allSymbols.length;i+=4){
        var batch=allSymbols.slice(i,i+4);
        var fetches=batch.map(function(sym){
          var cUrl='https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(sym)+'?interval=1d&range=5d'+cacheBust;
          return proxyFetch(cUrl,8000).then(function(cData){
            if(cData&&cData.chart&&cData.chart.result&&cData.chart.result[0]){
              var meta=cData.chart.result[0].meta;
              if(meta&&meta.regularMarketPrice){
                var key=symbolToKey[sym];
                if(key){
                  var pr=meta.regularMarketPrice;
                  var prev=meta.chartPreviousClose||meta.previousClose||pr;
                  var chg=prev?((pr-prev)/prev)*100:0;
                  var fmtP=pr>=1000?pr.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}):pr>=10?pr.toFixed(2):pr.toFixed(4);
                  if(key==='US10Y'||key==='US2Y')fmtP=pr.toFixed(3)+'%';
                  if(key==='JPY')fmtP=pr.toFixed(2);
                  var fmtC=chg>=0?'+'+chg.toFixed(2)+'%':chg.toFixed(2)+'%';
                  if(key==='US10Y'||key==='US2Y'){var bps=Math.round((pr-prev)*100);fmtC=(bps>=0?'+':'')+bps+'bp';}
                  chartPrices[key]={p:fmtP,c:fmtC,u:chg>=0,raw:pr};
                }
              }
            }
          }).catch(function(){});
        });
        await Promise.all(fetches);
      }
      if(Object.keys(chartPrices).length>0){
        setLivePrices(function(prev){
          // Only update symbols that actually returned data — don't wipe out existing live prices for symbols that failed this cycle
          var merged=Object.assign({},prev);
          Object.keys(chartPrices).forEach(function(k){merged[k]=chartPrices[k];});
          return merged;
        });
      }
    }catch(e){}
  };

  // Fetch MENA conflict wire — live RSS for MENA war-specific headlines
  const fetchMenaWire=async()=>{
    if(menaWire.length===0){setMenaWire(MENA_WIRE_FALLBACK);setMenaWireLive(true);}
    try{
      const results=[];
      for(const q of MENA_RSS_QUERIES){
        try{
          const data=await rssFetch('https://news.google.com/rss/search?q='+q+'&hl=en-US&gl=US&ceid=US:en');
          if(data.items){
            data.items.slice(0,6).forEach(function(item){
              var _t=decEnt(item.title||'');
              var src=_t.includes(' - ')?_t.split(' - ').pop().trim():'News';
              var headline=_t.includes(' - ')?_t.split(' - ').slice(0,-1).join(' - ').trim():_t;
              if(iranMustMatch.test(headline)){
                var cls=classifyIran(headline);
                results.push({t:headline,src:src,tm:timeAgo(item.pubDate),dom:cls.domain,sev:cls.sev,pubDate:new Date(item.pubDate)});
              }
            });
          }
        }catch(e){}
      }
      var seen=new Set();
      var unique=results.filter(function(r){var k=r.t.slice(0,40);if(seen.has(k))return false;seen.add(k);return true;});
      unique.sort(function(a,b){return b.pubDate-a.pubDate;});
      if(unique.length>0){setMenaWire(unique.slice(0,15));setMenaWireLive(true);}
    }catch(e){}
  };

  // Fetch live RSS feeds
  const fetchFeeds=async()=>{
    try{
      const results=[];
      for(const feed of RSS_FEEDS){
        try{
          const data=await rssFetch(`https://news.google.com/rss/search?q=${feed.q}&hl=en-US&gl=US&ceid=US:en`);
          if(data.items){
            data.items.slice(0,4).forEach(item=>{
              var _ti=decEnt(item.title||'');
              const cat=classifyHeadline(_ti);
              const src=_ti.includes(' - ')?_ti.split(' - ').pop().trim():'News';
              const headline=_ti.includes(' - ')?_ti.split(' - ').slice(0,-1).join(' - ').trim():_ti;
              results.push({
                t:headline,
                cat,
                sv:['CONFLICT','CYBER','INTEL'].includes(cat)?'critical':['CLIMATE','ENERGY','HEALTH'].includes(cat)?'high':'medium',
                src,
                tm:timeAgo(item.pubDate),
                url:item.link,
                pubDate:new Date(item.pubDate),
              });
            });
          }
        }catch(e){}
      }
      // Deduplicate and sort by date
      const seen=new Set();
      const unique=results.filter(r=>{const k=r.t.slice(0,50);if(seen.has(k))return false;seen.add(k);return true;});
      unique.sort((a,b)=>b.pubDate-a.pubDate);
      if(unique.length>0){setLiveNews(unique.slice(0,40));setFeedStatus('live');}
      else{setFeedStatus('fallback');}
    }catch(e){setFeedStatus('fallback');}
  };

  // ═══ IRAN-U.S. WAR TRACKER FETCH — multi-source MENA escalation monitor (60s refresh) ═══
  var iranMustMatch=/iran|tehran|irgc|revolutionary guard|quds force|hezbollah|houthi|ansar allah|strait of hormuz|persian gulf|bab.el.mandeb|red sea|yemen|iraq.*militia|syria.*strike|lebanon.*israel|israel.*iran|nuclear.*iran|iran.*nuclear|uranium|enrichment|jcpoa|ballistic missile|cruise missile|drone.*iran|iran.*drone|proxy|axis of resistance|al.asad|al.tanf|natanz|fordow|isfahan|parchin|arak|bushehr|kharg island|bandar abbas|chabahar|sanctions.*iran|iran.*sanctions|ofac|iaea|mossad|cia.*iran|centcom|fifth fleet|carrier.*gulf|f-35.*gulf|b-52.*iran|ayatollah|khamenei|raisi|zarif|oil.*iran|iran.*oil|petrochemical/i;

  // ═══ IRAN-U.S. WAR TRACKER + LIVE IMPACT FETCH (60s refresh) ═══
  function classifyIran(headline){
    var hl=headline.toLowerCase();
    var domain='MILITARY',sev='moderate',icon='\u{1F6A8}';
    if(/nuclear|uranium|enrichment|iaea|breakout|centrifuge|fordow|natanz|parchin|arak/.test(hl)){domain='NUCLEAR';sev='critical';icon='\u2622\uFE0F';}
    else if(/houthi|hezbollah|militia|proxy|ansar allah|islamic resistance|axis of resistance/.test(hl)){domain='PROXY';sev='high';icon='\u{1F3AF}';}
    else if(/cyber|hack|apt|malware|breach|espionage|wiper/.test(hl)){domain='CYBER';sev='high';icon='\u{1F4BB}';}
    else if(/jcpoa|diplomat|negotiat|talks|deal|back.channel/.test(hl)){domain='DIPLOMACY';sev='moderate';icon='\u{1F91D}';}
    else if(/sanction|ofac|treasury|designat|asset freeze/.test(hl)){domain='SANCTIONS';sev='moderate';icon='\u{1F4B0}';}
    else if(/oil|energy|petrol|crude|brent|shipping|tanker|insurance|hormuz.*clos/.test(hl)){domain='ENERGY';sev='high';icon='\u{1F6E2}\uFE0F';}
    else if(/missile|ballistic|cruise|launch|test|warhead|wmd/.test(hl)){domain='WMD';sev='critical';icon='\u{1F680}';}
    else if(/mossad|cia|intelligence|covert|assassin|shadow war/.test(hl)){domain='INTEL';sev='high';icon='\u{1F575}\uFE0F';}
    else if(/airspace|notam|flight restrict|no.fly|tfr|aviation|faa.*iran|iran.*faa/.test(hl)){domain='AIRSPACE';sev='high';icon='\u2708\uFE0F';}
    else if(/travel.*advis|travel.*ban|evacuati|embassy|consular|do not travel/.test(hl)){domain='TRAVEL';sev='high';icon='\u{1F6C2}';}
    else if(/ship|maritime|vessel|strait|chokepoint|reroute|cape of good hope|suez|bab/.test(hl)){domain='SHIPPING';sev='high';icon='\u{1F6A2}';}
    else if(/strike|airstrike|bomb|attack|kill|casualt|carrier|deploy|fleet|troops|military/.test(hl)){domain='MILITARY';sev='critical';icon='\u{1F4A5}';}
    return{domain:domain,sev:sev,icon:icon};
  }
  const fetchIranTracker=async()=>{
    var allItems=[];
    var iranQueries=[
      '(Iran OR IRGC OR "Revolutionary Guard" OR Tehran) (missile OR strike OR military OR nuclear OR enrichment OR sanctions)',
      '(Houthi OR "Ansar Allah" OR "Red Sea" OR "Bab el-Mandeb") (attack OR missile OR ship OR strike OR drone)',
      '(Hezbollah OR Lebanon OR "Blue Line") (Israel OR rocket OR drone OR strike OR escalation)',
      '(Iraq OR Syria) (militia OR "Islamic Resistance" OR "Al-Asad" OR "Al-Tanf" OR drone OR rocket) USA',
      '("Strait of Hormuz" OR "Persian Gulf" OR "Fifth Fleet" OR CENTCOM) (Iran OR military OR exercise OR carrier)',
      '(Iran OR IRGC) (cyber OR hack OR APT OR espionage OR infrastructure)',
      '(JCPOA OR "nuclear deal" OR IAEA OR uranium OR enrichment) (Iran OR talks OR sanctions)',
      '(Iran) (airspace OR NOTAM OR "flight restriction" OR "no-fly" OR aviation OR travel advisory OR embassy)',
      '(Iran OR "Red Sea" OR Houthi) (shipping OR oil OR tanker OR crude OR Brent OR insurance OR reroute)'
    ];
    for(var qi=0;qi<iranQueries.length;qi++){
      try{
        var data=await gdeltFetch(iranQueries[qi],15,'1440min');
        if(data&&data.articles){
          data.articles.forEach(function(art){
            var t=decEnt(art.title||'');
            if(t.indexOf(' - ')>25)t=t.substring(0,t.lastIndexOf(' - '));
            if(!iranMustMatch.test(t))return;
            if(/opinion|editorial|recipe|horoscope|celebrity|review:|stock tip|crypto/i.test(t))return;
            allItems.push({title:t.slice(0,140),source:(art.domain||'').replace('www.',''),time:timeAgo(art.seendate),seendate:art.seendate||'',url:art.url||'#'});
          });
        }
      }catch(e){}
    }
    var iranRssFeeds=[
      'https://news.google.com/rss/search?q=Iran+military+OR+IRGC+OR+missile+OR+nuclear+OR+Houthi+OR+Hezbollah&hl=en-US&gl=US&ceid=US:en',
      'https://news.google.com/rss/search?q=Iran+USA+OR+sanctions+OR+strike+OR+Red+Sea+OR+Strait+Hormuz&hl=en-US&gl=US&ceid=US:en',
      'https://news.google.com/rss/search?q=Iran+airspace+OR+travel+advisory+OR+shipping+OR+oil+tanker+OR+NOTAM+Middle+East&hl=en-US&gl=US&ceid=US:en'
    ];
    for(var ri=0;ri<iranRssFeeds.length;ri++){
      try{
        var rssData=await rssFetch(iranRssFeeds[ri]);
        if(rssData&&rssData.items){
          rssData.items.slice(0,10).forEach(function(item){
            var t=decEnt(item.title||'');
            if(!iranMustMatch.test(t))return;
            allItems.push({title:t.slice(0,140),source:item.link?item.link.split('/')[2].replace('www.',''):'',time:timeAgo(item.pubDate),seendate:item.pubDate||'',url:item.link||'#'});
          });
        }
      }catch(e){}
    }
    var seen=new Set();
    var unique=allItems.filter(function(d){var k=d.title.slice(0,40).toLowerCase().replace(/[^a-z0-9]/g,'');if(seen.has(k))return false;seen.add(k);return true;});
    unique.sort(function(a,b){return(b.seendate||'').localeCompare(a.seendate||'');});
    if(unique.length>=3){
      var liveItems=unique.slice(0,16).map(function(d){
        var cls=classifyIran(d.title);
        return{sev:cls.sev,domain:cls.domain,title:d.title,detail:'Source: '+d.source,time:d.time,icon:cls.icon,url:d.url};
      });
      var liveDomains=new Set(liveItems.map(function(d){return d.domain;}));
      var fallbackFill=IRAN_TRACKER_FALLBACK.filter(function(fb){return !liveDomains.has(fb.domain);});
      var merged=liveItems.concat(fallbackFill).slice(0,16);
      setIranEvents(merged);setIranLive(true);
      var impactItems=merged.filter(function(d){return d.domain==='AIRSPACE'||d.domain==='TRAVEL'||d.domain==='SHIPPING'||d.domain==='ENERGY';});
      var IMPACT_STANDING=[
        {sev:'critical',domain:'AIRSPACE',title:'Iran Airspace (OIIX) — All U.S. Civil Flights Prohibited',detail:'FAA SFAR 117 in effect. European EASA warning active. Full Tehran FIR ban for U.S. carriers.',time:'Standing',icon:'\u2708\uFE0F'},
        {sev:'high',domain:'AIRSPACE',title:'Iraq (ORBB) — Flights Below FL320 Restricted',detail:'Militia drone and missile threat. GPS spoofing reported across Baghdad FIR.',time:'Standing',icon:'\u2708\uFE0F'},
        {sev:'critical',domain:'SHIPPING',title:'Red Sea / Bab el-Mandeb — Houthi Anti-Ship Attacks Active',detail:'Multiple commercial vessels struck. Major carriers rerouting via Cape of Good Hope. +$2M per voyage cost.',time:'Active',icon:'\u{1F6A2}'},
        {sev:'high',domain:'SHIPPING',title:'Strait of Hormuz — Elevated Maritime Risk',detail:'IRGC naval exercises and fast-boat harassment. War-risk insurance at record levels. 21% of global oil transits.',time:'Active',icon:'\u{1F6A2}'},
        {sev:'high',domain:'ENERGY',title:'Oil Markets — Iran Conflict Premium Priced In',detail:'Brent crude carrying $8-12 risk premium. Full Hormuz blockade modeled at $120-150/bbl.',time:'Active',icon:'\u{1F6E2}\uFE0F'},
        {sev:'moderate',domain:'TRAVEL',title:'U.S. State Dept — Level 4: Do Not Travel to Iran',detail:'No consular services available. Risk of arbitrary arrest of dual nationals.',time:'Standing',icon:'\u{1F6C2}'},
        {sev:'moderate',domain:'TRAVEL',title:'Lebanon, Iraq, Yemen — Level 4: Do Not Travel',detail:'Active conflict zones. U.S. Embassy Baghdad operations limited.',time:'Standing',icon:'\u{1F6C2}'},
      ];
      var impactTitles=new Set(impactItems.map(function(d){return d.title.slice(0,30);}));
      IMPACT_STANDING.forEach(function(s){if(!impactTitles.has(s.title.slice(0,30)))impactItems.push(s);});
      setIranMilitary(impactItems.slice(0,10));
      setIranMilLive(true);
      console.log('SENTINEL: Iran tracker loaded '+liveItems.length+' live + '+impactItems.length+' impact items');
    }else{
      setIranEvents(IRAN_TRACKER_FALLBACK);setIranLive(true);
      setIranMilitary(IRAN_TRACKER_FALLBACK.filter(function(d){return d.domain==='ENERGY'||d.domain==='MILITARY'||d.domain==='WMD';}));
      setIranMilLive(true);
    }
  };


  // Simple search — opens Google News in new tab
  const searchIntel=function(query){
    if(!query||!query.trim())return;
    window.open('https://news.google.com/search?q='+encodeURIComponent(query.trim())+'&hl=en-US','_blank');
  };
  const clearSearch=function(){setSearchQuery('');};

  // ═══ GDELT BREAKING NEWS — auto-polls every 2 min ═══
  const GDELT_KEYWORDS=[
    'war','invasion','airstrike','missile','bombing','ceasefire','coup','martial law',
    'earthquake','tsunami','hurricane','typhoon','cyclone','volcanic eruption','wildfire',
    'terrorist attack','mass shooting','hostage','assassination','nuclear',
    'pandemic','outbreak','bird flu','H5N1','Ebola',
    'sanctions','NATO','UN Security Council','emergency summit','market crash','tariff'
  ];
  // GDELT helper — multi-proxy fallback (GDELT has no CORS headers)
  var gdeltProxies=[
    function(u){return 'https://corsproxy.io/?'+encodeURIComponent(u);},
    function(u){return 'https://api.allorigins.win/raw?url='+encodeURIComponent(u);},
    function(u){return 'https://corsproxy.org/?'+encodeURIComponent(u);}
  ];
  var gdeltFetch=async function(query,maxrecs,timespan){
    var gdeltUrl='https://api.gdeltproject.org/api/v2/doc/doc?query='+encodeURIComponent(query)+'&mode=artlist&maxrecords='+maxrecs+'&format=json&sort=datedesc&timespan='+timespan;
    for(var pi=0;pi<gdeltProxies.length;pi++){
      try{
        var proxyUrl=gdeltProxies[pi](gdeltUrl);
        var controller=new AbortController();
        var tm=setTimeout(function(){controller.abort();},10000);
        var resp=await fetch(proxyUrl,{signal:controller.signal});
        clearTimeout(tm);
        if(resp.ok){var data=await resp.json();if(data&&(data.articles||Array.isArray(data)))return data;}
      }catch(e){continue;}
    }
    return null;
  };

  // ── TIER 1: Direct RSS scan of major outlets for stories they tag as "breaking" ──
  var BREAKING_RSS=[
    {url:'https://feeds.bbci.co.uk/news/world/rss.xml',name:'BBC'},
    {url:'http://rss.cnn.com/rss/edition_world.rss',name:'CNN'},
    {url:'https://www.aljazeera.com/xml/rss/all.xml',name:'Al Jazeera'},
    {url:'https://feeds.reuters.com/reuters/topNews',name:'Reuters'},
    {url:'https://rss.nytimes.com/services/xml/rss/nyt/World.xml',name:'NY Times'},
  ];
  var breakingPattern=/breaking|just in|developing|flash|urgent/i;
  var securityBreaking=/kill|dead|shot|attack|bomb|strike|shoot|war|coup|quake|tsunami|hurricane|crash|hostage|kidnap|missile|nuclear|terror|explo|casualt|evacuat|siege|fire|collaps|shoot|armed|troops|invasion/i;

  var fetchBreakingRSS=async function(){
    try{
      var candidates=[];
      var rssPromises=BREAKING_RSS.map(function(feed){
        return rssFetch(feed.url).then(function(data){
          if(!data.items)return;
          // Check items published in the last 60 minutes
          var cutoff=Date.now()-60*60*1000;
          data.items.slice(0,10).forEach(function(item){
            var pubTime=new Date(item.pubDate).getTime();
            if(pubTime<cutoff)return;
            var title=decEnt(item.title||'');
            // Promote if outlet tags it as breaking OR headline matches urgent security terms
            var isTaggedBreaking=breakingPattern.test(title)||breakingPattern.test(item.description||'')||((item.categories||[]).join(' ').toLowerCase().indexOf('breaking')!==-1);
            var isUrgentSecurity=securityBreaking.test(title);
            if(isTaggedBreaking||isUrgentSecurity){
              candidates.push({title:title.replace(/^(BREAKING|JUST IN|DEVELOPING)[:\s\-]*/i,'').trim(),url:item.link,source:feed.name,time:new Date(item.pubDate).toISOString().slice(11,16)+' UTC',priority:isTaggedBreaking?2:1,pubTime:pubTime});
            }
          });
        }).catch(function(){});
      });
      await Promise.all(rssPromises);
      if(candidates.length===0)return false;
      // Sort: tagged breaking first, then by recency
      candidates.sort(function(a,b){return b.priority-a.priority||b.pubTime-a.pubTime;});
      var top=candidates[0];
      if(bannerDismissed&&top.title.substring(0,40)===bannerDismissed)return false;
      setBreakingNews({title:top.title,url:top.url,sources:candidates.length,domain:top.source,time:top.time});
      return true;
    }catch(e){return false;}
  };

  // ── TIER 2: GDELT cluster-based breaking detection (fallback) ──
  var fetchBreakingNews=async function(){
    try{
      // Tier 1: Check major outlet RSS feeds first — fastest path to real breaking news
      var rssHit=await fetchBreakingRSS();
      if(rssHit)return; // RSS found a breaking story, no need for GDELT

      // Tier 2: GDELT multi-source clustering
      var q='('+GDELT_KEYWORDS.slice(0,12).join(' OR ')+') sourcelang:eng';
      var data=await gdeltFetch(q,75,'180min');
      if(!data)return;
      if(!data.articles||data.articles.length<1)return;

      var clusters=[];
      data.articles.forEach(function(art){
        if(!art.title)return;
        art.title=decEnt(art.title);
        var titleLower=art.title.toLowerCase();
        if(/opinion|editorial|top \d|best \d|review|recipe|horoscope|celebrity|kardashian/i.test(art.title))return;
        var isBreaking=GDELT_KEYWORDS.some(function(kw){return titleLower.indexOf(kw.toLowerCase())!==-1;});
        if(!isBreaking)return;
        var matched=false;
        for(var c=0;c<clusters.length;c++){
          var clusterTitle=clusters[c].title.toLowerCase();
          var artWords=titleLower.replace(/[^a-z\s]/g,'').split(/\s+/).filter(function(w){return w.length>4;});
          var overlap=artWords.filter(function(w){return clusterTitle.indexOf(w)!==-1;}).length;
          if(overlap>=3){clusters[c].sources.push(art.domain||'unknown');clusters[c].count++;matched=true;break;}
        }
        if(!matched){
          clusters.push({title:art.title,url:art.url,domain:art.domain||'unknown',date:art.seendate||'',sources:[art.domain||'unknown'],count:1});
        }
      });

      clusters.sort(function(a,b){return b.count-a.count;});
      var top=clusters[0];
      if(!top||top.count<3)return;
      if(bannerDismissed&&top.title.substring(0,40)===bannerDismissed)return;

      setBreakingNews({
        title:top.title,
        url:top.url,
        sources:top.count,
        domain:top.domain,
        time:top.date?top.date.replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z/,'$4:$5 UTC'):new Date().toISOString().slice(11,16)+' UTC'
      });
    }catch(e){
      // Silent fail — no banner appears, dashboard unaffected
    }
  };

  const mapRef=useRef(null);
  const markersRef=useRef([]);
  const linesRef=useRef([]);
  const alertAudioRef=useRef(null);

  const triggerAlert=function(type,message){
    const newAlert={id:Date.now(),type,message};
    setAlertQueue(prev=>[...prev,newAlert]);
    // Play beep
    try{
      const ctx=new(window.AudioContext||window.webkitAudioContext)();
      const osc=ctx.createOscillator();
      const gain=ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value=440;
      gain.gain.setValueAtTime(0.15,ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.2);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime+0.2);
    }catch(e){}
    // Auto-remove after 5 seconds
    setTimeout(function(){setAlertQueue(prev=>prev.filter(a=>a.id!==newAlert.id));},5000);
  };

  useEffect(()=>{const i=setInterval(()=>setTime(new Date()),1000);return()=>clearInterval(i)},[]);

  // Theme toggle effect
  useEffect(()=>{
    const root=document.documentElement;
    if(darkMode){
      root.style.setProperty('--bg0','#000');
      root.style.setProperty('--bg1','#0a0a0a');
      root.style.setProperty('--bg2','#111');
      root.style.setProperty('--bg3','#1a1a1a');
      root.style.setProperty('--bdr','#222');
      root.style.setProperty('--bdrh','#333');
      root.style.setProperty('--t1','#e5e5e5');
      root.style.setProperty('--t2','#999');
      root.style.setProperty('--t3','#666');
      document.body.style.background='#000';
      document.body.style.color='#d4d4d4';
    }else{
      root.style.setProperty('--bg0','#fff');
      root.style.setProperty('--bg1','#f5f5f5');
      root.style.setProperty('--bg2','#eee');
      root.style.setProperty('--bg3','#e0e0e0');
      root.style.setProperty('--bdr','#ddd');
      root.style.setProperty('--bdrh','#ccc');
      root.style.setProperty('--t1','#1a1a1a');
      root.style.setProperty('--t2','#555');
      root.style.setProperty('--t3','#888');
      document.body.style.background='#fff';
      document.body.style.color='#1a1a1a';
    }
  },[darkMode]);

  // ═══ TIERED REFRESH RATES ═══
  // Breaking news: 30s (near-immediate)
  useEffect(()=>{fetchBreakingNews();const i=setInterval(fetchBreakingNews,30*1000);return()=>clearInterval(i)},[]);
  // Prices: 60s
  useEffect(()=>{fetchLivePrices();const i=setInterval(fetchLivePrices,60*1000);return()=>clearInterval(i)},[]);
  // Intel feed + MENA wire: 2 min
  useEffect(()=>{fetchFeeds();fetchMenaWire();const i=setInterval(()=>{fetchFeeds();fetchMenaWire()},2*60*1000);return()=>clearInterval(i)},[]);
  // Iran-U.S. War Tracker + Live Impact: 60s real-time
  useEffect(()=>{fetchIranTracker();const i=setInterval(fetchIranTracker,60*1000);return()=>clearInterval(i)},[]);
  // Advisories + ratings: 10 min (rarely change)
  useEffect(()=>{fetchAdvisories();fetchPolymarkets();const i=setInterval(()=>{fetchAdvisories();fetchPolymarkets()},10*60*1000);return()=>clearInterval(i)},[]);

  // Advisory data (component-level so JSX + map useEffect can both access)
  var ADV_COUNTRIES={
    'Afghanistan':4,'Ukraine':4,'Russia':4,'Syria':4,'Iran':4,'Iraq':4,
    'Yemen':4,'Somalia':4,'Sudan':4,'South Sudan':4,'Libya':4,'Mali':4,
    'Haiti':4,'North Korea':4,'Venezuela':4,'Myanmar':4,'Burkina Faso':4,
    'Niger':4,'Central African Republic':4,'Belarus':4,'Lebanon':4,
    'Pakistan':3,'Nigeria':3,'Honduras':3,'Israel':3,'Ethiopia':3,
    'Democratic Republic of the Congo':3,'Chad':3,'Mauritania':3,
    'Colombia':3,'Bangladesh':3,'Guatemala':3,'Uganda':3,
    'Guinea-Bissau':3,'Cameroon':3,'Nicaragua':3,'Kenya':3,
    'Mexico':2,'Brazil':2,'Egypt':2,'Turkey':2,'India':2,
    'Guinea':2,'Philippines':2,'South Africa':2,'Jamaica':2,'China':2
  };
  var ADV_ALIASES={
    'Burma':'Myanmar','Republic of the Congo':'DR Congo',
    'Dem. Rep. Congo':'Democratic Republic of the Congo',
    'Congo':'Democratic Republic of the Congo',
    'Korea, Dem. Rep.':'North Korea','Korea':'North Korea',
    'Korea, Rep.':'South Korea',
    'Lao PDR':'Laos','Syrian Arab Republic':'Syria',
    'Iran (Islamic Republic of)':'Iran','Iran, Islamic Rep.':'Iran',
    'Côte d\'Ivoire':'Ivory Coast','Cote d\'Ivoire':'Ivory Coast',
    'Russian Federation':'Russia',
    'Venezuela (Bolivarian Republic of)':'Venezuela',
    'Republic of Guinea':'Guinea',
    'Palestine':'Gaza','West Bank and Gaza':'Gaza',
    'Türkiye':'Turkey','Turkiye':'Turkey'
  };
  function getAdvLevel(name){
    if(ADV_COUNTRIES[name])return ADV_COUNTRIES[name];
    var alias=ADV_ALIASES[name];
    if(alias&&ADV_COUNTRIES[alias])return ADV_COUNTRIES[alias];
    var ks=Object.keys(ADV_COUNTRIES);
    for(var k=0;k<ks.length;k++){
      if(name.indexOf(ks[k])!==-1||ks[k].indexOf(name)!==-1)return ADV_COUNTRIES[ks[k]];
    }
    return 0;
  }
  // State Dept travel advisory URLs (component-level so JSX can access)
  var ADV_URLS={
    'Afghanistan':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/afghanistan-travel-advisory.html',
    'Ukraine':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/ukraine-travel-advisory.html',
    'Russia':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/russia-travel-advisory.html',
    'Syria':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/syria-travel-advisory.html',
    'Iran':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iran-travel-advisory.html',
    'Iraq':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iraq-travel-advisory.html',
    'Yemen':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/yemen-travel-advisory.html',
    'Somalia':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/somalia-travel-advisory.html',
    'Sudan':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/sudan-travel-advisory.html',
    'South Sudan':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/south-sudan-travel-advisory.html',
    'Libya':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/libya-travel-advisory.html',
    'Mali':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mali-travel-advisory.html',
    'Haiti':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/haiti-travel-advisory.html',
    'North Korea':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/north-korea-travel-advisory.html',
    'Venezuela':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/venezuela-travel-advisory.html',
    'Myanmar':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burma-travel-advisory.html',
    'Burkina Faso':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burkina-faso-travel-advisory.html',
    'Niger':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/niger-travel-advisory.html',
    'Central African Republic':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/central-african-republic-travel-advisory.html',
    'Belarus':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/belarus-travel-advisory.html',
    'Lebanon':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/lebanon-travel-advisory.html',
    'Pakistan':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/pakistan-travel-advisory.html',
    'Nigeria':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/nigeria-travel-advisory.html',
    'Honduras':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/honduras-travel-advisory.html',
    'Israel':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/israel-the-west-bank-and-gaza-travel-advisory.html',
    'Ethiopia':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/ethiopia-travel-advisory.html',
    'Democratic Republic of the Congo':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/democratic-republic-of-the-congo-travel-advisory.html',
    'Chad':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/chad-travel-advisory.html',
    'Mauritania':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mauritania-travel-advisory.html',
    'Colombia':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/colombia-travel-advisory.html',
    'Bangladesh':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/bangladesh-travel-advisory.html',
    'Guatemala':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/guatemala-travel-advisory.html',
    'Uganda':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/uganda-travel-advisory.html',
    'Guinea-Bissau':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/guinea-bissau-travel-advisory.html',
    'Cameroon':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/cameroon-travel-advisory.html',
    'Nicaragua':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/nicaragua-travel-advisory.html',
    'Kenya':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/kenya-travel-advisory.html',
    'Mexico':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mexico-travel-advisory.html',
    'Brazil':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/brazil-travel-advisory.html',
    'Egypt':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/egypt-travel-advisory.html',
    'Turkey':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/turkey-travel-advisory.html',
    'India':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/india-travel-advisory.html',
    'Guinea':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/guinea-travel-advisory.html',
    'Philippines':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/philippines-travel-advisory.html',
    'South Africa':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/south-africa-travel-advisory.html',
    'Jamaica':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jamaica-travel-advisory.html',
    'China':'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/china-travel-advisory.html'
  };
  function getAdvUrl(name){
    if(ADV_URLS[name])return ADV_URLS[name];
    var alias=ADV_ALIASES[name];
    if(alias&&ADV_URLS[alias])return ADV_URLS[alias];
    var keys=Object.keys(ADV_URLS);
    for(var k=0;k<keys.length;k++){
      if(name.indexOf(keys[k])!==-1||keys[k].indexOf(name)!==-1)return ADV_URLS[keys[k]];
    }
    return 'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories.html/';
  }

  // Initialize Leaflet map
  useEffect(()=>{
    if(mapRef.current)return;
    const map=L.map('leaflet-map',{
      center:[20,15],zoom:2,minZoom:2,maxZoom:8,
      zoomControl:false,attributionControl:false,
      worldCopyJump:true
    });
    const tileUrl=darkMode?'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png':'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';
    const labelUrl=darkMode?'https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png':'https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png';
    L.tileLayer(tileUrl,{
      subdomains:'abcd',maxZoom:19
    }).addTo(map);
    // Labels layer — CartoDB labels (English for major features)
    L.tileLayer(labelUrl,{
      subdomains:'abcd',maxZoom:19,pane:'shadowPane'
    }).addTo(map);
    L.control.zoom({position:'bottomright'}).addTo(map);
    mapRef.current=map;

    // ═══ ADVISORY SHADING — GeoJSON country fill ═══
    var advFillColors={4:'rgba(255,59,48,0.35)',3:'rgba(255,149,0,0.25)',2:'rgba(255,214,10,0.18)'};
    var advStrokeColors={4:'rgba(255,59,48,0.6)',3:'rgba(255,149,0,0.5)',2:'rgba(255,214,10,0.4)'};
    var lvlLabels={4:'LEVEL 4 — DO NOT TRAVEL',3:'LEVEL 3 — RECONSIDER TRAVEL',2:'LEVEL 2 — EXERCISE INCREASED CAUTION'};

    // Fetch GeoJSON and render
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
      .then(function(r){return r.json();})
      .then(function(geo){
        var layer=L.geoJSON(geo,{
          style:function(feature){
            var name=feature.properties.name||'';
            var lv=getAdvLevel(name);
            if(lv>0){
              return{fillColor:advFillColors[lv],fillOpacity:1,color:advStrokeColors[lv],weight:1.5,opacity:1};
            }
            return{fillColor:'transparent',fillOpacity:0,color:'transparent',weight:0,opacity:0};
          },
          onEachFeature:function(feature,layer){
            var name=feature.properties.name||'';
            var lv=getAdvLevel(name);
            if(lv>0){
              var url=getAdvUrl(name);
              layer.bindTooltip('<div style="pointer-events:auto;cursor:default">'+name+' — '+lvlLabels[lv]+'<br><a href="'+url+'" target="_blank" rel="noopener" style="color:#0a84ff;font-size:9px;pointer-events:auto;cursor:pointer">View State Dept Advisory ↗</a></div>',{sticky:false,className:'adv-tooltip',interactive:true,direction:'top',offset:L.point(0,-10)});
              layer.on('click',function(){
                var bounds=layer.getBounds();
                var center=bounds.getCenter();
                setCountryBrief({name:name,level:lv,lat:center.lat,lon:center.lng});
              });
              layer.on('mouseover',function(){
                layer.setStyle({fillOpacity:1,weight:2.5});
              });
              layer.on('mouseout',function(){
                layer.setStyle({fillOpacity:1,weight:1.5});
              });
            }
          },
          filter:function(feature){
            // Only render countries that have an advisory level
            var name=feature.properties.name||'';
            return getAdvLevel(name)>0;
          }
        }).addTo(map);
        geoLayerRef.current=layer;
        console.log('SENTINEL NOVA: GeoJSON advisory shading loaded');
      })
      .catch(function(err){console.error('GeoJSON load error:',err);});

    // Add connection lines
    CONNS.forEach(([fromId,toId,label,color])=>{
      const f=INCIDENTS.find(i=>i.id===fromId);const t=INCIDENTS.find(i=>i.id===toId);
      if(!f||!t)return;
      const line=L.polyline([[f.lat,f.lon],[t.lat,t.lon]],{
        color,weight:1.5,opacity:0.35,dashArray:'6,4',className:'conn-arc'
      }).addTo(map);
      linesRef.current.push(line);
    });
  },[]);

  // Update advisory GeoJSON shading when filter changes
  useEffect(()=>{
    if(!geoLayerRef.current)return;
    var fillColors={4:'rgba(255,59,48,0.35)',3:'rgba(255,149,0,0.25)',2:'rgba(255,214,10,0.18)'};
    var strokeColors={4:'rgba(255,59,48,0.6)',3:'rgba(255,149,0,0.5)',2:'rgba(255,214,10,0.4)'};
    geoLayerRef.current.eachLayer(function(layer){
      var name=(layer.feature&&layer.feature.properties&&layer.feature.properties.name)||'';
      var lv=getAdvLevel(name);
      if(lv>0){
        if(advFilter.has(lv)){
          layer.setStyle({fillColor:fillColors[lv],fillOpacity:1,color:strokeColors[lv],weight:1.5,opacity:1});
        }else{
          layer.setStyle({fillColor:'transparent',fillOpacity:0,color:'transparent',weight:0,opacity:0});
        }
      }
    });
  },[advFilter]);

  // Update markers when filter changes — use MarkerClusterGroup if available, else plain markers
  useEffect(()=>{
    if(!mapRef.current)return;
    const map=mapRef.current;
    // Remove old markers/cluster group
    markersRef.current.forEach(m=>map.removeLayer(m));
    markersRef.current=[];
    const filtered=mf==='ALL'?INCIDENTS:INCIDENTS.filter(i=>i.cat===mf);
    var useCluster=typeof L.markerClusterGroup==='function';
    var group=useCluster?L.markerClusterGroup({
      maxClusterRadius:40,
      spiderfyOnMaxZoom:true,
      showCoverageOnHover:false,
      zoomToBoundsOnClick:true,
      iconCreateFunction:function(cluster){
        var count=cluster.getChildCount();
        var sz=count<5?'small':count<15?'medium':'large';
        return L.divIcon({html:'<div><span>'+count+'</span></div>',className:'marker-cluster marker-cluster-'+sz,iconSize:L.point(36,36)});
      }
    }):null;
    filtered.forEach(inc=>{
      const col=SC[inc.sv];
      const size=inc.sv==='critical'?10:8;
      const pulseClass=inc.sv==='critical'?'pulse-marker':'';
      const icon=L.divIcon({
        className:'',
        html:`<div style="width:${size}px;height:${size}px;background:${col};border-radius:50%;border:2px solid rgba(0,0,0,0.6);box-shadow:0 0 ${inc.sv==='critical'?'12':'6'}px ${col}80;cursor:pointer" class="${pulseClass}"></div>`,
        iconSize:[size,size],iconAnchor:[size/2,size/2]
      });
      const marker=L.marker([inc.lat,inc.lon],{icon});
      const popup=`<div style="font-family:Inter,sans-serif">
        <div style="font:600 10px 'JetBrains Mono';color:${col};text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${inc.cat} — ${inc.sv.toUpperCase()}</div>
        <div style="font:500 12px/1.4 Inter;color:#e5e5e5;margin-bottom:4px">${inc.t}</div>
        <div style="font:400 10px 'JetBrains Mono';color:#999">${inc.reg} · ${inc.tm} ago</div>
        <div style="font:500 10px 'JetBrains Mono';color:#999;margin-top:4px">${inc.imp}</div>
      </div>`;
      marker.bindPopup(popup,{maxWidth:280,closeButton:true});
      marker.on('mouseover',function(){this.openPopup()});
      if(group){group.addLayer(marker);}else{marker.addTo(map);markersRef.current.push(marker);}
    });
    if(group){map.addLayer(group);markersRef.current=[group];}
  },[mf]);

  // Advisory shading is now painted directly via L.circle in map init (zero external deps)

  const fi=mf==='ALL'?INCIDENTS:INCIDENTS.filter(i=>i.cat===mf);

  // Use live news for feed + wire, fallback to static
  const feedItems=liveNews.length>0?liveNews:INCIDENTS;
  const wireItems=liveNews.length>0?liveNews:NEWS;

  // Compute advisory summary stats
  const advStats=useMemo(()=>{
    const l4=advisories.filter(a=>a.level===4).length;
    const l3=advisories.filter(a=>a.level===3).length;
    const l2=advisories.filter(a=>a.level===2).length;
    return{l4,l3,l2,total:advisories.length};
  },[advisories]);

  // ═══ GENERATE BRIEF — one-page top 10 global security developments (web-sourced) ═══
  const generateBrief=async function(){
    var D=window.docx;if(!D){alert('Document library not loaded. Please refresh.');return;}
    var now=new Date();
    var dateStr=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    var timeStr=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false})+' UTC';
    // Tightly scoped queries — each requires TWO security-relevant terms to co-occur
    var queries=[
      {q:'(airstrike OR missile OR shelling OR "armed conflict" OR "military offensive") (killed OR casualties OR "civilian" OR troops OR strike) sourcelang:eng',tag:'ARMED CONFLICT'},
      {q:'("terrorist attack" OR "suicide bomb" OR "car bomb" OR "IED" OR "mass shooting" OR "extremist") (killed OR injured OR claimed OR plot) sourcelang:eng',tag:'TERRORISM'},
      {q:'(kidnapping OR hostage OR abduction OR "ransom") (gang OR cartel OR militia OR "armed group" OR pirates) sourcelang:eng',tag:'KIDNAP & RANSOM'},
      {q:'(earthquake OR tsunami OR hurricane OR typhoon OR "volcanic eruption" OR cyclone) (deaths OR evacuated OR destroyed OR emergency OR casualties) sourcelang:eng',tag:'NATURAL DISASTER'},
      {q:'(ransomware OR cyberattack OR "data breach") (government OR hospital OR infrastructure OR pipeline OR bank) sourcelang:eng',tag:'CYBER THREAT'},
      {q:'(detained OR arrested OR "political prisoner" OR "wrongful detention") (journalist OR opposition OR diplomat OR activist OR dissident) sourcelang:eng',tag:'DETENTION / ARREST'},
      {q:'(deepfake OR "AI-generated" OR disinformation) (election OR government OR military OR "influence operation") sourcelang:eng',tag:'SYNTHETIC MEDIA'},
      {q:'(cartel OR assassination OR "drug war" OR "gang violence" OR "organized crime") (Mexico OR Colombia OR Ecuador OR Brazil OR Honduras) sourcelang:eng',tag:'ORGANIZED CRIME'},
      {q:'(coup OR "regime change" OR "martial law" OR "state of emergency" OR uprising OR revolution) (military OR government OR parliament OR protest) sourcelang:eng',tag:'POLITICAL INSTABILITY'},
      {q:'("nuclear" OR "ballistic missile" OR "weapons test" OR "chemical attack") (North Korea OR Iran OR Russia OR threat OR launch) sourcelang:eng',tag:'WMD / PROLIFERATION'},
    ];
    // Relevance keywords — headlines must contain at least one to pass the quality filter
    var securityTerms=/kill|dead|attack|bomb|shoot|strike|seize|arrest|detain|hostage|kidnap|ransom|breach|hack|quake|tsunami|hurricane|typhoon|cyclone|erupt|flood|wildfire|coup|martial|uprising|missile|nuclear|weapon|terror|explo|casualt|evacuat|cartel|traffick|assassin|deepfake|disinfo|sanction|militia|drone|shell|siege|riot|clash|protest.*violen/i;
    // Fetch top stories across all categories via GDELT
    var allDevs=[];
    var fetchPromises=queries.map(function(cat){
      return gdeltFetch(cat.q,6,'1440min').then(function(data){
        if(data&&data.articles){
          data.articles.forEach(function(art){
            var title=decEnt(art.title||'');
            // Strip source suffix (e.g. " - Reuters")
            if(title.indexOf(' - ')>25)title=title.substring(0,title.lastIndexOf(' - '));
            // Quality gate: must match security-relevant terms
            if(!securityTerms.test(title))return;
            var src=art.domain||'';
            var key=title.slice(0,35).toLowerCase().replace(/[^a-z0-9]/g,'');
            allDevs.push({headline:title.slice(0,120),tag:cat.tag,source:src,time:timeAgo(art.seendate),key:key,seendate:art.seendate||'',sources:art.socialimage?2:1});
          });
        }
      }).catch(function(){});
    });
    await Promise.all(fetchPromises);
    // Deduplicate by fuzzy key
    var seen=new Set();
    var unique=allDevs.filter(function(d){if(seen.has(d.key))return false;seen.add(d.key);return true;});
    // Sort by recency
    unique.sort(function(a,b){return(b.seendate||'').localeCompare(a.seendate||'');});
    var topItems=unique.slice(0,12);
    // Fallback to dashboard data if GDELT underperformed
    if(topItems.length<5){
      var news=liveNews.length>0?liveNews:INCIDENTS;
      news.slice(0,12-topItems.length).forEach(function(n){
        topItems.push({headline:decEnt(n.t||n.title||'').slice(0,120),tag:(n.cat||'SECURITY').toUpperCase(),source:decEnt(n.src||n.reg||''),time:n.tm||''});
      });
    }
    // ═══ REGION-BASED NARRATIVE CONSTRUCTION ═══
    var regionRules=[
      {name:'Middle East and North Africa',rx:/\b(iraq|iran|syria|yemen|gaza|palestine|israel|hezbollah|houthi|lebanon|jordan|saudi|bahrain|qatar|oman|uae|emirates|egypt|libya|tunisia|algeria|morocco|sinai|golan|west bank|rafah|beirut|tehran|baghdad|damascus|sanaa|riyadh|cairo|tripoli)\b/i},
      {name:'Russia-Ukraine',rx:/\b(ukraine|russia|russian|kremlin|kyiv|kiev|moscow|donbas|donetsk|luhansk|crimea|zaporizhzhia|kharkiv|kherson|odesa|putin|zelensky|wagner|bakhmut|avdiivka|kursk|belgorod|drone.*russia|russia.*drone|nato.*ukr|ukr.*nato)\b/i},
      {name:'Indo-Pacific',rx:/\b(china|chinese|beijing|taiwan|strait|south china sea|philippines|manila|japan|tokyo|north korea|pyongyang|DPRK|korea|india|pakistan|kashmir|bangladesh|myanmar|burma|rohingya|indonesia|bali|vietnam|thailand|australia|pacific|ASEAN|sri lanka|cambodia|laos|aukus|quad)\b/i},
      {name:'Sub-Saharan Africa',rx:/\b(nigeria|niger|mali|burkina faso|chad|sudan|south sudan|khartoum|RSF|ethiopia|tigray|somalia|mogadishu|al.shabaab|congo|DRC|mozambique|sahel|boko haram|kenya|uganda|cameroon|senegal|ghana|tanzania|zimbabwe|south africa|rwanda|junta.*africa|africa.*junta)\b/i},
      {name:'Europe and Transatlantic',rx:/\b(NATO|eu |european union|brussels|london|paris|berlin|germany|france|britain|UK |poland|romania|baltic|finland|sweden|norway|denmark|spain|italy|greece|turkey|ankara|istanbul|balkans|serbia|kosovo|moldova|georgia|tbilisi|arctic|north sea)\b/i},
      {name:'Americas',rx:/\b(mexico|cartel|sinaloa|colombia|bogota|venezuela|maduro|brazil|ecuador|peru|argentina|chile|honduras|guatemala|el salvador|haiti|cuba|canada|fentanyl|border.*US|US.*border|latin america|central america|caribbean)\b/i},
      {name:'Cyber and Technology',rx:/\b(cyber|ransomware|hack|breach|malware|phishing|zero.day|APT|deepfake|AI.generated|disinformation|misinformation|influence operation|botnet|critical infrastructure|SCADA|DDoS)\b/i}
    ];
    function classifyRegion(headline,tag){
      for(var ri=0;ri<regionRules.length;ri++){if(regionRules[ri].rx.test(headline))return regionRules[ri].name;}
      if(tag==='CYBER THREAT'||tag==='SYNTHETIC MEDIA')return 'Cyber and Technology';
      if(tag==='ORGANIZED CRIME')return 'Americas';
      return 'Global';
    }
    // Group by region and collect all sources for bottom attribution
    var regionGroups={};
    var allSources=[];
    topItems.forEach(function(d){
      var reg=classifyRegion(d.headline,d.tag);
      if(!regionGroups[reg])regionGroups[reg]=[];
      regionGroups[reg].push(d);
      var src=(d.source||'').replace('www.','');
      if(src&&allSources.indexOf(src)===-1)allSources.push(src);
    });
    var regionOrder=['Middle East and North Africa','Russia-Ukraine','Indo-Pacific','Sub-Saharan Africa','Europe and Transatlantic','Americas','Cyber and Technology','Global'];
    var activeRegions=regionOrder.filter(function(r){return regionGroups[r]&&regionGroups[r].length>0;});

    // ═══ ANALYTICAL NARRATIVE BUILDERS ═══
    // Primary assessment per tag (woven after lead item in each region)
    var tagInsight={
      'ARMED CONFLICT':'We judge this carries significant escalation risk and may draw in regional state or non-state actors, potentially shifting alliance postures and complicating ongoing diplomatic efforts. The trajectory of kinetic operations in this theater suggests that belligerents retain both the intent and capability to sustain or intensify current levels of activity, which we assess reduces the near-term probability of any meaningful ceasefire or negotiated pause.',
      'TERRORISM':'We assess the threat environment remains fluid and the operational tempo suggests a sustained capability among known networks. There is a moderate-to-high probability of retaliatory or copycat actions in the near term, particularly against soft targets in urban centers. The adaptability of threat actors to exploit emerging vulnerabilities continues to challenge existing protective security frameworks.',
      'KIDNAP & RANSOM':'This pattern is assessed as consistent with deteriorating local security conditions and likely indicates an expansion of criminal operational reach beyond traditional areas of activity. We judge that the frequency and geographic spread of reported incidents reflects a deliberate diversification of targeting, which may signal growing confidence among organized criminal groups operating in the region.',
      'NATURAL DISASTER':'We assess that humanitarian response capacity is likely to be strained across multiple response corridors, with cascading second-order effects on population displacement, supply chain disruption, and broader regional stability. The intersection of natural hazard events with pre-existing fragility amplifies the potential for protracted humanitarian need and may necessitate expanded international coordination.',
      'CYBER THREAT':'We assess that affected systems face sustained operational disruption. The sophistication and targeting pattern observed in recent reporting underscore persistent and evolving vulnerabilities across critical national infrastructure. We judge that the convergence of state-sponsored and criminal cyber activity presents a compounding risk that is not yet adequately reflected in prevailing defensive postures.',
      'DETENTION / ARREST':'We judge these actions are likely to draw significant international scrutiny and may signal a broader crackdown on civil liberties that could constrain the operating environment for foreign organizations and personnel. The pattern of detentions, when viewed in the context of recent political developments, suggests a deliberate effort to suppress dissent and restrict independent information flows.',
      'SYNTHETIC MEDIA':'We assess the information environment remains actively contested. The scale and coordination of observed synthetic media activity warrants enhanced monitoring for potential impact on democratic processes, public trust, and the integrity of open-source reporting itself.',
      'ORGANIZED CRIME':'We judge that territorial and operational disputes between criminal networks continue to pose a persistent threat to governance, public safety, and economic stability across affected regions. The increasing integration of narcotics trafficking, money laundering, and political corruption within these networks complicates law enforcement response and undermines institutional resilience.',
      'POLITICAL INSTABILITY':'We assess that governance continuity is at material risk, with cascading political, security, and economic effects that could destabilize adjacent states and complicate international engagement. The erosion of democratic norms and the centralization of executive power in affected states increase the probability of abrupt political transitions with limited institutional safeguards.',
      'WMD / PROLIFERATION':'We judge this represents a material and potentially acute concern for regional security architecture, which may prompt a recalibration of deterrence postures among relevant parties. Proliferation-related activity, particularly when combined with provocative rhetoric or diplomatic brinkmanship, elevates the risk of miscalculation with potentially severe consequences.'
    };
    // Secondary context per tag (woven after follow-on items)
    var tagContext={
      'ARMED CONFLICT':'This development, viewed alongside broader regional reporting, reinforces our assessment that the conflict trajectory remains on a deteriorating arc with limited near-term prospects for de-escalation. We continue to monitor for indicators of geographic spread or qualitative shifts in the nature of hostilities.',
      'TERRORISM':'The operational pattern is consistent with a capable and adaptive threat network. We assess continued vigilance across soft-target environments is warranted, and note that the evolution of attack methodologies may require corresponding adjustments to protective security measures.',
      'KIDNAP & RANSOM':'This further supports the assessment that criminal groups are exploiting security vacuums and may be diversifying both their operational geography and their ransom methodologies to maximize revenue and minimize risk of interdiction.',
      'NATURAL DISASTER':'The compounding nature of these events is assessed as likely to overwhelm existing response frameworks and may necessitate expanded international coordination. We note that disaster-affected populations in conflict zones face particularly acute vulnerabilities.',
      'CYBER THREAT':'This is consistent with a broader pattern of increasing sophistication in the threat landscape. The potential for cross-sector cascading effects remains a key concern, particularly where critical infrastructure interdependencies create single points of failure.',
      'DETENTION / ARREST':'Collectively, these detentions are assessed as part of a systematic pattern that may chill future opposition activity, restrict humanitarian access, and erode the rule of law in affected jurisdictions.',
      'SYNTHETIC MEDIA':'The proliferation of synthetic content across multiple platforms complicates attribution and response, which we assess as an intentional feature of the observed campaign designed to degrade public trust in legitimate information sources.',
      'ORGANIZED CRIME':'The convergence of trafficking, corruption, and violent enforcement underscores the systemic nature of this threat and its capacity to undermine institutional resilience at both local and national levels.',
      'POLITICAL INSTABILITY':'This further erodes the already fragile political settlement and, we assess, increases the probability of a more acute governance crisis within the coming weeks. International mediation efforts face narrowing windows of opportunity.',
      'WMD / PROLIFERATION':'Viewed in the context of recent diplomatic developments, this activity suggests a deliberate calibration of strategic signaling that warrants close watch and may indicate a willingness to escalate beyond established norms of behavior.'
    };
    // Standing regional background
    var regionBackground={
      'Middle East and North Africa':'The Middle East and North Africa remain among the most volatile and strategically consequential theaters in the current global security landscape. Ongoing conflicts in multiple states, shifting alliance structures, and the persistent threat of both state and non-state actor escalation continue to define the region\'s risk profile. The interplay between Iranian proxy networks, Israeli security operations, Gulf state diplomacy, and the humanitarian crisis in Gaza and the broader Levant creates a multi-layered threat environment that demands continuous monitoring. Energy security, maritime freedom of navigation, and the stability of key transit corridors add further strategic weight to developments across this region.',
      'Russia-Ukraine':'The Russia-Ukraine conflict continues to shape European and global security dynamics in profound and lasting ways. The war has entered a phase characterized by attritional warfare, evolving drone and missile strategies, and periodic shifts in territorial control along an extended front line. Western military and economic support to Ukraine remains a decisive variable, while Russian force generation, sanctions evasion, and information operations continue to complicate the strategic picture. Any shifts in the tempo or geography of hostilities carry significant implications for NATO posture, European energy security, and the broader rules-based international order.',
      'Indo-Pacific':'The Indo-Pacific region remains a focal point of great-power competition, with the U.S.-China strategic rivalry, Taiwan Strait tensions, North Korean provocations, and maritime disputes in the South China Sea all contributing to an elevated baseline threat level. The militarization of disputed territories, economic coercion, and information warfare are increasingly integrated elements of statecraft in the region. The potential for miscalculation or unintended escalation remains a persistent concern for security planners, particularly given the density of military assets and the absence of reliable de-escalation mechanisms between principal competitors.',
      'Sub-Saharan Africa':'Sub-Saharan Africa continues to face a convergence of security challenges including jihadist insurgency across the Sahel, civil conflict in Sudan and the eastern Democratic Republic of the Congo, and democratic backsliding through military coups in multiple West African states. Humanitarian conditions in several countries remain dire, with displacement, food insecurity, and endemic disease compounding the effects of armed violence. The withdrawal of Western security partners from the Sahel and the growing role of non-traditional security actors have fundamentally reshaped the security architecture of the continent, introducing new dynamics that remain difficult to predict.',
      'Europe and Transatlantic':'Beyond the direct Russia-Ukraine conflict, the broader European and Transatlantic security environment is characterized by the ongoing adaptation of NATO posture, energy security recalibration, and an evolving terrorism and domestic extremism threat. Hybrid threats including sabotage, cyber intrusions, and influence operations attributed to Russian intelligence services have featured prominently in recent reporting across Baltic, Nordic, and Central European states. The resilience of critical infrastructure and democratic institutions against these persistent threats remains a central concern for allied governments.',
      'Americas':'The Western Hemisphere security picture is dominated by transnational organized crime, narcotics trafficking, and governance fragility in several Central and South American states. Mexican cartel operations, Venezuelan political instability, and migration-driven pressures on the U.S. southern border continue to drive both national and regional security agendas. Gang violence, extortion, and the fentanyl epidemic represent persistent and in some cases worsening threat vectors with significant implications for public health, law enforcement capacity, and bilateral relations.',
      'Cyber and Technology':'The global cyber threat landscape continues to evolve in both sophistication and impact. State-sponsored advanced persistent threat groups, criminal ransomware syndicates, and influence operations leveraging AI-generated content all contribute to an increasingly contested digital environment. Critical infrastructure including energy, healthcare, financial services, and government networks remains a high-value target. The convergence of cyber and information warfare blurs traditional boundaries between espionage, sabotage, and armed conflict, and presents unique challenges for attribution and response.',
      'Global':'Several developments in the past 24 hours carry cross-cutting implications that span multiple geographic regions and threat domains. These events reflect the interconnected nature of modern security risk, where developments in one theater can rapidly influence conditions in another through diplomatic, economic, or informational channels.'
    };
    // Varied analytical connectors
    var conn1=['Reporting indicates that ','Available intelligence suggests that ','Open-source collection points to ','Multiple corroborating sources report that ','Assessed reporting reflects ','Collection over the past 24 hours reveals that ','Credible open-source reporting highlights ','We note that '];
    var conn2=['Separately, ','In a related development, ','Concurrently, ','Of additional note, ','In parallel, ','Also within this region, ','Adding to the regional threat picture, ','Further complicating the operating environment, '];
    var ci1=0;var ci2=0;
    function nC1(){var c=conn1[ci1%conn1.length];ci1++;return c;}
    function nC2(){var c=conn2[ci2%conn2.length];ci2++;return c;}

    // Build flowing prose per region: background + event narrative (no inline source citations)
    var regionNarratives=[];
    activeRegions.forEach(function(reg){
      var items=regionGroups[reg];
      var paragraphs=[];
      if(regionBackground[reg])paragraphs.push(regionBackground[reg]);
      var currentPara='Against this backdrop, ';
      items.forEach(function(d,di){
        if(di===0){
          var cn=nC1();
          currentPara+=cn.charAt(0).toLowerCase()+cn.slice(1);
          currentPara+=d.headline+'. ';
          if(tagInsight[d.tag])currentPara+=tagInsight[d.tag]+' ';
        }else{
          var lh=d.headline.charAt(0).toLowerCase()+d.headline.slice(1);
          currentPara+=nC2()+lh+'. ';
          if(tagContext[d.tag])currentPara+=tagContext[d.tag]+' ';
          if(di%2===0&&di<items.length-1){
            paragraphs.push(currentPara.trim());
            currentPara='Continued collection in this region also indicates ';
          }
        }
      });
      if(currentPara.trim())paragraphs.push(currentPara.trim());
      regionNarratives.push({region:reg,paragraphs:paragraphs});
    });

    // ═══ BUILD BLUF ═══
    var threatCount=topItems.length;
    var regionCount=activeRegions.length;
    var sortedRegs=activeRegions.slice().sort(function(a,b){return regionGroups[b].length-regionGroups[a].length;});
    var topRegs=sortedRegs.slice(0,Math.min(3,sortedRegs.length));
    var hasConflict=topItems.some(function(d){return d.tag==='ARMED CONFLICT'||d.tag==='WMD / PROLIFERATION';});
    var hasCyber=topItems.some(function(d){return d.tag==='CYBER THREAT'||d.tag==='SYNTHETIC MEDIA';});
    var hasTerror=topItems.some(function(d){return d.tag==='TERRORISM';});
    var hasInstability=topItems.some(function(d){return d.tag==='POLITICAL INSTABILITY'||d.tag==='DETENTION / ARREST';});
    var hasNatDis=topItems.some(function(d){return d.tag==='NATURAL DISASTER';});

    var blufText='The global security environment over the preceding 24-hour reporting cycle is assessed as elevated with moderate-to-high confidence. Open-source collection has identified approximately '+threatCount+' significant developments spanning '+regionCount+' geographic regions and multiple threat domains. ';
    blufText+='The most concentrated and consequential activity was observed across '+topRegs.join(', ')+', which together account for the preponderance of assessed escalation risk during this period. ';
    if(hasConflict)blufText+='We judge that active armed conflicts, particularly those involving state-on-state or state-on-proxy engagements, remain the primary driver of the current threat posture, with kinetic activity showing no material signs of abatement. ';
    if(hasTerror)blufText+='The terrorism and violent extremism threat picture warrants continued close monitoring; recent operational activity suggests sustained intent and capability among known threat networks, with a moderate-to-high probability of follow-on actions. ';
    if(hasCyber)blufText+='Persistent and evolving cyber and information warfare threats continue to test the resilience of critical infrastructure across multiple sectors and geographies. ';
    if(hasInstability)blufText+='Political instability and governance disruption in several states present compounding risk factors that may constrain the operating environment for international organizations and personnel. ';
    if(hasNatDis)blufText+='Natural disaster events are placing additional strain on humanitarian response capacity and are assessed as likely to generate secondary displacement and infrastructure effects in already fragile contexts. ';
    blufText+='This assessment is derived exclusively from open-source collection and is rendered with moderate-to-high confidence. All judgments are subject to revision as new information becomes available. We recommend sustained monitoring and enhanced collection across all identified vectors.';

    // ═══ LOOKING AHEAD ═══
    var laText='Over the next 24 to 48 hours, we assess that ';
    if(hasConflict)laText+='active conflict zones, particularly in '+topRegs[0]+', carry the highest probability of further escalation, with potential for expanded area of operations or intensified targeting of civilian infrastructure. ';
    else laText+='the overall threat environment is likely to remain at current levels, though the fluid nature of developments across multiple regions introduces uncertainty that could alter this assessment rapidly. ';
    laText+='Key watchpoints for the coming reporting cycle include the trajectory of any ceasefire or diplomatic initiatives associated with active conflicts, the potential for retaliatory actions following high-profile strikes or detentions, the propagation of cyber incidents to additional sectors or geographies, and the humanitarian impact of natural disaster events particularly where these intersect with pre-existing fragility. ';
    laText+='We recommend sustained collection on all identified vectors and note that developments in ';
    laText+=sortedRegs.length>1?sortedRegs[0]+' and '+sortedRegs[1]:sortedRegs[0];
    laText+=' have the greatest potential for near-term impact on organizational security posture and duty-of-care obligations. Organizations with equities in the identified regions should consider reviewing travel policies, continuity arrangements, and information security postures in light of this assessment. We will provide an updated assessment in the next scheduled cycle.';

    // ═══ BUILD DOCUMENT ═══ sizes in HALF-POINTS (size:20=10pt), spacing in twips, line in 240ths
    var children=[];
    var SP=D.BorderStyle.SINGLE;
    var LN=340; // ~1.42x line spacing
    var bodySize=19; // 9.5pt
    // ── Header ──
    children.push(new D.Paragraph({spacing:{after:40},children:[
      new D.TextRun({text:'SENTINEL NOVA',font:'Arial',size:30,bold:true,color:'cc0000'}),
      new D.TextRun({text:'  |  Global Security Brief',font:'Arial',size:20,color:'777777'}),
    ]}));
    children.push(new D.Paragraph({spacing:{after:120},border:{bottom:{style:SP,size:3,color:'cc0000',space:4}},children:[
      new D.TextRun({text:'24-Hour Intelligence Summary  \u2022  '+dateStr+'  \u2022  '+timeStr,font:'Arial',size:15,color:'999999'}),
    ]}));
    // ── BLUF ──
    children.push(new D.Paragraph({spacing:{before:100,after:80},children:[
      new D.TextRun({text:'BOTTOM LINE UP FRONT (BLUF)',font:'Arial',size:20,bold:true,color:'1a1a1a'}),
    ]}));
    children.push(new D.Paragraph({spacing:{after:200,line:LN},children:[
      new D.TextRun({text:blufText,font:'Arial',size:bodySize,color:'333333'}),
    ]}));
    // ── WHAT HAS HAPPENED ──
    children.push(new D.Paragraph({spacing:{before:60,after:100},border:{bottom:{style:SP,size:1,color:'cccccc',space:3}},children:[
      new D.TextRun({text:'WHAT HAS HAPPENED',font:'Arial',size:20,bold:true,color:'1a1a1a'}),
    ]}));
    regionNarratives.forEach(function(rn){
      // Region subheading
      children.push(new D.Paragraph({spacing:{before:160,after:80},children:[
        new D.TextRun({text:rn.region,font:'Arial',size:bodySize,bold:true,color:'1a1a1a'}),
      ]}));
      // Each paragraph with proper spacing between them
      rn.paragraphs.forEach(function(para){
        children.push(new D.Paragraph({spacing:{after:180,line:LN},children:[
          new D.TextRun({text:para,font:'Arial',size:bodySize,color:'333333'}),
        ]}));
      });
    });
    // ── LOOKING AHEAD ──
    children.push(new D.Paragraph({spacing:{before:100,after:80},border:{bottom:{style:SP,size:1,color:'cccccc',space:3}},children:[
      new D.TextRun({text:'LOOKING AHEAD',font:'Arial',size:20,bold:true,color:'1a1a1a'}),
    ]}));
    children.push(new D.Paragraph({spacing:{after:200,line:LN},children:[
      new D.TextRun({text:laText,font:'Arial',size:bodySize,color:'333333'}),
    ]}));
    // ── SOURCES (at the bottom, verified only) ──
    children.push(new D.Paragraph({spacing:{before:100,after:60},border:{bottom:{style:SP,size:1,color:'cccccc',space:3}},children:[
      new D.TextRun({text:'SOURCES',font:'Arial',size:18,bold:true,color:'1a1a1a'}),
    ]}));
    var verifiedSources=['GDELT Project (Global Event Database)','U.S. Department of State Travel Advisories','ReliefWeb (UN OCHA)'];
    allSources.forEach(function(s){
      if(/reuters|bbc|aljazeera|cnn|guardian|nytimes|washingtonpost|apnews|france24|dw\.com|economist|ft\.com|bloomberg|sky|abc|nbc|cbs|pbs|npr|politico|thehill|defense|janes|military|haaretz|timesofisrael/i.test(s)){
        var clean=s.replace(/\.com$|\.co\.uk$|\.org$/,'').replace(/\./g,' ');
        clean=clean.charAt(0).toUpperCase()+clean.slice(1);
        if(verifiedSources.indexOf(clean)===-1)verifiedSources.push(clean);
      }
    });
    var sourceText=verifiedSources.join('  \u2022  ');
    children.push(new D.Paragraph({spacing:{after:120,line:300},children:[
      new D.TextRun({text:sourceText,font:'Arial',size:16,color:'555555'}),
    ]}));
    // ── Methodology ──
    children.push(new D.Paragraph({spacing:{before:120,after:40,line:280},border:{top:{style:SP,size:1,color:'DDDDDD',space:4}},children:[
      new D.TextRun({text:'METHODOLOGY: ',font:'Arial',size:14,bold:true,color:'AAAAAA'}),
      new D.TextRun({text:'This brief is compiled from open-source intelligence (OSINT) feeds including the GDELT global event monitoring system, RSS aggregation from major international wire services, and structured data from government advisories. Events are classified by geographic region and threat domain. Probabilistic language ("we assess," "we judge") reflects confidence levels based on source reliability, recency, and multi-source corroboration. All analytical judgments are preliminary and require independent verification prior to operational use. This product does not constitute legal, operational, or travel advice.',font:'Arial',size:14,color:'BBBBBB',italics:true}),
    ]}));
    children.push(new D.Paragraph({spacing:{after:20},alignment:D.AlignmentType.CENTER,children:[
      new D.TextRun({text:'Classification: UNCLASSIFIED // FOUO',font:'Arial',size:13,bold:true,color:'AAAAAA'}),
    ]}));
    var doc=new D.Document({
      styles:{default:{document:{run:{font:'Arial',size:20}}}},
      sections:[{
        properties:{page:{size:{width:12240,height:15840},margin:{top:1080,right:1200,bottom:900,left:1200}}},
        footers:{default:new D.Footer({children:[
          new D.Paragraph({alignment:D.AlignmentType.CENTER,children:[
            new D.TextRun({text:'Powered by SENTINEL NOVA \u2014 Human Verified',font:'Arial',size:12,color:'BBBBBB',italics:true}),
          ]})
        ]})},
        children:children
      }]
    });
    var blob=await D.Packer.toBlob(doc);
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url;
    a.download='SENTINEL_NOVA_Brief_'+now.toISOString().slice(0,10)+'.docx';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  return(
    <div>
      {/* Ticker */}
      <div className="ticker"><div className="tscroll">
        {[...TICKERS,...TICKERS].map((t,i)=>{var lp=livePrices[t.s];var price=lp?lp.p:t.p;var change=lp?lp.c:t.c;var up=lp?lp.u:t.u;return <React.Fragment key={i}>
          <span className="tk"><span className="s">{t.s}</span><span className="p">{price}</span><span className={up?'up':'dn'}>{change}</span></span>
          {i%5===4&&<span className="tsep">│</span>}
        </React.Fragment>})}
      </div></div>

      {/* Breaking News Banner — GDELT powered */}
      {breakingNews&&<div className="breaking-banner">
        <div className="bb-inner">
          <div className="bb-pulse"/>
          <span className="bb-tag">BREAKING</span>
          <span className="bb-headline"><a href={breakingNews.url} target="_blank" rel="noopener noreferrer">{breakingNews.title}</a></span>
          <span className="bb-sources">{breakingNews.sources} sources</span>
          <span className="bb-time">{breakingNews.time}</span>
          <button className="bb-dismiss" onClick={function(){setBannerDismissed(breakingNews.title.substring(0,40));setBreakingNews(null);}}>✕</button>
        </div>
      </div>}

      {/* Alert Queue */}
      {alertQueue.map(alert=>{
        let color='alert-red';
        if(alert.type==='orange')color='alert-orange';
        else if(alert.type==='yellow')color='alert-yellow';
        return <div key={alert.id} className={'alert-flash '+color}>{alert.message}</div>;
      })}

      {/* Header */}
      <div className="hdr">
        <div className="hdr-l"><div className="logo">SENTINEL NOVA<span>GLOBAL SECURITY TERMINAL</span></div><span style={{font:'600 8px var(--mono)',color:'#30d158',padding:'2px 8px',borderRadius:2,border:'1px solid rgba(48,209,88,.4)',background:'rgba(48,209,88,.1)',letterSpacing:'1.5px',marginLeft:12}}>v2.1</span></div>
        <div className="hdr-r">
          {(function(){var crit=iranEvents.filter(function(e){return e.sev==='critical'}).length;var hi=iranEvents.filter(function(e){return e.sev==='high'}).length;var sc=Math.min(100,crit*15+hi*8+iranEvents.length*2);var cl=sc>=75?'#ff3b30':sc>=50?'#ff9500':sc>=25?'#ffd60a':'#30d158';var lb=sc>=75?'CRITICAL':sc>=50?'HIGH':sc>=25?'ELEVATED':'LOW';return <div className="hdr-spgi"><span style={{font:'600 9px var(--mono)',color:'var(--t2)'}}>MENA</span><span style={{font:'700 11px var(--mono)',color:cl}}>{lb}</span><div style={{width:40,height:6,background:'rgba(255,255,255,.12)',borderRadius:3,overflow:'hidden'}}><div style={{width:sc+'%',height:'100%',background:cl,borderRadius:3}}></div></div><span style={{font:'500 9px var(--mono)',color:cl}}>{sc}/100</span></div>})()}
          <span className="threat">⚠ {advStats.l4>0?'L4 ADVISORIES: '+advStats.l4:'THREAT LEVEL: ELEVATED'}</span>
          <span className="live" style={{flexShrink:0}}><span className="ldot"></span>LIVE</span>
          <span style={{whiteSpace:'nowrap',flexShrink:0,fontSize:10}}>{time.toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})}</span>
          <span style={{color:'var(--t3)',whiteSpace:'nowrap',flexShrink:0,fontSize:10}}>UTC {time.toISOString().slice(11,19)}</span>
          <button className="brief-btn" onClick={generateBrief} title="Download intelligence brief as .docx">BRIEF</button>
          <button className="theme-toggle" onClick={function(){setDarkMode(!darkMode);}} title={darkMode?'Light Mode':'Dark Mode'}>{darkMode?'☀':'☾'}</button>
        </div>
      </div>

      <div className="shell">
        {/* LEFT SIDEBAR */}
        <div className="sidebar">
          {/* TRAVEL ADVISORIES */}
          <div className="ph"><div className="pt">◆ Travel Advisories</div><span className="pb" style={{background:advLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:advLive?'var(--grn)':'var(--t3)'}}>{advLive?'● LIVE':'LOADING'}</span></div>
          {/* Summary bar */}
          {advLive&&<div style={{display:'flex',gap:0,borderBottom:'1px solid var(--bdr)'}}>
            {[[4,'#ff3b30','rgba(255,59,48,0.08)','L4',advStats.l4],[3,'#ff9500','rgba(255,149,0,0.06)','L3',advStats.l3],[2,'#ffd60a','rgba(255,214,10,0.05)','L2',advStats.l2]].map(function(item,idx){
              var lv=item[0],col=item[1],bg=item[2],label=item[3],count=item[4];
              var active=advFilter.has(lv);
              return <div key={lv} className={'adv-tog'+(active?' on':' off')} onClick={function(){setAdvFilter(function(prev){var next=new Set(prev);if(next.has(lv))next.delete(lv);else next.add(lv);return next;});}} style={{flex:1,padding:'8px 8px 10px',textAlign:'center',background:active?bg:'transparent',borderRight:idx<2?'1px solid var(--bdr)':'none',cursor:'pointer',color:col}}>
                <div style={{font:'700 18px var(--mono)',color:active?col:'var(--t3)'}}>{count}</div>
                <div style={{font:'600 7px var(--mono)',color:active?col:'var(--t3)',letterSpacing:'.5px',opacity:active?0.8:0.4}}>{label}</div>
                <div style={{font:'500 6px var(--mono)',color:active?col:'var(--t3)',marginTop:2,opacity:0.5}}>{active?'ON':'OFF'}</div>
              </div>;
            })}
          </div>}
          <div className="pbd" style={{padding:'6px 12px'}}>
            {advisories.length>0?advisories.filter(adv=>advFilter.has(adv.level)).map((adv,i)=>{
              const inner=<div key={i} style={{padding:'5px 0',borderBottom:i<advisories.length-1?'1px solid var(--bdr)':'none',overflow:'hidden'}}>
                <div style={{display:'flex',alignItems:'center',gap:5,marginBottom:2,overflow:'hidden'}}>
                  <span style={{font:'600 7px var(--mono)',color:ADV_COLORS[adv.level],padding:'1px 4px',borderRadius:2,background:ADV_COLORS[adv.level]+'18',border:'1px solid '+ADV_COLORS[adv.level]+'35',letterSpacing:'.5px',flexShrink:0,whiteSpace:'nowrap'}}>{ADV_SHORT[adv.level]||'L'+adv.level}</span>
                  <span style={{font:'400 8px var(--mono)',color:'var(--t3)',marginLeft:'auto',flexShrink:0}}>{adv.date?adv.date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):''}</span>
                </div>
                <div style={{font:'500 10px/1.3 Inter,sans-serif',color:'var(--t1)',cursor:adv.url?'pointer':'default'}}>{adv.country}{adv.url&&<span style={{color:'var(--t3)',fontSize:9,marginLeft:4}}>↗</span>}</div>
                {adv.desc&&<div style={{font:'400 9px/1.3 Inter,sans-serif',color:'var(--t3)',marginTop:1}}>{adv.desc.slice(0,70)}</div>}
              </div>;
              return adv.url?<a key={i} href={adv.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
            }):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading advisories...</div>}
          </div>

          {/* POLYMARKET — GEOPOLITICAL RISK */}
          <div className="ph"><div className="pt">◆ Polymarket Geopolitical Risk</div><span className="pb" style={{background:polyLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:polyLive?'var(--grn)':'var(--t3)'}}>{polyLive?'● LIVE':'LOADING'}</span></div>
          <div className="pbd" style={{padding:'6px 12px'}}>
            {polyMarkets.length>0?polyMarkets.map((m,i)=>{
              var pct=Math.round(m.yes*100);
              var barColor=pct>=60?'#ff3b30':pct>=35?'#ff9500':'#30d158';
              var inner=<div key={i} style={{padding:'6px 0',borderBottom:i<polyMarkets.length-1?'1px solid var(--bdr)':'none'}}>
                <div style={{font:'500 10px/1.3 Inter,sans-serif',color:'var(--t1)',marginBottom:4}}>{m.question}</div>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <div style={{flex:1,height:6,background:'var(--bg0)',borderRadius:3,overflow:'hidden'}}>
                    <div style={{width:pct+'%',height:'100%',background:barColor,borderRadius:3,transition:'width 1s ease'}}></div>
                  </div>
                  <span style={{font:'700 11px var(--mono)',color:barColor,minWidth:36,textAlign:'right'}}>{pct}%</span>
                  <span style={{font:'400 8px var(--mono)',color:'var(--t3)',minWidth:44,textAlign:'right'}}>{m.volume}</span>
                </div>
              </div>;
              var pmUrl='https://polymarket.com/search?query='+encodeURIComponent(m.question);
              return <a key={i} href={pmUrl} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>;
            }):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading markets...</div>}
          </div>
        </div>

        {/* CENTER */}
        <div className="center">
          {/* MAP */}
          <div style={{flex:'1 1 55%',minHeight:0,borderBottom:'1px solid var(--bdr)'}}>
            <div className="mwrap">
              <div id="leaflet-map"></div>
              <div className="mfilt" style={{zIndex:1000}}>
                {['ALL','CONFLICT','CLIMATE','CYBER','ENERGY','ECONOMIC'].map(f=>(
                  <button key={f} className={`mfb ${mf===f?'a':''}`} onClick={()=>setMf(f)}>{f}</button>
                ))}
              </div>
              <div className="map-search">
                <input type="text" placeholder="Search country..." onKeyDown={function(e){
                  if(e.key==='Enter'){
                    var query=e.target.value.trim().toLowerCase();
                    if(!query)return;
                    // Search in GeoJSON layer
                    var found=false;
                    if(geoLayerRef.current){
                      geoLayerRef.current.eachLayer(function(layer){
                        if(found)return;
                        var name=(layer.feature&&layer.feature.properties&&layer.feature.properties.name)||'';
                        if(name.toLowerCase().indexOf(query)!==-1){
                          found=true;
                          var bounds=layer.getBounds();
                          mapRef.current.flyToBounds(bounds,{padding:[50,50],duration:1.2});
                          var lv=getAdvLevel(name);
                          var center=bounds.getCenter();
                          setCountryBrief({name:name,level:lv,lat:center.lat,lon:center.lng});
                        }
                      });
                    }
                    // If not found in advisory countries, try geocoding via Nominatim
                    if(!found&&mapRef.current){
                      fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(e.target.value.trim())+'&limit=1')
                        .then(function(r){return r.json();})
                        .then(function(data){
                          if(data&&data[0]){
                            var lat=parseFloat(data[0].lat);
                            var lon=parseFloat(data[0].lon);
                            mapRef.current.flyTo([lat,lon],5,{duration:1.2});
                            setCountryBrief({name:data[0].display_name.split(',')[0],level:0,lat:lat,lon:lon});
                          }
                        }).catch(function(){});
                    }
                    e.target.value='';
                  }
                }}/>
              </div>
              <div className="mleg" style={{zIndex:1000}}>
                {Object.entries(CC).slice(0,6).map(([k,v])=><span key={k} className="ml"><span className="mld" style={{background:v}}></span>{k}</span>)}
              </div>
            </div>
          </div>

          {/* BOTTOM: Intel + Trends */}
          <div style={{flex:'1 1 45%',display:'grid',gridTemplateColumns:'1fr 1fr',overflow:'hidden'}}>
            {/* Intel Feed — live or fallback */}
            <div style={{overflow:'auto',borderRight:'1px solid var(--bdr)',display:'flex',flexDirection:'column'}}>
              <div className="ph">
                <div className="pt">◆ Intelligence Feed</div>
                <span className="pb" style={{background:feedStatus==='live'?'var(--grnbg)':'var(--redbg)',color:feedStatus==='live'?'var(--grn)':'var(--red)'}}>
                  {feedStatus==='live'?'● LIVE RSS':feedStatus==='loading'?'LOADING...':feedItems.length+' ACTIVE'}
                </span>
              </div>
              <div className="isrch">
                <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>🔍</span>
                <input
                  type="text"
                  placeholder="Search intel — e.g. Mexico cartel, Iran nuclear, bird flu..."
                  value={searchQuery}
                  onChange={e=>setSearchQuery(e.target.value)}
                  onKeyDown={e=>{if(e.key==='Enter')searchIntel(searchQuery);}}
                />
                <button onClick={()=>searchIntel(searchQuery)}>{searching?'SEARCHING...':'SEARCH'}</button>
                {searchResults.length>0&&<button className="clear" onClick={clearSearch}>✕ CLEAR</button>}
              </div>
              <div className="pbd" style={{flex:1,overflow:'auto'}}>
                {feedStatus==='live'?
                  liveNews.map(function(item,idx){
                    return <a key={idx} href={item.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                    <div className="fi">
                      <div className="fit">
                        <div className="fis" style={{background:SC[item.sv]}}/>
                        <span className="fitg" style={{background:(CC[item.cat]||'#999')+'20',color:CC[item.cat]||'#999',border:'1px solid '+(CC[item.cat]||'#999')+'40'}}>{item.cat}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.src}</span>
                        <span className="fitm">{item.tm}</span>
                      </div>
                      <div className="fitt" style={{cursor:'pointer'}}>{item.t} <span style={{color:'var(--t3)',fontSize:9}}>↗</span></div>
                    </div></a>;
                  })
                :
                  INCIDENTS.map(function(inc){
                    var q=encodeURIComponent(inc.t.split('—')[0].trim());
                    var url='https://news.google.com/search?q='+q;
                    return <a key={inc.id} href={url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                    <div className="fi">
                      <div className="fit">
                        <div className="fis" style={{background:SC[inc.sv]}}/>
                        <span className="fitg" style={{background:CC[inc.cat]+'20',color:CC[inc.cat],border:'1px solid '+CC[inc.cat]+'40'}}>{inc.cat}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{inc.reg}</span>
                        <span className="fitm">{inc.tm}</span>
                      </div>
                      <div className="fitt" style={{cursor:'pointer'}}>{inc.t} <span style={{color:'var(--t3)',fontSize:9}}>↗</span></div>
                      <div className="fisu">{inc.imp}</div>
                    </div></a>;
                  })
                }
              </div>
            </div>

            {/* Iran-U.S. War Tracker + Live Impact Split Panel */}
            <div style={{overflow:'hidden',display:'flex',flexDirection:'column'}}>
              {/* IRAN-U.S. ESCALATION TRACKER */}
              <div style={{flex:'1 1 55%',overflow:'auto',borderBottom:'1px solid var(--bdr)'}}>
                <div className="ph">
                  <div className="pt" style={{color:'#ff3b30'}}>◆ Iran-U.S. War Tracker</div>
                  <span className="pb" style={{background:iranLive?'var(--grnbg)':'var(--redbg)',color:iranLive?'var(--grn)':'var(--red)'}}>{iranLive?'● LIVE 60s':iranEvents.filter(e=>e.sev==='critical').length+' CRITICAL'}</span>
                </div>
                <div className="pbd" style={{padding:'6px 12px'}}>
                  {iranEvents.map((ev,i)=>{
                    const inner=<div key={i} style={{padding:'6px 0',borderBottom:i<iranEvents.length-1?'1px solid var(--bdr)':'none'}}>
                      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                        <span style={{fontSize:12}}>{ev.icon}</span>
                        <span style={{font:'600 8px var(--mono)',color:IRAN_SEV_COLORS[ev.sev],textTransform:'uppercase',letterSpacing:'.5px',padding:'1px 5px',borderRadius:2,background:IRAN_SEV_COLORS[ev.sev]+'18',border:'1px solid '+IRAN_SEV_COLORS[ev.sev]+'35'}}>{ev.sev}</span>
                        <span style={{font:'600 8px var(--mono)',color:IRAN_DOMAIN_COLORS[ev.domain]||'var(--t3)',letterSpacing:'.5px',padding:'1px 5px',borderRadius:2,background:(IRAN_DOMAIN_COLORS[ev.domain]||'#666')+'18',border:'1px solid '+(IRAN_DOMAIN_COLORS[ev.domain]||'#666')+'35'}}>{ev.domain}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{ev.time}</span>
                      </div>
                      <div style={{font:'500 11px/1.3 Inter,sans-serif',color:'var(--t1)'}}>{ev.title}</div>
                      <div style={{font:'400 10px Inter,sans-serif',color:'var(--t3)',marginTop:2}}>{ev.detail}</div>
                    </div>;
                    return ev.url?<a key={i} href={ev.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
                  })}
                </div>
              </div>

              {/* LIVE IMPACT — Travel, Airspace, Shipping, Energy */}
              <div style={{flex:'1 1 45%',overflow:'auto'}}>
                <div className="ph">
                  <div className="pt" style={{color:'#ff9500'}}>◆ Live Impact — Travel / Airspace / Shipping</div>
                  <span className="pb" style={{background:iranMilLive?'var(--grnbg)':'var(--redbg)',color:iranMilLive?'var(--grn)':'var(--red)'}}>{iranMilLive?'● LIVE 60s':'LOADING'}</span>
                </div>
                <div className="pbd" style={{padding:'6px 12px'}}>
                  {iranMilitary.map((imp,i)=>{
                    const inner=<div key={i} style={{padding:'6px 0',borderBottom:i<iranMilitary.length-1?'1px solid var(--bdr)':'none'}}>
                      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                        <span style={{fontSize:12}}>{imp.icon}</span>
                        <span style={{font:'600 8px var(--mono)',color:IRAN_DOMAIN_COLORS[imp.domain]||'#ff9500',textTransform:'uppercase',letterSpacing:'.5px',padding:'1px 5px',borderRadius:2,background:(IRAN_DOMAIN_COLORS[imp.domain]||'#ff9500')+'18',border:'1px solid '+(IRAN_DOMAIN_COLORS[imp.domain]||'#ff9500')+'35'}}>{imp.domain}</span>
                        <span style={{font:'600 8px var(--mono)',color:IRAN_SEV_COLORS[imp.sev],letterSpacing:'.3px'}}>{imp.sev.toUpperCase()}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{imp.time}</span>
                      </div>
                      <div style={{font:'500 10px/1.3 var(--mono)',color:'var(--t1)'}}>{imp.title}</div>
                      <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:2}}>{imp.detail}</div>
                    </div>;
                    return imp.url?<a key={i} href={imp.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* RIGHT PANEL */}
        <div className="rpanel">
          {/* MENA WAR ANALYSIS */}
          <div className="ph"><div className="pt">◆ MENA WAR ANALYSIS</div><span className="pb" style={{background:iranLive?'var(--redbg)':'rgba(102,102,102,.15)',color:iranLive?'var(--red)':'var(--t3)'}}>{iranLive?'● LIVE 60s':'LOADING'}</span></div>
          <div className="pbd" style={{padding:'8px 12px'}}>
            {/* Escalation Gauge */}
            {(function(){
              var crit=iranEvents.filter(function(e){return e.sev==='critical'}).length;
              var hi=iranEvents.filter(function(e){return e.sev==='high'}).length;
              var score=Math.min(100,crit*15+hi*8+iranEvents.length*2);
              var color=score>=75?'#ff3b30':score>=50?'#ff9500':score>=25?'#ffd60a':'#30d158';
              var label=score>=75?'CRITICAL':score>=50?'HIGH':score>=25?'ELEVATED':'LOW';
              return <div style={{marginBottom:10}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
                  <span style={{font:'600 10px var(--mono)',color:'var(--t2)'}}>ESCALATION INDEX</span>
                  <span style={{font:'700 13px var(--mono)',color:color}}>{score}/100 — {label}</span>
                </div>
                <div style={{height:6,background:'rgba(255,255,255,.08)',borderRadius:3,overflow:'hidden'}}>
                  <div style={{width:score+'%',height:'100%',background:'linear-gradient(90deg,'+color+','+color+'aa)',borderRadius:3,transition:'width 1s ease'}}></div>
                </div>
              </div>;
            })()}
            {/* Domain breakdown */}
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:6,marginBottom:10}}>
              {['MILITARY','NUCLEAR','PROXY','CYBER','DIPLOMACY','ENERGY'].map(function(dom){
                var ct=iranEvents.filter(function(e){return e.domain===dom}).length;
                return <div key={dom} style={{background:'rgba(255,255,255,.04)',border:'1px solid var(--bdr)',borderRadius:4,padding:'4px 6px',textAlign:'center'}}>
                  <div style={{font:'700 12px var(--mono)',color:IRAN_DOMAIN_COLORS[dom]||'#aaa'}}>{ct}</div>
                  <div style={{font:'500 7px var(--mono)',color:'var(--t3)',letterSpacing:'.5px'}}>{dom}</div>
                </div>;
              })}
            </div>
            {/* Key Flashpoints */}
            <div style={{font:'600 9px var(--mono)',color:'var(--t2)',letterSpacing:'.5px',marginBottom:4}}>KEY FLASHPOINTS</div>
            {iranEvents.filter(function(e){return e.sev==='critical'||e.sev==='high'}).slice(0,5).map(function(ev,i){
              return <div key={i} style={{padding:'4px 0',borderBottom:'1px solid var(--bdr)'}}>
                <div style={{display:'flex',alignItems:'center',gap:6}}>
                  <span style={{font:'400 11px',flexShrink:0}}>{ev.icon}</span>
                  <span style={{font:'600 8px var(--mono)',color:IRAN_SEV_COLORS[ev.sev],padding:'1px 5px',borderRadius:2,background:IRAN_SEV_COLORS[ev.sev]+'18',flexShrink:0}}>{ev.domain}</span>
                  <span style={{font:'500 9px/1.3 Inter,sans-serif',color:'var(--t1)',flex:1}}>{ev.title.length>65?ev.title.slice(0,65)+'…':ev.title}</span>
                </div>
                {ev.detail&&<div style={{font:'400 8px/1.3 Inter,sans-serif',color:'var(--t3)',marginTop:2,paddingLeft:20}}>{ev.detail.slice(0,100)}</div>}
              </div>;
            })}
          </div>

          {/* MENA CONFLICT WIRE */}
          <div className="ph" style={{marginTop:6}}><div className="pt">◆ MENA Conflict Wire</div><span className="pb" style={{background:iranLive?'var(--redbg)':'rgba(102,102,102,.15)',color:iranLive?'var(--red)':'var(--t3)'}}>{iranLive?'● LIVE':'FEED'}</span></div>
          <div className="pbd" style={{padding:'6px 12px',maxHeight:220,overflowY:'auto'}}>
            {iranEvents.slice(0,12).map(function(ev,i){
              return <div key={i} style={{padding:'4px 0',borderBottom:i<Math.min(iranEvents.length,12)-1?'1px solid var(--bdr)':'none'}}>
                <div style={{display:'flex',alignItems:'center',gap:5}}>
                  <span style={{font:'400 10px',flexShrink:0}}>{ev.icon}</span>
                  <span style={{font:'600 7px var(--mono)',color:IRAN_SEV_COLORS[ev.sev],padding:'1px 4px',borderRadius:2,background:IRAN_SEV_COLORS[ev.sev]+'15',flexShrink:0}}>{ev.sev.toUpperCase()}</span>
                  <span style={{font:'500 9px/1.3 Inter,sans-serif',color:'var(--t1)',flex:1}}>{ev.title}</span>
                </div>
                <div style={{display:'flex',justifyContent:'space-between',marginTop:2,paddingLeft:18}}>
                  <span style={{font:'400 8px var(--mono)',color:IRAN_DOMAIN_COLORS[ev.domain]||'var(--t3)'}}>{ev.domain}</span>
                  <span style={{font:'400 8px var(--mono)',color:'var(--t3)'}}>{ev.time||'Recent'}</span>
                </div>
              </div>;
            })}
          </div>

          {/* France 24 Live Stream */}
          <div className="ph" style={{marginTop:8}}><div className="pt">◆ France 24 Live</div><span className="pb" style={{background:'var(--redbg)',color:'var(--red)'}}>● LIVE 24/7</span></div>
          <div style={{padding:'0 12px 12px',background:'var(--card)',borderRadius:'0 0 6px 6px'}}>
            <iframe
              src="https://embed.france24.com/en/live"
              style={{width:'100%',height:180,border:'1px solid var(--bdr)',borderRadius:4,marginTop:6}}
              allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
              allowFullScreen
              title="France 24 English Live"
            ></iframe>
            <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:4,textAlign:'center'}}>France 24 English · 24/7 International News · Independent & Impartial</div>
          </div>
        </div>
      </div>

      {/* MENA War Ticker — Iran/MENA focused scrolling wire */}
      <div className="newstick">
        <span className="label">◆ MENA WIRE</span>
        <div className="nscroll">
          {iranEvents.length>0?
            [...iranEvents,...iranEvents].map(function(ev,i){return <span key={i} className="nitem">
              <span className="ndot" style={{background:IRAN_SEV_COLORS[ev.sev]||'#999'}}></span>
              <span style={{color:IRAN_DOMAIN_COLORS[ev.domain]||'#aaa',font:'600 8px var(--mono)',marginRight:4}}>{ev.domain}</span>
              {ev.title}
              <span className="nsrc">{ev.time||'Recent'}</span>
            </span>})
          :
            [...MENA_WIRE_FALLBACK,...MENA_WIRE_FALLBACK].map(function(ev,i){return <span key={i} className="nitem">
              <span className="ndot" style={{background:'#ff3b30'}}></span>
              <span style={{color:'#ff9500',font:'600 8px var(--mono)',marginRight:4}}>{ev.dom}</span>
              {ev.t}
              <span className="nsrc">{ev.src}</span>
            </span>})
          }
        </div>
      </div>

      {/* Tooltip */}
      {tt&&<div className="tt" style={{left:tt.x,top:tt.y}}>
        <h5 style={{color:SC[tt.i.sv]}}>{tt.i.cat} — {tt.i.sv.toUpperCase()}</h5>
        <p style={{color:'var(--t1)',fontWeight:500}}>{tt.i.t}</p>
        <p style={{marginTop:3}}>{tt.i.reg} · {tt.i.tm} ago</p>
        <p style={{marginTop:2,color:'var(--t2)'}}>{tt.i.imp}</p>
      </div>}

      {/* Country Brief Panel */}
      {countryBrief&&<div className="country-brief">
        <div className="country-brief-header">
          <div style={{display:'flex',alignItems:'center',gap:8,flex:1}}>
            <span className="country-brief-title">{countryBrief.name}</span>
            <span className="country-brief-level" style={{background:ADV_COLORS[countryBrief.level]+'18',border:'1px solid '+ADV_COLORS[countryBrief.level]+'35',color:ADV_COLORS[countryBrief.level]}}>L{countryBrief.level}</span>
          </div>
          <button className="country-brief-close" onClick={function(){setCountryBrief(null);}}>✕</button>
        </div>
        <div className="country-brief-content">
          {/* Advisory Description */}
          <div className="cb-section">
            <div className="cb-section-title">Travel Advisory</div>
            <div className="cb-desc">{ADV_LABELS[countryBrief.level]}</div>
            {advisories.find(a=>a.country===countryBrief.name)?.desc&&<div className="cb-item" style={{marginTop:6}}>{advisories.find(a=>a.country===countryBrief.name).desc}</div>}
            {countryBrief.level>0&&<a href={getAdvUrl(countryBrief.name)} target="_blank" rel="noopener" style={{display:'inline-block',marginTop:8,font:'500 9px var(--mono)',color:'#0a84ff',textDecoration:'none',padding:'3px 8px',border:'1px solid rgba(10,132,255,0.3)',borderRadius:3,background:'rgba(10,132,255,0.08)',letterSpacing:'.3px'}}>View State Dept Advisory ↗</a>}
          </div>

          {/* Iran / MENA Threat Items */}
          {iranEvents.filter(n=>(n.title||'').toLowerCase().includes(countryBrief.name.toLowerCase())||(n.detail||'').toLowerCase().includes(countryBrief.name.toLowerCase())).length>0&&<div className="cb-section">
            <div className="cb-section-title">Iran / MENA Threats</div>
            {iranEvents.filter(n=>(n.title||'').toLowerCase().includes(countryBrief.name.toLowerCase())||(n.detail||'').toLowerCase().includes(countryBrief.name.toLowerCase())).slice(0,4).map((n,i)=><div key={i} className="cb-item"><span style={{color:IRAN_SEV_COLORS[n.sev]||'#ccc',fontWeight:700}}>{n.icon} {n.domain}</span>: {n.title.slice(0,60)}</div>)}
          </div>}

          {/* Matching Headlines */}
          {(liveNews.length>0?liveNews:NEWS).filter(n=>(n.t||n.title||'').toLowerCase().includes(countryBrief.name.toLowerCase())||(n.reg||'').toLowerCase().includes(countryBrief.name.toLowerCase())).length>0&&<div className="cb-section">
            <div className="cb-section-title">Headlines</div>
            {(liveNews.length>0?liveNews:NEWS).filter(n=>(n.t||n.title||'').toLowerCase().includes(countryBrief.name.toLowerCase())||(n.reg||'').toLowerCase().includes(countryBrief.name.toLowerCase())).slice(0,3).map((n,i)=><div key={i} className="cb-item">{n.t||n.title}</div>)}
          </div>}

          {/* Matching Prediction Markets */}
          {polyMarkets.filter(m=>m.question.toLowerCase().includes(countryBrief.name.toLowerCase())).length>0&&<div className="cb-section">
            <div className="cb-section-title">Prediction Markets</div>
            {polyMarkets.filter(m=>m.question.toLowerCase().includes(countryBrief.name.toLowerCase())).slice(0,2).map((m,i)=><div key={i} className="cb-item"><span style={{color:Math.round(m.yes*100)>=50?'#ff3b30':'#30d158',fontWeight:700}}>{Math.round(m.yes*100)}%</span> — {m.question.slice(0,55)}</div>)}
          </div>}
        </div>
      </div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
