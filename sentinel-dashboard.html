<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SENTINEL NOVA â€” Global Security Terminal</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#000;color:#d4d4d4;overflow-x:hidden;font-size:12px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#000}::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
:root{--bg0:#000;--bg1:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--bdr:#222;--bdrh:#333;--amber:#ff9500;--amberd:#b36800;--amberbg:rgba(255,149,0,0.08);--red:#ff3b30;--redbg:rgba(255,59,48,0.1);--grn:#30d158;--grnbg:rgba(48,209,88,0.08);--blu:#0a84ff;--cyan:#64d2ff;--pur:#bf5af2;--yel:#ffd60a;--t1:#e5e5e5;--t2:#999;--t3:#666;--mono:'JetBrains Mono',monospace}

/* TICKER */
.ticker{background:#050505;border-bottom:1px solid var(--bdr);height:24px;overflow:hidden;display:flex;align-items:center}
.tscroll{display:flex;animation:tsc 60s linear infinite;white-space:nowrap}.tscroll:hover{animation-play-state:paused}
@keyframes tsc{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.tk{display:inline-flex;align-items:center;gap:5px;margin-right:28px;font:500 11px var(--mono);letter-spacing:.3px}
.tk .s{color:var(--t2)}.tk .p{color:var(--t1)}.tk .up{color:var(--grn);font-size:10px}.tk .dn{color:var(--red);font-size:10px}
.tsep{color:var(--bdr);margin-right:28px}

/* HEADER */
.hdr{background:var(--bg1);border-bottom:1px solid var(--bdr);padding:8px 16px;display:flex;align-items:center;justify-content:space-between}
.hdr-l{display:flex;align-items:center;gap:12px}
.logo{font:700 14px var(--mono);color:var(--red);letter-spacing:2px}
.logo span{color:var(--t3);font-weight:400;font-size:10px;letter-spacing:1px;margin-left:8px}
.hdr-r{display:flex;align-items:center;gap:20px;font:400 11px var(--mono);color:var(--t3)}
.live{display:flex;align-items:center;gap:5px}
.ldot{width:6px;height:6px;background:var(--grn);border-radius:50%;animation:bl 2s infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.3}}
.threat{padding:3px 10px;border-radius:3px;font:600 10px var(--mono);letter-spacing:1px;text-transform:uppercase;background:var(--redbg);color:var(--red);border:1px solid rgba(255,59,48,.3)}

/* LAYOUT */
.shell{display:grid;grid-template-columns:240px 1fr 280px;height:calc(100vh - 79px);overflow:hidden}
.sidebar{background:var(--bg1);border-right:1px solid var(--bdr);overflow-y:auto}
.center{display:flex;flex-direction:column;overflow:hidden}
.rpanel{background:var(--bg1);border-left:1px solid var(--bdr);overflow-y:auto}

/* PANELS */
.ph{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg2);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:2}
.pt{font:600 10px var(--mono);text-transform:uppercase;letter-spacing:1.5px;color:var(--red);display:flex;align-items:center;gap:6px}
.pb{font:500 9px var(--mono);padding:1px 6px;border-radius:2px;letter-spacing:.5px}
.pbd{padding:10px 12px}

/* RISK GAUGES */
.rg{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--bdr)}.rg:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.rg-t{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px}
.rg-l{font:500 11px/1 'Inter',sans-serif;color:var(--t2)}
.rg-v{font:700 16px var(--mono)}
.rg-b{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;margin-bottom:3px}
.rg-f{height:100%;border-radius:2px;transition:width 1s ease}
.rg-m{font:400 9px var(--mono);color:var(--t3);display:flex;justify-content:space-between}

/* MAP */
.mwrap{position:relative;width:100%;height:100%;min-height:300px;background:var(--bg0)}
.mwrap svg{width:100%;height:100%}
#leaflet-map{width:100%;height:100%;background:#000;z-index:0}
.leaflet-container{background:#000!important}
.leaflet-control-zoom{border:1px solid var(--bdr)!important;border-radius:3px!important}
.leaflet-control-zoom a{background:var(--bg2)!important;color:var(--t2)!important;border-color:var(--bdr)!important;width:26px!important;height:26px!important;line-height:26px!important;font-size:13px!important}
.leaflet-control-zoom a:hover{background:var(--bg3)!important;color:var(--t1)!important}
.leaflet-control-attribution{display:none!important}
.pulse-marker{border-radius:50%;animation:pmark 2s infinite}
@keyframes pmark{0%{box-shadow:0 0 0 0 rgba(255,59,48,.5)}70%{box-shadow:0 0 0 12px rgba(255,59,48,0)}100%{box-shadow:0 0 0 0 rgba(255,59,48,0)}}
.leaflet-popup-content-wrapper{background:var(--bg2)!important;color:var(--t1)!important;border:1px solid var(--bdrh)!important;border-radius:6px!important;box-shadow:0 4px 20px rgba(0,0,0,.6)!important;font-family:'Inter',sans-serif!important;font-size:11px!important}
.leaflet-popup-tip{background:var(--bg2)!important;border:1px solid var(--bdrh)!important}
.leaflet-popup-close-button{color:var(--t3)!important;font-size:16px!important}
.leaflet-popup-close-button:hover{color:var(--t1)!important}
.conn-arc{stroke-dasharray:6,4;animation:arcflow 3s linear infinite}
@keyframes arcflow{0%{stroke-dashoffset:0}100%{stroke-dashoffset:-30}}
.mfilt{position:absolute;top:8px;left:8px;display:flex;gap:4px;flex-wrap:wrap}
.mfb{font:500 9px var(--mono);padding:3px 8px;border-radius:2px;border:1px solid var(--bdr);background:var(--bg2);color:var(--t3);cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.5px}
.mfb:hover{border-color:var(--bdrh);color:var(--t2)}.mfb.a{background:var(--redbg);border-color:rgba(255,59,48,.4);color:var(--red)}
.mstat{position:absolute;top:8px;right:8px;display:flex;gap:6px}
.ms{background:rgba(0,0,0,.8);border:1px solid var(--bdr);border-radius:3px;padding:4px 8px;text-align:center}
.msv{font:700 14px var(--mono);display:block}.msl{font:400 8px var(--mono);color:var(--t3);text-transform:uppercase;letter-spacing:.5px}
.mleg{position:absolute;bottom:8px;left:8px;display:flex;gap:10px;font:400 9px var(--mono);color:var(--t3)}
.ml{display:flex;align-items:center;gap:3px}.mld{width:6px;height:6px;border-radius:50%}
.mpulse{animation:mp 2s infinite}@keyframes mp{0%{r:5;opacity:.9}50%{r:14;opacity:0}100%{r:5;opacity:0}}

/* CONNECTION LINES */
.conn-line{stroke-dasharray:4,3;animation:dash 20s linear infinite}
@keyframes dash{0%{stroke-dashoffset:0}100%{stroke-dashoffset:-200}}

/* NEWS TICKER */
.newstick{background:#050505;border-top:1px solid var(--bdr);height:22px;overflow:hidden;display:flex;align-items:center}
.newstick .label{font:600 9px var(--mono);color:var(--red);padding:0 10px;text-transform:uppercase;letter-spacing:1px;white-space:nowrap;border-right:1px solid var(--bdr);flex-shrink:0}
.nscroll{display:flex;animation:nsc 90s linear infinite;white-space:nowrap}.nscroll:hover{animation-play-state:paused}
@keyframes nsc{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.nitem{display:inline-flex;align-items:center;gap:6px;margin-right:40px;font:400 10px 'Inter',sans-serif;color:var(--t2)}
.nitem .ndot{width:4px;height:4px;border-radius:50%;flex-shrink:0}
.nitem .nsrc{font:400 9px var(--mono);color:var(--t3);margin-left:4px}

/* HEADER SPARKLINE */
.hdr-spgi{display:flex;align-items:center;gap:8px;padding:2px 10px;background:var(--bg2);border:1px solid var(--bdr);border-radius:3px}

/* INTEL FEED */
.fi{padding:8px 0;border-bottom:1px solid var(--bdr)}.fi:last-child{border-bottom:none}
.fi:hover{background:var(--bg2);margin:0 -12px;padding:8px 12px}
.fit{display:flex;align-items:center;gap:6px;margin-bottom:3px}
.fis{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.fitg{font:500 8px var(--mono);padding:1px 5px;border-radius:2px;text-transform:uppercase;letter-spacing:.5px}
.fitm{font:400 9px var(--mono);color:var(--t3);margin-left:auto}
.fitt{font:500 11px/1.4 'Inter',sans-serif;color:var(--t1)}
.fisu{font:400 10px 'Inter',sans-serif;color:var(--t3);margin-top:2px}

/* MARKET */
.mr{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(34,34,34,.5);font:400 11px var(--mono)}
.mr:last-child{border-bottom:none}
.mrs{color:var(--t1);font-weight:500;width:65px}.mrp{color:var(--t1);width:65px;text-align:right}.mrc{width:60px;text-align:right;font-size:10px}
.msec{padding:6px 12px;font:600 9px var(--mono);color:var(--red);letter-spacing:1.5px;text-transform:uppercase;background:var(--bg2);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:1}

/* CHART TABS */
.ctabs{display:flex;gap:4px;margin-bottom:8px}
.ct{font:500 9px var(--mono);padding:3px 8px;border-radius:2px;border:1px solid var(--bdr);background:transparent;color:var(--t3);cursor:pointer;letter-spacing:.5px;transition:all .15s}
.ct.a{background:var(--redbg);border-color:rgba(255,59,48,.4);color:var(--red)}.ct:hover{border-color:var(--bdrh)}

/* TOOLTIP */
.tt{position:fixed;background:var(--bg2);border:1px solid var(--bdrh);border-radius:4px;padding:8px 12px;z-index:200;pointer-events:none;max-width:280px;box-shadow:0 4px 20px rgba(0,0,0,.6)}
.tt h5{font:600 11px 'Inter',sans-serif;margin-bottom:3px}.tt p{font:400 10px 'Inter',sans-serif;color:var(--t2);line-height:1.4}

/* REGIONAL */
.rr{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--bdr);font:400 10px var(--mono)}
.rr:last-child{border-bottom:none}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useMemo}=React;

/* â•â•â• MINI SVG CHART COMPONENTS â•â•â• */
const Sparkline=({data,dataKey,w=200,h=60,color='#30d158',fill=true,showAxis=false})=>{
  const vals=data.map(d=>d[dataKey]);
  const mn=Math.min(...vals),mx=Math.max(...vals);
  const range=mx-mn||1;
  const pad=4;
  const pts=vals.map((v,i)=>{
    const x=pad+(i/(vals.length-1))*(w-pad*2);
    const y=pad+((mx-v)/range)*(h-pad*2);
    return `${x},${y}`;
  });
  const line=pts.join(' ');
  const areaPath=`M${pts[0]} L${line.replace(/,/g,' ').split(' L').join(' L')} L${pad+(vals.length-1)/(vals.length-1)*(w-pad*2)},${h} L${pad},${h} Z`;
  const polyline=pts.join(' ');
  const gradId='g'+Math.random().toString(36).slice(2,8);
  return(
    <svg width="100%" height={h} viewBox={`0 0 ${w} ${h}`} preserveAspectRatio="none">
      {fill&&<defs><linearGradient id={gradId} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={color} stopOpacity=".25"/><stop offset="100%" stopColor={color} stopOpacity="0"/></linearGradient></defs>}
      {fill&&<polygon points={`${pts[0]} ${polyline} ${pad+(vals.length-1)/(vals.length-1)*(w-pad*2)},${h-pad} ${pad},${h-pad}`} fill={`url(#${gradId})`}/>}
      <polyline points={polyline} fill="none" stroke={color} strokeWidth="1.5" strokeLinejoin="round" strokeLinecap="round"/>
    </svg>
  );
};

const AreaChartSVG=({data,keys,colors,w=400,h=180,labels})=>{
  const allVals=keys.flatMap(k=>data.map(d=>d[k]));
  const mx=Math.max(...allVals),mn=0;
  const range=mx-mn||1;
  const pad={t:10,r:10,b:24,l:32};
  const cw=w-pad.l-pad.r,ch=h-pad.t-pad.b;
  const toX=i=>pad.l+(i/(data.length-1))*cw;
  const toY=v=>pad.t+((mx-v)/range)*ch;
  return(
    <svg width="100%" viewBox={`0 0 ${w} ${h}`} style={{display:'block'}}>
      {/* grid */}
      {[0,.25,.5,.75,1].map((f,i)=>{
        const y=pad.t+f*ch;
        const v=Math.round(mx-(f*range));
        return <g key={i}><line x1={pad.l} y1={y} x2={w-pad.r} y2={y} stroke="#1a1a1a" strokeWidth=".5"/><text x={pad.l-4} y={y+3} fill="#666" fontSize="8" fontFamily="JetBrains Mono" textAnchor="end">{v}</text></g>;
      })}
      {/* x labels */}
      {data.map((d,i)=><text key={i} x={toX(i)} y={h-4} fill="#666" fontSize="8" fontFamily="JetBrains Mono" textAnchor="middle">{d.d||d.month||''}</text>)}
      {/* areas + lines */}
      {keys.map((k,ki)=>{
        const pts=data.map((d,i)=>`${toX(i)},${toY(d[k])}`).join(' ');
        const gid='ac'+ki+Math.random().toString(36).slice(2,6);
        return <g key={k}>
          <defs><linearGradient id={gid} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={colors[ki]} stopOpacity=".15"/><stop offset="100%" stopColor={colors[ki]} stopOpacity="0"/></linearGradient></defs>
          <polygon points={`${toX(0)},${toY(0)} ${pts} ${toX(data.length-1)},${toY(0)}`} fill={`url(#${gid})`}/>
          <polyline points={pts} fill="none" stroke={colors[ki]} strokeWidth="1.5" strokeLinejoin="round"/>
        </g>;
      })}
    </svg>
  );
};

/* â•â•â• DATA â•â•â• */
const TICKERS=[
  {s:'SPGI',p:'512.38',c:'+1.24%',u:true},{s:'ES1',p:'5,842',c:'+0.32%',u:true},{s:'NQ1',p:'20,815',c:'+0.48%',u:true},
  {s:'DXY',p:'104.12',c:'-0.18%',u:false},{s:'GC1',p:'2,938',c:'+0.85%',u:true},{s:'CL1',p:'78.62',c:'-1.23%',u:false},
  {s:'US10Y',p:'4.284',c:'+2bp',u:false},{s:'VIX',p:'16.82',c:'-3.41%',u:false},{s:'BTC',p:'97,245',c:'+2.14%',u:true},
  {s:'EUR',p:'1.0842',c:'+0.11%',u:true},{s:'GBP',p:'1.2668',c:'-0.07%',u:false},{s:'JPY',p:'152.34',c:'+0.23%',u:true},
  {s:'NG1',p:'3.42',c:'+4.12%',u:true},{s:'HG1',p:'4.28',c:'-0.56%',u:false},{s:'W1',p:'582.50',c:'+1.87%',u:true},
];

/* Advisory level colors & labels */
const ADV_COLORS={4:'#ff3b30',3:'#ff9500',2:'#ffd60a',1:'#30d158'};
const ADV_LABELS={4:'DO NOT TRAVEL',3:'RECONSIDER TRAVEL',2:'EXERCISE INCREASED CAUTION',1:'EXERCISE NORMAL PRECAUTIONS'};
const ADV_SHORT={4:'L4 â€” DNT',3:'L3 â€” RECONSIDER',2:'L2 â€” CAUTION',1:'L1 â€” NORMAL'};

/* Country risk rating RSS */
const RATING_RSS_QUERIES=[
  'sovereign+credit+rating+downgrade+upgrade+Moody+Fitch+%22S%26P%22',
  'country+rating+outlook+negative+positive+watch+sovereign',
];

/* Current fallback â€” Level 4 Do Not Travel (as of Feb 2026, State Dept) */
const ADV_FALLBACK=[
  {country:'Afghanistan',level:4,title:'Afghanistan â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/afghanistan-travel-advisory.html',desc:'Terrorism, wrongful detention, kidnapping'},
  {country:'Ukraine',level:4,title:'Ukraine â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/ukraine-travel-advisory.html',desc:'Armed conflict with Russia, civil unrest'},
  {country:'Russia',level:4,title:'Russia â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/russia-travel-advisory.html',desc:'Wrongful detention, harassment of US citizens'},
  {country:'Syria',level:4,title:'Syria â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/syria-travel-advisory.html',desc:'Terrorism, civil unrest, kidnapping'},
  {country:'Iran',level:4,title:'Iran â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iran-travel-advisory.html',desc:'Wrongful detention, terrorism, kidnapping'},
  {country:'Iraq',level:4,title:'Iraq â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/iraq-travel-advisory.html',desc:'Terrorism, kidnapping, armed conflict'},
  {country:'Yemen',level:4,title:'Yemen â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/yemen-travel-advisory.html',desc:'Civil unrest, terrorism, Houthi activity'},
  {country:'Somalia',level:4,title:'Somalia â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/somalia-travel-advisory.html',desc:'Terrorism, piracy, kidnapping'},
  {country:'Sudan',level:4,title:'Sudan â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/sudan-travel-advisory.html',desc:'Armed conflict, civil unrest, kidnapping'},
  {country:'South Sudan',level:4,title:'South Sudan â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/south-sudan-travel-advisory.html',desc:'Crime, kidnapping, armed conflict'},
  {country:'Libya',level:4,title:'Libya â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/libya-travel-advisory.html',desc:'Crime, terrorism, armed conflict'},
  {country:'Mali',level:4,title:'Mali â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/mali-travel-advisory.html',desc:'Crime, terrorism, kidnapping'},
  {country:'Haiti',level:4,title:'Haiti â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/haiti-travel-advisory.html',desc:'Kidnapping, gang violence, civil unrest'},
  {country:'North Korea',level:4,title:'North Korea â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/north-korea-travel-advisory.html',desc:'Wrongful detention, nuclear/missile threat'},
  {country:'Venezuela',level:4,title:'Venezuela â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/venezuela-travel-advisory.html',desc:'Crime, civil unrest, wrongful detention'},
  {country:'Myanmar (Burma)',level:4,title:'Myanmar â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burma-travel-advisory.html',desc:'Civil unrest, armed conflict'},
  {country:'Burkina Faso',level:4,title:'Burkina Faso â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/burkina-faso-travel-advisory.html',desc:'Terrorism, crime, kidnapping'},
  {country:'Niger',level:4,title:'Niger â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/niger-travel-advisory.html',desc:'Terrorism, kidnapping'},
  {country:'Central African Republic',level:4,title:'CAR â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/central-african-republic-travel-advisory.html',desc:'Crime, civil unrest, kidnapping'},
  {country:'Belarus',level:4,title:'Belarus â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/belarus-travel-advisory.html',desc:'Wrongful detention, Russia-Ukraine spillover'},
  {country:'Lebanon',level:4,title:'Lebanon â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/lebanon-travel-advisory.html',desc:'Crime, terrorism, Hezbollah activity'},
  {country:'Gaza Strip',level:4,title:'Gaza â€” Level 4: Do Not Travel',date:new Date('2026-01-09'),url:'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/israel-the-west-bank-and-gaza-travel-advisory.html',desc:'Armed conflict, terrorism'},
];

/* Current fallback sovereign rating changes */
const RATING_FALLBACK=[
  {headline:'Moody\'s Downgrades US to Aa1 â€” Last AAA Rating Lost by Any Major Agency',src:'Moody\'s',agency:'Moody\'s',direction:'downgrade',color:'#ff3b30',time:'May 2025',url:'https://www.moodys.com/web/en/us/about-us/usrating.html'},
  {headline:'Fitch Downgrades China to A from A+ â€” Debt Trajectory & Tariff Impact',src:'Fitch Ratings',agency:'Fitch',direction:'downgrade',color:'#ff3b30',time:'Apr 2025',url:'https://www.fitchratings.com'},
  {headline:'S&P Downgrades France to A+ from AA- â€” Unscheduled Move on Budget Risk',src:'S&P Global',agency:'S&P',direction:'downgrade',color:'#ff3b30',time:'Oct 2025',url:'https://www.spglobal.com/ratings'},
  {headline:'Moody\'s France Outlook Cut to Negative â€” Political Fragmentation Risk',src:'Moody\'s',agency:'Moody\'s',direction:'downgrade',color:'#ff3b30',time:'Oct 2025',url:'https://ratings.moodys.com/ratings-news/453186'},
  {headline:'Moody\'s Downgrades Botswana to Baa1 â€” Diamond Downturn & Rising Debt',src:'Moody\'s',agency:'Moody\'s',direction:'downgrade',color:'#ff3b30',time:'Oct 2025',url:'https://www.moodys.com'},
  {headline:'Moody\'s Upgrades Israel Outlook to Stable from Negative â€” Ceasefire Effect',src:'Moody\'s',agency:'Moody\'s',direction:'upgrade',color:'#30d158',time:'Jan 2026',url:'https://ratings.moodys.com/ratings-news/429502'},
  {headline:'S&P Upgrades South Africa to BB â€” First Upgrade in Nearly Two Decades',src:'S&P Global',agency:'S&P',direction:'upgrade',color:'#30d158',time:'Nov 2025',url:'https://www.spglobal.com/ratings'},
  {headline:'NATO Rearmament Spending May Pressure European Sovereign Ratings in 2026',src:'Moody\'s',agency:'Moody\'s',direction:'watch',color:'#ffd60a',time:'Feb 2026',url:'https://www.moodys.com/web/en/us/insights/credit-risk/outlooks/global-sovereigns-2026.html'},
];

const INCIDENTS=[
  {id:1,t:'Russian Naval Buildup in Black Sea â€” NATO Alert Level Raised',sv:'critical',cat:'CONFLICT',reg:'E. Europe',tm:'12m',lat:44,lon:34,imp:'NATO Article 5 consultation triggered',ty:'Military'},
  {id:2,t:'Cat-5 Cyclone Bearing Down on Bay of Bengal â€” 2.4M at Risk',sv:'critical',cat:'CLIMATE',reg:'S. Asia',tm:'28m',lat:16,lon:87,imp:'$8.2B estimated damage',ty:'Weather'},
  {id:3,t:'Major Ransomware Attack on European Energy Grid Operator',sv:'critical',cat:'CYBER',reg:'W. Europe',tm:'1h',lat:50,lon:8,imp:'3 nations, grid at 60%',ty:'Cyber'},
  {id:4,t:'Taiwan Strait â€” PLA Air Incursions Reach 52 Sorties in 24h',sv:'critical',cat:'CONFLICT',reg:'E. Asia',tm:'2h',lat:24,lon:121,imp:'Semiconductor supply risk',ty:'Military'},
  {id:5,t:'Strait of Hormuz â€” Tanker Seized by IRGC Navy',sv:'critical',cat:'ENERGY',reg:'M. East',tm:'3h',lat:26.5,lon:56,imp:'Oil +4.2%, $2.1B/day trade risk',ty:'Maritime'},
  {id:6,t:'Sahel Region â€” Wagner Group Expands Into 3 New Countries',sv:'high',cat:'CONFLICT',reg:'W. Africa',tm:'4h',lat:14,lon:-2,imp:'Democratic transitions destabilized',ty:'Military'},
  {id:7,t:'Mediterranean Wildfire Season â€” 340K Ha Across 5 Nations',sv:'high',cat:'CLIMATE',reg:'S. Europe',tm:'5h',lat:38,lon:23,imp:'$3.1B economic impact',ty:'Wildfire'},
  {id:8,t:'North Korea ICBM Test â€” Trajectory Over Sea of Japan',sv:'critical',cat:'CONFLICT',reg:'E. Asia',tm:'6h',lat:39,lon:127,imp:'UN emergency session called',ty:'WMD'},
  {id:9,t:'Amazon Deforestation Surge â€” 40% Above 5-Year Average',sv:'high',cat:'CLIMATE',reg:'S. America',tm:'6h',lat:-5,lon:-60,imp:'Carbon sink -12%',ty:'Deforestation'},
  {id:10,t:'US-China Semiconductor Export Controls Expanded',sv:'high',cat:'ECONOMIC',reg:'Global',tm:'8h',lat:39,lon:-77,imp:'$45B bilateral trade affected',ty:'Trade'},
  {id:11,t:'Arctic Permafrost Methane Release Exceeds Models by 40%',sv:'high',cat:'CLIMATE',reg:'Arctic',tm:'10h',lat:72,lon:125,imp:'Tipping point risk elevated',ty:'Emissions'},
  {id:12,t:'Sudan Civil Conflict â€” 2M New Displacements',sv:'high',cat:'CONFLICT',reg:'E. Africa',tm:'12h',lat:15,lon:32,imp:'Humanitarian crisis, spillover',ty:'Civil War'},
  {id:13,t:'EU Carbon Border Tax Phase 2 â€” 8 Sectors Added',sv:'medium',cat:'REGULATORY',reg:'Europe',tm:'1d',lat:50,lon:4,imp:'â‚¬45B cross-border trade',ty:'Regulatory'},
  {id:14,t:'India-Pakistan Indus Treaty Renegotiation Stalls',sv:'high',cat:'CONFLICT',reg:'S. Asia',tm:'1d',lat:30,lon:72,imp:'300M affected, agriculture risk',ty:'Water'},
  {id:15,t:'Pacific Islands Climate Emergency â€” Sea Level +18cm',sv:'high',cat:'CLIMATE',reg:'Oceania',tm:'1d',lat:-8,lon:160,imp:'$420M relocation costs',ty:'Sea Level'},
  {id:16,t:'Venezuelan Migration Crisis â€” 800K Cross to Colombia',sv:'medium',cat:'SOCIAL',reg:'S. America',tm:'1d',lat:7,lon:-72,imp:'$1.2B aid needed',ty:'Migration'},
  {id:17,t:'Chinese Spy Balloon Incursions â€” 3 Nations Report',sv:'medium',cat:'INTEL',reg:'Global',tm:'2d',lat:45,lon:-100,imp:'Sovereignty concern',ty:'Espionage'},
  {id:18,t:'Gulf of Guinea Piracy â€” 12 Incidents in 30 Days',sv:'medium',cat:'MARITIME',reg:'W. Africa',tm:'2d',lat:4,lon:3,imp:'$800M insurance spike',ty:'Maritime'},
];

const CC={CONFLICT:'#ff3b30',CLIMATE:'#ff9500',CYBER:'#bf5af2',ECONOMIC:'#0a84ff',ENERGY:'#ffd60a',REGULATORY:'#64d2ff',SOCIAL:'#30d158',INTEL:'#ff375f',MARITIME:'#5ac8fa',HEALTH:'#30d158'};
const SC={critical:'#ff3b30',high:'#ff9500',medium:'#ffd60a',low:'#30d158'};

/* Connection lines between related incidents [fromId, toId, label, color] */
const CONNS=[
  [5,1,'Energy supply chain disruption','#ffd60a'],   // Hormuz â†’ Black Sea
  [4,8,'East Asia escalation corridor','#ff3b30'],     // Taiwan â†’ DPRK
  [1,3,'Hybrid warfare vector','#bf5af2'],             // Black Sea â†’ Cyber EU
  [10,4,'Trade decoupling','#0a84ff'],                 // US-China â†’ Taiwan
  [5,14,'Water-energy nexus','#64d2ff'],               // Hormuz â†’ Indus
  [6,12,'Sahel-Sudan conflict arc','#ff3b30'],         // Sahel â†’ Sudan
];

/* News headlines for live ticker */
const NEWS=[
  {t:'NATO deploys additional carrier group to Eastern Mediterranean amid rising tensions',s:'Reuters',c:'#ff3b30'},
  {t:'Global reinsurance rates surge 18% on back of record climate losses',s:'FT',c:'#ff9500'},
  {t:'CISA warns of critical infrastructure vulnerability in energy sector SCADA systems',s:'CyberScoop',c:'#bf5af2'},
  {t:'World Bank revises global GDP growth forecast down to 2.4% citing geopolitical risk',s:'Bloomberg',c:'#0a84ff'},
  {t:'China conducts live-fire naval exercises in South China Sea for third consecutive week',s:'SCMP',c:'#ff3b30'},
  {t:'European gas storage levels fall below 5-year average ahead of winter season',s:'Platts',c:'#ffd60a'},
  {t:'UN Security Council emergency session on Sahel security deterioration',s:'AP',c:'#ff3b30'},
  {t:'IMF warns sovereign debt risks compounding climate vulnerability in 40 nations',s:'FT',c:'#ff9500'},
  {t:'US Treasury sanctions 12 entities linked to ransomware-as-a-service operations',s:'WSJ',c:'#bf5af2'},
  {t:'Arctic shipping routes see 300% increase in commercial traffic year-over-year',s:'Reuters',c:'#64d2ff'},
  {t:'OPEC+ signals potential output cut extension as demand outlook weakens',s:'Bloomberg',c:'#ffd60a'},
  {t:'S&P Global upgrades defense sector outlook to positive on sustained spending growth',s:'S&P Global',c:'#30d158'},
];

const MKTS={
  'COMMODITIES':[{s:'GC1',n:'Gold',p:'2,938',c:'+0.85%',u:1},{s:'CL1',n:'WTI Crude',p:'78.62',c:'-1.23%',u:0},{s:'NG1',n:'Nat Gas',p:'3.42',c:'+4.12%',u:1},{s:'HG1',n:'Copper',p:'4.28',c:'-0.56%',u:0},{s:'W1',n:'Wheat',p:'582.50',c:'+1.87%',u:1}],
  'FX & RATES':[{s:'DXY',n:'Dollar Idx',p:'104.12',c:'-0.18%',u:0},{s:'EUR',n:'EUR/USD',p:'1.0842',c:'+0.11%',u:1},{s:'US10Y',n:'10Y Yield',p:'4.284%',c:'+2bp',u:0},{s:'US2Y',n:'2Y Yield',p:'4.612%',c:'+1bp',u:0}],
  'CRYPTO':[{s:'BTC',n:'Bitcoin',p:'97,245',c:'+2.14%',u:1},{s:'ETH',n:'Ethereum',p:'3,284',c:'+1.56%',u:1}],
  'DEFENSE & INTEL':[{s:'SPGI',n:'S&P Global',p:'512.38',c:'+1.24%',u:1},{s:'LMT',n:'Lockheed',p:'458.92',c:'+2.34%',u:1},{s:'RTX',n:'RTX Corp',p:'98.45',c:'+1.82%',u:1},{s:'NOC',n:'Northrop',p:'512.10',c:'+1.45%',u:1},{s:'PLTR',n:'Palantir',p:'78.22',c:'+3.21%',u:1}],
};

/* SPGI RSS feed queries */
const SPGI_RSS_QUERIES=[
  '%22S%26P+Global%22+SPGI+earnings+revenue',
  '%22S%26P+Global%22+ratings+credit+Platts',
];

/* Current SPGI news fallback (Feb 2026) */
const SPGI_NEWS_FALLBACK=[
  {t:'S&P Global Reports Q4 & Full-Year 2025 Results â€” Revenue Up 9% to $3.92B',src:'S&P Global IR',tm:'Feb 10',url:'https://investor.spglobal.com/news-releases/news-details/2026/SP-Global-Reports-Fourth-Quarter-and-Full-Year-2025-Results/default.aspx'},
  {t:'SPGI Stock Drops 17% Premarket After 2026 Guidance Disappoints Analysts',src:'Seeking Alpha',tm:'Feb 10',url:'https://seekingalpha.com/news/4549419-sp-global-stock-drops-after-q4-earnings-2026-guidance-disappoint'},
  {t:'SPGI Up 7.3% â€” Strong 2025 Results and New Climate-Risk Data Push',src:'Simply Wall St',tm:'Feb 14',url:'https://simplywall.st/stocks/us/diversified-financials/nyse-spgi/sp-global/news/why-sp-global-spgi-is-up-73-after-strong-2025-results-and-ne'},
  {t:'S&P Global Ratings Wins Ratings Provider of the Year â€” PE Wire Europe Awards',src:'PE Wire',tm:'Feb 12',url:'https://www.stocktitan.net/news/SPGI/s-p-global-ratings-wins-ratings-provider-of-the-year-at-private-g48vy8gp0m8s.html'},
  {t:'S&P Global to Present at Raymond James 47th Institutional Investors Conference',src:'Stock Titan',tm:'Feb 18',url:'https://www.stocktitan.net/news/SPGI/s-p-global-to-present-at-raymond-james-47th-annual-institutional-dsjn8x6nn5cs.html'},
  {t:'S&P Global Energy & Verisk Launch Climate-Risk Data Collaboration for Banks & Insurers',src:'S&P Global',tm:'Feb 2026',url:'https://press.spglobal.com'},
  {t:'Full-Year 2025: Revenue $15.3B (+8%), Adjusted EPS $17.83 (+14%), $12.85B Buyback Complete',src:'S&P Global IR',tm:'Feb 10',url:'https://press.spglobal.com/2026-02-10-S-P-Global-Reports-Fourth-Quarter-and-Full-Year-2025-Results'},
  {t:'2026 Guidance: Reported Revenue Growth 6.6%-8.6%, New CERAWeek Energy Conference Role',src:'S&P Global',tm:'Feb 10',url:'https://investor.spglobal.com'},
];

const TREND={
  '1M':[{d:'W1',geo:72,clim:65,cyb:61,con:74},{d:'W2',geo:74,clim:67,cyb:63,con:76},{d:'W3',geo:75,clim:69,cyb:62,con:79},{d:'W4',geo:78,clim:72,cyb:65,con:83}],
  '6M':[{d:'Sep',geo:68,clim:58,cyb:55,con:65},{d:'Oct',geo:70,clim:62,cyb:58,con:70},{d:'Nov',geo:72,clim:64,cyb:60,con:73},{d:'Dec',geo:74,clim:66,cyb:62,con:76},{d:'Jan',geo:76,clim:70,cyb:64,con:80},{d:'Feb',geo:78,clim:72,cyb:65,con:83}],
  '1Y':[{d:'Mar',geo:60,clim:48,cyb:50,con:55},{d:'May',geo:62,clim:52,cyb:52,con:58},{d:'Jul',geo:65,clim:55,cyb:54,con:62},{d:'Sep',geo:68,clim:58,cyb:55,con:65},{d:'Nov',geo:72,clim:64,cyb:60,con:73},{d:'Feb',geo:78,clim:72,cyb:65,con:83}],
};

const SPGI=[{t:'09:30',p:508.2},{t:'10:00',p:509.5},{t:'10:30',p:510.1},{t:'11:00',p:509.8},{t:'11:30',p:511.2},{t:'12:00',p:510.6},{t:'12:30',p:511.8},{t:'13:00',p:512.5},{t:'13:30',p:511.9},{t:'14:00',p:512.8},{t:'14:30',p:513.1},{t:'15:00',p:512.4},{t:'15:30',p:512.0},{t:'16:00',p:512.38}];

/* (Regional risk now computed from live advisories) */

/* â•â•â• RSS FEED CONFIG â•â•â• */
const RSS_FEEDS=[
  // Conflict & military
  {q:'Russia+Ukraine+war+military+frontline',cat:'CONFLICT'},
  {q:'Iran+US+tensions+military+strikes+nuclear',cat:'CONFLICT'},
  {q:'China+Taiwan+military+South+China+Sea',cat:'CONFLICT'},
  {q:'Israel+Gaza+Hamas+Hezbollah+Middle+East+war',cat:'CONFLICT'},
  {q:'NATO+military+defense+troops+deployment',cat:'CONFLICT'},
  {q:'North+Korea+missile+nuclear+ICBM',cat:'CONFLICT'},
  // Climate & disasters
  {q:'climate+disaster+extreme+weather+hurricane+wildfire',cat:'CLIMATE'},
  // Cyber
  {q:'cybersecurity+ransomware+hack+breach+critical+infrastructure',cat:'CYBER'},
  // Economic & sanctions
  {q:'global+economy+sanctions+trade+war+tariff+recession',cat:'ECONOMIC'},
  {q:'US+China+trade+decoupling+semiconductor+sanctions',cat:'ECONOMIC'},
  // Energy
  {q:'oil+energy+crisis+OPEC+pipeline+gas+prices',cat:'ENERGY'},
  // Health / Pandemic
  {q:'pandemic+virus+outbreak+WHO+bird+flu+H5N1+epidemic',cat:'HEALTH'},
  // Terrorism & intel
  {q:'terrorism+intelligence+ISIS+security+threat+espionage',cat:'INTEL'},
];
const PROXY='https://api.rss2json.com/v1/api.json?rss_url=';
const catKeywords={
  CONFLICT:['war','military','nato','conflict','troops','missile','attack','invasion','defense','army','weapon','strike','ukraine','russia','frontline','battalion','airstrike','drone strike','ceasefire','escalation','iran','hezbollah','hamas','gaza','israel','taiwan','korea','artillery','casualties'],
  CLIMATE:['climate','flood','wildfire','hurricane','drought','emissions','carbon','warming','sea level','storm','heat','ice','snow','blizzard','cyclone','typhoon','earthquake','tornado','fire','weather'],
  CYBER:['cyber','ransomware','hack','breach','malware','vulnerability','phishing','data leak','cisa','zero-day','ddos','spyware','critical infrastructure'],
  ECONOMIC:['economy','gdp','trade','tariff','inflation','recession','debt','imf','world bank','fiscal','monetary','sanctions','decoupling','semiconductor','stock market','currency','default'],
  ENERGY:['oil','gas','opec','energy','pipeline','refinery','nuclear','solar','wind','grid','fuel','petroleum','lng','electricity','power plant','crude'],
  HEALTH:['pandemic','epidemic','virus','outbreak','who','h5n1','bird flu','covid','disease','vaccine','pathogen','quarantine','health emergency','mpox','ebola'],
  INTEL:['intelligence','espionage','spy','terrorism','isis','al-qaeda','cia','fbi','mi6','surveillance','threat assessment','counterterrorism','mossad'],
  REGULATORY:['regulation','eu','law','compliance','legislation','tax','ban','policy','mandate','rule'],
};
function classifyHeadline(title){
  const t=title.toLowerCase();
  let best='CONFLICT',score=0;
  for(const[cat,kws]of Object.entries(catKeywords)){
    const s=kws.filter(k=>t.includes(k)).length;
    if(s>score){score=s;best=cat;}
  }
  return best;
}
function timeAgo(dateStr){
  const d=new Date(dateStr);const now=new Date();const mins=Math.floor((now-d)/60000);
  if(mins<60)return mins+'m ago';
  const hrs=Math.floor(mins/60);if(hrs<24)return hrs+'h ago';
  return Math.floor(hrs/24)+'d ago';
}

/* â•â•â• WEATHER ALERTS (current real events â€” Feb 23, 2026) â•â•â• */
const WEATHER_FALLBACK=[
  {sev:'extreme',type:'Blizzard',title:'BLIZZARD OF 2026 â€” Historic Nor\'easter Battering Northeast US',detail:'2ft+ snow across I-95 corridor. Winds 40-70mph with 84mph gusts at Montauk. 8,000+ flights cancelled. 22,000+ delayed. States of emergency in NY, NJ, New England.',time:'NOW',icon:'â„ï¸',url:'https://en.wikipedia.org/wiki/February_2026_North_American_blizzard'},
  {sev:'extreme',type:'Blizzard',title:'NYC/NJ â€” Whiteout Conditions, Travel Ban, NJ Transit Suspended',detail:'First blizzard warning for NYC since 2017. Freehold NJ 2ft+. Statewide travel ban. NJ Governor: biggest storm in nearly 30 years. 12 FEMA emergency declarations approved.',time:'NOW',icon:'â„ï¸',url:'https://www.fema.gov/disaster/2026-winter-storm'},
  {sev:'extreme',type:'Blizzard',title:'Boston/New England â€” 4in/hr Snow Rates, 83mph Gusts Nantucket',detail:'Swansea & New Bedford 2ft+. First blizzard warning in 4 years for southern New England. National Guard activated across 22 NY counties.',time:'NOW',icon:'â„ï¸',url:'https://www.weather.gov/media/phi/current_briefing.pdf'},
  {sev:'severe',type:'Polar Vortex',title:'Polar Vortex Locked Over Eastern US â€” Frigid Pattern Through Feb',detail:'Monthly temperatures well below historical average. Frequent arctic outbreaks. Pattern trending stormier across Plains, Mississippi Valley, Appalachians, Atlantic Seaboard.',time:'Ongoing',icon:'ðŸ¥¶',url:'https://www.accuweather.com/en/winter-weather/polar-vortex-to-keep-frigid-pattern-locked-over-eastern-us-through-much-of-february/1858892'},
  {sev:'severe',type:'Cyclone',title:'Tropical Cyclone Gezani â€” Madagascar Devastated, Mozambique Flooding',detail:'175 km/h winds. Central Madagascar hit hard. 25,000+ houses destroyed. Flooding continues in southern Mozambique & Malawi.',time:'Feb 10',icon:'ðŸŒ€',url:'https://fews.net/global/global-weather-hazards/february-2026-1'},
  {sev:'severe',type:'Flooding',title:'Persistent Flooding â€” Colombia, Mozambique, Malawi, Costa Rica',detail:'La NiÃ±a-driven. Heavy above-average rainfall. Landslides in western Colombia. Eastern Southern Africa flooding ongoing. Costa Rica landslides.',time:'Ongoing',icon:'ðŸŒŠ',url:'https://fews.net/global/global-weather-hazards/february-2026-1'},
  {sev:'moderate',type:'Drought',title:'Drought Emergency â€” Angola, DRC, Central Asia',detail:'Rainfall deficit since October. Western/central Angola intensifying. Central DRC abnormal dryness. Drought warnings in Kyrgyzstan, Tajikistan, Afghanistan, Turkmenistan.',time:'Ongoing',icon:'â˜€ï¸',url:'https://fews.net/global/global-weather-hazards/february-2026-1'},
  {sev:'severe',type:'Heat',title:'Desert Southwest US â€” Record-Breaking Heat, 90sÂ°F in February',detail:'Ridging aloft brings well above-normal temps. Potential record highs across Desert Southwest. Stark contrast to frozen East.',time:'This Week',icon:'ðŸ”¥',url:'https://www.spc.noaa.gov/products/outlook/day1otlk.html'},
  {sev:'severe',type:'Winter Storm',title:'Jan 22-27 Storm Aftermath â€” 171 Deaths, $13-15B Damage, FEMA Aid',detail:'Deadliest North American winter storm since Uri. First billion-dollar disaster of 2026. FEMA disaster assistance approved for multiple states.',time:'Jan 2026',icon:'â„ï¸',url:'https://www.fema.gov/disaster/2026-winter-storm'},
  {sev:'watch',type:'Outlook',title:'Next Storm Threat Feb 26 â€” Heavy Rain & Potential Winter Weather East',detail:'Shortwave energy pushing low pressure across East. Heavy rain/thunderstorms Tennessee/Ohio Valleys. Winter weather potential for Northeast.',time:'Feb 26',icon:'âš ï¸',url:'https://www.noaa.gov/weather-prediction-center'},
];

const NOTAM_FALLBACK=[
  {id:'A0847/26',zone:'UKBV â€” Ukraine/Black Sea',status:'PROHIBITED',detail:'All flight levels. Conflict zone. Indefinite.',color:'#ff3b30',time:'Active'},
  {id:'A1204/26',zone:'OIIX â€” Iran Western FIR',status:'RESTRICTED',detail:'FL250+. Military activity. Strait of Hormuz approaches.',color:'#ff9500',time:'Active'},
  {id:'A0923/26',zone:'RCTP â€” Taiwan Strait',status:'WARNING',detail:'GPS jamming reported. Military exercises. NOTAM renewed daily.',color:'#ff9500',time:'4h ago'},
  {id:'A0561/26',zone:'HSSS â€” Sudan FIR',status:'PROHIBITED',detail:'All altitudes Khartoum TMA. Armed conflict.',color:'#ff3b30',time:'Active'},
  {id:'V0112/26',zone:'BIRK â€” Iceland/Reykjanes',status:'WARNING',detail:'Volcanic ash advisory. FL050-FL200. Eruption ongoing.',color:'#ffd60a',time:'6h ago'},
  {id:'A0445/26',zone:'ZMUB â€” Mongolia Northern',status:'WARNING',detail:'GPS interference. Military source. FL100+.',color:'#ffd60a',time:'12h ago'},
  {id:'A0789/26',zone:'OEJD â€” Saudi/Yemen Border',status:'RESTRICTED',detail:'FL0-FL260. Military operations. Houthi drone threat.',color:'#ff9500',time:'Active'},
  {id:'A0334/26',zone:'DGAA â€” Sahel Region',status:'WARNING',detail:'Security risk below FL250. Multiple nations.',color:'#ffd60a',time:'1d ago'},
];

const WX_SEV_COLORS={extreme:'#ff3b30',severe:'#ff9500',moderate:'#ffd60a',watch:'#64d2ff'};
const NOTAM_STATUS_COLORS={PROHIBITED:'#ff3b30',RESTRICTED:'#ff9500',WARNING:'#ffd60a'};

/* â•â•â• APP â•â•â• */
function App(){
  const[time,setTime]=useState(new Date());
  const[mf,setMf]=useState('ALL');
  const[tt,setTt]=useState(null);
  const[tp,setTp]=useState('6M');
  const[liveNews,setLiveNews]=useState([]);
  const[feedStatus,setFeedStatus]=useState('loading');
  const[wxAlerts,setWxAlerts]=useState(WEATHER_FALLBACK);
  const[notams,setNotams]=useState(NOTAM_FALLBACK);
  const[wxLive,setWxLive]=useState(false);
  const[spgiNews,setSpgiNews]=useState([]);
  const[spgiNewsLive,setSpgiNewsLive]=useState(false);
  const[advisories,setAdvisories]=useState([]);
  const[advLive,setAdvLive]=useState(false);
  const[ratings,setRatings]=useState([]);
  const[ratingsLive,setRatingsLive]=useState(false);

  // Fetch US State Dept Travel Advisories
  const fetchAdvisories=async()=>{
    // Load fallback immediately so panel is never empty
    if(advisories.length===0){setAdvisories(ADV_FALLBACK);setAdvLive(true);}
    // Try State Dept RSS via proxy
    try{
      const rssUrl=encodeURIComponent('https://travel.state.gov/_res/rss/TAsTWs.xml');
      const res=await fetch(PROXY+rssUrl);
      const data=await res.json();
      if(data.items&&data.items.length>0){
        const advs=[];
        data.items.forEach(item=>{
          const title=item.title||'';
          const lvlMatch=title.match(/Level\s*(\d)/i);
          const level=lvlMatch?parseInt(lvlMatch[1]):null;
          const country=title.split('-')[0]?.trim()||title.split('â€“')[0]?.trim()||title;
          if(level&&level>=2){
            advs.push({country,level,title:title.trim(),date:new Date(item.pubDate),url:item.link||'https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories.html/',desc:item.description?item.description.replace(/<[^>]*>/g,'').slice(0,120):''});
          }
        });
        advs.sort((a,b)=>b.level-a.level||b.date-a.date);
        if(advs.length>0){setAdvisories(advs.slice(0,22));return;}
      }
    }catch(e){console.log('State Dept RSS error',e);}
    // Try State Dept API directly (may work on some browsers)
    try{
      const res=await fetch('https://cadataapi.state.gov/api/TravelAdvisories');
      if(res.ok){
        const text=await res.text();
        const parser=new DOMParser();
        const xml=parser.parseFromString(text,'text/xml');
        const items=xml.querySelectorAll('item');
        const advs=[];
        items.forEach(item=>{
          const title=item.querySelector('title')?.textContent||'';
          const link=item.querySelector('link')?.textContent||'';
          const pubDate=item.querySelector('pubDate')?.textContent||'';
          const desc=item.querySelector('description')?.textContent||'';
          const lvlMatch=title.match(/Level\s*(\d)/i);
          const level=lvlMatch?parseInt(lvlMatch[1]):null;
          const country=title.split('-')[0]?.trim()||title;
          if(level&&level>=2){
            advs.push({country,level,title:title.trim(),date:pubDate?new Date(pubDate):new Date(),url:link,desc:desc.replace(/<[^>]*>/g,'').slice(0,120)});
          }
        });
        advs.sort((a,b)=>b.level-a.level||b.date-a.date);
        if(advs.length>0){setAdvisories(advs.slice(0,22));}
      }
    }catch(e){}
  };

  // Fetch sovereign credit rating changes
  const fetchRatings=async()=>{
    // Load fallback immediately so panel is never empty
    if(ratings.length===0){setRatings(RATING_FALLBACK);setRatingsLive(true);}
    // Try live RSS
    try{
      const results=[];
      for(const q of RATING_RSS_QUERIES){
        const rssUrl=encodeURIComponent('https://news.google.com/rss/search?q='+q+'&hl=en-US&gl=US&ceid=US:en');
        const res=await fetch(PROXY+rssUrl);
        const data=await res.json();
        if(data.items){
          data.items.slice(0,5).forEach(item=>{
            const src=item.title.includes(' - ')?item.title.split(' - ').pop().trim():'Ratings';
            const headline=item.title.includes(' - ')?item.title.split(' - ').slice(0,-1).join(' - ').trim():item.title;
            const t=headline.toLowerCase();
            let direction='neutral',color='var(--t2)';
            if(t.match(/downgrad|negativ|lower|cut|junk/)){direction='downgrade';color='#ff3b30';}
            else if(t.match(/upgrad|positiv|rais|improv/)){direction='upgrade';color='#30d158';}
            else if(t.match(/watch|review|outlook/)){direction='watch';color='#ffd60a';}
            let agency='';
            if(t.includes('moody'))agency="Moody's";
            else if(t.includes('fitch'))agency='Fitch';
            else if(t.includes('s&p')||t.includes('s & p')||t.includes('standard'))agency='S&P';
            results.push({headline,src,agency,direction,color,time:timeAgo(item.pubDate),url:item.link});
          });
        }
      }
      const seen=new Set();
      const unique=results.filter(r=>{const k=r.headline.slice(0,35);if(seen.has(k))return false;seen.add(k);return true;});
      if(unique.length>0){setRatings(unique.slice(0,8));setRatingsLive(true);}
    }catch(e){}
  };

  // Fetch SPGI news
  const fetchSpgiNews=async()=>{
    // Load fallback immediately so panel is never empty
    if(spgiNews.length===0){setSpgiNews(SPGI_NEWS_FALLBACK);setSpgiNewsLive(true);}
    // Try live RSS
    try{
      const results=[];
      for(const q of SPGI_RSS_QUERIES){
        try{
          const rssUrl=encodeURIComponent(`https://news.google.com/rss/search?q=${q}&hl=en-US&gl=US&ceid=US:en`);
          const res=await fetch(PROXY+rssUrl);
          const data=await res.json();
          if(data.items){
            data.items.slice(0,4).forEach(item=>{
              const src=item.title.includes(' - ')?item.title.split(' - ').pop().trim():'News';
              const headline=item.title.includes(' - ')?item.title.split(' - ').slice(0,-1).join(' - ').trim():item.title;
              results.push({t:headline,src,tm:timeAgo(item.pubDate),url:item.link,pubDate:new Date(item.pubDate)});
            });
          }
        }catch(e){}
      }
      const seen=new Set();
      const unique=results.filter(r=>{const k=r.t.slice(0,40);if(seen.has(k))return false;seen.add(k);return true;});
      unique.sort((a,b)=>b.pubDate-a.pubDate);
      if(unique.length>0){setSpgiNews(unique.slice(0,10));setSpgiNewsLive(true);}
    }catch(e){}
  };

  // Fetch live RSS feeds
  const fetchFeeds=async()=>{
    try{
      const results=[];
      for(const feed of RSS_FEEDS){
        const rssUrl=encodeURIComponent(`https://news.google.com/rss/search?q=${feed.q}&hl=en-US&gl=US&ceid=US:en`);
        try{
          const res=await fetch(PROXY+rssUrl);
          const data=await res.json();
          if(data.items){
            data.items.slice(0,4).forEach(item=>{
              const cat=classifyHeadline(item.title);
              const src=item.title.includes(' - ')?item.title.split(' - ').pop().trim():'News';
              const headline=item.title.includes(' - ')?item.title.split(' - ').slice(0,-1).join(' - ').trim():item.title;
              results.push({
                t:headline,
                cat,
                sv:['CONFLICT','CYBER','INTEL'].includes(cat)?'critical':['CLIMATE','ENERGY','HEALTH'].includes(cat)?'high':'medium',
                src,
                tm:timeAgo(item.pubDate),
                url:item.link,
                pubDate:new Date(item.pubDate),
              });
            });
          }
        }catch(e){}
      }
      // Deduplicate and sort by date
      const seen=new Set();
      const unique=results.filter(r=>{const k=r.t.slice(0,50);if(seen.has(k))return false;seen.add(k);return true;});
      unique.sort((a,b)=>b.pubDate-a.pubDate);
      if(unique.length>0){setLiveNews(unique.slice(0,40));setFeedStatus('live');}
      else{setFeedStatus('fallback');}
    }catch(e){setFeedStatus('fallback');}
  };

  // Fetch live severe weather alerts from NWS API (real government data)
  const fetchWeather=async()=>{
    // Load fallback immediately â€” real current events so panel is never empty
    if(wxAlerts===WEATHER_FALLBACK&&!wxLive){setWxAlerts(WEATHER_FALLBACK);setWxLive(true);}
    try{
      // NWS API â€” real active alerts, all urgencies (captures snow, ice, wind, floods, fire, etc.)
      const res=await fetch('https://api.weather.gov/alerts/active?status=actual&limit=50',{
        headers:{'Accept':'application/geo+json','User-Agent':'SentinelDashboard/1.0'}
      });
      if(!res.ok)throw new Error('NWS fetch failed');
      const data=await res.json();
      if(data.features&&data.features.length>0){
        const nwsSevMap={'Extreme':'extreme','Severe':'severe','Moderate':'moderate','Minor':'watch','Unknown':'watch'};
        const eventIcons={
          'Tornado':'ðŸŒªï¸','Hurricane':'ðŸŒ€','Typhoon':'ðŸŒ€','Tropical Storm':'ðŸŒ€',
          'Flash Flood':'ðŸŒŠ','Flood':'ðŸŒŠ','Coastal Flood':'ðŸŒŠ','Lakeshore Flood':'ðŸŒŠ',
          'Severe Thunderstorm':'â›ˆï¸','Thunderstorm':'â›ˆï¸',
          'Winter Storm':'â„ï¸','Blizzard':'â„ï¸','Ice Storm':'â„ï¸','Snow':'â„ï¸','Heavy Snow':'â„ï¸','Lake Effect Snow':'â„ï¸','Freezing Rain':'â„ï¸','Sleet':'â„ï¸','Winter Weather':'â„ï¸','Wind Chill':'â„ï¸',
          'Extreme Cold':'ðŸ¥¶','Cold':'ðŸ¥¶','Freeze':'ðŸ¥¶','Frost':'ðŸ¥¶','Hard Freeze':'ðŸ¥¶',
          'Heat':'ðŸ”¥','Excessive Heat':'ðŸ”¥','Fire Weather':'ðŸ”¥','Red Flag':'ðŸ”¥',
          'Tsunami':'ðŸŒŠ','Storm Surge':'ðŸŒŠ','Rip Current':'ðŸŒŠ',
          'Wind':'ðŸ’¨','High Wind':'ðŸ’¨','Dust Storm':'ðŸ’¨','Gale':'ðŸ’¨','Dense Fog':'ðŸŒ«ï¸','Avalanche':'ðŸ”ï¸'
        };
        // Sort by severity so we get most impactful first
        const sevOrder={Extreme:0,Severe:1,Moderate:2,Minor:3,Unknown:4};
        const sorted=[...data.features].sort((a,b)=>(sevOrder[a.properties.severity]??4)-(sevOrder[b.properties.severity]??4));
        // Deduplicate by event type â€” keep one per event type to show variety
        const seenEvents=new Set();
        const diverse=sorted.filter(f=>{
          const evt=f.properties.event||'';
          if(seenEvents.has(evt))return false;
          seenEvents.add(evt);return true;
        });
        // If fewer than 8 diverse, backfill from sorted
        const final=diverse.length>=8?diverse.slice(0,8):[...diverse,...sorted.filter(f=>!diverse.includes(f))].slice(0,8);
        const wxItems=final.map(f=>{
          const p=f.properties;
          const sev=nwsSevMap[p.severity]||'moderate';
          const evtKey=Object.keys(eventIcons).find(k=>p.event&&p.event.includes(k));
          const icon=evtKey?eventIcons[evtKey]:'âš ï¸';
          const type=p.event||'Weather Alert';
          const onset=p.onset?new Date(p.onset):new Date(p.effective);
          const areaDesc=(p.areaDesc||'').length>80?p.areaDesc.slice(0,77)+'...':p.areaDesc;
          const headline=p.headline||`${p.event} â€” ${areaDesc}`;
          const detail=p.description?p.description.slice(0,140).replace(/\n/g,' ')+'...':areaDesc;
          // NWS provides a web URL for each alert
          const alertUrl=p['@id']?p['@id'].replace('api.weather.gov/alerts','alerts.weather.gov/#'):('https://alerts.weather.gov');
          return{sev,type,title:headline,detail,time:timeAgo(onset.toISOString()),icon,url:alertUrl};
        });
        setWxAlerts(wxItems);setWxLive(true);
        // Also try to supplement with global alerts from GDACS
        try{
          const gdacsUrl=encodeURIComponent('https://www.gdacs.org/xml/rss.xml');
          const gres=await fetch(PROXY+gdacsUrl);
          const gdata=await gres.json();
          if(gdata.items&&gdata.items.length>0){
            const globalWx=gdata.items.slice(0,4).map(item=>{
              const t=item.title.toLowerCase();
              let sev='moderate',icon='âš ï¸',type='Disaster';
              if(t.match(/earthquake|quake/)){sev='severe';icon='ðŸŒ';type='Earthquake';}
              else if(t.match(/cyclone|hurricane|typhoon|storm/)){sev='extreme';icon='ðŸŒ€';type='Cyclone';}
              else if(t.match(/flood/)){sev='severe';icon='ðŸŒŠ';type='Flood';}
              else if(t.match(/volcano/)){sev='severe';icon='ðŸŒ‹';type='Volcano';}
              else if(t.match(/drought/)){sev='watch';icon='â˜€ï¸';type='Drought';}
              else if(t.match(/wildfire|fire/)){sev='severe';icon='ðŸ”¥';type='Wildfire';}
              return{sev,type,title:item.title,detail:item.content||item.description||'',time:timeAgo(item.pubDate),icon,url:item.link};
            });
            // Merge: NWS first, then global
            setWxAlerts(prev=>[...prev.slice(0,5),...globalWx].slice(0,8));
          }
        }catch(ge){}
        return;
      }
    }catch(e){console.log('NWS fetch error, trying RSS fallback',e);}
    // Fallback: GDACS global disaster alerts
    try{
      const gdacsUrl=encodeURIComponent('https://www.gdacs.org/xml/rss.xml');
      const gres=await fetch(PROXY+gdacsUrl);
      const gdata=await gres.json();
      if(gdata.items&&gdata.items.length>0){
        const wxItems=gdata.items.slice(0,8).map(item=>{
          const t=item.title.toLowerCase();
          let sev='moderate',icon='âš ï¸',type='Disaster';
          if(t.match(/earthquake|quake/)){sev='severe';icon='ðŸŒ';type='Earthquake';}
          else if(t.match(/cyclone|hurricane|typhoon|storm/)){sev='extreme';icon='ðŸŒ€';type='Cyclone';}
          else if(t.match(/flood/)){sev='severe';icon='ðŸŒŠ';type='Flood';}
          else if(t.match(/volcano/)){sev='severe';icon='ðŸŒ‹';type='Volcano';}
          else if(t.match(/wildfire|fire/)){sev='severe';icon='ðŸ”¥';type='Wildfire';}
          return{sev,type,title:item.title,detail:item.content||item.description||'',time:timeAgo(item.pubDate),icon,url:item.link};
        });
        setWxAlerts(wxItems);setWxLive(true);
        return;
      }
    }catch(ge){}
    // Final fallback: Google News RSS for weather
    try{
      const wxUrl=encodeURIComponent('https://news.google.com/rss/search?q=severe+weather+OR+hurricane+OR+typhoon+OR+earthquake+OR+wildfire+OR+flood+warning&hl=en-US&gl=US&ceid=US:en');
      const res=await fetch(PROXY+wxUrl);
      const data=await res.json();
      if(data.items&&data.items.length>0){
        const wxItems=data.items.slice(0,8).map(item=>{
          const t=item.title.toLowerCase();
          const src=item.title.includes(' - ')?item.title.split(' - ').pop().trim():'Weather';
          const headline=item.title.includes(' - ')?item.title.split(' - ').slice(0,-1).join(' - ').trim():item.title;
          let sev='moderate',icon='âš ï¸',type='Weather';
          if(t.match(/hurricane|typhoon|cat.?[4-5]|super/)){sev='extreme';icon='ðŸŒ€';type='Cyclone';}
          else if(t.match(/flood|tsunami|surge/)){sev='severe';icon='ðŸŒŠ';type='Flooding';}
          else if(t.match(/wildfire|fire|blaze|burn/)){sev='severe';icon='ðŸ”¥';type='Wildfire';}
          else if(t.match(/earthquake|quake/)){sev='severe';icon='ðŸŒ';type='Earthquake';}
          else if(t.match(/heat|record.?temp|heat.?dome/)){sev='moderate';icon='ðŸ”¥';type='Heat';}
          else if(t.match(/storm|tornado|blizzard|snow/)){sev='severe';icon='â„ï¸';type='Storm';}
          else if(t.match(/drought|dry/)){sev='watch';icon='â˜€ï¸';type='Drought';}
          return{sev,type,title:headline,detail:src,time:timeAgo(item.pubDate),icon,url:item.link};
        });
        setWxAlerts(wxItems);setWxLive(true);
      }
    }catch(e){}
  };

  const[notamLive,setNotamLive]=useState(false);

  // Fetch live NOTAMs â€” FAA TFR RSS (real-time), Aviation Herald, and ICAO news
  const fetchNotams=async()=>{
    const allNotams=[];
    // Source 1: FAA TFR (Temporary Flight Restrictions) â€” official real-time RSS
    try{
      const tfrUrl=encodeURIComponent('https://tfr.faa.gov/tfr2/feed.jsp');
      const res=await fetch(PROXY+tfrUrl);
      const data=await res.json();
      if(data.items&&data.items.length>0){
        data.items.slice(0,6).forEach(item=>{
          const t=item.title||'';
          let status='RESTRICTED',color='#ff9500';
          if(t.toLowerCase().match(/prohibit|p-40|dc sfra/)){status='PROHIBITED';color='#ff3b30';}
          else if(t.toLowerCase().match(/hazard|security|national defense/)){status='PROHIBITED';color='#ff3b30';}
          const notamId=t.match(/(\d\/\d+)/)?t.match(/(\d\/\d+)/)[1]:'TFR';
          allNotams.push({id:notamId,zone:t.slice(0,55),status,detail:item.description?item.description.replace(/<[^>]*>/g,'').slice(0,100):'FAA TFR â€” Active restriction',color,time:timeAgo(item.pubDate),url:item.link||'https://tfr.faa.gov/tfr2/list.jsp',src:'FAA'});
        });
      }
    }catch(e){console.log('FAA TFR fetch error',e);}

    // Source 2: Aviation Herald (incidents/safety) via RSS
    try{
      const avhUrl=encodeURIComponent('https://avherald.com/h?rss=1');
      const res=await fetch(PROXY+avhUrl);
      const data=await res.json();
      if(data.items&&data.items.length>0){
        data.items.slice(0,4).forEach(item=>{
          const t=item.title||'';
          let status='WARNING',color='#ffd60a';
          if(t.toLowerCase().match(/crash|fatal|emergency|mayday/)){status='PROHIBITED';color='#ff3b30';}
          else if(t.toLowerCase().match(/divert|reject|engine|fire|smoke/)){status='RESTRICTED';color='#ff9500';}
          allNotams.push({id:'AVH',zone:t.slice(0,55),status,detail:t,color,time:timeAgo(item.pubDate),url:item.link||'https://avherald.com',src:'AvHerald'});
        });
      }
    }catch(e){}

    // Source 3: Google News RSS for NOTAMs / airspace closures as supplement
    try{
      const queries=['NOTAM+airspace+closure+flight+restriction','TFR+temporary+flight+restriction+FAA'];
      for(const q of queries){
        const rssUrl=encodeURIComponent(`https://news.google.com/rss/search?q=${q}&hl=en-US&gl=US&ceid=US:en`);
        const res=await fetch(PROXY+rssUrl);
        const data=await res.json();
        if(data.items){
          data.items.slice(0,3).forEach(item=>{
            const t=item.title.toLowerCase();
            const src=item.title.includes(' - ')?item.title.split(' - ').pop().trim():'News';
            const headline=item.title.includes(' - ')?item.title.split(' - ').slice(0,-1).join(' - ').trim():item.title;
            let status='WARNING',color='#ffd60a';
            if(t.match(/prohibit|clos|ban|shut/)){status='PROHIBITED';color='#ff3b30';}
            else if(t.match(/restrict|tfr|limit|military/)){status='RESTRICTED';color='#ff9500';}
            allNotams.push({id:'NEWS',zone:headline.slice(0,55),status,detail:src+' â€” '+headline.slice(55,120),color,time:timeAgo(item.pubDate),url:item.link,src});
          });
        }
      }
    }catch(e){}

    if(allNotams.length>0){
      // Deduplicate by first 35 chars of zone
      const seen=new Set();
      const unique=allNotams.filter(n=>{const k=n.zone.slice(0,35).toLowerCase();if(seen.has(k))return false;seen.add(k);return true;});
      setNotams(unique.slice(0,8));setNotamLive(true);
    }
  };

  const mapRef=useRef(null);
  const markersRef=useRef([]);
  const linesRef=useRef([]);

  useEffect(()=>{const i=setInterval(()=>setTime(new Date()),1000);return()=>clearInterval(i)},[]);
  useEffect(()=>{fetchFeeds();fetchWeather();fetchNotams();fetchSpgiNews();fetchAdvisories();fetchRatings();const i=setInterval(()=>{fetchFeeds();fetchWeather();fetchNotams();fetchSpgiNews();fetchAdvisories();fetchRatings()},2*60*1000);return()=>clearInterval(i)},[]);

  // Initialize Leaflet map
  useEffect(()=>{
    if(mapRef.current)return;
    const map=L.map('leaflet-map',{
      center:[20,15],zoom:2,minZoom:2,maxZoom:8,
      zoomControl:true,attributionControl:false,
      worldCopyJump:true
    });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',{
      subdomains:'abcd',maxZoom:19
    }).addTo(map);
    // Add labels as separate layer on top
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png',{
      subdomains:'abcd',maxZoom:19,pane:'shadowPane'
    }).addTo(map);
    mapRef.current=map;

    // Add connection lines
    CONNS.forEach(([fromId,toId,label,color])=>{
      const f=INCIDENTS.find(i=>i.id===fromId);const t=INCIDENTS.find(i=>i.id===toId);
      if(!f||!t)return;
      const line=L.polyline([[f.lat,f.lon],[t.lat,t.lon]],{
        color,weight:1.5,opacity:0.35,dashArray:'6,4',className:'conn-arc'
      }).addTo(map);
      linesRef.current.push(line);
    });
  },[]);

  // Update markers when filter changes
  useEffect(()=>{
    if(!mapRef.current)return;
    const map=mapRef.current;
    // Clear old markers
    markersRef.current.forEach(m=>map.removeLayer(m));
    markersRef.current=[];
    // Add filtered markers
    const filtered=mf==='ALL'?INCIDENTS:INCIDENTS.filter(i=>i.cat===mf);
    filtered.forEach(inc=>{
      const col=SC[inc.sv];
      const size=inc.sv==='critical'?10:8;
      const pulseClass=inc.sv==='critical'?'pulse-marker':'';
      const icon=L.divIcon({
        className:'',
        html:`<div style="width:${size}px;height:${size}px;background:${col};border-radius:50%;border:2px solid rgba(0,0,0,0.6);box-shadow:0 0 ${inc.sv==='critical'?'12':'6'}px ${col}80;cursor:pointer" class="${pulseClass}"></div>`,
        iconSize:[size,size],iconAnchor:[size/2,size/2]
      });
      const marker=L.marker([inc.lat,inc.lon],{icon}).addTo(map);
      const popup=`<div style="font-family:Inter,sans-serif">
        <div style="font:600 10px 'JetBrains Mono';color:${col};text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${inc.cat} â€” ${inc.sv.toUpperCase()}</div>
        <div style="font:500 12px/1.4 Inter;color:#e5e5e5;margin-bottom:4px">${inc.t}</div>
        <div style="font:400 10px 'JetBrains Mono';color:#999">${inc.reg} Â· ${inc.tm} ago</div>
        <div style="font:500 10px 'JetBrains Mono';color:#999;margin-top:4px">${inc.imp}</div>
      </div>`;
      marker.bindPopup(popup,{maxWidth:280,closeButton:true});
      marker.on('mouseover',function(){this.openPopup()});
      markersRef.current.push(marker);
    });
  },[mf]);

  const fi=mf==='ALL'?INCIDENTS:INCIDENTS.filter(i=>i.cat===mf);

  // Use live news for feed + wire, fallback to static
  const feedItems=liveNews.length>0?liveNews:INCIDENTS;
  const wireItems=liveNews.length>0?liveNews:NEWS;

  // Compute advisory summary stats
  const advStats=useMemo(()=>{
    const l4=advisories.filter(a=>a.level===4).length;
    const l3=advisories.filter(a=>a.level===3).length;
    const l2=advisories.filter(a=>a.level===2).length;
    return{l4,l3,l2,total:advisories.length};
  },[advisories]);

  return(
    <div>
      {/* Ticker */}
      <div className="ticker"><div className="tscroll">
        {[...TICKERS,...TICKERS].map((t,i)=><React.Fragment key={i}>
          <span className="tk"><span className="s">{t.s}</span><span className="p">{t.p}</span><span className={t.u?'up':'dn'}>{t.c}</span></span>
          {i%5===4&&<span className="tsep">â”‚</span>}
        </React.Fragment>)}
      </div></div>

      {/* Header */}
      <div className="hdr">
        <div className="hdr-l"><div className="logo">SENTINEL NOVA<span>GLOBAL SECURITY TERMINAL</span></div><span style={{font:'600 8px var(--mono)',color:'var(--red)',padding:'2px 8px',borderRadius:2,border:'1px solid rgba(255,59,48,.4)',background:'rgba(255,59,48,.1)',letterSpacing:'1.5px',marginLeft:12}}>RESTRICTED</span></div>
        <div className="hdr-r">
          <div className="hdr-spgi">
            <span style={{font:'600 10px var(--mono)',color:'var(--t2)'}}>SPGI</span>
            <span style={{font:'700 11px var(--mono)',color:'var(--grn)'}}>512.38</span>
            <svg width="48" height="16" viewBox="0 0 48 16"><polyline points={SPGI.map((d,i)=>{const x=i/(SPGI.length-1)*48;const mn=Math.min(...SPGI.map(s=>s.p));const mx=Math.max(...SPGI.map(s=>s.p));return `${x},${2+((mx-d.p)/(mx-mn))*12}`}).join(' ')} fill="none" stroke="#30d158" strokeWidth="1.2"/></svg>
            <span style={{font:'500 9px var(--mono)',color:'var(--grn)'}}>+1.24%</span>
          </div>
          <span className="threat">âš  {advStats.l4>0?'L4 ADVISORIES: '+advStats.l4:'THREAT LEVEL: ELEVATED'}</span>
          <span className="live"><span className="ldot"></span>LIVE</span>
          <span>{time.toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})}</span>
          <span style={{color:'var(--t3)'}}>UTC {time.toISOString().slice(11,19)}</span>
        </div>
      </div>

      <div className="shell">
        {/* LEFT SIDEBAR */}
        <div className="sidebar">
          {/* TRAVEL ADVISORIES */}
          <div className="ph"><div className="pt">â—† US Travel Advisories</div><span className="pb" style={{background:advLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:advLive?'var(--grn)':'var(--t3)'}}>{advLive?'â— STATE DEPT LIVE':'LOADING'}</span></div>
          {/* Summary bar */}
          {advLive&&<div style={{display:'flex',gap:0,borderBottom:'1px solid var(--bdr)'}}>
            <div style={{flex:1,padding:'6px 8px',textAlign:'center',background:'rgba(255,59,48,0.08)',borderRight:'1px solid var(--bdr)'}}>
              <div style={{font:'700 16px var(--mono)',color:'#ff3b30'}}>{advStats.l4}</div>
              <div style={{font:'500 7px var(--mono)',color:'var(--t3)',letterSpacing:'.5px'}}>L4 â€” DNT</div>
            </div>
            <div style={{flex:1,padding:'6px 8px',textAlign:'center',background:'rgba(255,149,0,0.06)',borderRight:'1px solid var(--bdr)'}}>
              <div style={{font:'700 16px var(--mono)',color:'#ff9500'}}>{advStats.l3}</div>
              <div style={{font:'500 7px var(--mono)',color:'var(--t3)',letterSpacing:'.5px'}}>L3 â€” RECON</div>
            </div>
            <div style={{flex:1,padding:'6px 8px',textAlign:'center',background:'rgba(255,214,10,0.05)'}}>
              <div style={{font:'700 16px var(--mono)',color:'#ffd60a'}}>{advStats.l2}</div>
              <div style={{font:'500 7px var(--mono)',color:'var(--t3)',letterSpacing:'.5px'}}>L2 â€” CAUT</div>
            </div>
          </div>}
          <div className="pbd" style={{padding:'6px 12px'}}>
            {advisories.length>0?advisories.map((adv,i)=>{
              const inner=<div key={i} style={{padding:'5px 0',borderBottom:i<advisories.length-1?'1px solid var(--bdr)':'none'}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:2}}>
                  <span style={{font:'600 8px var(--mono)',color:ADV_COLORS[adv.level],padding:'1px 5px',borderRadius:2,background:ADV_COLORS[adv.level]+'18',border:'1px solid '+ADV_COLORS[adv.level]+'35',letterSpacing:'.5px'}}>{ADV_SHORT[adv.level]||'L'+adv.level}</span>
                  <span style={{font:'400 8px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{adv.date?timeAgo(adv.date.toISOString()):''}</span>
                </div>
                <div style={{font:'500 10px/1.3 Inter,sans-serif',color:'var(--t1)',cursor:adv.url?'pointer':'default'}}>{adv.country}{adv.url&&<span style={{color:'var(--t3)',fontSize:9,marginLeft:4}}>â†—</span>}</div>
                {adv.desc&&<div style={{font:'400 9px Inter,sans-serif',color:'var(--t3)',marginTop:1}}>{adv.desc.slice(0,80)}</div>}
              </div>;
              return adv.url?<a key={i} href={adv.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
            }):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading advisories...</div>}
          </div>

          {/* SOVEREIGN RISK RATINGS */}
          <div className="ph"><div className="pt">â—† Sovereign Risk Ratings</div><span className="pb" style={{background:ratingsLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:ratingsLive?'var(--grn)':'var(--t3)'}}>{ratingsLive?'â— LIVE':'LOADING'}</span></div>
          <div className="pbd" style={{padding:'6px 12px'}}>
            {ratings.length>0?ratings.map((r,i)=>{
              const inner=<div key={i} style={{padding:'5px 0',borderBottom:i<ratings.length-1?'1px solid var(--bdr)':'none'}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:2}}>
                  <span style={{font:'600 8px var(--mono)',color:r.color,padding:'1px 5px',borderRadius:2,background:r.color+'18',border:'1px solid '+r.color+'35',letterSpacing:'.5px',textTransform:'uppercase'}}>{r.direction}</span>
                  {r.agency&&<span style={{font:'500 8px var(--mono)',color:'var(--t2)'}}>{r.agency}</span>}
                  <span style={{font:'400 8px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{r.time}</span>
                </div>
                <div style={{font:'500 10px/1.3 Inter,sans-serif',color:'var(--t1)',cursor:r.url?'pointer':'default'}}>{r.headline.slice(0,65)}{r.headline.length>65?'...':''}{r.url&&<span style={{color:'var(--t3)',fontSize:9,marginLeft:4}}>â†—</span>}</div>
                <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:1}}>{r.src}</div>
              </div>;
              return r.url?<a key={i} href={r.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
            }):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading ratings...</div>}
          </div>
        </div>

        {/* CENTER */}
        <div className="center">
          {/* MAP */}
          <div style={{flex:'1 1 55%',minHeight:0,borderBottom:'1px solid var(--bdr)'}}>
            <div className="mwrap">
              <div id="leaflet-map"></div>
              <div className="mfilt" style={{zIndex:1000}}>
                {['ALL','CONFLICT','CLIMATE','CYBER','ENERGY','ECONOMIC'].map(f=>(
                  <button key={f} className={`mfb ${mf===f?'a':''}`} onClick={()=>setMf(f)}>{f}</button>
                ))}
              </div>
              <div className="mstat" style={{zIndex:1000}}>
                <div className="ms"><span className="msv" style={{color:'var(--red)'}}>{INCIDENTS.filter(i=>i.sv==='critical').length}</span><span className="msl">Critical</span></div>
                <div className="ms"><span className="msv" style={{color:'var(--amber)'}}>{INCIDENTS.filter(i=>i.sv==='high').length}</span><span className="msl">High</span></div>
                <div className="ms"><span className="msv" style={{color:'var(--t1)'}}>{INCIDENTS.length}</span><span className="msl">Total</span></div>
              </div>
              <div className="mleg" style={{zIndex:1000}}>
                {Object.entries(CC).slice(0,6).map(([k,v])=><span key={k} className="ml"><span className="mld" style={{background:v}}></span>{k}</span>)}
              </div>
            </div>
          </div>

          {/* BOTTOM: Intel + Trends */}
          <div style={{flex:'1 1 45%',display:'grid',gridTemplateColumns:'1fr 1fr',overflow:'hidden'}}>
            {/* Intel Feed â€” live or fallback */}
            <div style={{overflow:'auto',borderRight:'1px solid var(--bdr)'}}>
              <div className="ph">
                <div className="pt">â—† Intelligence Feed</div>
                <span className="pb" style={{background:feedStatus==='live'?'var(--grnbg)':'var(--redbg)',color:feedStatus==='live'?'var(--grn)':'var(--red)'}}>
                  {feedStatus==='live'?'â— LIVE RSS':feedStatus==='loading'?'LOADING...':feedItems.length+' ACTIVE'}
                </span>
              </div>
              <div className="pbd">
                {feedStatus==='live'?
                  /* LIVE RSS ITEMS */
                  liveNews.map((item,idx)=>{
                    return <a key={idx} href={item.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                    <div className="fi">
                      <div className="fit">
                        <div className="fis" style={{background:SC[item.sv]}}/>
                        <span className="fitg" style={{background:(CC[item.cat]||'#999')+'20',color:CC[item.cat]||'#999',border:'1px solid '+(CC[item.cat]||'#999')+'40'}}>{item.cat}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.src}</span>
                        <span className="fitm">{item.tm}</span>
                      </div>
                      <div className="fitt" style={{cursor:'pointer'}}>{item.t} <span style={{color:'var(--t3)',fontSize:9}}>â†—</span></div>
                    </div></a>;
                  })
                :
                  /* FALLBACK STATIC ITEMS */
                  INCIDENTS.map(inc=>{
                    const q=encodeURIComponent(inc.t.split('â€”')[0].trim());
                    const url=`https://news.google.com/search?q=${q}`;
                    return <a key={inc.id} href={url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                    <div className="fi">
                      <div className="fit">
                        <div className="fis" style={{background:SC[inc.sv]}}/>
                        <span className="fitg" style={{background:CC[inc.cat]+'20',color:CC[inc.cat],border:'1px solid '+CC[inc.cat]+'40'}}>{inc.cat}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{inc.reg}</span>
                        <span className="fitm">{inc.tm}</span>
                      </div>
                      <div className="fitt" style={{cursor:'pointer'}}>{inc.t} <span style={{color:'var(--t3)',fontSize:9}}>â†—</span></div>
                      <div className="fisu">{inc.imp}</div>
                    </div></a>;
                  })
                }
              </div>
            </div>

            {/* Weather + NOTAMs Split Panel */}
            <div style={{overflow:'hidden',display:'flex',flexDirection:'column'}}>
              {/* SEVERE WEATHER */}
              <div style={{flex:'1 1 50%',overflow:'auto',borderBottom:'1px solid var(--bdr)'}}>
                <div className="ph">
                  <div className="pt">â—† Severe Weather</div>
                  <span className="pb" style={{background:'var(--redbg)',color:'var(--red)'}}>{wxAlerts.filter(w=>w.sev==='extreme').length} EXTREME</span>
                </div>
                <div className="pbd" style={{padding:'6px 12px'}}>
                  {wxAlerts.map((wx,i)=>{
                    const inner=<div key={i} style={{padding:'6px 0',borderBottom:i<wxAlerts.length-1?'1px solid var(--bdr)':'none'}}>
                      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                        <span style={{fontSize:12}}>{wx.icon}</span>
                        <span style={{font:'600 9px var(--mono)',color:WX_SEV_COLORS[wx.sev],textTransform:'uppercase',letterSpacing:'.5px',padding:'1px 5px',borderRadius:2,background:WX_SEV_COLORS[wx.sev]+'18',border:'1px solid '+WX_SEV_COLORS[wx.sev]+'35'}}>{wx.sev}</span>
                        <span style={{font:'500 9px var(--mono)',color:'var(--t3)'}}>{wx.type}</span>
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{wx.time}</span>
                      </div>
                      <div style={{font:'500 11px/1.3 Inter,sans-serif',color:'var(--t1)'}}>{wx.title}</div>
                      <div style={{font:'400 10px Inter,sans-serif',color:'var(--t3)',marginTop:2}}>{wx.detail}</div>
                    </div>;
                    return wx.url?<a key={i} href={wx.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
                  })}
                </div>
              </div>

              {/* NOTAMs */}
              <div style={{flex:'1 1 50%',overflow:'auto'}}>
                <div className="ph">
                  <div className="pt">â—† Active NOTAMs</div>
                  <span className="pb" style={{background:notamLive?'var(--grnbg)':'var(--redbg)',color:notamLive?'var(--grn)':'var(--red)'}}>{notamLive?'â— LIVE':notams.filter(n=>n.status==='PROHIBITED').length+' PROHIBITED'}</span>
                </div>
                <div className="pbd" style={{padding:'6px 12px'}}>
                  {notams.map((n,i)=>{
                    const inner=<div key={i} style={{padding:'6px 0',borderBottom:i<notams.length-1?'1px solid var(--bdr)':'none'}}>
                      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                        <span style={{font:'600 9px var(--mono)',color:'var(--t2)'}}>{n.id}</span>
                        <span style={{font:'600 8px var(--mono)',color:NOTAM_STATUS_COLORS[n.status]||n.color,textTransform:'uppercase',letterSpacing:'.5px',padding:'1px 5px',borderRadius:2,background:(NOTAM_STATUS_COLORS[n.status]||n.color)+'18',border:'1px solid '+(NOTAM_STATUS_COLORS[n.status]||n.color)+'35'}}>{n.status}</span>
                        {n.src&&<span style={{font:'400 8px var(--mono)',color:'var(--t3)',padding:'1px 4px',border:'1px solid var(--bdr)',borderRadius:2}}>{n.src}</span>}
                        <span style={{font:'400 9px var(--mono)',color:'var(--t3)',marginLeft:'auto'}}>{n.time}</span>
                      </div>
                      <div style={{font:'500 10px/1.3 var(--mono)',color:'var(--t1)',cursor:n.url?'pointer':'default'}}>{n.zone}{n.url&&<span style={{color:'var(--t3)',fontSize:9,marginLeft:4}}>â†—</span>}</div>
                      <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:2}}>{n.detail}</div>
                    </div>;
                    return n.url?<a key={i} href={n.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>{inner}</a>:inner;
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* RIGHT PANEL */}
        <div className="rpanel">
          {/* SPGI */}
          <div className="ph"><div className="pt">â—† SPGI â€” S&P Global</div><span className="pb" style={{background:'var(--grnbg)',color:'var(--grn)'}}>+1.24%</span></div>
          <div className="pbd">
            <div style={{display:'flex',alignItems:'baseline',gap:8}}>
              <span style={{font:'700 22px var(--mono)',color:'var(--grn)'}}>$512.38</span>
              <span style={{font:'500 11px var(--mono)',color:'var(--grn)'}}>+$6.28</span>
            </div>
            <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:2}}>NYSE Â· Intraday Â· Vol: 1.2M</div>
            <div style={{marginTop:8}}><Sparkline data={SPGI} dataKey="p" w={260} h={55} color="#30d158"/></div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginTop:8,font:'400 9px var(--mono)'}}>
              <div><span style={{color:'var(--t3)'}}>Open</span><br/><span style={{color:'var(--t1)'}}>508.20</span></div>
              <div><span style={{color:'var(--t3)'}}>High</span><br/><span style={{color:'var(--t1)'}}>513.10</span></div>
              <div><span style={{color:'var(--t3)'}}>Low</span><br/><span style={{color:'var(--t1)'}}>508.05</span></div>
              <div><span style={{color:'var(--t3)'}}>Mkt Cap</span><br/><span style={{color:'var(--t1)'}}>$161.2B</span></div>
              <div><span style={{color:'var(--t3)'}}>P/E</span><br/><span style={{color:'var(--t1)'}}>48.32</span></div>
              <div><span style={{color:'var(--t3)'}}>52w H/L</span><br/><span style={{color:'var(--t1)'}}>520/380</span></div>
            </div>
          </div>

          {/* SPGI News */}
          <div className="ph"><div className="pt">â—† SPGI News & Updates</div><span className="pb" style={{background:spgiNewsLive?'var(--grnbg)':'rgba(102,102,102,.15)',color:spgiNewsLive?'var(--grn)':'var(--t3)'}}>{spgiNewsLive?'â— LIVE':'LOADING'}</span></div>
          <div className="pbd" style={{padding:'6px 12px'}}>
            {spgiNews.length>0?spgiNews.map((item,i)=>(
              <a key={i} href={item.url} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none',color:'inherit',display:'block'}}>
                <div style={{padding:'5px 0',borderBottom:i<spgiNews.length-1?'1px solid var(--bdr)':'none'}}>
                  <div style={{font:'500 10px/1.4 Inter,sans-serif',color:'var(--t1)',cursor:'pointer'}}>{item.t} <span style={{color:'var(--t3)',fontSize:9}}>â†—</span></div>
                  <div style={{display:'flex',justifyContent:'space-between',marginTop:2}}>
                    <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.src}</span>
                    <span style={{font:'400 9px var(--mono)',color:'var(--t3)'}}>{item.tm}</span>
                  </div>
                </div>
              </a>
            )):<div style={{font:'400 10px var(--mono)',color:'var(--t3)',padding:'8px 0'}}>Loading SPGI news...</div>}
          </div>

          {/* France 24 Live Stream */}
          <div className="ph" style={{marginTop:8}}><div className="pt">â—† France 24 Live</div><span className="pb" style={{background:'var(--redbg)',color:'var(--red)'}}>â— LIVE 24/7</span></div>
          <div style={{padding:'0 12px 12px',background:'var(--card)',borderRadius:'0 0 6px 6px'}}>
            <iframe
              src="https://embed.france24.com/en/live"
              style={{width:'100%',height:180,border:'1px solid var(--bdr)',borderRadius:4,marginTop:6}}
              allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
              allowFullScreen
              title="France 24 English Live"
            ></iframe>
            <div style={{font:'400 9px var(--mono)',color:'var(--t3)',marginTop:4,textAlign:'center'}}>France 24 English Â· 24/7 International News Â· Independent & Impartial</div>
          </div>
        </div>
      </div>

      {/* News Ticker â€” live or fallback */}
      <div className="newstick">
        <span className="label">â—† WIRE</span>
        <div className="nscroll">
          {liveNews.length>0?
            [...liveNews,...liveNews].map((n,i)=><span key={i} className="nitem">
              <span className="ndot" style={{background:CC[n.cat]||'#999'}}></span>
              {n.t}
              <span className="nsrc">{n.src}</span>
            </span>)
          :
            [...NEWS,...NEWS].map((n,i)=><span key={i} className="nitem">
              <span className="ndot" style={{background:n.c}}></span>
              {n.t}
              <span className="nsrc">{n.s}</span>
            </span>)
          }
        </div>
      </div>

      {/* Tooltip */}
      {tt&&<div className="tt" style={{left:tt.x,top:tt.y}}>
        <h5 style={{color:SC[tt.i.sv]}}>{tt.i.cat} â€” {tt.i.sv.toUpperCase()}</h5>
        <p style={{color:'var(--t1)',fontWeight:500}}>{tt.i.t}</p>
        <p style={{marginTop:3}}>{tt.i.reg} Â· {tt.i.tm} ago</p>
        <p style={{marginTop:2,color:'var(--t2)'}}>{tt.i.imp}</p>
      </div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
